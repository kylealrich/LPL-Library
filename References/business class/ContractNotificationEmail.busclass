ContractNotificationEmail is a BusinessClass
	owned by po
	prefix is CNEml
	
	Ontology
		symbolic key is ContractNotificationEmail
		
	Persistent Fields
		SentToDeliverableContact		is a ContractDeliverableContact
		SentToMilestoneContact			is a ContractMilestoneContact 
		SentToEmailAddress				is an EmailAddressMulti 
			holds pii
			default label is "To"
		SentToCc                        is an EmailAddressMulti 
			holds pii
			default label is "Cc"
		SentToBcc                      	is an EmailAddressMulti 
			holds pii
			default label is "Bcc"
		SentFromPrimaryContractContact	is a ContractAttachedContact
		SentFromEmailAddress			is an EmailAddress 
			holds pii
			default label is "From"
		EmailSubjectLine				is Alpha size up to 250
			default label is "Subject"
		EmailContent					is Text
			default label is "Content"
		NotificationType				is Numeric size 2
			States
				FirstAlert					value is 0
				SecondAlert					value is 1
				OneDayPriorAlert			value is 2
				PastDueAlert				value is 3
				SentOnDemand				value is 4
				TermsNegotiation            value is 5
				ContractAlert               value is 6
				FromSupplier                value is 7
				FromRequester               value is 9
				ContractProposal            value is 8
				EvaluationNotificationAlert	value is 10
				EvaluationReminder			value is 11
		PastDueCount					is Numeric size 6
		SentTimeStamp					is TimeStamp
			default label is "Sent"
		IncludeAttachments				is Boolean
			
	Transient Fields
		DaysToAlert						is Numeric size 6
		TransientEmailContent			is RichText
			derive value from EmailContent
		
	Field Rules
		SentTimeStamp
			default to current timestamp

	Derived Fields
		EmailMessageContent is a StringField
			type is RichText
			"You Are Being Requested To Perform A Contract Evaluation." "</br>"
			"Performance Evaluation Is Ready To Be Scored For <Contract.RepresentativeText>." "</br>"
			"Click <Contract.PerformanceEvaluationLinkback> To Score The Evaluation." "</br>"
	Conditions
		FromSupplier
			restricted
			when (NotificationType = 7)
		
		DeliverableNotification
			restricted
			when (ContractDeliverable entered)
			
		MilestoneNotification
			restricted
			when (ContractMilestone entered)
			
		ContractNotification
			restricted
			when (!DeliverableNotification
			and   !MilestoneNotification)
			
		GeneralContractEmailNotification
			restricted
			when (ContractDeliverable not entered
			and   ContractMilestone not entered)
			
		DeliverableNotificationWithAttachment
			restricted
			when (ContractDeliverable entered
			and   DeliverableCommentsWithAttachmentsToEmailRel exists)
			
		MilestoneNotificationWithAttachment
			restricted
			when (ContractMilestone entered
			and   MilestoneCommentsWithAttachmentsToEmailRel exists)
			
		GeneralContractDocumentEmailNotification
			restricted
			when (ContractDocumentRel exists)
		
		GeneralContractEmailNotificationWithAttachment
			restricted
			when (ContractDeliverable not entered
			and   ContractMilestone not entered
			and   ContractCommentAttachmentRel exists)
			
		GeneralContractLineEmailNotificationWithAttachment
			restricted
			when (ContractDeliverable not entered
			and   ContractMilestone not entered
			and   ContractLineCommentAttachmentRel exists)
			
		GeneralContractEmailNotificationWithRegularAttachment
			restricted
			when (ContractDeliverable not entered
			and   ContractMilestone not entered
			and   ContractAttachmentRel exists)
			
		GeneralContractLineEmailNotificationWithRegularAttachment
			restricted
			when (ContractDeliverable not entered
			and   ContractMilestone not entered
			and   ContractLineAttachmentRel exists)
		
		GeneralRedlineContractEmailWithAttachment
			restricted
			when (ContractNotification
			and   RedlineAttachmentRel exists)
		
		IDMGeneralRedlineContractEmailWithAttachment
			restricted
			when (ContractNotification
			and RedlineAttachmentRel exists
			and Contract.UseIDMPerClassificationAndSubClass)
		
		NonIDMGeneralRedlineContractEmailWithAttachment
			restricted
			when (ContractNotification
			and RedlineAttachmentRel exists
			and not Contract.UseIDMPerClassificationAndSubClass)
		
		GeneralAddendumDocumentEmailNotification
			restricted
			when (ContractAddendumRel exists)
		
		IDMGeneralAddendumDocumentEmailNotification
			restricted
			when (Contract.IsUsingIDMTemplate
			and   IDMContractAddendumRel exists)
			
	Relations
		EmailMessageContentEvaluationRel
			one-to-many relation to SupplierPerformanceEvaluation
			Field Mapping uses symbolic key
				related.SupplierGroup					= ContractGroup
		DeliverableCommentsWithAttachmentsToEmailRel
			one-to-many relation to ContractDeliverableComment
			Field Mapping uses part of key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractDeliverable			= ContractDeliverable
			Instance Selection
				where (related.HasAttachmentToEmail)
			
		MilestoneCommentsWithAttachmentsToEmailRel
			one-to-many relation to ContractMilestoneComment
			Field Mapping uses part of key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractMilestone			= ContractMilestone
			Instance Selection
				where (related.HasAttachmentToEmail)
				
		RedlineAttachmentRel 
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.ContractRedlineDocument entered)
				
		ContractDocumentRel
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.LineNumber = 0
				and    related.ForContractDocument) 
		
		ContractCommentAttachmentRel
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.LineNumber = 0
				and    related.SequenceNumber entered
				and   !related.ForContractDocument
				and    related.ContractCommentType entered)
				
		ContractLineCommentAttachmentRel
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where  (related.SequenceNumber entered
				and     related.LineNumber     entered
				and     related.ContractCommentType    entered)
				
		ContractAttachmentRel
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.LineNumber = 0
				and    related.SequenceNumber entered
				and    related.ContractCommentType !entered)
				
		ContractLineAttachmentRel
			one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where  (related.SequenceNumber entered
				and     related.LineNumber     entered
				and     related.ContractCommentType    !entered)

		IDMContractDocumentRel
			one-to-many relation to ContractNotificationEmailAttachment
 		   	Field Mapping uses symbolic key
 		        related.ContractGroup             = ContractGroup
 		        related.Contract                  = Contract
 		        related.ContractDeliverable       = blank
 		        related.ContractMilestone         = blank
 		        related.ContractNotificationEmail = ContractNotificationEmail
     		Instance Selection
         		where (related.IDMUniqueId entered
         		and    not related.ForAddendumDocument)
        
        ContractAddendumRel
        	one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.ForAddendumDocument
				and    related.IDMUniqueId not entered)
		
        IDMContractAddendumRel
        	one-to-many relation to ContractNotificationEmailAttachment
			Field Mapping uses symbolic key
				related.ContractGroup              = ContractGroup
				related.Contract                   = Contract
				related.ContractDeliverable        = blank
				related.ContractMilestone          = blank
				related.ContractNotificationEmail  = ContractNotificationEmail
			Instance Selection
				where (related.ForAddendumDocument
				and    related.IDMUniqueId entered)		 

	Sets
		ByTimeDescending
			duplicates
			Sort Order
				ContractGroup
				Contract
				ContractDeliverable
				ContractMilestone
				SentTimeStamp descending
	
	Actions
		CreateEmail is a Create Action
			restricted
			Exit Rules
				if (MilestoneNotification)
					if (NotificationType.PastDueAlert)
						send email
							to SentToEmailAddress
							cc SentToCc
							bcc SentToBcc
							from SentFromEmailAddress
							subject "<EmailSubjectLine>"
							Attachments
								for each MilestoneCommentsWithAttachmentsToEmailRel
									attachment each.Attachment.File
										name is each.Attachment.Title
										mime type is each.Attachment.MimeType
							Contents
								"<EmailContent>"
					else
						send email
							to SentToEmailAddress
							cc SentToCc
							bcc SentToBcc
							from SentFromEmailAddress
							subject "<EmailSubjectLine>"
							Attachments
								for each MilestoneCommentsWithAttachmentsToEmailRel
									attachment each.Attachment.File
										name is each.Attachment.Title
										mime type is each.Attachment.MimeType
							Contents
								"<EmailContent>"
				else
					if (NotificationType.PastDueAlert)
						send email
							to SentToEmailAddress
							cc SentToCc
							bcc SentToBcc
							from SentFromEmailAddress
							subject "<EmailSubjectLine>"
							Attachments
								for each DeliverableCommentsWithAttachmentsToEmailRel
									attachment each.Attachment.File
										name is each.Attachment.Title
										mime type is each.Attachment.MimeType
							Contents
								"<EmailContent>"
					else
						send email
							to SentToEmailAddress
							cc SentToCc
							bcc SentToBcc
							from SentFromEmailAddress
							subject "<EmailSubjectLine>"
							Attachments
								for each DeliverableCommentsWithAttachmentsToEmailRel
									attachment each.Attachment.File
										name is each.Attachment.Title
										mime type is each.Attachment.MimeType
							Contents
								"<EmailContent>"
				
		CreateImmediateEmail is a Create Action
			restricted
			Exit Rules
				send email
					to SentToEmailAddress
					cc SentToCc
							bcc SentToBcc
					from SentFromEmailAddress
					subject "<EmailSubjectLine>"
					Attachments
						if (IncludeAttachments)
							for each DeliverableCommentsWithAttachmentsToEmailRel
								attachment each.Attachment.File
									name is each.Attachment.Title
									mime type is each.Attachment.MimeType
							for each MilestoneCommentsWithAttachmentsToEmailRel
								attachment each.Attachment.File
									name is each.Attachment.Title
									mime type is each.Attachment.MimeType
					Contents
						"<EmailContent>"

		Create is a Create Action
			restricted
			
		Update is an Update Action
			restricted
			
		Delete is a Delete Action
			restricted
			
		Purge is a Purge Action
			restricted
	
