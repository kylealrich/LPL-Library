ContractTermVersionArticle is a BusinessClass
    owned by po
    prefix is CTVAR

    Patterns

    Ontology
    	symbolic key is ContractTermVersionArticle
    	
    Persistent Fields
    	ContractArticle			is Numeric 8
    	Title      	            is a Description
		HeaderText 	            is Alpha 100
		OriginalHeaderText		is Alpha 100
		DisplayOrder
    
	Transient Fields
		
	Local Fields
		LocalContractTermAndCondition	is Numeric 8

	Derived Fields
		DerivedCompareCurrentAndOriginalHeaderText is a NativeField
			type is RichText


		DerivedOriginalHeaderText is a DerivedField
			type is Alpha 100
			restricted
			if (OriginalContractTermVersionArticleRel exists)
				return first OriginalContractTermVersionArticleRel.HeaderText
			else
				return ""

		DerivedCompareCurrentAndPreviousActivatedHeaderText is a NativeField
			type is RichText


		DerivedPreviousActivatedHeaderText is a DerivedField
			type is Alpha 100
			restricted
			if (PreviousActivatedContractTermVersionArticleRel exists)
				return first PreviousActivatedContractTermVersionArticleRel.HeaderText
			else
				return ""

		DerivedCompareCurrentAndPreviousHeaderText is a NativeField
			type is RichText

		DerivedCompareCurrentAndOriginalActivatedHeaderText is a NativeField
			type is RichText


		DerivedOriginalActivatedHeaderText is a DerivedField
			type is Alpha 100
			restricted
			if (OriginalActivatedContractTermVersionArticleRel exists)
				return first OriginalActivatedContractTermVersionArticleRel.HeaderText
			else
				return ""

    Conditions
		UpdatesExistInAnyPreviousVersion
			restricted
			when (AllPreviousContractArticleUpdateRel exists)
		UpdatesExistsInThisVersion
			restricted
			when (ContractArticleUpdateRel exists)
		AllUpdatesSinceLastActivatedVersion
			restricted
			when (AllUpdatesSinceLastActivatedVersionRel exists)
		AllUpdatesSinceFirstActivatedVersion
			restricted
			when (AllUpdatesSinceFirstActivatedVersionRel exists)
		UpdatesInFirstVersion
			restricted
			when (ContractArticleUpdatesInThisVersionRel exists)

    Relations
    	ContractTermsByDisplayRel 
			one-to-many relation to ContractTermVersionTerm
			delete cascades
			Field Mapping uses ByDisplayOrder 
				related.ContractGroup   			= ContractGroup
				related.Contract        			= Contract
				related.ContractTermVersion			= ContractTermVersion
				related.ContractTermVersionArticle	= ContractTermVersionArticle

		ContractTermVersionRel
			one-to-many relation to ContractTermVersion
			Field Mapping uses symbolic key
				related.ContractGroup		= ContractGroup
				related.Contract			= Contract

    	ArticleInCurrentVersionRel 
			one-to-many relation to ContractTermVersionArticle
			Field Mapping uses ByContractArticle 
				related.ContractGroup   			= ContractGroup
				related.Contract        			= Contract
				related.ContractTermVersion			= last ContractTermVersionRel.ContractTermVersion
				related.ContractArticle				= ContractArticle

    	TermInCurrentVersionRel 
			one-to-many relation to ContractTermVersionTerm
			Field Mapping uses ByContractArticle 
				related.ContractGroup   			= ContractGroup
				related.Contract        			= Contract
				related.ContractTermVersion			= last ContractTermVersionRel.ContractTermVersion
				related.ContractArticle				= ContractArticle
				related.ContractTermAndCondition	= LocalContractTermAndCondition

		ContractTermVersionTermRel is a ContractTermVersionTerm set

		OriginalContractTermVersionArticleRel
			one-to-many relation to ContractTermVersionArticle
			Field Mapping uses symbolic key
				related.ContractGroup		= ContractGroup
				related.Contract			= Contract
				related.ContractTermVersion	= 1
			Instance Selection
				where (related.ContractArticle = ContractArticle)

		PreviousActivatedContractTermVersionArticleRel
			one-to-many relation to ContractTermVersionArticle
			Field Mapping uses symbolic key
				related.ContractGroup		= ContractGroup
				related.Contract			= Contract
				related.ContractTermVersion	= ContractTermVersion.DerivedPreviousActivatedVersionNumber
			Instance Selection
				where (related.ContractArticle = ContractArticle)

		AllPreviousContractArticleUpdateRel
			one-to-many relation to ContractArticleUpdate
			Field Mapping uses symbolic key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractArticle				= ContractArticle
			Instance Selection
				where (related.TermNegotiationVersion <= ContractTermVersion
				and	   related.ChangesMade
				and	   (related.ApprovalStage.SupplierNegotiation
				or		related.ApprovalStage.SupplierAddendumNegotiation))

		ContractArticleUpdateRel
			one-to-many relation to ContractArticleUpdate
			Field Mapping uses symbolic key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractArticle				= ContractArticle
			Instance Selection
				where (related.TermNegotiationVersion = ContractTermVersion
				and	   related.ChangesMade
				and	   (related.ApprovalStage.SupplierNegotiation
				or		related.ApprovalStage.SupplierAddendumNegotiation))

		AllUpdatesSinceLastActivatedVersionRel
			one-to-many relation to ContractArticleUpdate
			Field Mapping uses symbolic key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractArticle				= ContractArticle
			Instance Selection
				where (related.TermNegotiationVersion <= ContractTermVersion
				and	   related.TermNegotiationVersion > ContractTermVersion.DerivedPreviousActivatedVersionNumber
				and	   related.ChangesMade
				and	   (related.ApprovalStage.SupplierNegotiation
				or		related.ApprovalStage.SupplierAddendumNegotiation))

		OriginalActivatedContractTermVersionArticleRel
			one-to-many relation to ContractTermVersionArticle
			Field Mapping uses symbolic key
				related.ContractGroup		= ContractGroup
				related.Contract			= Contract
				related.ContractTermVersion	= ContractTermVersion.DerivedFirstActivatedVersionNumber
			Instance Selection
				where (related.ContractArticle = ContractArticle)

		AllUpdatesSinceFirstActivatedVersionRel
			one-to-many relation to ContractArticleUpdate
			Field Mapping uses symbolic key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractArticle				= ContractArticle
			Instance Selection
				where (related.TermNegotiationVersion <= ContractTermVersion
				and	   related.TermNegotiationVersion > ContractTermVersion.DerivedFirstActivatedVersionNumber
				and	   related.ChangesMade
				and	   (related.ApprovalStage.SupplierNegotiation
				or		related.ApprovalStage.SupplierAddendumNegotiation))

		ContractArticleUpdatesInThisVersionRel
			one-to-many relation to ContractArticleUpdate
			Field Mapping uses symbolic key
				related.ContractGroup				= ContractGroup
				related.Contract					= Contract
				related.ContractArticle				= ContractArticle
			Instance Selection
				where (related.TermNegotiationVersion = ContractTermVersion
				and	   related.ChangesApproved)

    Sets
    	ByDisplayOrder
			duplicates
			Sort Order
				ContractGroup
				Contract
				ContractTermVersion
				DisplayOrder
				ContractTermVersionArticle

		ByContractArticle
			Sort Order
				ContractGroup
				Contract
				ContractTermVersion
				ContractArticle
				ContractTermVersionArticle

    Field Rules
	
	Attach Rules
				
	Actions
    	CreateDeletedTerms is an Instance Action
    		restricted
			Local Fields
				LocalContractTermVersionArticle	is a ContractTermVersionArticle view

			Action Rules
				if (!ArticleInCurrentVersionRel exists)		
					invoke Create ContractTermVersionArticle
						assign result to LocalContractTermVersionArticle
						invoked.ContractGroup				= ContractGroup
						invoked.Contract					= Contract
						invoked.ContractTermVersion 		= last ContractTermVersionRel.ContractTermVersion
						invoked.ContractArticle				= ContractArticle
						invoked.Title						= ""
						invoked.HeaderText					= ""
						invoked.DisplayOrder				= DisplayOrder
				else
					LocalContractTermVersionArticle = ContractTermVersionArticle
				for each ContractTermVersionTermRel
					LocalContractTermAndCondition = each.ContractTermAndCondition
					if (!TermInCurrentVersionRel exists)
						invoke Create ContractTermVersionTerm
							invoked.ContractGroup 				= ContractGroup
							invoked.Contract 					= Contract
							invoked.ContractTermVersion 		= last ContractTermVersionRel.ContractTermVersion
							invoked.ContractTermVersionArticle 	= LocalContractTermVersionArticle.ContractTermVersionArticle
							invoked.ContractArticle				= ContractArticle
							invoked.ContractTermAndCondition	= each.ContractTermAndCondition
							invoked.Title						= ""
							invoked.HeaderText					= ""
							invoked.Description					= ""
							invoked.DisplayOrder				= each.DisplayOrder					

		Create is a Create Action
			restricted
		
		Update is an Update Action
			restricted
		
		Delete is a Delete Action
			restricted
