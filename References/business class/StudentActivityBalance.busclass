StudentActivityBalance is a BusinessClass
    owned by studentactivities
    prefix is SAAB

    Ontology
    	symbolic key is StudentActivityBalance

 	Patterns
		implements ContextualParent
 		implements DynamicCreation

    Persistent Fields
		StudentActivityType
		ParentStudentActivityAccount	is a StudentActivityAccount
		BeginningBalance				is an InternationalAmount
		PeriodReceipts					is an InternationalAmount
		PeriodDisbursements				is an InternationalAmount
		PeriodTransfers					is an InternationalAmount
		BalanceAdjustment				is an InternationalAmount
		BeginningPostedBalance			is an InternationalAmount
		PostedReceipts					is an InternationalAmount
		PostedDisbursements				is an InternationalAmount
		PostedTransfers					is an InternationalAmount
		PostedBalanceAdjustment			is an InternationalAmount

	Transient Fields
		TransactionCurrencyCode			is a Currency
			derive value from DerivedCurrency

	Local Fields
		LocalBeginningBalanceByType			is an InternationalAmount
		LocalPeriodReceiptsByType			is an InternationalAmount
		LocalPeriodDisbursementsByType		is an InternationalAmount
		LocalPeriodTransfersByType			is an InternationalAmount
		LocalBeginningPostedBalanceByType	is an InternationalAmount
		LocalPostedReceiptsByType			is an InternationalAmount
		LocalPostedDisbursementsByType		is an InternationalAmount
		LocalPostedTransfersByType			is an InternationalAmount
		CalculationComplete					is Boolean

	Derived Fields
		DerivedCurrency is a DerivedField
			type is like Currency
			return StudentActivityDistrict.AccountingEntity.FunctionalCurrency

		PeriodEndingBalance is a DerivedField
			type is like InternationalAmount
			return (BeginningBalance + PeriodReceipts - PeriodDisbursements + PeriodTransfers)

		PostedEndingBalance is a DerivedField
			type is like InternationalAmount
			return (BeginningPostedBalance + PostedReceipts + PostedDisbursements + PostedTransfers)

		BeginningBalanceByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalBeginningBalanceByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalBeginningBalanceByType

		PeriodReceiptsByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPeriodReceiptsByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPeriodReceiptsByType

		PeriodDisbursementsByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPeriodDisbursementsByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPeriodDisbursementsByType

		PeriodTransfersByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPeriodTransfersByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPeriodTransfersByType

		PeriodEndingBalanceByType is a DerivedField
			type is like InternationalAmount
			return (BeginningBalanceByType + PeriodReceiptsByType - PeriodDisbursementsByType + PeriodTransfersByType)

		BeginningPostedBalanceByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalBeginningPostedBalanceByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalBeginningPostedBalanceByType

		PostedReceiptsByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPostedReceiptsByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPostedReceiptsByType

		PostedDisbursementsByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPostedDisbursementsByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPostedDisbursementsByType

		PostedTransfersByType is a DerivedField
			type is like InternationalAmount
			if (CalculationComplete)
				return LocalPostedTransfersByType
			initialize LocalBeginningBalanceByType	
			initialize LocalPeriodReceiptsByType
			initialize LocalPeriodDisbursementsByType
			initialize LocalPeriodTransfersByType
			initialize LocalBeginningPostedBalanceByType
			initialize LocalPostedReceiptsByType
			initialize LocalPostedDisbursementsByType
			initialize LocalPostedTransfersByType
			for each SchoolTypeActivityBalanceDetailRel
				LocalBeginningBalanceByType			+= each.BeginningBalance
				LocalPeriodReceiptsByType			+= each.PeriodReceipts
				LocalPeriodDisbursementsByType		+= each.PeriodDisbursements
				LocalPeriodTransfersByType			+= each.PeriodTransfers
				LocalBeginningPostedBalanceByType	+= each.BeginningPostedBalance
				LocalPostedReceiptsByType			+= each.PostedReceipts
				LocalPostedDisbursementsByType		+= each.PostedDisbursements
				LocalPostedTransfersByType			+= each.PostedTransfers
			CalculationComplete	= true
			return LocalPostedTransfersByType

		PostedEndingBalanceByType is a DerivedField
			type is like InternationalAmount
			return (BeginningPostedBalanceByType + PostedReceiptsByType + PostedDisbursementsByType + PostedTransfersByType)


	Context Fields
		StudentActivitySchoolType

	Sets
		ByActivityType
			duplicates
			Sort Order
				StudentActivityType

		ByDescendingDate
			Sort Order
				StudentActivityDistrict
				StudentActivityAccount
				StudentActivityClosedPeriod	descending

		ByAscendingDate
			Sort Order
				StudentActivityDistrict
				StudentActivityAccount
				StudentActivityClosedPeriod

		ByDistrictDescendingDate
			Sort Order
				StudentActivityDistrict
				StudentActivityClosedPeriod	descending
				StudentActivityAccount

		ByParentActivity
			Sort Order
				StudentActivityDistrict
				StudentActivityClosedPeriod	descending
				ParentStudentActivityAccount
				StudentActivityAccount


	Relations
		PreviousStudentActivityBalanceRel
			one-to-many relation to StudentActivityBalance
			Field Mapping uses ByDescendingDate
				related.StudentActivityDistrict			= StudentActivityDistrict
				related.StudentActivityAccount			= StudentActivityAccount
			Instance Selection
				where (related.StudentActivityClosedPeriod < StudentActivityClosedPeriod)

		NextStudentActivityBalanceRel
			one-to-many relation to StudentActivityBalance
			Field Mapping uses ByDescendingDate
				related.StudentActivityDistrict			= StudentActivityDistrict
				related.StudentActivityAccount			= StudentActivityAccount
			Instance Selection
				where (related.StudentActivityClosedPeriod > StudentActivityClosedPeriod)

		StudentActivityBalanceDetailRel
			one-to-many relation to StudentActivityBalanceDetail
			Field Mapping uses symbolic key
				related.StudentActivityDistrict			= StudentActivityDistrict

				related.StudentActivityClosedPeriod		= StudentActivityClosedPeriod


			Instance Selection
				where (related.StudentActivityAccount	= StudentActivityAccount)

		SchoolsForTypeRel
			one-to-many relation to StudentActivitySchool
			Field Mapping uses BySchoolType
				related.StudentActivityDistrict		= StudentActivityDistrict
				related.StudentActivitySchoolType	= StudentActivitySchoolType

		SchoolTypeActivityBalanceDetailRel
			one-to-many relation to StudentActivityBalanceDetail
			Field Mapping uses ByActivityType
				related.StudentActivityDistrict			= StudentActivityDistrict
				related.StudentActivityClosedPeriod		= StudentActivityClosedPeriod
				related.StudentActivityType				= StudentActivityType
				related.StudentActivityAccount			= StudentActivityAccount
			Instance Selection
				where (related.StudentActivitySchool	= any SchoolsForTypeRel.StudentActivitySchool)
	
		StudentActivityReceiptDetailRel
			one-to-many relation to StudentActivityReceiptDetail
			Field Mapping uses ByClosedPeriod		
				related.StudentActivityDistrict							= StudentActivityDistrict
				related.ClosedPeriod									= StudentActivityClosedPeriod
				related.SchoolActivityAccount.StudentActivityAccount	= StudentActivityAccount
			
		StudentActivityBankReceiptDetailRel
			one-to-many relation to StudentActivityBankTransDetail
			Field Mapping uses ByClosedPeriod		
				related.StudentActivityDistrict							= StudentActivityDistrict
				related.ClosedPeriod									= StudentActivityClosedPeriod
				related.SchoolActivityAccount.StudentActivityAccount	= StudentActivityAccount
			Instance Selection
				where (!related.BankTransactionType.Transfer
				and     related.StudentActivityBankTransaction.AmountType.BankCredit)

		StudentActivityDisbursementDetailRel
			one-to-many relation to StudentActivityBankTransDetail
			Field Mapping uses ByClosedPeriod		
				related.StudentActivityDistrict							= StudentActivityDistrict
				related.ClosedPeriod									= StudentActivityClosedPeriod
				related.SchoolActivityAccount.StudentActivityAccount	= StudentActivityAccount
			Instance Selection
				where (!related.BankTransactionType.Transfer
				and     related.StudentActivityBankTransaction.AmountType.BankDebit)
			
		StudentActivityTransferDetailRel
			one-to-many relation to StudentActivityTransferDetail
			Field Mapping uses ByClosedPeriod		
				related.StudentActivityDistrict							= StudentActivityDistrict
				related.ClosedPeriod									= StudentActivityClosedPeriod
				related.SchoolActivityAccount.StudentActivityAccount	= StudentActivityAccount
			
		StudentActivityBankTransferDetailRel
			one-to-many relation to StudentActivityBankTransDetail
			Field Mapping uses ByClosedPeriod		
				related.StudentActivityDistrict							= StudentActivityDistrict
				related.ClosedPeriod									= StudentActivityClosedPeriod
				related.SchoolActivityAccount.StudentActivityAccount	= StudentActivityAccount
			Instance Selection
				where (related.BankTransactionType.Transfer)


	Conditions
		HasPostedBalances
			when (BeginningPostedBalance	entered
			or    PostedReceipts			entered
			or    PostedDisbursements		entered
			or    PostedTransfers			entered)

		HasBalancesByType
			when (BeginningBalanceByType	entered
			or    PeriodReceiptsByType		entered
			or    PeriodDisbursementsByType	entered
			or    PeriodTransfersByType		entered)

		HasPostedBalancesByType
			when (BeginningPostedBalanceByType	entered
			or    PostedReceiptsByType			entered
			or    PostedDisbursementsByType		entered
			or    PostedTransfersByType			entered)

		HasBalanceAdjustment
			when (BalanceAdjustment		entered
			and   PreviousStudentActivityBalanceRel exists)
			
		HasPostedBalanceAdjustment
			when (PostedBalanceAdjustment	entered
			and   PreviousStudentActivityBalanceRel exists)

		HasReceiptDetails
			when (StudentActivityReceiptDetailRel exists)
			
		HasBankReceiptDetails	
			when (StudentActivityBankReceiptDetailRel exists)

		HasDisbursementDetails
			when (StudentActivityDisbursementDetailRel exists)
			
		HasTransferDetails
			when (StudentActivityTransferDetailRel exists)
		
		HasBankTransferDetails
			when (StudentActivityBankTransferDetailRel exists)

		HasTransactionDetails
			when (HasReceiptDetails
			or    HasBankReceiptDetails
			or    HasDisbursementDetails
			or    HasTransferDetails
			or    HasBankTransferDetails)


		PostingActivity
			when (StudentActivityAccount.GLAccount entered)
		
			
	Field Rules
 		StudentActivityType
 			default to StudentActivityAccount.StudentActivityType
		
		BeginningBalance
			BeginningBalance = (first PreviousStudentActivityBalanceRel.PeriodEndingBalance + BalanceAdjustment)

		BeginningPostedBalance
			BeginningPostedBalance	= (first PreviousStudentActivityBalanceRel.PostedEndingBalance + PostedBalanceAdjustment)

		ParentStudentActivityAccount
			default to StudentActivityAccount.ParentStudentActivityAccount

						
	Actions

		RebuildAdjustedBeginningBalance is an Instance Action
			Action Rules
				BalanceAdjustment		= sum StudentActivityBalanceDetailRel.BalanceAdjustment
				PostedBalanceAdjustment	= sum StudentActivityBalanceDetailRel.PostedBalanceAdjustment
			Exit Rules
				if (NextStudentActivityBalanceRel exists)
					invoke Update last NextStudentActivityBalanceRel		
				
  		DeleteIfNoDetailsExist is an Instance Action
  			restricted
  			Action Rules
  				if (!StudentActivityBalanceDetailRel exists)
  					invoke Delete
		
		Create is a Create Action
			restricted
			Exit Rules
				if (NextStudentActivityBalanceRel exists)
					invoke Update last NextStudentActivityBalanceRel		
			
		Update is an Update Action
			restricted
			Exit Rules
				if (NextStudentActivityBalanceRel exists)
					invoke Update last NextStudentActivityBalanceRel		

		Delete is a Delete Action
			restricted							
