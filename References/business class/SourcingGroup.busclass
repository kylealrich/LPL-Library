SourcingGroup is a BusinessClass
	owned by ss
	prefix is SGRP

	Ontology
		symbolic key is SourcingGroup

	Patterns
		implements Proxy for SourcingGroupExtension

	Persistent Fields
		Description
		EventApprovalRequired			is Boolean
		AmendmentApprovalRequired		is Boolean
		AwardApprovalRequired			is Boolean
		DisputePeriod					is Boolean
		AmendmentCriteria
		LastSourcingTemplate			is Numeric size 8
			disable Auditing
		LastSourcingEvent				is Numeric size 8
			disable Auditing
		HeaderResponseText				is Alpha size 250
		QuestionResponseText			is Alpha size 250
		AttachmentResponseText			is Alpha size 250
		LineResponseText				is Alpha size 250
		LineQuestionResponseText		is Alpha size 250
		BidBondText						is Alpha size 250
		SendEventAvailableEmail			is Boolean
		CreateEventAvailableMessage		is Boolean
		SendAmendedEmail				is Boolean
		CreateAmendedMessage			is Boolean
		SendCanceledEmail				is Boolean
		CreateCanceledMessage			is Boolean
		SendSuspendedEmail              is Boolean
		CreateSuspendedMessage          is Boolean
		SendLineCanceledEmail			is Boolean
		CreateLineCanceledMessage		is Boolean
		SendQAndAAnsweredEmail			is Boolean
		CreateQAndAAnsweredMessage		is Boolean
		SendAwardedEmail				is Boolean
		CreateAwardedMessage            is Boolean
		SendOutputEmail					is Boolean
		CreateOutputMessage             is Boolean
		SendBestAndFinalYesEmail        is Boolean
		CreateBestAndFinalYesMessage    is Boolean
		SendBestAndFinalNoEmail         is Boolean
		CreateBestAndFinalNoMessage     is Boolean
		SendStepTwoYesEmail             is Boolean
		CreateStepTwoYesMessage         is Boolean
		SendStepTwoNoEmail              is Boolean
		CreateStepTwoNoMessage          is Boolean
		SendPendingEmail                is Boolean
		CreatePendingMessage            is Boolean
		EventEmailSubject               is Alpha size 100
			Text Variables
				Event					value is SourcingEvent
				EventName               value is SourcingEvent.Name
				EventOpenDate           value is SourcingEvent.OpenDate
		EventEmailContent				is RichText
			Text Variables
				Event					value is SourcingEvent
				EventName               value is SourcingEvent.Name
				EventOpenDate           value is SourcingEvent.OpenDate
				EventCloseDate          value is SourcingEvent.CloseDate
				EventPreviewDate        value is SourcingEvent.PreviewDate
		AmendmentEmailSubject           is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		AmendmentEmailContent			is RichText
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		CancelEmailSubject              is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		CancelEmailContent				is RichText
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		SuspendEmailSubject              is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		SuspendEmailContent				is RichText
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		AwardEmailSubject               is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		AwardEmailContent				is RichText
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		OutputEmailSubject              is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		OutputEmailContent				is RichText
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		QANDAEmailSubject				is Alpha size 100
			Text Variables
				Event                   value is SourcingEvent
				EventName               value is SourcingEvent.Name
		QANDAEmailContent				is RichText
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		BuyerQANDAEmailSubject			is Alpha size 100
			Text Variables
				Event				value is SourcingEvent
				EventName			value is SourcingEvent.Name
				Supplier			value is Supplier
				SupplierContactName	value is SupplierSourceId.MainContact.FirstAndLastName
		BuyerQANDAEmailContent			is RichText
			Text Variables
				Event				value is SourcingEvent
				EventName			value is SourcingEvent.Name
				Supplier			value is Supplier
				SupplierContactName	value is SupplierSourceId.MainContact.FirstAndLastName
		NeedsApprovalEmailSubject		is Alpha size 100
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		NeedsApprovalEmailContent		is RichText
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		RejectedEmailSubject			is Alpha size 100
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		RejectedEmailContent			is RichText
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		DisapprovedEmailSubject			is Alpha size 100
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		DisapprovedEmailContent			is RichText
			Text Variables
				Event		value is SourcingEvent
				EventName	value is SourcingEvent.Name
		ApproverEmailAddress			is an EmailAddress 
			holds pii
		SendToAwardedOnly				is Boolean
		ConsolidateEmails				is Boolean
		OnlyNotifyResponders			is Boolean
		PostingOptions
		RequireNonAwardReason			is Boolean
		RecentlyFinalizeDay				is Numeric size 6
		YellowAlert						is Numeric size 6
		RedAlert						is Numeric size 6
		NegotiationText					is Alpha size 250
		AllowTermsToBeNegotiated		is Boolean
		ReportLogo						is an Attachment
		ChangeCloseDateWithResponses	is Numeric 1
			default label is "WhenCloseDateCanBeChangedToLaterForSealedBids"
			States
				Always				 		value is 0 
               	IfNoResponsesExist          value is 1 
               	Never                       value is 2
		CloseDateChangeNonSealedEarlier is Numeric 1
			default label is "WhenCloseDateCanBeChangedToEarlierForNonSealedBids"
			States
				Always				 		value is 0 
               	IfNoResponsesExist          value is 1 
               	Never                       value is 2
		CloseDateChangeNonSealedLater   is Numeric 1
			default label is "WhenCloseDateCanBeChangedToLaterForNonSealedBids"		
			States
				Always				 		value is 0 
               	IfNoResponsesExist          value is 1 
               	Never                       value is 2
		CloseDateChangeSealedEarlier    is Numeric 1      
			default label is "WhenCloseDateCanBeChangedToEarlierForSealedBids"		
			States
				Always				 		value is 0 
               	IfNoResponsesExist          value is 1 
               	Never                       value is 2
		ValidatedSuppliersForEvent		is Boolean
		IncompleteBuyerScoringEdit
		UseCommentsForEventLineDesc		is Boolean
		VendorItemProcessing
		VendorItemDescriptionRequired	is Boolean
		DeliveryDateResponseRequired	is Boolean
			default label is "RequireSupplierToEnterDeliveryDateWhenRespondingToLinesWithPOOutput"
		WizardForTerms					is Boolean
		WizardForAttachments			is Boolean
		WizardForMeetings				is Boolean
		WizardForQuestions				is Boolean
		WizardForContacts				is Boolean
		WizardForWeighting				is Boolean
		ShowResponsesViewed             is Boolean
			default label is "ShowResponsesNotViewedOnAnalysisForm"
		BuyerCanAddCommodityCode		is Boolean
		CommodityCodeEmail				is an EmailAddress 
			holds pii
		CanRequestResponseModification  is Boolean		
		CanAlwaysCreateEventAttachment  is Boolean
			default label is "AllowEventAndEventLineAttachmentsAfterEventClosed"
		EmailAddressOption				is Numeric size 1
			States
				UseBuyerEmailAddress	value is 0
				UseCompanyEmailAddress	value is 1
		EventEmailAddress				is an EmailAddress
	Context Fields
		SourcingEvent
		Supplier
		SupplierSourceId
	
	Local Fields
		LocalSourcingGroup  is a SourcingGroup
	
	Field Rules
		Description
			required

		LastSourcingTemplate
			constraint (LastSourcingTemplate >= 90000000)
				"LastEventTemplateMustBeGreaterThan90000000"
   		SendCanceledEmail
   			if (SendAmendedEmail
   			and AmendmentCriteria.CancelSourcingEvent)
   				constraint (!SendCanceledEmail)
   					"CannotSendSeparateCanceledEmailWhenSendAmendmentEmailIsSelectedAndEventCancelCreatesAnAmendment"
   		SendLineCanceledEmail
   			if (SendAmendedEmail
   			and AmendmentCriteria.CancelSourcingEventLine)
   				constraint (!SendLineCanceledEmail)
   					"CannotSendSeparateLineCanceledEmailWhenSendAmendmentEmailIsSelectedAndEventLineCancelCreatesAnAmendment"
   		CreateCanceledMessage
   			if (CreateAmendedMessage
   			and AmendmentCriteria.CancelSourcingEvent)
   				constraint (!CreateCanceledMessage)
   					"CannotCreateSeparateCanceledMessageWhenCreateAmendmentMessageIsSelectedAndEventCancelCreatesAnAmendment"
   		CreateLineCanceledMessage
   			if (CreateAmendedMessage
   			and AmendmentCriteria.CancelSourcingEventLine)
				constraint (!CreateLineCanceledMessage)
					"CannotCreateSeparateLineCanceledMessageWhenCreateAmendmentMessageIsSelectedAndEventLineCancelCreatesAnAmendment"

		HeaderResponseText
			initial value is "Read the Terms and Conditions for this event."
			default to "Read the Terms and Conditions for this event."

		QuestionResponseText
			initial value is "Respond to the questions for this event. An * indicates a required field."
			default to "Respond to the questions for this event. An * indicates a required field."

		AttachmentResponseText
			initial value is "Attach any documents, specifications, and pictures you have for this event."
			default to "Attach any documents, specifications, and pictures you have for this event."

		LineResponseText
			initial value is "Respond to at least one event line. Response values can be entered directly on list."
			default to "Respond to at least one event line. Response values can be entered directly on list."

		LineQuestionResponseText
			initial value is "Respond to the questions for this event line. An * indicates a required field."
			default to "Respond to the questions for this event line. An * indicates a required field."  

		BidBondText
			initial value is "Enter a Bid Bond ID if you have received one. Otherwise, a paper bid bond is required. You may attach a paper bid bond here, but a hard copy will also be required."
			default to "Enter a Bid Bond ID if you have received one. Otherwise, a paper bid bond is required. You may attach a paper bid bond here, but a hard copy will also be required."

		SendAmendedEmail
			if (!SendAmendedEmail
			and !CreateAmendedMessage)
				constraint (!OnlyNotifyResponders)
					"SendAmendedmentNotificationsOnlyToRespondingSuppliersCannotBeSetToTrueIfAmendedEmailAndPortalMessageAreBothSetToFalse"

		CreateAmendedMessage
			if (!CreateAmendedMessage
			and !SendAmendedEmail)
				constraint (!OnlyNotifyResponders)
					"SendAmendedmentNotificationsOnlyToRespondingSuppliersCannotBeSetToTrueIfAmendedEmailAndPortalMessageAreBothSetToFalse"

		OnlyNotifyResponders
			if (!CreateAmendedMessage
			and !SendAmendedEmail)
				constraint (!OnlyNotifyResponders)
					"SendAmendedmentNotificationsOnlyToRespondingSuppliersCannotBeSetToTrueIfAmendedEmailAndPortalMessageAreBothSetToFalse"
   		EventEmailSubject
   			initial value is "Bidding opportunity: Event #{Event} is or will be available for response"
   			default to "Bidding opportunity: Event #{Event} is or will be available for response"
   		EventEmailContent
			initial value is "<p>Event: {Event}- {EventName} has been created that matches a commodity code you selected." 
			default to  "<p>Event: {Event}- {EventName} has been created that matches a commodity code you selected."
		AmendmentEmailSubject
			initial value is "Event: {Event} has been amended"
			default to "Event: {Event} has been amended"
		AmendmentEmailContent
			initial value is "This event has been modified and an amendment has been created. If you responded to this event, review the details to determine how they affect your response."
			default to "This event has been modified and an amendment has been created. If you responded to this event, review the details to determine how they affect your response."
		CancelEmailSubject
			initial value is "One or more lines on event: {Event} have been cancelled"
			default to "One or more lines on event: {Event} have been cancelled"
		CancelEmailContent
			initial value is "Lines have been cancelled on this event. Log in to the supplier portal to review this event."
			default to "Lines have been cancelled on this event. Log in to the supplier portal to review this event."
		SuspendEmailSubject
			initial value is "Event {Event} has been suspended"
			default to "Event {Event} has been suspended"
		SuspendEmailContent
			initial value is "This event has been suspended. Log in to the supplier portal to review this event. The event may be reinstated in the future."
			default to "This event has been suspended. Log in to the supplier portal to review this event. The event may be reinstated in the future."
		AwardEmailSubject
			initial value is "Event: {Event} has been awarded"
			default to "Event: {Event} has been awarded"
		AwardEmailContent
			initial value is "The bid process has been completed and lines on this event have been awarded. Log in to the supplier portal to review the award details for this event." 
			default to "The bid process has been completed and lines on this event have been awarded. Log in to the supplier portal to review the award details for this event."

		OutputEmailSubject
			initial value is "Event: {Event} has been processed"
			default to "Event: {Event} has been processed"

		OutputEmailContent
			initial value is "Thank you for participating in the bid process. We have completed processing the award and will send you the proper documentation."
			default to "Thank you for participating in the bid process. We have completed processing the award and will send you the proper documentation."

		QANDAEmailSubject
			initial value is "Response to your question for event: {Event}"
			default to "Response to your question for event: {Event}"

		QANDAEmailContent
			initial value is "Your question has been answered. Please review the response."
			default to "Your question has been answered. Please review the response."

		BuyerQANDAEmailSubject
			initial value is "A question for event: {Event} has been submitted from supplier {Supplier}- {SupplierContactName}"
			default to "A question for event: {Event} has been submitted from supplier {Supplier}- {SupplierContactName}"

		BuyerQANDAEmailContent
			initial value is "{SupplierContactName} has submitted the following question."
			default to "{SupplierContactName} has submitted the following question."

		NeedsApprovalEmailSubject
			initial value is "Event: {Event} needs approval"
			default to "Event: {Event} needs approval"

		NeedsApprovalEmailContent
			initial value is "Event: {Event} requires your approval."
			default to "Event: {Event} requires your approval."

		RejectedEmailSubject
			initial value is "Event: {Event} has been rejected"
			default to "Event: {Event} has been rejected"

		RejectedEmailContent
			initial value is "Event: {Event} has been rejected."
			default to "Event: {Event} has been rejected."

		DisapprovedEmailSubject
			initial value is "Event: {Event} has been disapproved"
			default to "Event: {Event} has been disapproved"

		DisapprovedEmailContent
			initial value is "Event: {Event} has been disapproved- please make necessary changes and submit."
			default to "Event: {Event} has been disapproved- please make necessary changes and submit."

		ApproverEmailAddress
			if (EventApprovalRequired
			or  AwardApprovalRequired)
				required

		PostingOptions
			required

		RecentlyFinalizeDay
			default to 30

		YellowAlert
			if (YellowAlert entered)
				constraint (YellowAlert >= 0)
					"CannotEnterNegativeDaysInYellowAlert"
				constraint (RedAlert entered)
					"MustEnterRedAlertNumberOfDays"
				constraint (YellowAlert > RedAlert)
					"YellowAlertNumberOfDaysMustBeGreaterThanRedAlertNumberOfDays"

		RedAlert
			if (RedAlert entered)
				constraint (RedAlert >= 0)
					"CannotEnterNegativeDaysInRedAlert"
				constraint (YellowAlert entered)
					"MustEnterYellowAlertNumberOfDays"
				constraint (RedAlert < YellowAlert)
					"YellowAlertNumberOfDaysMustBeGreaterThanRedAlertNumberOfDays"

		NegotiationText
			default to "You have chosen to negotiate the terms on this event. Please enter comments and/or an attachment defining the terms you dispute."
			initial value is "You have chosen to negotiate the terms on this event. Please enter comments and/or an attachment defining the terms you dispute."

		EventEmailAddress
			if (EventEmailAddress entered
			and EmailAddressOption = 0)
				initialize EventEmailAddress
			if (!EventEmailAddress entered)
				constraint (EmailAddressOption.UseBuyerEmailAddress)
					"MustEnterCompanyEmailAddress"
		
		EmailAddressOption
			if (EmailAddressOption = 0)
				initialize EventEmailAddress
		CommodityCodeEmail
			if (!BuyerCanAddCommodityCode)
				initialize

	Derived Fields
		ActorBusinessGroup is a DerivedField
			type is like BusinessGroup
			return actor.context.BusinessGroup

	Conditions
		HasReportLogo
			restricted
			when (ReportLogo entered)
		HasCompaniesSendingPendingMessages
			restricted
			when (SourcingCompanyUsingPendingMessagesRel exists)

		BusinessGroupAllowsAccess
			when ((actor.context.BusinessGroup != ""
			and	   actor.context.BusinessGroup = SourcingGroup)
			or	  (actor.context.BusinessGroup = ""))
			
	Relations

		ProcurementGroupRel
			one-to-one relation to ProcurementGroup
			Field Mapping uses symbolic key
				related.ProcurementGroup = SourcingGroup
		
		ItemGroupRel
			one-to-one relation to ItemGroup
			Field Mapping uses symbolic key
				related.ItemGroup = SourcingGroup
		
		SupplierGroupRel
			one-to-one relation to SupplierGroup
			Field Mapping uses symbolic key
				related.SupplierGroup = SourcingGroup
		
		SourcingCompanyUsingPendingMessagesRel
			one-to-many relation to SourcingCompany
			Field Mapping uses BySourcingGroup
				related.SourcingGroup = LocalSourcingGroup
			Instance Selection
				where (related.SourcingCompanyExtension.SendPendingEmail
				or     related.SourcingCompanyExtension.CreatePendingMessage)
		
		SourcingCompanyRel is a SourcingCompany set
		
		SourcingGroupExtension
			one-to-one relation to SourcingGroupExtension
			Field Mapping uses symbolic key
				related.SourcingGroup   = SourcingGroup
				
	Actions
		Create is a Create Action
		
			Field Rules
			
				SendEventAvailableEmail			
					default to true
				CreateEventAvailableMessage     
					default to true
				SendAmendedEmail				
					default to true
				CreateAmendedMessage            
					default to true
				SendCanceledEmail
					if (AmendmentCriteria.CancelSourcingEvent = false)				
						default to true
				CreateCanceledMessage
					if (AmendmentCriteria.CancelSourcingEvent = false)	           
						default to true
				SendLineCanceledEmail			
					if (AmendmentCriteria.CancelSourcingEventLine = false)
						default to true
				CreateLineCanceledMessage       
					if (AmendmentCriteria.CancelSourcingEventLine = false)
						default to true
				SendQAndAAnsweredEmail			
					default to true
				CreateQAndAAnsweredMessage      
					default to true
				SendAwardedEmail				
					default to true
				CreateAwardedMessage            
					default to true
				SendBestAndFinalYesEmail
					default to true
				CreateBestAndFinalYesMessage
					default to true
				SendStepTwoYesEmail
					default to true
				CreateStepTwoYesMessage
					default to true
				ChangeCloseDateWithResponses
					default to 2
				CloseDateChangeSealedEarlier
					default to 2					
				  			
		Update is an Update Action
		
			Exit Rules
				if (first SourcingCompany set.EventEmailSubject !entered)
			 		invoke Update SourcingCompany set
		
		SetTemplate is an Update Action
			restricted
			Action Rules
				LastSourcingTemplate = 90000000
		
		Delete is a Delete Action
		
		NotifySuppliersOfUnsubmittedAndMissingResponses is a Set Action
			Parameters
				ParmSourcingGroup        is a SourcingGroup
				DaysToCloseDate          is Numeric size 3
				NotifyUnsubmitted        is Boolean
				NotifyMissing            is Boolean
				NotifyMissingNoCloseDate is Boolean
				DaysSinceRelease         is Numeric size 3
				
			Instance Selection
			
				where (SourcingGroup = ParmSourcingGroup)
			
			Parameter Rules
				ParmSourcingGroup
					required
					
					LocalSourcingGroup = ParmSourcingGroup
					constraint (HasCompaniesSendingPendingMessages)
						"AtLeastOneCompanyForSourcingGroupMustHave_'UnsubmittedOrMissingResponsesOnAnEvent'_EitherSendingEmailOrCreatingMessages"
					
					if (!NotifyUnsubmitted
					and !NotifyMissing)
						constraint (NotifyMissingNoCloseDate)
							"MustEnterAtLeastOneOfUnsubmitted,NotCreatedResponses,OrNoCloseDateOptions"
							
				NotifyMissing
					if (DaysToCloseDate entered)
						NotifyMissing = true
				
				DaysToCloseDate
					if (NotifyMissing)
						required
							"NumberOfDaysAheadOfCloseDateIsRequiredForOptionChosen"
					constraint (DaysToCloseDate > 0)
						"MustEnterAPositiveNumberOfDaysAheadOfCloseDate"
						
				NotifyMissingNoCloseDate
					if (DaysSinceRelease entered)
						NotifyMissingNoCloseDate = true
						
				DaysSinceRelease
					if (NotifyMissingNoCloseDate)
						required 
							"NumberOfDaysSinceEventReleaseIsRequiredForOptionChosen"
					constraint (DaysSinceRelease > 0)
						"MustEnterAPositiveNumberOfDaysSinceRelease"
						
			Action Rules
				
				Instance Rules
				
					if (NotifyUnsubmitted)
						invoke NotifyPendingResponses SourcingEventResponse
							invoked.ParmSourcingGroup     = ParmSourcingGroup
					
					if (NotifyMissing)
						invoke NotifyMissingResponses SourcingEvent
							invoked.SourcingGroup     = ParmSourcingGroup
							invoked.DaysToCloseDate   = DaysToCloseDate
							
					if (NotifyMissingNoCloseDate)
						invoke NotifyMissingResponsesNoClose SourcingEvent
							invoked.SourcingGroup     = ParmSourcingGroup
							invoked.DaysSinceRelease  = DaysSinceRelease
			
		
