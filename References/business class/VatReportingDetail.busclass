VatReportingDetail is a BusinessClass
    owned by tx
    prefix is TVD
    classic name is TXVATRPTDT

    Ontology
        symbolic key is VatReportingDetail
            classic set name is TVDSET1


            classic name for VatReportingDetail.VATSummarySequense is SUM-SEQ-NBR
            classic name for VatReportIDForCountry.VatReportID is VAT-RPT-ID

    Patterns
        implements StaticJava
        disable AuditIndex

    Persistent Fields

        VATBoxNumber       is a VatBoxNbr
        EffectOnVatBox     is AlphaUpper size 1 
            classic name is SUMMARY-FLAG
	        States
	            AddToVatBox              value is "+"
	            SubtractFromVatBox       value is "-"

	Transient Fields	 
		SummarizedTaxAmount			is a CurrencyAmount			
			derive value from SummarizedBaseTaxAmt
			
    Local Fields
		LocalBoxBaseTaxAmount			is a CurrencyAmount	
		LocalAddThisSeq					is like VatSeqNbr
		LocalAddingToSummaryLine		is like VatReportingLine

	Derived Fields
		SummarizedBaseTaxAmt is a DerivedField	 			
			type is like InternationalAmount
			restricted
			for each TaxTransactionsForLineRel
				display "[TLC]VatRptDetail-LocalBoxBaseTaxAmount:<LocalBoxBaseTaxAmount>"
	            if (EffectOnVatBox.AddToVatBox)
					if (each.BaseTaxAmount.BaseAmount.EnteredCurrencyAmount entered)
						LocalBoxBaseTaxAmount = LocalBoxBaseTaxAmount + each.BaseTaxAmount.BaseAmount.EnteredCurrencyAmount 
	            else
	            if (EffectOnVatBox.SubtractFromVatBox)
	                LocalBoxBaseTaxAmount = LocalBoxBaseTaxAmount - each.BaseTaxAmount.BaseAmount.EnteredCurrencyAmount
	                 	
			return LocalBoxBaseTaxAmount 
			 	

		DerivedTaxUsageFlag is a DerivedField
			type is AlphaUpper 1
			return VatReportingLineForSummaryRel.TaxUsageIndicator
		DerivedLineNbr is a DerivedField
			type is like VatReportingLine
			return VatReportingDetail.VATSummarySequense
		DerivedLineBoxNbr is a DerivedField
			type is like VatBoxNbr
			return VatReportingLineForSummaryRel.VATBoxNumber	
		DerivedLineTaxTotal is a DerivedField
			type is like InternationalAmount
			return VatReportingLineForSummaryRel.TotalTaxAmount				

												



			
                
    Relations

        VatReportingLineRel
            classic name is TXVATRPTLN
            one-to-one relation to VatReportingLine
            required
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup		      = TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity						  = TaxEntity 	

                related.VatReportIDForCountry.VatReportID = VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode = VatReportIDForCountry.CountryCode

                related.VatReportingLine                  = VatReportingLine

       	VatReportingLineForSummaryRel		
            one-to-one relation to VatReportingLine
            Field Mapping uses symbolic key
 		    	related.FinanceEnterpriseGroup		      = TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity						  = TaxEntity 	

                related.VatReportIDForCountry.VatReportID = VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode = VatReportIDForCountry.CountryCode
                related.VatReportingLine                  = VatReportingDetail.VATSummarySequense


       	VatReportingLineSummaryRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
            Instance Selection
                where (related.TaxUsageIndicator  			= "S")  

       	VatReportingLineTaxCodesRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
            Instance Selection
                where (related.TaxUsageIndicator  			= "T"
                and    related.VATBoxNumber					= VatReportingLineSummaryRel.VATBoxNumber)

        VatReportingLineTaxUsageCodesRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
            Instance Selection
                where (related.TaxUsageIndicator  			= "U"
                and    related.VATBoxNumber					= VatReportingLineSummaryRel.VATBoxNumber)
                
       	VatReportingTaxCodesRel
            one-to-many relation to VatUsageCode
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
			Instance Selection
                where (related.VatReportingLine 		  	= VatReportingLineTaxCodesRel.VatReportingLine)
                
        VatReportingTaxUsageCodesRel
            one-to-many relation to VatUsageCode
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
			Instance Selection
                where (related.VatReportingLine 		  	= VatReportingLineTaxUsageCodesRel.VatReportingLine)

        VatReportingDetailCodesRel
            one-to-many relation to VatReportingDetail

            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode

                related.VatReportingLine                    = VatReportingDetail.VATSummarySequense
      		Instance Selection
                where (related.VATBoxNumber					= VatReportingLineRel.VATBoxNumber)
 
        VatReportingDetailCodesRel2		
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
 		    	related.FinanceEnterpriseGroup		      = TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity						  = TaxEntity 	
                related.VatReportIDForCountry.VatReportID = VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode = VatReportIDForCountry.CountryCode
                related.VatReportingLine                  = VatReportingDetail.VATSummarySequense
            Instance Selection
                where (related.TaxUsageIndicator.Sum
                and    related.VATBoxNumber				  = VATBoxNumber)
           
       	VatReportingDetailCodesRel3		
            one-to-many relation to VatReportingDetail

            Field Mapping uses ByDetailBoxNumber  
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
                related.VATBoxNumber						= VatReportingLineRel.VATBoxNumber			 
                related.VatReportingLine                    = VatReportingDetail.VATSummarySequense		 
                                                             
      	TaxTransactionsForLineRel
            one-to-many relation to TaxTransaction
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 							= VatReportIDForCountry.TaxEntity
   			Instance Selection
                where 	(related.TaxUsageCode not entered
                and      related.TaxCode					= VatReportingTaxCodesRel.VatUsageCode.VatCode						  		 
                or      (related.TaxUsageCode entered
                and      related.TaxUsageCode			    = VatReportingTaxUsageCodesRel.VatUsageCode.VatCode))

              



       	VatReportingLineForSummaryRelX		

            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
 		    	related.FinanceEnterpriseGroup		      	= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity						  	= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
                related.VatReportingLine                  	= VatReportingDetail.VATSummarySequense	
            Instance Selection

                where (related.TaxUsageIndicator.Sum)

        VatReportingDetailCodesRelX		
            one-to-one relation to VatReportingDetail		

            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup					= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity								= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 		= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 		= VatReportIDForCountry.CountryCode
                related.VatReportingLine                    	= VatReportingLineForSummaryRelX.VatReportingLine	
				related.VatReportingDetail.VATSummarySequense   = VatReportingDetail.VATSummarySequense	



        VatReportingDetailCodesRelX1							
            one-to-one relation to VatReportingDetail		 

            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup					= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity								= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 		= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 		= VatReportIDForCountry.CountryCode
                related.VatReportingLine                    	= LocalAddThisSeq			 			
				related.VatReportingDetail.VATSummarySequense   = LocalAddingToSummaryLine   			

                                

    Conditions

		VatBoxIsSummaryType
			restricted
			when (VatReportingLineForSummaryRel.TaxUsageIndicator.Sum)

		DetailsContainThisSummaryLine
			restricted
			when (VatReportingLineForSummaryRelX exist)
		CannotAddSummaryLine	

			when (VatReportingLineForSummaryRelX exist)
		LineAndSummarySeqDifferent
			restricted
			when (VatReportingDetail.VATSummarySequense != VatReportingLine)
 
   	Sets
		ByDetailBoxNumber   
			duplicates
			indexed
			Sort Order
				FinanceEnterpriseGroup
				TaxEntity
				VatReportIDForCountry
				VATBoxNumber
				VatReportingLine
				VatReportingDetail.VATSummarySequense

    Field Rules

		VatReportingDetail
			if (VatReportingDetail.VATSummarySequense entered)
				constraint (VatReportingLineForSummaryRel exists)					
					"ReportingLineSequenceNumberDoesNotExist"	

        EffectOnVatBox
            default to "+"
	 
		VATBoxNumber
			initial value is VatReportingLine.VATBoxNumber

	Actions
        Create is a Create Action
			Entrance Rules
				constraint (LineAndSummarySeqDifferent)	
					"ThisVatBoxCannotSummarizeItself;LineAndSummarySequenceMustBeDifferent"			
				LocalAddThisSeq 		 = VatReportingDetail.VATSummarySequense	
				LocalAddingToSummaryLine = VatReportingLine

				constraint (VatReportingDetailCodesRelX1 not exists) 
					"AttemptingToAddALineSequenceThatThisSummaryLineIsAlreadyIn;CannotAddThisSequenceNumberToThisSummaryLine,<LocalAddThisSeq>;<LocalAddingToSummaryLine>"	






												
        Update is an Update Action
															
        Delete is a Delete Action
			
