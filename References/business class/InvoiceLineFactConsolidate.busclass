InvoiceLineFactConsolidate is a BusinessClass
	owned by procurement
	prefix is ILFCd
	sql name is InvoiceLFConsol
	
	Ontology
		symbolic key is InvoiceLineFactConsolidate

	Patterns
        disable Auditing
        disable EffectiveDated

		implements DynamicCreation

	Persistent Fields
        ConsolidationLevel 			is Numeric size 1
		TotalExtendedAmount			is an InternationalAmount
		TotalInvoiceQuantity		is like Quantity
		OnOffPercent	        	is Percent size 5.2
		TotalOnOffSpend				is an InternationalAmount
		TotalOnOffQuantity			is like Quantity
		LocationCompany				is Numeric 4
		ItemType
		ItemDescription				is Alpha size 30
		ConsolidationDateRange		is a DateRange
		CommodityCode               is a CommCodes
		UNSPSCSegment				is AlphaUpper 2
		UNSPSCFamily				is AlphaUpper 2
		UNSPSCClass 				is AlphaUpper 2
		UNSPSCCommodity				is AlphaUpper 2
		ShipToLocation				is like InventoryLocation
		Buyer						
		ConsolidateUniqueID			is UniqueID
		
	Local Fields
        SpendDimension
   		LocalCompany							is Numeric 4
   		LocalDateRange							is a DateRange
		LocalYear								is Year
		LocalMonth								is Numeric 2
		LocalDay								is Numeric 2
		LocalInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
        LocalNegativeFound                        is Boolean				

	Context Fields
		UNSPSCCode

		InvoiceLineFactCommodityCode
		InvoiceLineFactUNSPSC
						
	Derived Fields
		DerivedEventName is a ConditionalField
			type is Text
			restricted
			if (InvoiceLineFactConsolidate.SpendCategory = 1)
				StringOnContract
			else
			if (InvoiceLineFactConsolidate.SpendCategory = 2)
				StringOffContract
			else
			if (InvoiceLineFactConsolidate.SpendCategory = 3)
				StringNoContract
			else
				StringNoPurchaseOrder
					
		StringOnContract is a MessageField
			restricted
			"OnContract_=_<ComputePercentage>%"
			
		StringOffContract is a MessageField
			restricted
			"OffContract_=__<ComputePercentage>%"
		
		StringNoContract is a MessageField
			restricted
			"NoContract_=_<ComputePercentage>%"

		StringNoPurchaseOrder is a MessageField
			restricted
			"NoPurchaseOrder_=_<ComputePercentage>%"

		NoBuyerExistsMessage is a MessageField
			restricted
			"NoBuyerExists"
		
		BuyerName is a ConditionalField
			type is Alpha size 30
			if (BuyerLevel1Rel exists)
				BuyerLevel1Rel.Buyer.Employee.Name.FamilyName
			else
				NoBuyerExistsMessage
			
		ComputePercentage is a ComputeField
			type is Decimal size 5.2
			restricted
			(OnOffPercent * 100)
			
		StringVariableLevel1 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level1.Value
			
		StringVariableLevel2 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level2.Value
			
		StringVariableLevel3 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level3.Value
			
		StringVariableLevel4 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level4.Value
			
		StringVariableLevel5 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level5.Value
			
		StringVariableLevel6 is a StringField
			type is Alpha size up to 35
			restricted
			InvoiceLineFactConsolidate.Level6.Value
			
        StringLevel2Type is a StringField
            type is Numeric size 2
            InvoiceLineFactConsolidate.Level2.Type
            
        StringLevel3Type is a StringField
            type is Numeric size 2
            InvoiceLineFactConsolidate.Level3.Type
            
        StringLevel4Type is a StringField
            type is Numeric size 2
            InvoiceLineFactConsolidate.Level4.Type
            
        ComputeSpendCategory is a ComputeField
			type is Numeric size 1
			restricted
			(InvoiceLineFactConsolidate.SpendCategory)
			
		DerivedDiversityEventName is a ConditionalField
			type is Alpha size up to 26
			restricted
			if (DiverseCodeLevel1Rel exists)
				StringDiverseCodePercent
			else
				StringNoDiverseCode
					
		StringDiverseCodeAmount is a StringField
			type is Alpha size up to 26
			restricted
			InvoiceLineFactConsolidate.Level1.Value
			" "
			"="
			"  "
			TotalOnOffSpend
			
		StringDiverseCodePercent is a StringField
			type is Alpha size up to 26
			restricted
			StringVariableLevel1
			" "
			"="
			"  "
			DerivedDiversityPercent
			"%"
			
		StringNoDiverseCode is a MessageField
			restricted
			"NoDiversity_=_<DerivedDiversityPercent>%"

		StringDiverseCodePercentComparedToOtherDiverseCodes is a StringField
			type is Alpha size up to 26
			restricted
			StringVariableLevel1
			" "
			"="
			"  "
			DerivedDiversityPercentComparedWithOtherDiversityCodes
			"%"
			
		DerivedTotalSpend is a DerivedField
			type is like InternationalAmount
			restricted
			return (sum InvoiceLineFactConsolidatesForDiversityRel.TotalOnOffSpend)
			
		DerivedTotalSpendWithDiversity is a DerivedField
			type is like InternationalAmount
			restricted
			return (sum InvoiceLineFactConsolidateWithDiversityCodeRel.TotalOnOffSpend)
			
		DerivedDiversityPercentComparedWithOtherDiversityCodes is a ComputeField
			type is Decimal 5.2
			restricted
			((TotalOnOffSpend / DerivedTotalSpendWithDiversity) * 100)
					
		DerivedDiversityPercent is a ComputeField
			type is Decimal 5.2
			restricted
			((TotalOnOffSpend / DerivedTotalSpend) * 100)
			
		StringVariableLevel1Numeric is a StringField
			type is Numeric 4
			restricted
			InvoiceLineFactConsolidate.Level1.Value
			
		StringVariableLevel2Numeric is a StringField
			type is Numeric 4
			restricted
			InvoiceLineFactConsolidate.Level2.Value
			
		OnContractMessage is a MessageField
			restricted
			"OnContract"
			
		OffContractMessage is a MessageField
			restricted
			"OffContract"
			
		NoContractMessage is a MessageField
			restricted
			"NoContract"
		
		ContractLabel is a ConditionalField
			type is Alpha 12
			restricted
			if (OnContract)
				OnContractMessage
			else
			if (OffContract)
				OffContractMessage
			else
				NoContractMessage
				
		ContractsCountLevel5 is a MessageField
			restricted
			"View_(<NumberOfContractsLevel5>)"
				
		ContractsCountLevel3 is a MessageField
			restricted
			"View_(<NumberOfContractsLevel3>)"
				
		ContractsCount is a MessageField
			restricted
			"View_(<NumberOfContracts>)"
				
		DerivedContractsLinkLevel5 is a ConditionalField
			type is Alpha size 20
			restricted
			if (ContractsLinkLevel5)
				ContractsCountLevel5
			else
				blank

		DerivedContractsLinkLevel3 is a ConditionalField
			type is Alpha size 20
			restricted
			if (ContractsLinkLevel3)
				ContractsCountLevel3
			else
				blank

		DerivedContractsLink is a ConditionalField
			type is Alpha size 20
			restricted
			if (ContractsLink)
				ContractsCount
			else
				blank

		NumberOfContractsLevel3 is a ComputeField
			type is Numeric 6
			restricted
			(instance count of ContractItemLineItemLevel3Rel)
		
		NumberOfContractsLevel5 is a ComputeField
			type is Numeric 6
			restricted
			(instance count of ContractItemLineItemLevel5Rel)
		
		NumberOfContracts is a ComputeField
			type is Numeric 6
			restricted
			(instance count of ContractItemLineItemRel)
		
		SupplierVendorName is a ConditionalField
			type is Alpha size 30
			if (SupplierRel exists)
				first SupplierRel.SupplierName
			else
				VendorRel.VendorName
				
		ActiveMessage is a MessageField
			restricted
			"Active"
			
		InactiveMessage is a MessageField
			restricted
			"Inactive"
		
		RequestingLocationActive is a ConditionalField
			type is Text
			restricted
			if (RequestingLocationLevel4Rel.Active)
				ActiveMessage
			else
				InactiveMessage
				
		DerivedSegment is a MessageField
			"<UNSPSCForSegmentRel.ShortDescription>"
				
        DerivedFamily is a MessageField
            "<UNSPSCForFamilyRel.ShortDescription>"
                
        DerivedClass is a MessageField
            "<UNSPSCForClassRel.ShortDescription>"
                
        DerivedCommodity is a MessageField
            "<UNSPSCForCommodityRel.ShortDescription>"
                
   		DerivedItem is a DerivedField
			type is Alpha size up to 35
			if (ItemLevel5)
				return StringVariableLevel5
			else
			if (ItemLevel3)
				return StringVariableLevel3
			else
			if (ItemLevel6)
				return StringVariableLevel6
			else
				return blank
			
		ItemMasterMessage is a MessageField
			restricted
			"ItemMaster"
			
		SpecialMessage is a MessageField
			restricted
			"Special"
			
		ServiceMessage is a MessageField
			restricted
			"Service"
		
		DerivedContractItemType is a ConditionalField
			type is Text
			if (ItemType.Inventoried
			or  ItemType.NonStock)
				ItemMasterMessage
			else
			if (ItemType.Special)
				SpecialMessage
			else
				ServiceMessage
														
		DerivedDateWith0Month0Day is a StringField
			type is Date
			restricted
			LocalYear
			0
			LocalMonth
			0
			LocalDay
			
		DerivedDateWith0Day is a StringField
			type is Date
			restricted
			LocalYear
			LocalMonth
			0
			LocalDay
			
		StringUNSPSCSegment is a StringField
			type is Alpha 2
			restricted
			InvoiceLineFactConsolidate.Level1.Value

		StringUNSPSCFamily is a ConditionalField
			type is Alpha 2
			restricted
			if (InvoiceLineFactConsolidate.Level2.Value not entered)
				"00"
			else
				InvoiceLineFactConsolidate.Level2.Value
			
		StringUNSPSCClass is a ConditionalField
			type is Alpha 2
			restricted
			if (InvoiceLineFactConsolidate.Level3.Value not entered)
				"00"
			else
				InvoiceLineFactConsolidate.Level3.Value
			
		StringUNSPSCCommodity is a ConditionalField
			type is Alpha 2
			restricted
			if (InvoiceLineFactConsolidate.Level4.Value not entered)
				"00"
			else
				InvoiceLineFactConsolidate.Level4.Value
			
		StringUNSPSC is a StringField
			type is Alpha 11
			StringUNSPSCSegment
			"-"
			StringUNSPSCFamily
			"-"
			StringUNSPSCClass
			"-"
			StringUNSPSCCommodity
			
		StringCommodityCodeLevel1 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level1.Value

		StringCommodityCodeLevel2 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level2.Value

		StringCommodityCodeLevel3 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level3.Value

		StringCommodityCodeLevel4 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level4.Value

		StringCommodityCodeLevel5 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level5.Value

		StringCommodityCodeLevel6 is a StringField
			type is Alpha 5
			restricted
			InvoiceLineFactConsolidate.Level6.Value

		StringCommodityCode is a StringField
			type is Alpha 35
			restricted
			StringCommodityCodeLevel1
			"-"
			StringCommodityCodeLevel2
			"-"
			StringCommodityCodeLevel3
			"-"
			StringCommodityCodeLevel4
			"-"
			StringCommodityCodeLevel5
			"-"
			StringCommodityCodeLevel6
			
		DerivedUNSPSCShortDescription is a DerivedField
			type is Alpha size up to 20
			restricted
			display "UNSPSC:<UNSPSCCode>,<UNSPSCCode.ShortDescription>"
			return UNSPSCCode.ShortDescription
			
		DerivedItemLevel is a ConditionalField
			type is Numeric 1
			restricted
			if (ItemLevel3)
				3
			else
			if (ItemLevel5)
				5
			else
			if (ItemLevel6)
				6
			else
				1
			
		DerivedLevel1Type is a ConditionalField
			type is Numeric 2
			restricted
			if (InvoiceLineFactConsolidate.Level1.Value		= "=")
				0
			else
				InvoiceLineFactConsolidate.Level1.Type
				
		DerivedLevel1Value is a ConditionalField
			type is Alpha size 50
			restricted
			if (InvoiceLineFactConsolidate.Level1.Value		= "=")
				blank
			else
				InvoiceLineFactConsolidate.Level1.Value
			
		DerivedLevel2Type is a ConditionalField
			type is Numeric 2
			restricted
			if (InvoiceLineFactConsolidate.Level2.Value		= "=")
				17
			else
				InvoiceLineFactConsolidate.Level2.Type
				
		DerivedLevel2Value is a ConditionalField
			type is Alpha size 50
			restricted
			if (InvoiceLineFactConsolidate.Level2.Value		= "=")
				blank
			else
				InvoiceLineFactConsolidate.Level2.Value
			
		DerivedLevel3Type is a ConditionalField
			type is Numeric 2
			restricted
			if (InvoiceLineFactConsolidate.Level3.Value		= "=")
				18
			else
				InvoiceLineFactConsolidate.Level3.Type
				
		DerivedLevel3Value is a ConditionalField
			type is Alpha size 50
			restricted
			if (InvoiceLineFactConsolidate.Level3.Value		= "=")
				blank
			else
				InvoiceLineFactConsolidate.Level3.Value
			
		DerivedLevel4Type is a ConditionalField
			type is Numeric 2
			restricted
			if (InvoiceLineFactConsolidate.Level4.Value		= "=")
				19
			else
				InvoiceLineFactConsolidate.Level4.Type
				
		DerivedLevel4Value is a ConditionalField
			type is Alpha size 50
			restricted
			if (InvoiceLineFactConsolidate.Level4.Value		= "=")
				blank
			else
				InvoiceLineFactConsolidate.Level4.Value
				
        DerivedLevel5Type is a ConditionalField
            type is Numeric 2
            if (InvoiceLineFactConsolidate.Level5.Value        = "=")
                20
            else
                InvoiceLineFactConsolidate.Level5.Type
                
        DerivedLevel5Value is a ConditionalField
            type is Alpha 50
            if (InvoiceLineFactConsolidate.Level5.Value        = "=")
                blank
            else
                InvoiceLineFactConsolidate.Level5.Value
                
   		DerivedFromDate is a ConditionalField
			type is Date
			restricted
			if (InvoiceLineFactConsolidate.Level1.Type.ProcurementGroup)
				ProcurementGroup.TotalSpendAnalysisFromDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.Buyer)
				ProcurementGroup.BuyerSpendAnalysisFromDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.DiversityCode)
				ProcurementGroup.DiversitySpendAnalysisFromDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.CommodityCodeSegment1)
				ProcurementGroup.CommodityCodeSpendAnalysisFromDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.UNSPSCSegment)
				ProcurementGroup.UNSPSCSpendAnalysisFromDate
			else
				current corporate date
			
		DerivedThruDate is a ConditionalField
			type is Date
			restricted
			if (InvoiceLineFactConsolidate.Level1.Type.ProcurementGroup)
				ProcurementGroup.TotalSpendAnalysisThruDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.Buyer)
				ProcurementGroup.BuyerSpendAnalysisThruDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.DiversityCode)
				ProcurementGroup.DiversitySpendAnalysisThruDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.CommodityCodeSegment1)
				ProcurementGroup.CommodityCodeSpendAnalysisThruDate
			else
			if (InvoiceLineFactConsolidate.Level1.Type.UNSPSCSegment)
				ProcurementGroup.UNSPSCSpendAnalysisThruDate
			else
				current corporate date
				
		ConsolidationDateRangePhrase is a LabelField
			restricted
			"ConsolidationDateRange"

		ConsolidateLastTwelveMonthsPhrase is a LabelField
			restricted
			"'ConsolidateLastTwelveMonths'"

		TotalSpendForProcurementGroup is a DerivedField
			type is like InternationalAmount
			restricted
			return first InvoiceLineFactConsolidatesForProcurementGroupRel.TotalOnOffSpend 
			
		NoCompanyMessage is a MessageField	
			restricted
			"NoCompany"
		
		DerivedCompanyValue is a DerivedField
			type is like Description
			if (InvoiceLineFactConsolidate.Level2.Type.Company)
				if (InvoiceLineFactConsolidate.Level2.Value 	not entered)
					return NoCompanyMessage
				else
					return InvoiceLineFactConsolidate.Level2.Value
						
		NoLocationExistsMessage is a MessageField
			restricted
			"NoLocationExists"
		
		DerivedLocationValue is a DerivedField
			type is like Description
			if (InvoiceLineFactConsolidate.Level3.Type.ShipToLocation)
				if (InvoiceLineFactConsolidate.Level3.Value 	not entered)
					return NoLocationExistsMessage
				else
					return InvoiceLineFactConsolidate.Level3.Value
			else
			if (InvoiceLineFactConsolidate.Level2.Type.ShipToLocation)
				if (InvoiceLineFactConsolidate.Level2.Value 	not entered)
					return NoLocationExistsMessage
				else
					return InvoiceLineFactConsolidate.Level2.Value
						
		DerivedBuyerValue is a DerivedField 
			type is like Name
			holds pii
			if (InvoiceLineFactConsolidate.Level4.Type.Buyer)
				if (InvoiceLineFactConsolidate.Level4.Value 	not entered)
					return NoBuyerExistsMessage
				else
					return InvoiceLineFactConsolidate.Level4.Value
						
		NoRequestingLocationExistsMessage is a MessageField
			restricted
			"NoRequestingLocationExists"
		
		DerivedRequestingLocationValue is a DerivedField
			type is Text
			if (InvoiceLineFactConsolidate.Level4.Type.RequestingLocation)
				if (InvoiceLineFactConsolidate.Level4.Value 	not entered)
					return NoRequestingLocationExistsMessage
				else
					return InvoiceLineFactConsolidate.Level4.Value
			else
			if (InvoiceLineFactConsolidate.Level2.Type.RequestingLocation)
				if (InvoiceLineFactConsolidate.Level2.Value 	not entered)
					return NoRequestingLocationExistsMessage
				else
					return InvoiceLineFactConsolidate.Level2.Value
						
		NoItemExistsMessage is a MessageField
			restricted
			"NoItemExists"
		
		DerivedItemValue is a DerivedField
			type is like Description
			if (InvoiceLineFactConsolidate.Level3.Type.Item)
				if (InvoiceLineFactConsolidate.Level3.Value 	not entered)
					return NoItemExistsMessage
				else
					return InvoiceLineFactConsolidate.Level3.Value
			else
			if (InvoiceLineFactConsolidate.Level5.Type.Item)
				if (InvoiceLineFactConsolidate.Level5.Value 	not entered)
					return NoItemExistsMessage
				else
					return InvoiceLineFactConsolidate.Level5.Value
			else
			if (InvoiceLineFactConsolidate.Level6.Type.Item)
				if (InvoiceLineFactConsolidate.Level6.Value 	not entered)
					return NoItemExistsMessage
				else
					return InvoiceLineFactConsolidate.Level6.Value
						
        DerivedAllPositiveTotalSpendPiePieces is a DerivedField
            type is Boolean
            for each InvoiceLineFactConsolidatesForProcurementGroupRel
                if (TotalExtendedAmount < 0)
                    return false
                    end for each
            return true

        DerivedNegativeTotalSpendPiePiecePhrase is a ConditionalField
            type is Alpha size up to 15
            if (DerivedAllPositiveTotalSpendPiePieces)
                ""
            else 
                DerivedNegativePhrase
                
        DerivedNegativePhrase is a MessageField
            "*Negatives!*"
            
        DerivedAllPositiveBuyerSpendPiePieces is a DerivedField
            type is Boolean
            initialize LocalNegativeFound
            for each InvoiceLineFactConsolidatesBuyerRel
                if (each.TotalExtendedAmount < 0)
                    LocalNegativeFound    = true
                    end for each
            if (LocalNegativeFound)
                return false
            else
                return true
            
        DerivedNegativeBuyerSpendPiePiecePhrase is a ConditionalField
            type is Alpha size up to 15
            if (DerivedAllPositiveBuyerSpendPiePieces)
                ""
            else 
                DerivedNegativePhrase
         
	Conditions
	
		OnContract
			restricted
			when (InvoiceLineFactConsolidate.SpendCategory	= 1)
			
		OffContract
			restricted
			when (InvoiceLineFactConsolidate.SpendCategory	= 2)
	
		NoContract
			restricted
			when (InvoiceLineFactConsolidate.SpendCategory	= 3)
		
		HasInvoiceLinesForItemLevel5
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsForItemLevel5Rel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsForItemLevel5Rel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsForItemLevel5Rel exists))

		HasInvoiceLinesForLocationBuyerItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsByLocationBuyerItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsByLocationBuyerItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsByLocationBuyerItemRel exists))

		HasInvoiceLinesForLocationReqLocItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsByLocationReqLocItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsByLocationReqLocItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsByLocationReqLocItemRel exists))

		HasInvoiceLinesForLocationItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsByBuyerLocItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsByBuyerLocItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsByBuyerLocItemRel exists))

		HasInvoiceLinesForRequestingLocationItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsByBuyerReqLocItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsByBuyerReqLocItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsByBuyerReqLocItemRel exists))

		HasInvoiceLinesForCommCodesItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsForCommCodesItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsForCommCodesItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsForCommCodesItemRel exists))

		HasInvoiceLinesForUNSPSCItem
			restricted
			when ((OnContract
			and    OnContractInvoiceLineFactsForUNSPSCItemRel exists)
			or    (OffContract
			and    OffContractInvoiceLineFactsForUNSPSCItemRel exists)
			or    (NoContract
			and    NoContractInvoiceLineFactsForUNSPSCItemRel exists))

		HasOnContractInvoiceLinesForLocationItem
			restricted
			when (OnContractInvoiceLineFactsByBuyerLocItemRel exists)

		HasOffContractInvoiceLinesForLocationItem
			restricted
			when (OffContractInvoiceLineFactsByBuyerLocItemRel exists)

		HasNoContractInvoiceLinesForLocationItem
			restricted
			when (NoContractInvoiceLineFactsByBuyerLocItemRel exists)

		HasOnContractInvoiceLinesForCommCodesItem
			restricted
			when (OnContractInvoiceLineFactsForCommCodesItemRel exists)

		HasOffContractInvoiceLinesForCommCodesItem
			restricted
			when (OffContractInvoiceLineFactsForCommCodesItemRel exists)

		HasNoContractInvoiceLinesForCommCodesItem
			restricted
			when (NoContractInvoiceLineFactsForCommCodesItemRel exists)

		HasOnContractInvoiceLinesForUNSPSCItem
			restricted
			when (OnContractInvoiceLineFactsForUNSPSCItemRel exists)

		HasOffContractInvoiceLinesForUNSPSCItem
			restricted
			when (OffContractInvoiceLineFactsForUNSPSCItemRel exists)

		HasNoContractInvoiceLinesForUNSPSCItem
			restricted
			when (NoContractInvoiceLineFactsForUNSPSCItemRel exists)

		CompanyLocationBuyerConsolidation
			restricted
			when (InvoiceLineFactConsolidate.Level2.Type.Company
			and   InvoiceLineFactConsolidate.Level3.Type.ShipToLocation
			and   InvoiceLineFactConsolidate.Level4.Type.Buyer)
			
		CompanyLocationReqLocationConsolidation	
			restricted
			when (InvoiceLineFactConsolidate.Level2.Type.Company
			and   InvoiceLineFactConsolidate.Level3.Type.ShipToLocation
			and   InvoiceLineFactConsolidate.Level4.Type.RequestingLocation)
			
		UNSPSCConsolidation
			restricted
			when (InvoiceLineFactConsolidate.Level1.Type.UNSPSCSegment
			and   InvoiceLineFactConsolidate.Level2.Type.UNSPSCFamily
			and   InvoiceLineFactConsolidate.Level3.Type.UNSPSCClass
			and   InvoiceLineFactConsolidate.Level4.Type.UNSPSCCommodity)
			
		BuyerLocationConsolidation
			restricted
			when (InvoiceLineFactConsolidate.Level1.Type.Buyer
			and   InvoiceLineFactConsolidate.Level2.Type.ShipToLocation)
		
		BuyerRequestingLocationConsolidation
			restricted
			when (InvoiceLineFactConsolidate.Level1.Type.Buyer
			and   InvoiceLineFactConsolidate.Level2.Type.RequestingLocation)
		
		CommodityCodeConsolidation
			restricted
			when (InvoiceLineFactConsolidate.Level1.Type.CommodityCodeSegment1)

		ItemValid6
			restricted
			when (ItemmastLevel6Rel exists)
			
		ItemValid3
			restricted
			when (InvoiceLineFactConsolidate.Level1.Type.Buyer
			and   ItemmastLevel3Rel exists)
			
		ItemValid5
			restricted
			when (ItemmastLevel5Rel exists)
		
		ItemLevel5
			restricted
			when (InvoiceLineFactConsolidate.Level5.Type.Item)
			
		ItemLevel3
			restricted
			when (InvoiceLineFactConsolidate.Level3.Type.Item)
			
		ItemLevel6
			restricted
			when (InvoiceLineFactConsolidate.Level6.Type.Item)
					
		ConsolidatePercentRedAlert
			restricted
			when (OnOffPercent > 0.20
			and   OffContract)
			
		ConsolidatePercentYellowAlert
			restricted
			when (OnOffPercent > 0.10
			and   OnOffPercent <= 0.20
			and   OffContract)
			
    	ContractsLinkLevel5
    		restricted
    		when (ContractItemLineItemLevel5Rel exists)

    	ContractsLinkLevel3
    		restricted
    		when (ContractItemLineItemLevel3Rel exists)

    	ContractsLink
    		restricted
    		when (ContractItemLineItemRel exists)

    	ContractsForNegotiationLink
    		restricted
    		when (ContractLinesForNegotiationRel exists)

		HasItemmastUsageContractAmountsForPeriod
			restricted
			when (ItemmastUsageContractAmountsForPeriodRel exists)
						
		HasContractNegotiationsForContracts
			restricted
			when (ContractNegotiationsForContractsRel exists)
			
		FamilyEntered
			restricted
			when (UNSPSCForFamilyRel exists)
			
		ClassEntered
			restricted
			when (UNSPSCForClassRel exists)
			
		CommodityEntered
			restricted
			when (UNSPSCForCommodityRel exists)
			
		UseCommCodesRel
			restricted
			when (InvoiceLineFactConsolidate.Level2.Value 	= "    -"
			or    InvoiceLineFactConsolidate.Level3.Value 	= "    -"
			or    InvoiceLineFactConsolidate.Level4.Value 	= "    -"
			or    InvoiceLineFactConsolidate.Level5.Value 	= "    -")
			
		Level2Entered
			restricted
			when (InvoiceLineFactConsolidate.Level2.Type	!= 0
			and   InvoiceLineFactConsolidate.Level2.Value	entered)
			
		Level3Entered
			restricted
			when (InvoiceLineFactConsolidate.Level3.Type	!= 0
			and   InvoiceLineFactConsolidate.Level3.Value	entered)
			
		Level2NotEntered
			restricted
			when (InvoiceLineFactConsolidate.Level2.Value	not entered)
			
		Level4NotEntered
			restricted
			when (InvoiceLineFactConsolidate.Level4.Value	not entered
			and   InvoiceLineFactConsolidate.TotalExtendedAmount not entered)
			
		Levels2And3And4NotEntered
			restricted
			when (InvoiceLineFactConsolidate.Level2.Value	not entered
			and   InvoiceLineFactConsolidate.Level3.Value   not entered
			and   InvoiceLineFactConsolidate.Level4.Value   not entered
			and   InvoiceLineFactConsolidate.TotalExtendedAmount not entered)
			
		Levels3And4NotEntered
			restricted
			when (InvoiceLineFactConsolidate.Level3.Value	not entered
			and   InvoiceLineFactConsolidate.Level4.Value   not entered
			and   InvoiceLineFactConsolidate.TotalExtendedAmount not entered)
			
        UnspscLevel4NotEntered
            when (InvoiceLineFactConsolidate.Level4.Value    not entered)
            
        UnspscLevels2And3And4NotEntered
            when (InvoiceLineFactConsolidate.Level2.Value    not entered
            and   InvoiceLineFactConsolidate.Level3.Value   not entered
            and   InvoiceLineFactConsolidate.Level4.Value   not entered)
            
        UnspscLevels3And4NotEntered
            when (InvoiceLineFactConsolidate.Level3.Value    not entered
            and   InvoiceLineFactConsolidate.Level4.Value   not entered)
            
        Levels2And3And4And5NotEntered
            when (InvoiceLineFactConsolidate.Level2.Value    not entered
            and   InvoiceLineFactConsolidate.Level3.Value   not entered
            and   InvoiceLineFactConsolidate.Level4.Value   not entered
            and   InvoiceLineFactConsolidate.Level5.Value   not entered)
            
        Levels3And4And5NotEntered
            when (InvoiceLineFactConsolidate.Level3.Value    not entered
            and   InvoiceLineFactConsolidate.Level4.Value   not entered
            and   InvoiceLineFactConsolidate.Level5.Value   not entered)
            
        Levels4And5NotEntered
            when (InvoiceLineFactConsolidate.Level4.Value   not entered
            and   InvoiceLineFactConsolidate.Level5.Value   not entered)
            
        Level5NotEntered
            when (InvoiceLineFactConsolidate.Level5.Value    not entered)
            
   		Buyer1
			restricted
			when (BuyerLevel1Rel exists)

		Buyer4
			restricted
			when (BuyerLevel4Rel exists)
			
		Rqloc4	
			restricted
			when (RequestingLocationLevel4Rel exists)
			
		Location3
			restricted
			when (LocationLevel3Rel exists)
			
		Company2
			restricted
			when (CompanyLevel2Rel exists)
			
		HasItemmastUsageDateRange
			restricted
			when (ItemmastUsageDateRangesRel exists)
			
		HasRequestingLocationConsolidationsForBuyer
			restricted
			when (InvoiceLineFactConsolidatesBuyerReqLocationOnOrOffRel exists)
			
		HasRequestingLocationConsolidationsForLocation
			restricted
			when (Level4RequestingLocationInvoiceLineFactConsolidatesRel exists)

        PieChartHasNegativeSlice
            when (!DerivedAllPositiveBuyerSpendPiePieces)
            
        HasItemGood
        	when (InvoiceLineFactConsolidate.Level6.Value entered
        	and   InvoiceLineFactConsolidate.Level6.Type.Item
        	and   InvoiceLineFactConsolidate.SpendCategory.OnContract)
        	
        IsValidForActorContext
			restricted
			when (ProcurementGroup.FinanceEnterpriseGroup = actor.context.FinanceEnterpriseGroup)
            
   	Relations
	
		InvoiceLineFactConsolidatesBuyerLocationOnOrOffRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 2
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= SpendDimension.Type.ShipToLocation		
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory)
				
		InvoiceLineFactConsolidatesBuyerReqLocationOnOrOffRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 2
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= SpendDimension.Type.RequestingLocation				
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory)
							
		Level4BuyerInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 4
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= InvoiceLineFactConsolidate.Level2.Type
				related.InvoiceLineFactConsolidate.Level2.Value				= InvoiceLineFactConsolidate.Level2.Value
				related.InvoiceLineFactConsolidate.Level3.Type				= InvoiceLineFactConsolidate.Level3.Type
				related.InvoiceLineFactConsolidate.Level3.Value				= InvoiceLineFactConsolidate.Level3.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory
				and    related.InvoiceLineFactConsolidate.Level4.Type.Buyer)
				
		Level4RequestingLocationInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 4
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= InvoiceLineFactConsolidate.Level2.Type
				related.InvoiceLineFactConsolidate.Level2.Value				= InvoiceLineFactConsolidate.Level2.Value
				related.InvoiceLineFactConsolidate.Level3.Type				= InvoiceLineFactConsolidate.Level3.Type
				related.InvoiceLineFactConsolidate.Level3.Value				= InvoiceLineFactConsolidate.Level3.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory
				and    related.InvoiceLineFactConsolidate.Level4.Type.RequestingLocation)
				
		Level4CommodityCodeInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 4
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= InvoiceLineFactConsolidate.Level2.Type
				related.InvoiceLineFactConsolidate.Level2.Value				= InvoiceLineFactConsolidate.Level2.Value
				related.InvoiceLineFactConsolidate.Level3.Type				= InvoiceLineFactConsolidate.Level3.Type
				related.InvoiceLineFactConsolidate.Level3.Value				= InvoiceLineFactConsolidate.Level3.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory
				and    related.InvoiceLineFactConsolidate.Level4.Type.CommodityCode)
				
		InvoiceLineFactConsolidatesForDiversityRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= 2
				related.ConsolidationLevel									= 1
				related.InvoiceLineFactConsolidate.Level1.Type				= SpendDimension.Type.DiversityCode	
	
		InvoiceLineFactConsolidatesOnOrOffCompanyRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 2
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  = ComputeSpendCategory
				and    related.InvoiceLineFactConsolidate.Level2.Type.Company)	
							
		ItemmastLevel5Rel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.Item					= StringVariableLevel5
													
		ItemmastLevel4Rel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.Item					= StringVariableLevel4
													
		ItemmastLevel3Rel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.Item					= StringVariableLevel3
				
		ItemmastLevel6Rel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.Item					= StringVariableLevel6
													
		ItemmastRel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.Item					= DerivedItem
													
		BuyerLevel1Rel
			one-to-one relation to Buyer
			Field Mapping uses symbolic key
				related.HROrganization			= ContextProcurementGroupRel.ProcurementGroup.BusinessGroup.FinanceEnterpriseGroup.HROrganization
				related.Buyer 					= StringVariableLevel1
													
		BuyerLevel4Rel
			one-to-one relation to Buyer
			Field Mapping uses symbolic key
				related.HROrganization			= ContextProcurementGroupRel.ProcurementGroup.BusinessGroup.FinanceEnterpriseGroup.HROrganization
				related.Buyer 					= StringVariableLevel4
													
		VendorLevel2Rel
			one-to-one relation to Vendor
			Field Mapping uses symbolic key
				related.VendorGroup				= ProcurementGroup
				related.Vendor					= StringVariableLevel2
													
  		CommodityCodeRel
  			one-to-one relation to CommodityCode
  			Field Mapping uses symbolic key
  				related.ItemGroup				= ProcurementGroup
  				related.CommodityCode			= CommodityCode
  	
		DiverseCodeLevel1Rel
			one-to-one relation to PayablesDiversityCode
			Field Mapping uses symbolic key
				related.VendorGroup				= ProcurementGroup
				related.PayablesDiversityCode	= StringVariableLevel1
													
		CompanyLevel2Rel
			one-to-one relation to PurchasingCompany
			Field Mapping uses symbolic key
				related.Company					= StringVariableLevel2Numeric
				
		LocationLevel3Rel
			one-to-one relation to InventoryLocation
			Field Mapping uses symbolic key
				related.Company					= StringVariableLevel2Numeric
				related.InventoryLocation		= StringVariableLevel3
		
		BuyerLocationLevel2Rel
			one-to-one relation to InventoryLocation
			Field Mapping uses symbolic key
				related.Company					= LocationCompany
				related.InventoryLocation		= StringVariableLevel2
													
		RequestingLocationLevel4Rel
			one-to-one relation to RequestingLocation
			Field Mapping uses symbolic key
				related.Company					= LocationCompany
				related.RequestingLocation		= StringVariableLevel4
				
		BuyerRequestingLocationLevel2Rel
			one-to-one relation to RequestingLocation
			Field Mapping uses symbolic key
				related.Company					= LocationCompany
				related.RequestingLocation		= StringVariableLevel2
		
		InvoiceLineFactConsolidatesBuyerRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel									= 1
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				
		BuyerByLocationsRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerLocItem
				related.ProcurementGroup  = ProcurementGroup
				related.Buyer			  = StringVariableLevel1
				related.Company 		  = LocationCompany
				related.Location 		  = StringVariableLevel2
		
		BuyerByReqLocationsRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerReqLocItem
				related.ProcurementGroup 		= ProcurementGroup
				related.Buyer			  		= StringVariableLevel1
				related.Company 		  		= LocationCompany
				related.RequestingLocation 		= StringVariableLevel2
		
		OnContractInvoiceLineFactsForItemLevel5Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel5
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		OffContractInvoiceLineFactsForItemLevel5Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel5
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		NoContractInvoiceLineFactsForItemLevel5Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel5
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
		
		OnContractInvoiceLineFactsForItemLevel3Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel3
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		OffContractInvoiceLineFactsForItemLevel3Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel3
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		NoContractInvoiceLineFactsForItemLevel3Rel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= StringVariableLevel3
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
		
		InvoiceLineFactsForItemByDateRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByItem
				related.ProcurementGroup		= ProcurementGroup
				related.Item					= DerivedItem
			Instance Selection
				where (related.InvoiceDate		within LocalDateRange)
		
		InvoiceLineFactsForVendorRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByVendor
				related.Vendor = StringVariableLevel2
			Instance Selection
				where (related.PayablesDiversityCode = InvoiceLineFactConsolidate.Level1.Value
				and    related.InvoiceDate			>= DerivedFromDate
				and    related.InvoiceDate			<= DerivedThruDate)
		
		VendorRel
			one-to-one relation to Vendor
			Field Mapping uses symbolic key
				related.VendorGroup		= ProcurementGroup
				related.Vendor			= StringVariableLevel2	
							
		SupplierRel 
			one-to-many relation to Supplier
			Field Mapping uses symbolic key
				related.SupplierGroup	= ProcurementGroup
			Instance Selection
				where (related.Vendor = StringVariableLevel2)
		
		InvoiceLineFactsForDiversityRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel									= 2
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory.OffContract)
						
		Level5ItemInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup							= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory	= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel							= 5
				related.InvoiceLineFactConsolidate.Level1.Type		= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory		
				and  ((related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     Levels2And3And4NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= StringVariableLevel2
				and     Levels3And4NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= StringVariableLevel2
				and     related.InvoiceLineFactConsolidate.Level3.Value		= StringVariableLevel3
				and     Level4NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= StringVariableLevel2
				and     related.InvoiceLineFactConsolidate.Level3.Value		= StringVariableLevel3
				and     related.InvoiceLineFactConsolidate.Level4.Value		= StringVariableLevel4)))
													
        Level5ItemInvoiceLineFactConsolidatesForUNSPSCRel
            one-to-many relation to InvoiceLineFactConsolidate
            Field Mapping uses ByLevelsOnOff
                related.ProcurementGroup                            = ProcurementGroup
                related.InvoiceLineFactConsolidateControl            = InvoiceLineFactConsolidateControl
                related.InvoiceLineFactConsolidate.SpendCategory    = InvoiceLineFactConsolidate.SpendCategory
                related.ConsolidationLevel                            = 5
                related.InvoiceLineFactConsolidate.Level1.Type        = InvoiceLineFactConsolidate.Level1.Type
                related.InvoiceLineFactConsolidate.Level1.Value        = StringVariableLevel1
            Instance Selection
                where (related.InvoiceLineFactConsolidate.SpendCategory      = ComputeSpendCategory        
                and  ((related.InvoiceLineFactConsolidate.Level1.Value        = StringVariableLevel1
                and     UnspscLevels2And3And4NotEntered)
                or     (related.InvoiceLineFactConsolidate.Level2.Type        = StringLevel2Type
                and     related.InvoiceLineFactConsolidate.Level1.Value        = StringVariableLevel1
                and     related.InvoiceLineFactConsolidate.Level2.Value        = StringVariableLevel2
                and     UnspscLevels3And4NotEntered)
                or     (related.InvoiceLineFactConsolidate.Level3.Type        = StringLevel3Type
                and     related.InvoiceLineFactConsolidate.Level1.Value        = StringVariableLevel1
                and     related.InvoiceLineFactConsolidate.Level2.Value        = StringVariableLevel2
                and     related.InvoiceLineFactConsolidate.Level3.Value        = StringVariableLevel3
                and     UnspscLevel4NotEntered)
                or     (related.InvoiceLineFactConsolidate.Level4.Type        = StringLevel4Type
                and     related.InvoiceLineFactConsolidate.Level1.Value        = StringVariableLevel1
                and     related.InvoiceLineFactConsolidate.Level2.Value        = StringVariableLevel2
                and     related.InvoiceLineFactConsolidate.Level3.Value        = StringVariableLevel3
                and     related.InvoiceLineFactConsolidate.Level4.Value        = StringVariableLevel4)))
                                                    
   		Level5ItemFromLevel3InvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 5
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= InvoiceLineFactConsolidate.Level2.Type
				related.InvoiceLineFactConsolidate.Level2.Value				= InvoiceLineFactConsolidate.Level2.Value
				related.InvoiceLineFactConsolidate.Level3.Type				= InvoiceLineFactConsolidate.Level3.Type
				related.InvoiceLineFactConsolidate.Level3.Value				= InvoiceLineFactConsolidate.Level3.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory)		
													
		Level5ItemFromLevel2InvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 5
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
				related.InvoiceLineFactConsolidate.Level2.Type				= InvoiceLineFactConsolidate.Level2.Type
				related.InvoiceLineFactConsolidate.Level2.Value				= InvoiceLineFactConsolidate.Level2.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory)		
													
		Level5ItemFromLevel1InvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 5
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory)		
													
		Level3ItemFromLevel1BuyerInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup							= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory	= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel							= 3
				related.InvoiceLineFactConsolidate.Level1.Type		= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory		
				and    related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1)

		Level3ItemFromLevel2InvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup							= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory	= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel							= 3
				related.InvoiceLineFactConsolidate.Level1.Type		= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory		
				and    related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and    related.InvoiceLineFactConsolidate.Level2.Value		= StringVariableLevel2)

		ContractItemLineItemLevel5Rel
			one-to-many relation to ContractLine
			Field Mapping uses ByItemContractLine 
				related.ContractGroup 	= ProcurementGroup
				related.ItemNumber		= StringVariableLevel5
					
		ContractItemLineItemLevel3Rel
			one-to-many relation to ContractLine
			Field Mapping uses ByItemContractLine 
				related.ContractGroup 	= ProcurementGroup
				related.ItemNumber		= StringVariableLevel3
					
		ContractItemLineItemRel
			one-to-many relation to ContractLine
			Field Mapping uses ByItemContractLine 
				related.ContractGroup 	= ProcurementGroup
				related.ItemNumber		= DerivedItem
					
		ContractLinesForNegotiationRel
			one-to-many relation to ContractLine
			Field Mapping uses ByItemContractLine 
				related.ContractGroup 	= ProcurementGroup
				related.ItemNumber		= DerivedItem
			Instance Selection
				where (related.Contract.EligibleForNegotiation)
					
		ItemmastUsageContractAmountsForPeriodRel
			one-to-many relation to ItemmastUsageContractAmount
			Field Mapping uses ByItemmastUsage
				related.Item						= DerivedItem
				
		ItemmastUsagesPeriodAnalysisRel
			one-to-many relation to ItemmastUsage
			Field Mapping uses ByDateRange

				related.Item						= DerivedItem
				
		ItemmastUsageDateRangesRel
			one-to-many relation to ItemmastUsageDateRange
			Field Mapping uses symbolic key
				related.ItemGroup					= ProcurementGroup
				related.Item						= DerivedItem
			Instance Selection
				where (related.ForecastingOrBoth)
				
		ContractNegotiationsForItemOnlyRel
			one-to-many relation to ContractNegotiation
			Field Mapping uses symbolic key
				related.ItemGroup					= ProcurementGroup
				related.Item						= DerivedItem
			Instance Selection
				where (related.Contract1	not entered)	
				
		ContractNegotiationsForContractsRel
			one-to-many relation to ContractNegotiation
			Field Mapping uses symbolic key
				related.ItemGroup					= ProcurementGroup
				related.Item						= DerivedItem
			Instance Selection
				where (related.Contract1	entered)	
				
		SuppliersForDiversityCodeRel		
			one-to-many relation to SupplierDiversityResponse
			Field Mapping uses ByDiversityCode
				related.SupplierGroup		  = ProcurementGroup
				related.PayablesDiversityCode = InvoiceLineFactConsolidate.Level1.Value
	
		UNSPSCForSegmentRel
			one-to-one relation to UNSPSCCode
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.UNSPSCCode.UNSPSCSegment	= StringVariableLevel1
				related.UNSPSCCode.UNSPSCFamily		= "00"
				related.UNSPSCCode.UNSPSCClass		= "00"
				related.UNSPSCCode.UNSPSCCommodity	= "00"
																		
		UNSPSCForFamilyRel
			one-to-one relation to UNSPSCCode
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.UNSPSCCode.UNSPSCSegment	= StringVariableLevel1
				related.UNSPSCCode.UNSPSCFamily		= StringVariableLevel2
				related.UNSPSCCode.UNSPSCClass		= "00"
				related.UNSPSCCode.UNSPSCCommodity	= "00"
																		
		UNSPSCForClassRel
			one-to-one relation to UNSPSCCode
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.UNSPSCCode.UNSPSCSegment	= StringVariableLevel1
				related.UNSPSCCode.UNSPSCFamily		= StringVariableLevel2
				related.UNSPSCCode.UNSPSCClass		= StringVariableLevel3
				related.UNSPSCCode.UNSPSCCommodity	= "00"
																		
		UNSPSCForCommodityRel
			one-to-one relation to UNSPSCCode
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.UNSPSCCode.UNSPSCSegment	= StringVariableLevel1
				related.UNSPSCCode.UNSPSCFamily		= StringVariableLevel2
				related.UNSPSCCode.UNSPSCClass		= StringVariableLevel3
				related.UNSPSCCode.UNSPSCCommodity	= StringVariableLevel4
																		
		ContextInvoiceLineFactUNSPSCForSegmentRel
			one-to-one relation to UNSPSCCode
			Field Mapping uses symbolic key
				related.ItemGroup				= ProcurementGroup
				related.UNSPSCCode.UNSPSCSegment	= UNSPSCSegment
				related.UNSPSCCode.UNSPSCFamily		= "00"
				related.UNSPSCCode.UNSPSCClass		= "00"
				related.UNSPSCCode.UNSPSCCommodity	= "00"
																		
		PoRecLinesByDateRel
			one-to-many relation to PurchaseOrderReceiptLine
			Field Mapping uses symbolic key	
				related.Company			= LocalCompany
			Instance Selection
				where (related.ReceivedDate		within LocalDateRange
				and    related.Item				= DerivedItem)
				
		PoCompaniesRel
			one-to-many relation to PurchasingCompany
			Field Mapping uses Set2
				related.ProcurementGroup		= ProcurementGroup
				
		ItemmastUsageContractAmountsForItemRel
			one-to-many relation to ItemmastUsageContractAmount
			Field Mapping uses ByItemmastUsage
				related.Item						= DerivedItem
				
		ItemmastUsagesRel
			one-to-many relation to ItemmastUsage
			Field Mapping uses ByDateRange

				related.Item						= DerivedItem
				
		Level6ItemInvoiceLineFactConsolidatesRel
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByLevelsOnOff
				related.ProcurementGroup									= ProcurementGroup
				related.InvoiceLineFactConsolidateControl					= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.SpendCategory			= InvoiceLineFactConsolidate.SpendCategory
				related.ConsolidationLevel									= 6
				related.InvoiceLineFactConsolidate.Level1.Type				= InvoiceLineFactConsolidate.Level1.Type
				related.InvoiceLineFactConsolidate.Level1.Value				= InvoiceLineFactConsolidate.Level1.Value
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory  	= ComputeSpendCategory		
				and  ((related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
                and     Levels2And3And4And5NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level2.Type		= DerivedLevel2Type
				and     related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= DerivedLevel2Value
                and     Levels3And4And5NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level3.Type		= DerivedLevel3Type
				and     related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= DerivedLevel2Value
				and     related.InvoiceLineFactConsolidate.Level3.Value		= DerivedLevel3Value
                and     Levels4And5NotEntered)
				or     (related.InvoiceLineFactConsolidate.Level4.Type		= DerivedLevel4Type
				and     related.InvoiceLineFactConsolidate.Level1.Value		= StringVariableLevel1
				and     related.InvoiceLineFactConsolidate.Level2.Value		= DerivedLevel2Value
				and     related.InvoiceLineFactConsolidate.Level3.Value		= DerivedLevel3Value
                and     related.InvoiceLineFactConsolidate.Level4.Value     = DerivedLevel4Value
                and     Level5NotEntered)
                or     (related.InvoiceLineFactConsolidate.Level5.Type      = DerivedLevel5Type
                and     related.InvoiceLineFactConsolidate.Level1.Value     = StringVariableLevel1
                and     related.InvoiceLineFactConsolidate.Level2.Value     = DerivedLevel2Value
                and     related.InvoiceLineFactConsolidate.Level3.Value     = DerivedLevel3Value
                and     related.InvoiceLineFactConsolidate.Level4.Value     = DerivedLevel4Value
                and     related.InvoiceLineFactConsolidate.Level5.Value     = DerivedLevel5Value))
				and   (!UseCommCodesRel
				or    (UseCommCodesRel
				and    related.CommodityCode								= CommodityCode)))	

		InvoiceLineFactsForDiverseInvoicesRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByDiversityCode
				related.ProcurementGroup 			= ProcurementGroup
				related.PayablesDiversityCode		 = InvoiceLineFactConsolidate.Level1.Value
			Instance Selection
				where (related.PayablesDiversityCode entered
				and    related.InvoiceDate >= ProcurementGroup.DiversitySpendAnalysisFromDate
				and    related.InvoiceDate <= ProcurementGroup.DiversitySpendAnalysisThruDate)
				
		OnContractInvoiceLineFactsByLocationBuyerItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationBuyerItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.Buyer							= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

		OnContractInvoiceLineFactsByLocationReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.RequestingLocation				= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OnContractInvoiceLineFactsByBuyerLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.Location						= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OnContractInvoiceLineFactsByBuyerReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.RequestingLocation				= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OffContractInvoiceLineFactsByLocationBuyerItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationBuyerItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.Buyer							= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

		OffContractInvoiceLineFactsByLocationReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.RequestingLocation				= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OffContractInvoiceLineFactsByBuyerLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.Location						= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OffContractInvoiceLineFactsByBuyerReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.RequestingLocation				= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		NoContractInvoiceLineFactsByLocationBuyerItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationBuyerItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.Buyer							= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

		NoContractInvoiceLineFactsByLocationReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByLocationReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Company							= StringVariableLevel2Numeric
				related.Location						= StringVariableLevel3
				related.RequestingLocation				= StringVariableLevel4
				related.Item							= StringVariableLevel5
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		NoContractInvoiceLineFactsByBuyerLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.Location						= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		NoContractInvoiceLineFactsByBuyerReqLocItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByBuyerReqLocItem
				related.ProcurementGroup				= ProcurementGroup
				related.Buyer							= StringVariableLevel1
				related.Company							= LocationCompany
				related.RequestingLocation				= StringVariableLevel2
				related.Item							= StringVariableLevel3
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
				
		OnContractInvoiceLineFactsForCommCodesItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByCommCodesItem
				related.ProcurementGroup		= ProcurementGroup
				related.CommodityCode			= CommodityCode.CommodityCodeRel.CommodityCode
				related.Item					= DerivedItem
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		OffContractInvoiceLineFactsForCommCodesItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByCommCodesItem
				related.ProcurementGroup		= ProcurementGroup
				related.CommodityCode			= CommodityCode.CommodityCodeRel.CommodityCode
				related.Item					= DerivedItem
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

														
		NoContractInvoiceLineFactsForCommCodesItemRel
			one-to-many relation to InvoiceLineFact
			Field Mapping uses ByCommCodesItem
				related.ProcurementGroup		= ProcurementGroup
				related.CommodityCode			= CommodityCode.CommodityCodeRel.CommodityCode
				related.Item					= DerivedItem
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

		
		OnContractInvoiceLineFactsForUNSPSCItemRel
			one-to-many relation to InvoiceLineFact
            Field Mapping uses ConsolidateUNSPSCItemSortSet            
				related.ProcurementGroup		= ProcurementGroup
                related.UNSPSC.UNSPSCSegment    = StringUNSPSCSegment
                related.UNSPSC.UNSPSCFamily     = StringUNSPSCFamily
                related.UNSPSC.UNSPSCClass      = StringUNSPSCClass
                related.UNSPSC.UNSPSCCommodity  = StringUNSPSCCommodity
                related.Item					= DerivedItem
			Instance Selection
				where (related.OnContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)
														
		OffContractInvoiceLineFactsForUNSPSCItemRel
			one-to-many relation to InvoiceLineFact
            Field Mapping uses ConsolidateUNSPSCItemSortSet            
				related.ProcurementGroup		= ProcurementGroup
                related.UNSPSC.UNSPSCSegment    = StringUNSPSCSegment
                related.UNSPSC.UNSPSCFamily     = StringUNSPSCFamily
                related.UNSPSC.UNSPSCClass      = StringUNSPSCClass
                related.UNSPSC.UNSPSCCommodity  = StringUNSPSCCommodity
            	related.Item					= DerivedItem
			Instance Selection
				where (related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

														
		NoContractInvoiceLineFactsForUNSPSCItemRel
			one-to-many relation to InvoiceLineFact
            Field Mapping uses ConsolidateUNSPSCItemSortSet            
				related.ProcurementGroup		= ProcurementGroup
                related.UNSPSC.UNSPSCSegment    = StringUNSPSCSegment
                related.UNSPSC.UNSPSCFamily     = StringUNSPSCFamily
                related.UNSPSC.UNSPSCClass      = StringUNSPSCClass
                related.UNSPSC.UNSPSCCommodity  = StringUNSPSCCommodity
                related.Item					= DerivedItem
			Instance Selection
				where (!related.OnContract
				and    !related.OffContract
				and    related.InvoiceDate		>= DerivedFromDate
				and    related.InvoiceDate		<= DerivedThruDate)

		LocationCompanyRel
			one-to-one relation to PurchasingCompany
			Field Mapping uses symbolic key
				related.Company					= LocationCompany
				
		InvoiceLineFactConsolidateWithDiversityCodeRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.DiversityCode
			Instance Selection
				where (related.InvoiceLineFactConsolidate.SpendCategory.OffContract
				and	   related.InvoiceLineFactConsolidate.Level1.Value entered)
		
		InvoiceLineFactConsolidatesForProcurementGroupRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= actor.context.FinanceEnterpriseGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.ProcurementGroup
				
		ContextProcurementGroupRel
			one-to-one relation to ProcurementGroup
			Field Mapping uses symbolic key
				related.ProcurementGroup		= ProcurementGroup
	
		InvoiceLineFactUNSPSCRel
			one-to-many relation to InvoiceLineFactUNSPSC
			Field Mapping uses ByUNSPSC
				related.ProcurementGroup						= ProcurementGroup
				related.InvoiceLineFactConsolidateControl		= InvoiceLineFactConsolidateControl

				related.UNSPSCCode.UNSPSCSegment				= StringUNSPSCSegment
				related.UNSPSCCode.UNSPSCFamily					= StringUNSPSCFamily
				related.UNSPSCCode.UNSPSCClass					= StringUNSPSCClass
				related.UNSPSCCode.UNSPSCCommodity				= StringUNSPSCCommodity
				 		
		InvoiceLineFactCommodityCodesRel
			one-to-many relation to InvoiceLineFactCommodityCode
			Field Mapping uses ByCommodityCode
				related.ProcurementGroup						= ProcurementGroup
				related.InvoiceLineFactConsolidateControl		= InvoiceLineFactConsolidateControl
				related.CommodityCode							= CommodityCode.CommodityCodeRel.CommodityCode
				 		
	Sets
		ByConsolidationLevel
			Sort Order
				ConsolidationLevel
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidate.Level1.Type
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Type
				InvoiceLineFactConsolidate.Level2.Value	
				InvoiceLineFactConsolidate.Level3.Type
				InvoiceLineFactConsolidate.Level3.Value	
				InvoiceLineFactConsolidate.Level4.Type
				InvoiceLineFactConsolidate.Level4.Value
				InvoiceLineFactConsolidate.Level5.Type
				InvoiceLineFactConsolidate.Level5.Value	
				UniqueID
											
		ByLevelsOnOff
			Sort Order
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidate.SpendCategory
				ConsolidationLevel
				InvoiceLineFactConsolidate.Level1.Type
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Type
				InvoiceLineFactConsolidate.Level2.Value	
				InvoiceLineFactConsolidate.Level3.Type
				InvoiceLineFactConsolidate.Level3.Value	
				InvoiceLineFactConsolidate.Level4.Type
				InvoiceLineFactConsolidate.Level4.Value
				UniqueID
				TotalExtendedAmount 	descending
				
		ByOffPercent
			Sort Order
				OnOffPercent	descending					
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Value
				InvoiceLineFactConsolidate.Level3.Value
				InvoiceLineFactConsolidate.Level4.Value
				InvoiceLineFactConsolidate.Level5.Value
				InvoiceLineFactConsolidate.Level6.Value
				UniqueID
				
		ByAmount
			Sort Order
				TotalExtendedAmount 	descending
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Value
				InvoiceLineFactConsolidate.Level3.Value
				InvoiceLineFactConsolidate.Level4.Value
				InvoiceLineFactConsolidate.Level5.Value
				InvoiceLineFactConsolidate.Level6.Value
				UniqueID
		
		ByOnOffSpendAmount
			Sort Order
				TotalOnOffSpend 	descending
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Value
				InvoiceLineFactConsolidate.Level3.Value
				InvoiceLineFactConsolidate.Level4.Value
				InvoiceLineFactConsolidate.Level5.Value
				InvoiceLineFactConsolidate.Level6.Value
				UniqueID
							
		ByLevels
			Sort Order
				InvoiceLineFactConsolidate.Level1.Value
				InvoiceLineFactConsolidate.Level2.Value	
				InvoiceLineFactConsolidate.Level3.Value	
				InvoiceLineFactConsolidate.Level4.Value
				InvoiceLineFactConsolidate.Level5.Value	
				InvoiceLineFactConsolidate.Level6.Value	
				UniqueID
								
		ByItemLevel3
			duplicates
			Sort Order
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidate.Level3.Value
			Instance Selection
				where (ItemLevel3)
				
		ByItemLevel5
			duplicates
			Sort Order
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidate.Level5.Value
			Instance Selection
				where (ItemLevel5)
				
		ByItemLevel6
			duplicates
			Sort Order
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidate.Level6.Value
			Instance Selection
				where (ItemLevel6)
				
	Actions
		Create is a Create Action
			restricted                       
			Exit Rules
				invoke FastUpdate
			
		Update is an Update Action
			restricted
			Exit Rules
				invoke FastUpdate
			
		Delete is a Delete Action
			restricted

		Purge is a Purge Action
			restricted
			
		CreateEvent is an Instance Action
			restricted
            completion message is "SourcingEvent#<LocalSourcingEvent.SourcingEvent>CreatedForCompany<LocalSourcingEvent.Company>"
            Parameters
				Company						 is a SourcingCompany
				ApplyTemplate				 is a SourcingEvent
    			NewName						 is a Description
				NewDescription				 is RichText
				NewEventReference			 is a Description
				NewSourcingEventType		 is a SourcingEventType
				NewBuyer					 is a Buyer					
				NewCategory					 is a Category
				NewSubCategory				 is a SubCategory
				NewPostingOptions			 is a PostingOptions
				NewCreateAmendments			 is Boolean
				NewAllowSupplierQandA		 is Boolean
				NewInformalQuote			 is Boolean
				NewPreviewDate				 is TimeStamp
				NewOpenDate					 is TimeStamp
				NewCloseDate				 is TimeStamp
				NewQandAOpenDate			 is TimeStamp
				NewQandACloseDate			 is TimeStamp
				NewDisputeCloseDate			 is TimeStamp
				NewDefaultOutputType		 is Numeric size 2
		    		States
		                PO 							value is 1 
		                Contract 					value is 2 
		                Blanket 					value is 3 
		                CatalogQuote 				value is 4 
		                Standing 					value is 5 
		                Service 					value is 6
		                NoOutput					value is 7
		        NewDefaultContractManagement is Boolean 
				
			Parameter Rules
				Company 
					required
				ApplyTemplate
					constraint (ApplyTemplate.IsTemplate)
		    			"MustSelectAnEventTemplate"
					constraint (!ApplyTemplate.SourcingEventLine set exists)
						"CanOnlyApplyAnEventTemplateWithNoLines"
				NewName
    				required
    				initial value is ApplyTemplate.Name
    				if (ApplyTemplate entered) 
    					default to ApplyTemplate.Name
				NewDescription
					initial value is ApplyTemplate.Description
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.Description
				NewEventReference
					initial value is ApplyTemplate.EventReference
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.EventReference
				NewSourcingEventType
					initial value is ApplyTemplate.SourcingEventType
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.SourcingEventType
				NewBuyer
					initial value is ApplyTemplate.Buyer
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.Buyer
				NewCategory
					initial value is ApplyTemplate.Category
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.Category
				NewSubCategory
					initial value is ApplyTemplate.SubCategory
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.SubCategory
				NewPostingOptions
					initial value is ApplyTemplate.PostingOptions
    				if (ApplyTemplate entered)
    					default to ApplyTemplate.PostingOptions
				NewCreateAmendments
					initial value is ApplyTemplate.CreateAmendments
				NewAllowSupplierQandA
					initial value is ApplyTemplate.AllowSupplierQandA
				NewInformalQuote
					initial value is ApplyTemplate.InformalQuote
				NewDefaultOutputType
					initial value is ApplyTemplate.OutputType
					if (ApplyTemplate entered)
    					default to ApplyTemplate.OutputType
							
			Local Fields
            	LocalSourcingEvent			is a SourcingEvent view
				LocalSourcingEventQuestion	is a SourcingEventQuestion view
				LocalSourcingEventArticle 	is a SourcingEventArticle view
				LocalSourcingEventTerm		is a SourcingEventTermAndCondition view
				
			Action Rules
				invoke Create Draft SourcingEvent
					assign result to LocalSourcingEvent
							
					invoked.CreateByCopy 	  	= true
		    		invoked.CreateFromLibrary 	= true
		    		invoked.Company 			= Company
					invoked.Name				= NewName						
					invoked.Description			= NewDescription				
					invoked.EventReference		= NewEventReference			
					invoked.SourcingEventType 	= NewSourcingEventType		
					if (NewBuyer entered)
						invoked.Buyer 			= NewBuyer
					else
						invoked.Buyer			= actor.context.Buyer										
					invoked.Category 			= NewCategory					
					invoked.SubCategory 		= NewSubCategory
					invoked.PostingOptions 		= NewPostingOptions
					invoked.OutputType			= NewDefaultOutputType
					invoked.CreateAmendments 	= NewCreateAmendments			
					invoked.AllowSupplierQandA	= NewAllowSupplierQandA		
					invoked.InformalQuote 		= NewInformalQuote			
					invoked.PreviewDate 		= NewPreviewDate				
					invoked.OpenDate 			= NewOpenDate					
					invoked.CloseDate 			= NewCloseDate				
					invoked.QandAOpenDate 		= NewQandAOpenDate			
					invoked.QandACloseDate 		= NewQandACloseDate			
					invoked.DisputeCloseDate 	= NewDisputeCloseDate
					
					if (ApplyTemplate entered)
						fill in fields from ApplyTemplate
				
				if (ApplyTemplate entered)
					for each ApplyTemplate.SourcingEventQuestion set 
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventQuestion set
							assign result to LocalSourcingEventQuestion
							fill in fields from each
						
						for each each.SourcingEventQuestionValue set 
							invoke CreateDisplay LocalSourcingEventQuestion.SourcingEventQuestion.SourcingEventQuestionValue set
								fill in fields from each
								
					for each ApplyTemplate.SourcingEventArticle set
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventArticle set
							assign result to LocalSourcingEventArticle
							fill in fields from each

						for each each.SourcingEventTermAndCondition set
							invoke Create LocalSourcingEventArticle.SourcingEventArticle.SourcingEventTermAndCondition set
								assign result to LocalSourcingEventTerm
								fill in fields from each
							
							for each each.SourcingEventTermAndConditionAttachment set		
								invoke Create LocalSourcingEventTerm.SourcingEventTermAndCondition.SourcingEventTermAndConditionAttachment set 
									fill in fields from each
							
					for each ApplyTemplate.SourcingEventMeeting set 
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventMeeting set
							fill in fields from each
					
					for each ApplyTemplate.SourcingEventAttachment set 
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventAttachment set
							fill in fields from each
					
					for each ApplyTemplate.SourcingEventContact set 
						if (each.Contact entered)
							invoke CreateContactFromEmployee LocalSourcingEvent.SourcingEvent.SourcingEventContact set
								fill in fields from each
						else
							invoke CreateAdHocContact LocalSourcingEvent.SourcingEvent.SourcingEventContact set
								fill in fields from each
					
					for each ApplyTemplate.SourcingEventComment set 
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventComment set
							fill in fields from each
							
					for each ApplyTemplate.SourcingEventCommodities set 
						invoke Create LocalSourcingEvent.SourcingEvent.SourcingEventCommodities set
							fill in fields from each

				invoke Create Draft LocalSourcingEvent.SourcingEvent.SourcingEventLine set
					invoked.Name											= ItemDescription
					invoked.ItemNumber          							= DerivedItem
					if (DerivedItem entered)
						invoked.ItemDescription								= ItemDescription
					else
						invoked.Description                                 = ItemDescription
					invoked.Quantity										= TotalOnOffQuantity
					invoked.UOM												= ItemmastRel.StockUOM
					if (ApplyTemplate entered)
						invoked.TemplateApplied									= true	
						
		FastUpdate is an Instance Action
			restricted
			Action Rules
				ConsolidateUniqueID 	= UniqueID

		PurgeInvoiceLineFactConsolidate is a Set Action

			restricted
			completion message is "PurgeOfSpendAnalysisConsolidationIsComplete"
			Parameters
				PrmProcurementGroup							is a ProcurementGroup
				PrmLastInvoiceLineFactConsolidateControl	is Numeric size 10
				PrmConsolidationOptions						is a ConsolidationOptions
				
			Local Fields
				LocalSpendDimension 						is a SpendDimension
				LocalPurgeInvoiceLineFactConsolidateControl	is Boolean
				
			Sort Order
				ProcurementGroup
				InvoiceLineFactConsolidateControl
				
			Instance Selection
				where (PrmProcurementGroup					= ProcurementGroup
				and   (InvoiceLineFactConsolidateControl 	= PrmLastInvoiceLineFactConsolidateControl
				or     InvoiceLineFactConsolidateControl	< PrmLastInvoiceLineFactConsolidateControl))
				
			Action Rules
				InvoiceLineFactConsolidateControl Set Rules
					Entrance Rules
						LocalPurgeInvoiceLineFactConsolidateControl			= true
												
					Exit Rules
						if (LocalPurgeInvoiceLineFactConsolidateControl)
							invoke Purge InvoiceLineFactConsolidateControl
				
				Instance Rules
					if   ((PrmConsolidationOptions.ConsolidateTotalSpend
					and    LocalSpendDimension.Type.ProcurementGroup		= InvoiceLineFactConsolidate.Level1.Type)
					or    (PrmConsolidationOptions.ConsolidateBuyerSpend
					and    LocalSpendDimension.Type.Buyer					= InvoiceLineFactConsolidate.Level1.Type)
					or    (PrmConsolidationOptions.ConsolidateDiversitySpend
					and    LocalSpendDimension.Type.DiversityCode			= InvoiceLineFactConsolidate.Level1.Type)
					or    (PrmConsolidationOptions.ConsolidateCommodityCodeSpend
					and    LocalSpendDimension.Type.CommodityCodeSegment1	= InvoiceLineFactConsolidate.Level1.Type)
					or    (PrmConsolidationOptions.ConsolidateUNSPSCSpend
					and    LocalSpendDimension.Type.UNSPSCSegment			= InvoiceLineFactConsolidate.Level1.Type))
						invoke Purge InvoiceLineFactConsolidate
					else 
						LocalPurgeInvoiceLineFactConsolidateControl			= false
						
