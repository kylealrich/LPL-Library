FinancePeriod is a BusinessClass
    owned by sharedfinance
    prefix is FPRD

    Ontology
    	symbolic key is FinancePeriod

 	Patterns
 		implements DynamicCreation

    Persistent Fields
		CloseManagementStatus				is Numeric 1
			States
				Unscheduled					value is 0
				Scheduled					value is 1
				Open						value is 2
				Closed						value is 3
		PeriodOpenDate						is TimeStamp
		PeriodCloseDate						is TimeStamp
	
	Local Fields
		LocalSubscriber						is a FinanceResource
		LocalGroupingForTeam				is Numeric 9
		LocalTeam							is a FinanceTeam
		LocalCloseDate						is TimeStamp						
		LocalCalcDone						is Boolean
		LocalTotalDetailCount				is Numeric 5
		LocalScheduledCount					is Numeric 5
		LocalInProcessCount					is Numeric 5
		LocalPendingApprovalCount			is Numeric 5
		LocalClosedCount					is Numeric 5
		LocalVoidedCount					is Numeric 5
		LocalOverdueCount					is Numeric 5
		LocalDueTodayCount					is Numeric 5
		LocalStartTodayCount				is Numeric 5
		LocalInJeopardyCount				is Numeric 5
		LocalLateToStartCount				is Numeric 5
		LocalReopenedCount					is Numeric 5
		LocalStartEarlyCount				is Numeric 5
		LocalStartLateCount					is Numeric 5
		LocalDoneEarlyCount					is Numeric 5
		LocalDoneLateCount					is Numeric 5
		LocalOneTimeTaskCount				is Numeric 5
	
	Rule Blocks










































	Derived Fields
































		PeriodOpenDateDate is a DerivedField
			type is Date
			restricted
			return (PeriodOpenDate date)

		PeriodCloseDateDate is a DerivedField
			type is Date
			restricted
			return (PeriodCloseDate date)	

































































































































































































































		OriginalCloseDate is a DerivedField
			type is TimeStamp
			restricted

			initialize LocalCloseDate
			for each this instance.audit log records
				if (each.action = "ClosePeriod")
					if (LocalCloseDate not entered)
						LocalCloseDate = each.entry stamp
					else
					if (each.entry stamp date < LocalCloseDate)
						LocalCloseDate = each.entry stamp
			return LocalCloseDate

		ReopenedMessage is a MessageField
			restricted
			"*PeriodWasReopened;See_Reopen_AuditForDetailsOnReopenAndCloseDates"
						
	Sets
		ByPeriodStatus
			duplicates
			Sort Order
				FinanceGroup			
				CloseManagementStatus
				
		ByOpenPeriod
			Sort Order
				FinanceGroup
				FinancePeriod
			Instance Selection
				where (CloseManagementStatus.Open) 
				
	Relations
















				








































































































		PurgeSubscriptionRel
			one-to-many relation to FinanceResourceSubscription
			Field Mapping uses BySubscription
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.Subscription = reference to FinancePeriod			
		PurgeUpdatesRel		
			one-to-many relation to SubscriptionUpdates
			Field Mapping uses ByThisChanged
				related.FinanceGroup = FinanceGroup
				related.ThisChanged = reference to FinancePeriod
		PurgeUnsubscribeRel
			one-to-many relation to FinanceResourceSubscription
			Field Mapping uses ByBusinessClassName
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.Subscription.BusinessClassName = "FinancePeriod"
			Instance Selection
				where (related.FinanceResource = actor.agent(Employee).Employee)

		MySubscriptionsRel
			one-to-many relation to FinanceResourceSubscription
			Field Mapping uses BySubscription
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.Subscription = reference to FinancePeriod			
				related.FinanceResource = actor.agent(Employee).Employee
		MyUpdatesRel
			one-to-many relation to SubscriptionUpdates
			Field Mapping uses ByThisChanged
				related.FinanceGroup = FinanceGroup
				related.ThisChanged = reference to FinancePeriod
			Instance Selection
				where (related.WhenItChanged >= first  MySubscriptionsRel.MarkAsViewedTimeStamp)   				
		MyNotesRel
			one-to-many relation to FinanceResourceDialogue		
			Field Mapping uses ByNavigateToThis
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.NavigateToThis = reference to FinancePeriod			
				related.DialogueType = 2 
				related.FinanceResource = actor.agent(Employee).Employee
		MyMessagesRel
			one-to-many relation to FinanceResourceDialogue		
			Field Mapping uses ByNavigateToThis
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.NavigateToThis = reference to FinancePeriod			
				related.DialogueType = 0 
				related.FinanceResource = actor.agent(Employee).Employee		
			Instance Selection
				where (related.HideFromNewView = false)
		MyWorkRequestsRel
			one-to-many relation to FinanceResourceSchedule
			Field Mapping uses ByNavigateToThis
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.NavigateToThis = reference to FinancePeriod			
				related.FinanceResource = actor.agent(Employee).Employee		
				related.CreatedBy = 2 
				related.WorkStatus < 2 
		MyRemindersRel
			one-to-many relation to FinanceResourceSchedule
			Field Mapping uses ByNavigateToThis
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.NavigateToThis = reference to FinancePeriod			
				related.FinanceResource = actor.agent(Employee).Employee		
				related.CreatedBy = 0 
				related.WorkStatus < 2 
		AllSubscribersRel
			one-to-many relation to FinanceResourceSubscription
			Field Mapping uses ByBusinessClassName
				related.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
				related.Subscription.BusinessClassName = "FinancePeriod"												
		AvailablePeriodRel
			one-to-many relation to FinancePeriod
			Field Mapping uses ByPeriodStatus
				related.FinanceGroup = FinanceGroup
				related.CloseManagementStatus < 3
		SendToTeamMembersRel
			one-to-many relation to FinanceTeamMember 
			Field Mapping uses ByFinanceTeam
				related.FinanceEnterpriseGroup 	= FinanceGroup
				related.FinanceTeam 			= LocalTeam				

	Conditions



















































































		ShowExpectedOpenDate
			restricted
			when (CloseManagementStatus.Scheduled)
		ShowOpenDate
			restricted
			when (CloseManagementStatus.Open
			or    CloseManagementStatus.Closed)	
		ShowExpectedCloseDate
			restricted
			when (CloseManagementStatus.Open)
		ShowClosedDate
			restricted
			when (CloseManagementStatus.Closed)

























		SubscribeToPeriodValid
			restricted
			when (CloseManagementStatus.Open
			and   !MySubscriptionsRel exists)	
		UnsubscribeToPeriodValid
			restricted
			when (CloseManagementStatus.Open
			and   MySubscriptionsRel exists)
		ShowMyUpdates
			restricted
			when (MySubscriptionsRel exists
			and   MyUpdatesRel exists)	
		ShowMyNotes
			restricted
			when (MyNotesRel exists)
		ShowMyMessages
			restricted
			when (MyMessagesRel exists)	
		ShowMyWorkRequests
			restricted
			when (MyWorkRequestsRel exists)	
		ShowMyReminders
			restricted
			when (MyRemindersRel exists)
	
	Field Rules
			
		
	Actions
		Create is a Create Action
			restricted
			Action Rules
				display "CreatePeriod<FinancePeriod.Year>:<FinancePeriod.Period>"
			Exit Rules

				for each AllSubscribersRel
					if (LocalSubscriber not = each.FinanceResource)
						LocalSubscriber = each.FinanceResource
						invoke Create FinanceResourceSubscription
							invoked.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
							invoked.FinanceResource = each.FinanceResource
							invoked.Subscription = reference to FinancePeriod
							invoked.SubscriptionTitle = "Period updates for " + FinancePeriod
									
		Update is an Update Action


		Delete is a Purge Action	
			restricted

			Entrance Rules
				invoke Purge PurgeSubscriptionRel 
				invoke Purge PurgeUpdatesRel 
		
		Reset is an Instance Action
			restricted

			Parameters
				RevertToScheduled	is Boolean
			Action Rules
				if (RevertToScheduled)
					invoke RevertToScheduled
			
		RevertToScheduled is an Instance Action
			restricted

			Action Rules
				CloseManagementStatus = CloseManagementStatus.Scheduled	
				initialize PeriodOpenDate
				initialize PeriodCloseDate
			Exit Rules
				invoke Create SubscriptionUpdates
					invoked.FinanceGroup = FinanceGroup
					invoked.UpdatedByResource = actor.agent(Employee).Employee 
					invoked.ThisChanged = reference to FinancePeriod
					invoked.HowItChanged = 422 
					invoked.Label = "Period " + FinancePeriod
					invoked.Description = "Period reset from open to scheduled " 

		
		RevertToUnscheduled is an Instance Action
			restricted
			Action Rules

				CloseManagementStatus = CloseManagementStatus.Unscheduled
				initialize PeriodOpenDate
				initialize PeriodCloseDate
		












						
		OpenPeriod is an Instance Action

				
			Action Rules










			
				CloseManagementStatus = CloseManagementStatus.Open
				PeriodOpenDate = current timestamp


					 						
		ClosePeriod is an Instance Action

			Action Rules
				CloseManagementStatus = CloseManagementStatus.Closed
				PeriodCloseDate = current timestamp
	
		ReopenPeriod is an Instance Action

			action comment required
			Action Rules
				CloseManagementStatus = CloseManagementStatus.Open

		Subscribe is an Instance Action
			restricted
			valid when (SubscribeToPeriodValid)
			completion message is "YouWillNowReceivePeriodUpdates"
			Action Rules
				for each AvailablePeriodRel
					invoke Create FinanceResourceSubscription
						invoked.HROrganization = FinanceGroup.FinanceEnterpriseGroup.HROrganization
						invoked.FinanceResource = actor.agent(Employee).Employee 
						invoked.Subscription = reference to each.FinancePeriod
						invoked.SubscriptionTitle = "Period updates for " + each.FinancePeriod

		UnSubscribe is an Instance Action
			valid when (UnsubscribeToPeriodValid)
			completion message is "YouWillNoLongerReceivePeriodUpdates"
			Action Rules
				invoke Purge PurgeUnsubscribeRel.FinanceResourceSubscription











































































































































































































































