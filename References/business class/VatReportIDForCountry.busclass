VatReportIDForCountry is a BusinessClass
	default label is "VatReportIDForCountry/\Jurisdiction"
    owned by tx
    prefix is TVR
    classic name is TXVATRPT

    Ontology
        symbolic key is VatReportIDForCountry
            classic set name is TVRSET1
            classic name for VatReportIDForCountry.VatReportID is VAT-RPT-ID

    Patterns
        implements StaticJava
        disable AuditIndex
        implements BODId	        

    Persistent Fields

        Description
		VatReturnPreview	is RichText		

	Transient Fields
		VatYear							is Year
		VatPeriod						is Numeric 2
			
	Local Fields
		LocalBODCurrentTimeStamp		is a BODCurrentTimeStamp

		VatCountry						is Alpha 30
		LocalBoxDescription				is a Description
		BoxNumber						is Numeric 3
		BoxNumberTotal					is an InternationalAmount 
		SelectTaxCode					is like TaxCode
		LocalVatYear					is Year
		LocalVatPeriod					is Numeric 2
		LocalVatReportId				is like VatReportIDForCountry
		LocalSource						is Alpha 1
		LocalInvoiceOrCredit			is Alpha 1
		LocalTaxUsageIndicator			is Alpha 1
		LocalGoodsAndServicesInd		is Alpha 1
		LocalVatReportingLine   		is like VatReportingLine
		LocalVATBoxNumber				is a VatBoxNbr
		LocalLineBoxNumber    			is a VatBoxNbr
		LocalTotalTaxAmount	  			is a InternationalAmount	
		LocalAdjustTotalTaxAmount       is a InternationalAmount
        LocalBoxBaseTaxAmount			is a InternationalAmount
        LocalAdjustByVatBox				is a VatBoxNbr
        VatBoxTable	
        Idx								is Numeric size 2
        LocalPrmVatSalesCode	is Alpha size 10
		LocalPrmTaxYear1 	is Numeric size 10
		LocalPrmTaxYear2 is Numeric size 10
		LocalPrmTaxYear3 is Numeric size 10
		LocalPrmTaxPeriod1 is Numeric size 10
		LocalPrmTaxPeriod2 is Numeric size 10
		LocalPrmTaxPeriod3 is Numeric size 10
		LocalCount is Numeric size 4
		LocalOrigCompany is Numeric size 4
		LocalVendorCustomer is Alpha 20	
		LocalInnerVendorCustomer is Alpha 20	
		LocalSubTotalBaseAmount is Decimal 8.3
		LocalCustomerCountry is AlphaUpper size 3

		LocalCustomerVatRegistrationNumber is Alpha 20 
		LocalCustomerGroup is Alpha 10	
		LocalVendorCustomerName is Alpha 20	
		LocalCustomerMunicipality is Alpha 40
		LocalCustomerPostalCode is Alpha 20
		LocalTaxReportLine is XMLDocument
		LocalTransactionCurrency is Alpha 10


		LocalCustomerAddressLine1 is Alpha 20
		LocalCustomerAddressLine2 is Alpha 20
		LocalCustomerAddressLine3 is Alpha 20
		LocalCustomerAddressLine4 is Alpha 20



 		NativeLPLBODTrigger							is Boolean	
 		FindBoxNumber		is Numeric 3
		LocalEffectOnVatBox 		is AlphaUpper size 1
            States
                AddTo           value is "+"
                SubtractFrom    value is "-"
                NoEffectOn   	value is blank		

		LocalNewTaxEntity				is like TaxEntity
 		LocalNewCountryCode 			is a Country
	 	LocalNewVatReportID 			is a VatRptId

		NewBODTracker  					is a FSMInboundBODTracker view
		LocalFSMInboundBODTracker		is Numeric 15
		Error            				is Boolean
	    ErrorMessage     				is Alpha 300	 
		LocalConfigurationParameter		is Alpha size up to 200					                 		              					

	Derived Fields

		CurrentYear is a DerivedField	 			
			type is Year
			restricted
			return current year 	 

		CurrentTimestamp is a DerivedField
			type is Alpha 20
			return current timestamp

				
		DerivedBODCurrentTimeStamp is a DerivedField
			type is Alpha size 25
			restricted
			DerivedBODCurrentTimeStamp = system current timestamp
			return DerivedBODCurrentTimeStamp
			
		DerivedBODFormattedCurrentTimeStamp is a DerivedField
			type is Alpha size 30
			restricted
			return DerivedBODCurrentTimeStamp[1:4] + "-" + DerivedBODCurrentTimeStamp[5:6] + "-" + DerivedBODCurrentTimeStamp[7:8] + "T" + DerivedBODCurrentTimeStamp[9:10] + ":" + DerivedBODCurrentTimeStamp[11:12] + ":" + DerivedBODCurrentTimeStamp[13:14] + "Z"
		 
		DerivedDelimiter is a DerivedField
			type is Alpha size 5
			restricted
			LocalConfigurationParameter = "Generic_Delimiter"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
					
		DerivedTenantID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter = "tenantID"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedReleaseID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter = "releaseID"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedLogicalID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter = "logicalID"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedVersionID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter = "VersionID"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
			
		DerivedappProdline is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter = "appProdline"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedIntegrationApplication is a DerivedField
			type is Alpha size 25
			restricted
			LocalConfigurationParameter = "IntegrationApplication"
			if (FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
					
		DerivedVATRegistrationNumber is a DerivedField
			type is AlphaUpper size 25
			restricted
	    	return TaxEntity.VATRegistrationNumber
	    	
	    DerivedVATRegistrationCountry is a DerivedField
			type is AlphaUpper size 3
			restricted
	    	return TaxEntity.VATRegistrationCountry
	    	
	    DerivedTaxEntitiesName is a DerivedField
			type is AlphaUpper size 10
			restricted
	    	return TaxEntity.Name
	    	
	    DerivedTaxEntityTaxID is a DerivedField
			type is AlphaUpper size 25
			restricted
	    	return TaxEntity.TaxID
	    		
	    DerivedLUTaxIdentificationNumber is a DerivedField
			type is AlphaUpper size 25
			restricted
			if(TaxEntity.VATRegistrationCountry = "LU" and DerivedIntegrationApplication = "Local.ly")
				return DerivedVATRegistrationNumber
			else
	    		return DerivedTaxEntityTaxID
	    	
	    DerivedVatEuropeanSalesCodeTaxCode is a DerivedField 
	    	type is AlphaUpper size 15
	    	restricted
	    	return BODVatEuropeanSalesCodeRel.TaxCode
	    	
	    DerivedAccountingEntity is a DerivedField
			type is Alpha 20
			restricted
			return FinanceEnterpriseGroup+DerivedDelimiter+TaxEntity
			
		DerivedAddressCode is a DerivedField
			type is Alpha 20
			restricted
	    	return BODAccountingEntityRel.AddressCode
		
		DerivedPostalAddressCountry is a DerivedField
			type is Alpha 20
			restricted
			if (BODAddressCodeRel.PostalAddress.Country = "US")
				return "DE"
			else
				return BODAddressCodeRel.PostalAddress.Country
				
		DerivedPostalAddressCountryName is a DerivedField
			type is Alpha 20
			restricted 
			if (BODAddressCodeRel.PostalAddress.CountryName = "USA")
				return " Malmo "
			else
				return BODAddressCodeRel.PostalAddress.CountryName
				
		DerivedAddressLine1 is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.DeliveryAddress.AddressLine1
			
		DerivedAddressLine2 is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.DeliveryAddress.AddressLine2
			
		DerivedAddressLine3 is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.DeliveryAddress.AddressLine3
			
		DerivedAddressLine4 is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.DeliveryAddress.AddressLine4
			
		DerivedPostalCode is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.PostalCode
			
		DerivedRegion is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.PostalAddress.Region
			
		DerivedTelephoneNumbCountry is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.TelephoneNumber.Country
				
		DerivedTelephoneNumbExtension is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.TelephoneNumber.Extension
			
		DerivedSubscriberNumber is a DerivedField
			type is Alpha 20
			restricted 
			return BODAddressCodeRel.TelephoneNumber.SubscriberNumber
			
		DerivedCount is a DerivedField
	    	type is Numeric size 4
	    	restricted
	    	return LocalCount
	    	
	    DerivedBODVariationID is a DerivedField
			type is Alpha 25
			restricted
			return bod id.VariationID
			
		DerivedBODActionCode is a DerivedField
			type is Alpha 10
			restricted
			if (action type.Create)
				return "Add"
			if (action type.Update)
				return "Replace"
			else 
				return "Delete"	
				
		DerivedBODStatus is a DerivedField
			type is Alpha 10
			restricted
			if (action type.Create)
				return "Open"
			else 
			if (action type.Update)
				return "Open"
			else 
			if (action type.Delete)
				return "Deleted"
			else
				return ""
	    
	    DerivedCustomerCountry is a DerivedField
	    	type is AlphaUpper size 3
	    	restricted
	    	return LocalCustomerCountry
			  
		DerivedSubTotalBaseAmount is a DerivedField
	    	type is Decimal 8.3
	    	restricted
	    	if(TaxEntity.VATRegistrationCountry = "ES" or  TaxEntity.VATRegistrationCountry = "AT" or  TaxEntity.VATRegistrationCountry = "DK")
	    		if(LocalSubTotalBaseAmount < -1)
	    			return LocalSubTotalBaseAmount * -1
	    	else
	    		return LocalSubTotalBaseAmount
	    	
	    DerivedCustomerVatRegistrationNumber is a DerivedField
	    	type is Alpha 20
	    	restricted 
	    	if (LocalCustomerVatRegistrationNumber = 0)
	    		return ""
	    	else
	    		return LocalCustomerVatRegistrationNumber
	    	
	    DerivedVendorCustomer is a DerivedField
	    	type is Alpha 20 
	    	restricted
	    	return LocalInnerVendorCustomer
				
		DerivedTransactionCurrency is a DerivedField
	    	type is Alpha 10
	    	restricted
	    	return LocalTransactionCurrency
	    	
	    DerivedOuterTransCurrency is a DerivedField
	    	type is Alpha 10
	    	restricted
	    	return last BODTaxTransactionRel.TransactionCurrency
	    	
	    DerivedVendorCustomerName is a DerivedField
	    	type is Alpha 20 
	    	restricted
	    	return LocalVendorCustomerName
	    	
	    DerivedCustomerMunicipality is a DerivedField
	    	type is Alpha 40 
	    	restricted
	    	return LocalCustomerMunicipality
	    	
	    DerivedCustomerPostalCode is a DerivedField
	    	type is Alpha 20 
	    	restricted
	    	return LocalCustomerPostalCode

		DerivedPeriodType is a DerivedField
			type is Alpha 10
			restricted
			if (LocalPrmTaxPeriod1 != LocalPrmTaxPeriod2  and  LocalPrmTaxPeriod1 !=  LocalPrmTaxPeriod3)
				return "Quarter"
			else
				return "Month"
				
		DerivedDisplayPrmTaxYear1 is a DerivedField
			type is Alpha 10
			restricted
	    	return LocalPrmTaxYear1
	    	
	    DerivedDisplayPrmTaxPeriod1 is a DerivedField
			type is Alpha 10
			restricted
	    	return LocalPrmTaxPeriod1
				
		DerivedDisplayID is a DerivedField
			type is Alpha 10
			restricted
			if (DerivedPeriodType = "Month")
				return DerivedDisplayPrmTaxYear1+DerivedDisplayPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "1")
				return DerivedDisplayPrmTaxYear1+DerivedDisplayPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "4")
				return DerivedDisplayPrmTaxYear1+"2"
			if (LocalPrmTaxPeriod1 = "7")
				return DerivedDisplayPrmTaxYear1+"3"
			else
				return DerivedDisplayPrmTaxYear1+"4"
			

		DerivedDocumentID is a DerivedField
			type is Alpha 40
			restricted
			if (VatReportIDForCountry.CountryCode = "FR")
				return TaxEntity+LocalVatReportId+LocalPrmTaxYear1
			else	
				return TaxEntity + DerivedDelimiter + VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode  + DerivedDelimiter +  LocalPrmTaxYear1
			
		DerivedTradeDeclarationID is a DerivedField
			type is Alpha 40
			restricted
			if (DerivedPeriodType = "Month")
				return VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode + DerivedDelimiter +LocalPrmTaxYear1 + DerivedDelimiter +  LocalPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "1") 
				return VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode + DerivedDelimiter + LocalPrmTaxYear1 + DerivedDelimiter  + LocalPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "4") 
				return VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode + DerivedDelimiter + LocalPrmTaxYear1 + DerivedDelimiter  + "2"	
			if (LocalPrmTaxPeriod1 = "7") 
				return VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode + DerivedDelimiter + LocalPrmTaxYear1 + DerivedDelimiter  + "3"	
			else
				return VatReportIDForCountry.VatReportID + DerivedDelimiter + VatReportIDForCountry.CountryCode + DerivedDelimiter + LocalPrmTaxYear1 + DerivedDelimiter  + "4"	
		
		DerivedPrmTaxPeriod1 is a DerivedField
			type is Alpha 10
			restricted
			if(DerivedVATRegistrationCountry = "BE")
				return LocalPrmTaxPeriod1
			if (DerivedPeriodType = "Month")
				if (LocalPrmTaxPeriod1 < 10) 
					return "0"+ LocalPrmTaxPeriod1
				else
					return LocalPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "1") 
				if(DerivedPostalAddressCountry = "ES" or DerivedPostalAddressCountryName = "Spain")
					return LocalPrmTaxPeriod1 +"T"
				else 
					return  LocalPrmTaxPeriod1
			if (LocalPrmTaxPeriod1 = "4") 
				if(DerivedPostalAddressCountry = "ES" or DerivedPostalAddressCountryName = "Spain")
					return  "2" +"T"
				else
					return "2"
			if (LocalPrmTaxPeriod1 = "7") 
				if(DerivedPostalAddressCountry = "ES" or DerivedPostalAddressCountryName = "Spain")
					return  "3" +"T"
				else
					return "3" 		 
			else
				if(DerivedPostalAddressCountry = "ES" or DerivedPostalAddressCountryName = "Spain")
					return  "4" +"T"
				else
					return "4" 
				
		DerivedNativeBODID is a DerivedField
			type is Alpha 100
			restricted
			return "infor-nid:"+DerivedTenantID+":"+DerivedAccountingEntity+ ":" + DerivedDefaultBODLocation + ":" + DerivedDocumentID+":" + "EUSales: EUSales&verb=Sync&TrackerID="+ LocalFSMInboundBODTracker
					
		DerivedDTLCount is a DerivedField
			type is Alpha 4
			restricted
			return "1"	 
			
		DerivedDefaultBODLocation is a DerivedField
			type is AlphaUpper size 20
			return ""
		
		PartyIDsLUXML is a DerivedField
			type is XMLDocument	
			restricted
			PartyIDsLUXML = template.IONSyncLCLTradeStatistics_VatReportIDForCountry_PartyIDsLU_ST document for this instance
			
		PartyIDsPTXML is a DerivedField
			type is XMLDocument	
			restricted
			PartyIDsPTXML = template.IONSyncLCLTradeStatistics_VatReportIDForCountry_PartyIDsPT_ST document for this instance
			
		FinalPartyIDsXML is a DerivedField
			type is XMLDocument
			restricted 
			if (TaxEntity.VATRegistrationCountry = "LU")
				return PartyIDsLUXML
			else
			if (TaxEntity.VATRegistrationCountry = "PT")
				return PartyIDsPTXML
		
		EUSDtlXml is a DerivedField
			type is XMLDocument	
			restricted
			EUSDtlXml = template.IONSyncLCLTradeStatistics_VatReportIDForCountry_EUSDtl_ST document for this instance
			
		PROPERTIESXML is a DerivedField
			type is XMLDocument
			restricted
			PROPERTIESXML = template.IONSyncLCLTradeStatistics_VatReportIDForCountry_PROPERTIES_ST document for this instance			
			
		LCLEUSalesServiceXMLBOD is a DerivedField
			type is XMLDocument	
			restricted
			LCLEUSalesServiceXMLBOD = template.IONSyncLCLTradeStatistics_VatReportIDForCountry_ST document for this instance
			
		DeclarationLineXML is a DerivedField
			type is XMLDocument
			restricted
			return LocalTaxReportLine

		DisplayIdx is a DerivedField
			type is Alpha size 3
			restricted
			return "[" + Idx + "]" 
		



		TableStyle is a StringField	 
			type is RichText
			"	<style>                                    "
			"	table {                                    "
			"		font-family: arial, sans-serif;        "
			" 		border: 1px solid black;               "
			"		border-collapse: collapse;             "
			"		width: 100%;                           "
			"	}                                          "
            "                                              "
			"	td, th {                                   "
			"		border: 1px solid #dddddd;             "
			"		text-align: left;                      "
			"		padding: 8px;                          "
			"	}                                          "
			"	 td.right {                                "
			"	    text-align: right;                     "
			"	}                                          "
            "                                              "
			"	#d01r {									   "
			"	     text-align: right;                    "
			"	}                                          "
			"	tr:nth-child(even) {                       "
			"		background-color: #dddddd;             "
			"	}                                          "
			"	p {      								   "
			"	    border-bottom: 6px solid red; 		   "
			"	    background-color: lightgrey;  		   "
			"	} 										   "
			"	</style>                                   "
						
		TableHeader is a StringField	 
			type is RichText
			" <h1> "
			" Value Added Tax Return <br>"				
			" </h1> "

		BeginTable is a StringField	 
			type is RichText
			TableStyle
			"<table>"
			
		TableHeader1 is a StringField	 
			type is RichText	
			BeginTable
			" <h2> "
			"  <tr>  "
			"	<th>VatReportId</th>                           "
			"	<td>" VatReportIDForCountry.VatReportID "</td>      "			
			"  </tr>                                                                            "
			"  <tr>  "
			"	<th>Country</th>      "
			"	<td>" VatReportIDForCountry.CountryCode "</td>      "			
			"  </tr>                                                                            "
			"  <tr>  "
			"	<th>Year</th>      "
			"	<td>" LocalVatYear "</td>      "			
			"  </tr>                                                                            "
			"  <tr>  "
			"	<th>Period</th>      "
			"	<td>" VatPeriod "</td>      "			
			"  </tr> "
			" </h2> "
			EndTable
			" <p></p>"		

		TableLineBreak is a StringField	 
			type is RichText
			default label is untranslatable
			" ============================================================================================= "
						
		TableDetail is a StringField	 
			type is RichText
			"  </tr>                                         "
			"	<td>" LocalBoxDescription             "</td>                                                "
			"	<td style=""background-color:#000000;color:white;text-align: center;"">" BoxNumber     "</td> "  
			"	<td style=""text-align: right;"">" BoxNumberTotal  "</td> "   
			"  </tr>                                         "	
					
		EndTable is a StringField	 
			type is RichText
			"</table>                                        "

		EndDelimeter is a StringField	 
			type is RichText
			"</pre>"	
							
		DerivedVatReturnResults is a StringField
			type is Text	 
			"<TableHeader>"	
			"<TableHeader1>"
			"<TableDetail>"
			"<EndTable>"			

		VatReturnHeader is a StringField	 
			type is RichText	
			"<pre>"	
			"+==================================================================================+<br>"
			"|  Date..................: " CurrentTimestamp	 	                   		    	"<br>"	 
			"+==================================================================================+<br>"
			"+                         * * *   VAT Return Report  * * *                         |<br>"				
			"+==================================================================================+<br>"	
			"| Company................:" VatReportIDForCountry.VatReportID 						"<br>"	 
			"| TransactionId..........:" VatReportIDForCountry.CountryCode 						"<br>"	 
			"| DocumentDate...........:" LocalVatYear 											"<br>"	 
			"| DocumentNumber.........:" LocalVatPeriod 										"<br>"	 
			"+==================================================================================+<br>"		 
			"<table>                                            								"
			"  <tr>                                                                             "
			"	<th>" LocalBoxDescription "</th>                                                "
			"  </tr>                                                                            "
			"  <tr>                                                                             "
			"	<td>" BoxNumber      "</td>                                                     "
			"  </tr>                                                                            "
			"</table>                                                                           "
			"</pre>"		

		VatBoxAdjustmentsDetail is a StringField	 
			type is RichText
			"  <tr>                                                                             "
			"	<td>" LocalBoxDescription  "</td>                                               "
			"	<td>" LocalAdjustByVatBox  "</td>                                               "
			"	<td>" LocalBoxBaseTaxAmount"</td>                                       		"  
			"  </tr>                                                                            "	

		GetLastVatReportingLine	is a DerivedField			  
			type is Numeric 3
			restricted
			return (instance count of VatReportingLineRel)
						
    Relations

        VatReportingLineRel
            classic name is VATRPT-LINES
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup	= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity				= TaxEntity 	

            Instance Selection
                where (related.VatReportIDForCountry.VatReportID = VatReportIDForCountry.VatReportID
                and   related.VatReportIDForCountry.CountryCode = VatReportIDForCountry.CountryCode)

       	TaxTransactionTaxCodesRel
            one-to-many relation to TaxTransaction
            Field Mapping uses symbolic key	
            	related.FinanceEnterpriseGroup	= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 				= VatReportIDForCountry.TaxEntity



       	TaxCalendarsRel
            one-to-many relation to TaxCalendar 
            Field Mapping uses symbolic key
                related.FinanceEnterpriseGroup 	= TaxEntity.FinanceEnterpriseGroup
           	Instance Selection
                where (related.TaxCalendar.TaxEntity 	= TaxEntity)

                
       	TaxCalendarPeriodsRel
            one-to-many relation to TaxCalendarPeriod
            Field Mapping uses symbolic key
                related.FinanceEnterpriseGroup 	= TaxEntity.FinanceEnterpriseGroup
           	Instance Selection
                where (related.TaxCalendar.TaxEntity 	= TaxEntity)



        VatReportingLineTaxCodesRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
            Instance Selection
                where (related.TaxUsageIndicator  			= "T")

        VatReportingLineTaxUsageCodesRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
            Instance Selection
                where (related.TaxUsageIndicator  			= "U")
                                
        VatReportingTaxCodesRel
            one-to-many relation to VatUsageCode
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode

			Instance Selection
                where (related.VatReportingLine	  			= VatReportingLineTaxCodesRel.VatReportingLine)

        VatReportingTaxUsageCodesRel
            one-to-many relation to VatUsageCode
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
			Instance Selection
                where (related.VatReportingLine 		  	= VatReportingLineTaxCodesRel.VatReportingLine)
                
       	TaxTransactionsForLineRel
            one-to-many relation to TaxTransaction
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 							= VatReportIDForCountry.TaxEntity
   			Instance Selection

                where 	(related.TaxUsageCode not entered
                and      related.TaxCode					= VatReportingTaxCodesRel.VatUsageCode.VatCode)						  		 



       	PayablesInvoiceWithholdingRel
            one-to-many relation to PayablesInvoiceWithholding

            Field Mapping uses ByReportableRecords	 
            	related.Reportable							= true
				related.Company								= GeneralLedgerCompanyRel.Company
					
		GeneralLedgerCompanyRel
			one-to-many relation to GeneralLedgerCompany
			Field Mapping uses ByAccountingEntity
				related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup
                related.AccountingEntity					= VatReportIDForCountry.TaxEntity	
                
		VendorGroupGlobalWithholdingRel
			one-to-many relation to VendorGroup
			Field Mapping uses symbolic key
			Instance Selection
				where (related.VendorGroup.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
				and    related.GlobalWithholding)				
 


























		VatPurchaseAndSalesDistributionRel
            one-to-many relation to VatPurchaseSaleDistribution
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 							= VatReportIDForCountry.TaxEntity

		VatPurchaseSaleTransactionsRel
            one-to-many relation to VatPurchaseSaleTransaction
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 							= VatReportIDForCountry.TaxEntity

		VatPurchaseAndSalesDistributionRel2
            one-to-many relation to VatPurchaseSaleDistribution
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup
                related.TaxEntity 							= VatReportIDForCountry.TaxEntity
            Instance Selection
                where (related.PurchaseOrSalesTransaction.SalesOnly
                and    related.SalesTransactions
                or     related.PurchaseOrSalesTransaction.PurchaseOnly
                and    related.PurchaseTransactions
                or     related.PurchaseOrSalesTransaction.Both)

  		JournalDetailPurgeReportRel									
			one-to-many relation to JournalDetailPurgeReport
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup				=  VatReportIDForCountry.TaxEntity.FinanceEnterpriseGroup
				


		VatReportIDForCountryRel
			one-to-one relation to VatReportIDForCountry
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode   

       	VatReportingLine4ReturnRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode   
                
        VatReportingCodesRel
            classic name is VATRPT-CODES
            one-to-many relation to VatUsageCode
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup						= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity									= TaxEntity 	
            Instance Selection
                where (related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                and    related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode  
                and    related.VatUsageCode.VatReportingLine 		= LocalVatReportingLine)
                
       	TaxTransactionsForReturnLineRel	 
            one-to-many relation to TaxTransaction
            Field Mapping uses symbolic key	 
            	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup 
                related.TaxEntity 							= TaxEntity
                
     	EntityTaxCodeForVatRel		 
            one-to-one relation to EntityTaxCode
          	Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
                related.TaxEntity 							= TaxEntity
                related.TaxCode 							= SelectTaxCode


       	VatReportingSummaryCodesRel
            one-to-many relation to VatReportingDetail
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode   
                related.VatReportingLine 					= LocalVatReportingLine
      		Instance Selection
                where (related.VATBoxNumber					= LocalVATBoxNumber)     



       	AdjustVatBoxesRel
            one-to-many relation to VatLineAdjustment  
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
                related.VatReportingLine 					= LocalVatReportingLine

       	SummaryReportingLineBoxNbrRel
            one-to-many relation to VatReportingLine
            Field Mapping uses ByBoxNumber	
		    	related.FinanceEnterpriseGroup				= FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode
                related.VATBoxNumber  						= LocalAdjustByVatBox
                related.VatReportingLine					= LocalVatReportingLine



       	VatReportingLine4ReturnSummaryRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode  
           	Instance Selection
                where (related.TaxUsageIndicator 			= "S")

                

        VatReportingDetailRel
            one-to-many relation to VatReportingDetail
            delete cascades
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup			  = TaxEntity.FinanceEnterpriseGroup
   				related.TaxEntity						  = TaxEntity 	            
                related.VatReportIDForCountry.VatReportID = VatReportIDForCountry.VatReportID
                related.VatReportIDForCountry.CountryCode = VatReportIDForCountry.CountryCode
                related.VatReportingLine   			  	  = LocalVatReportingLine	

      	NonSummaryReportingLinesRel
            one-to-many relation to VatReportingLine
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup				= FinanceEnterpriseGroup
    			related.TaxEntity							= TaxEntity 	
                related.VatReportIDForCountry.VatReportID 	= VatReportIDForCountry.VatReportID  
                related.VatReportIDForCountry.CountryCode 	= VatReportIDForCountry.CountryCode  
           	Instance Selection
                where (related.TaxUsageIndicator 			= "T"
                or     related.TaxUsageIndicator 			= "U")
                

        FSMBODConfigurationParameterRel
        	one-to-one relation to FSMBODConfigurationParameter
			Field Mapping uses symbolic key
            	related.FSMBODConfigurationParameter 		= LocalConfigurationParameter
        
        FSMBODConfigurationRel
        	one-to-one relation to FSMBODConfiguration
			Field Mapping uses symbolic key
            	related.FSMBODConfiguration.Verb 		= 1
            	related.FSMBODConfiguration.Noun 		= "LCLTradeStatistics"
            	related.FSMBODConfiguration.Direction 	= 1
				
		BODAccountingEntityRel
			one-to-many relation to AccountingEntity
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup			= FinanceEnterpriseGroup
				related.AccountingEntity                = TaxEntity
				
		BODAddressCodeRel
			one-to-many relation to AddressCode
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup			= FinanceEnterpriseGroup
				related.AddressCode                       = DerivedAddressCode
				
		BODVatEuropeanSalesCodeRel
			one-to-many relation to VatEuropeanSalesCode
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup				       = FinanceEnterpriseGroup
				related.TaxEntity                       		   = TaxEntity
				related.VatReportIDForCountry.VatReportID          = VatReportIDForCountry.VatReportID	
				related.VatReportIDForCountry.CountryCode		= 	VatReportIDForCountry.CountryCode	
				
		BODTaxTransactionRel
			one-to-many relation to TaxTransaction
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup				       = FinanceEnterpriseGroup
				related.TaxEntity                       		   = TaxEntity
			Instance Selection
                where (related.TaxYear=LocalPrmTaxYear1
                and related.SystemCode = "AR" 
                and (related.TaxPeriod=LocalPrmTaxPeriod1
                or related.TaxPeriod=LocalPrmTaxPeriod2
                or related.TaxPeriod=LocalPrmTaxPeriod3))	
                

        BODTaxTransactionVenCustRel
			one-to-many relation to TaxTransaction
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup				       = FinanceEnterpriseGroup
				related.TaxEntity                       		   = TaxEntity
			Instance Selection
                where (related.TaxYear=LocalPrmTaxYear1
                and related.SystemCode = "AR" 
                and related.VendorCustomer=LocalVendorCustomer
                and (related.TaxPeriod=LocalPrmTaxPeriod1
                or related.TaxPeriod=LocalPrmTaxPeriod2
                or related.TaxPeriod=LocalPrmTaxPeriod3))	
                
		BODCompanyCustomerRel
			one-to-many relation to CompanyCustomer
			Field Mapping uses symbolic key
				related.Company				       = LocalOrigCompany
				related.Customer                   = LocalVendorCustomer
				
		
		BODCustomerRel
			one-to-many relation to Customer
			Field Mapping uses symbolic key
				related.CustomerGroup		       = LocalCustomerGroup
				related.Customer                   = LocalVendorCustomer
				

                                                                				
		NewVatReportIDForCountryRel
            one-to-one relation to VatReportIDForCountry
            Field Mapping uses symbolic key
		    	related.FinanceEnterpriseGroup			  = FinanceEnterpriseGroup	
    			related.TaxEntity						  = LocalNewTaxEntity
                related.VatReportIDForCountry.VatReportID = LocalNewVatReportID		
                related.VatReportIDForCountry.CountryCode = LocalNewCountryCode 	
                 	               							 	




		FSMInboundBODTrackerRel
            one-to-one relation to FSMInboundBODTracker
            Field Mapping uses symbolic key
                related.FSMInboundBODTracker	= LocalFSMInboundBODTracker
                       	           
	Rule Blocks
				
		NativeLPLRuleblock
			initialize LocalSubTotalBaseAmount
			if (BODTaxTransactionRel exists)
				for each distinct VendorCustomer in BODTaxTransactionRel
					LocalCount = 1
					LocalVendorCustomer = each.VendorCustomer
					if (BODTaxTransactionVenCustRel exists)
						for each BODTaxTransactionVenCustRel 
							LocalOrigCompany	= each.InvoiceCompany.OrigCompany
							LocalTransactionCurrency = each.TransactionCurrency
							LocalInnerVendorCustomer = each.VendorCustomer
							LocalVendorCustomerName = each.VendorCustomerName 
							LocalSubTotalBaseAmount += each.BaseInvoiceAmount.TransactionAmount
					initialize LocalCustomerAddressLine1
					initialize LocalCustomerAddressLine2
					initialize LocalCustomerAddressLine3
					initialize LocalCustomerAddressLine4
					initialize LocalCustomerPostalCode
					initialize LocalCustomerMunicipality
					initialize LocalCustomerCountry
					if (BODCompanyCustomerRel exists)		
						for each BODCompanyCustomerRel
							LocalCustomerVatRegistrationNumber =  each.VATRegistrationNumber
							LocalCustomerGroup= each.CustomerGroup
							if (BODCustomerRel exists)		
								for each BODCustomerRel
									LocalCustomerAddressLine1 = each.PostalAddress.DeliveryAddress.AddressLine1
     								LocalCustomerAddressLine2 =  each.PostalAddress.DeliveryAddress.AddressLine2
     								LocalCustomerAddressLine3 = each.PostalAddress.DeliveryAddress.AddressLine3
     								LocalCustomerAddressLine4 =  each.PostalAddress.DeliveryAddress.AddressLine4
     								LocalCustomerPostalCode =    each.PostalAddress.PostalCode
     								LocalCustomerMunicipality =   each.PostalAddress.Municipality
     								LocalCustomerCountry =        each.PostalAddress.Country
				LocalTaxReportLine += template.IONSyncLCLTradeStatistics_VatReportIDForCountry_DeclarationLine_ST document for this instance
		
		GetVatTaxTransactions	
			for each TaxTransactionsForReturnLineRel



				if (LocalTaxUsageIndicator 			= "T"
				and each.TaxCode 					= SelectTaxCode
				or (LocalTaxUsageIndicator 			= "U"
				and each.TaxUsageCode 				= SelectTaxCode))

					if (each.TaxPointDate year 		= LocalVatYear
					and each.TaxPointDate month 	= LocalVatPeriod
					and each.TransactionSource  	= LocalSource)

						if (LocalInvoiceOrCredit = "B"

						or  LocalInvoiceOrCredit = each.InvoicedOrCreditMemo)
							BoxNumberTotal 			= BoxNumberTotal + each.TransactionTaxAmount
				else
				if (LocalTaxUsageIndicator 			= "S")



					if (VatReportingSummaryCodesRel exist)
						for each VatReportingSummaryCodesRel 
							BoxNumberTotal = each.SummarizedBaseTaxAmt						

		LoadVatTable








			Idx = Idx + 1
			VatBoxTable.VatBoxData[Idx].BoxNumber 	 	= BoxNumber

			VatBoxTable.VatBoxData[Idx].BoxDescription 	= LocalBoxDescription   
			VatBoxTable.VatBoxData[Idx].BoxTotal 		= BoxNumberTotal






		PrintVatBoxTable
			initialize Idx

			while (Idx < 9)
				Idx = Idx + 1
				if (VatBoxTable.VatBoxData[Idx].BoxNumber entered)
					VatReturnPreview = VatReturnPreview + "Box.:" + VatBoxTable.VatBoxData[Idx].BoxNumber + "<br>"
					VatReturnPreview = VatReturnPreview + "Amt.:" + VatBoxTable.VatBoxData[Idx].BoxTotal + "<br>"
					VatReturnPreview = VatReturnPreview + "Desc:" + VatBoxTable.VatBoxData[Idx].BoxDescription + "<br>"
				else	
					end while		
											
		UpdateSummaryLines
			display "TestingThis"	






			initialize Idx
			for each VatReportingLine4ReturnSummaryRel		
				initialize LocalTotalTaxAmount
				LocalVatReportingLine 	= each.VatReportingLine
				FindBoxNumber 			= each.VATBoxNumber 							 
				for each VatReportingDetailRel	
		            if (each.EffectOnVatBox.SubtractFromVatBox)
		            	LocalTotalTaxAmount -= each.DerivedLineTaxTotal
		            else
		        		LocalTotalTaxAmount += each.DerivedLineTaxTotal	            				
		        
		        include UpdateSummaryBoxNumber		
		        		
		        invoke Update each
		        	invoked.TotalTaxAmount = LocalTotalTaxAmount	

		UpdateSummaryBoxNumber	
			initialize Idx
			while (Idx < 9)

				Idx = Idx + 1
				if (VatBoxTable.VatBoxData[Idx].BoxNumber 	= FindBoxNumber)
					VatBoxTable.VatBoxData[Idx].BoxTotal 	= LocalTotalTaxAmount	

		PrintVatBoxes
			initialize Idx
			VatReturnPreview = VatReturnPreview + "<pre>"
			while (Idx < 9)
				Idx = Idx + 1

				if (VatBoxTable.VatBoxData[Idx].BoxNumber entered)
					BoxNumber 			= VatBoxTable.VatBoxData[Idx].BoxNumber				
					BoxNumberTotal 		= VatBoxTable.VatBoxData[Idx].BoxTotal		    	
					LocalBoxDescription = VatBoxTable.VatBoxData[Idx].BoxDescription
					VatReturnPreview = VatReturnPreview + TableDetail	
				else	
					end while		
			VatReturnPreview = VatReturnPreview + "</pre>"
		        																	      		
		AdjustVatLineAmounts	





			initialize LocalBoxBaseTaxAmount
			for each VatReportingLine4ReturnRel
				LocalVatReportingLine = each.VatReportingLine
				LocalLineBoxNumber    = each.VATBoxNumber
				VatReturnPreview = VatReturnPreview + "LocalVatReportingLine:" + LocalVatReportingLine + "Box:" + LocalLineBoxNumber + "<br>" 

				if (each.AdjustVatBoxesRel exist)
					VatReturnPreview = VatReturnPreview + "LocalVatReportingLine:Here1" + LocalVatReportingLine + "<br>"
					VatReturnPreview = VatReturnPreview + BeginTable
					LocalAdjustByVatBox = first VatReportingLine4ReturnRel.AdjustVatBoxesRel.AdjustByVatBox				 
					LocalBoxDescription	= first VatReportingLine4ReturnRel.AdjustVatBoxesRel.AdjustDescription
					LocalTotalTaxAmount = first VatReportingLine4ReturnRel.AdjustVatBoxesRel.DerivedAdjByAmount
					LocalEffectOnVatBox = first VatReportingLine4ReturnRel.AdjustVatBoxesRel.EffectOnVatBox

					VatReturnPreview = VatReturnPreview + "LocalVatReportingLine:Here2" + LocalVatReportingLine + "TaxTtl:" + LocalTotalTaxAmount + "<br>"
		        	if (LocalEffectOnVatBox.AddTo)
		        		LocalBoxBaseTaxAmount += LocalTotalTaxAmount
		            if (LocalEffectOnVatBox.SubtractFrom)
		            	LocalBoxBaseTaxAmount -= LocalTotalTaxAmount
					VatReturnPreview = VatReturnPreview + "LocalLineBoxNumber:" + LocalLineBoxNumber + "AdjByVatBox:" + LocalAdjustByVatBox + "TaxTtl:" + LocalBoxBaseTaxAmount + "<br>"
					VatReturnPreview = VatReturnPreview + VatBoxAdjustmentsDetail   		
         			VatReturnPreview = VatReturnPreview + EndTable	




					LocalAdjustTotalTaxAmount = each.TotalTaxAmount + LocalBoxBaseTaxAmount				
					invoke Update each
						invoked.TotalAdjustmentAmount = LocalBoxBaseTaxAmount	
						invoked.TotalTaxAmount = LocalAdjustTotalTaxAmount
						


																								      			                
	Context Fields
		PurchaseOrSalesTransaction
		FSMInboundBODTracker
		 
	Conditions
		VatPurchaseAndSalesDistributionRelExist
			restricted
			when (VatPurchaseAndSalesDistributionRel exist) 	
		VatPurchaseAndSalesTransactionRelExist
			restricted
			when (VatPurchaseSaleTransactionsRel exist) 
	 	PurchaseOrSalesJournalRecordsExist
	 		restricted
	 		when (VatPurchaseAndSalesTransactionRelExist
	 		or    VatPurchaseAndSalesDistributionRelExist)	
	 	VatPurchaseAndSalesDistributionRel2Exist
	 		restricted
	 		when (VatPurchaseAndSalesDistributionRel2 exist)	
	 	VatReturnPreviewHasValues
	 		restricted
	 		when (VatReturnPreview entered)	
	 	GlobalWithholdingEnabled
	 		restricted
	 		when (VendorGroupGlobalWithholdingRel exists)
		JournalDetailPurgeReportExist
			when (JournalDetailPurgeReportRel exist)
				 							 											                                
    Sets

        Set2
            indexed
            Sort Order
            	TaxEntity

                VatReportIDForCountry.VatReportID


    Actions
       	Create is a Create Action
        Update is an Update Action
        Delete is a Delete Action
			Entrance Rules
			    if (VatReportingLineRel exist)
	        		invoke Delete VatReportingLineRel
            		
        TriggerEUSales is an Instance Action 
	  	 	restricted
	  	 	Parameters
	  	 	
	  	 		PrmTaxEntity      is a TaxEntity
				PrmVatSalesCode	  is Alpha size 10
				PrmTaxYear1		  is Numeric size 10
				PrmTaxYear2       is Numeric size 10
				PrmTaxYear3       is Numeric size 10
				PrmTaxPeriod1     is Numeric size 10
				PrmTaxPeriod2     is Numeric size 10
				PrmTaxPeriod3     is Numeric size 10
 	
	  	 	Local Fields
				ActionCode			 is Alpha size 1
					States
						Create  value is "C"
						Update	value is "U"
						Delete	value is "D"
				LocalFinanceEnterpriseGroup  is like FinanceEnterpriseGroup
					  	 		
			Action Rules
				display"FinanceEnterpriseGroup<PrmTaxEntity.FinanceEnterpriseGroup>"
				display"AccountingEntity<PrmTaxEntity>"
				if (PrmTaxEntity.FinanceEnterpriseGroup.BODTrigger)
					ActionCode = ActionCode.Create
					LocalFinanceEnterpriseGroup = PrmTaxEntity.FinanceEnterpriseGroup
					increment bod id.VariationID

					trigger "EUSalesService" PA service
						resume on error
						title is "EG:<PrmTaxEntity.FinanceEnterpriseGroup>AE:<PrmTaxEntity>"
						Criteria
							LocalFinanceEnterpriseGroup
							PrmTaxEntity

						Variables
							ActionCode
							bod id.VariationID
								variable name is BODVariationId
							LocalBODCurrentTimeStamp.OutputBODCurrentTimeStamp
								variable name is CurrentTimeStamp
							PrmTaxEntity
								variable name is PrmTaxEntity
							LocalFinanceEnterpriseGroup
								variable name is FinanceEnterpriseGroup		
							PrmTaxYear1
								variable name is TaxYear1
							PrmTaxYear2
								variable name is TaxYear2
							PrmTaxYear3
								variable name is TaxYear3																
							PrmTaxPeriod1
								variable name is TaxPeriod1
							PrmTaxPeriod2
								variable name is TaxPeriod2
							PrmTaxPeriod3
								variable name is TaxPeriod3	
							PrmVatSalesCode
								variable name is VatSalesCode
																															
							VatReportIDForCountry.VatReportID
								variable name is VatReportID
								
							VatReportIDForCountry.CountryCode
								variable name is CountryCode
								









		UpdateBODIdFields is an Instance Action
			restricted
			Parameters
				PrmAccountingEntity  is Alpha size 22
					default label is "AccountingEntity"
				PrmLocation          is Alpha size 22
					default label is "Location" 
				PrmDocumentID        is Alpha size 100
					default label is "DocumentID"
				PrmRevision          is Alpha size 22
					default label is "Revision"	
				PrmSystemOfRecord    is Alpha size 1
					default label is "SystemOfRecord"
				PrmVariationID       is Alpha size 22
					default label is "VariationID"	
			Action Rules
				if (bod id.AccountingEntity != PrmAccountingEntity)
					bod id.AccountingEntity 	= PrmAccountingEntity
				if (bod id.Location != PrmLocation)
					bod id.Location				= PrmLocation
				if (bod id.DocumentID != PrmDocumentID)
					bod id.DocumentID			= PrmDocumentID
				if (bod id.Revision != PrmRevision)
					bod id.Revision				= PrmRevision
				if (bod id.SystemOfRecord != PrmSystemOfRecord)
					bod id.SystemOfRecord		= PrmSystemOfRecord
				if (bod id.VariationID != PrmVariationID)
					bod id.VariationID			= PrmVariationID				
								

		VatReturnsPreview is an Instance Action		

	 		default label is untranslatable
			restricted	
			Parameters
				PrmVatYear			is Year
					default label is "VatYear"	
				PrmVatPeriod		is Numeric 2	
					default label is "VatPeriod"	
				PrmPrintDetail		is Boolean	
					default label is "PrintDetail"	 
			Local Fields
			Parameter Rules
				PrmVatYear
					initial value is CurrentYear		//"2020"
				PrmVatPeriod
					initial value is "04"	//current date month	//"04"
			Action Rules


				VatYear						 = PrmVatYear
				LocalVatYear				 = VatYear
				VatPeriod					 = PrmVatPeriod
				LocalVatPeriod				 = VatPeriod
				initialize VatReturnPreview
				initialize Idx



				if (VatReportIDForCountryRel exist)	
					VatCountry = VatReportIDForCountryRel.VatReportIDForCountry.CountryCode 
					VatReturnPreview = VatReturnPreview + TableHeader				
					VatReturnPreview = VatReturnPreview + TableHeader1	



					if (VatReportingLine4ReturnRel exist)


						VatReturnPreview = VatReturnPreview + BeginTable
						for each VatReportingLine4ReturnRel	// Change this or create a new one for Indicator = "T" or "U", then do all summary lines.

							initialize BoxNumberTotal
							LocalVatReportingLine   	= each.VatReportingLine
							LocalBoxDescription			= each.Description
							BoxNumber 	         		= each.VATBoxNumber
							LocalVATBoxNumber			= each.VATBoxNumber

							LocalSource 		 		= each.Source
							LocalInvoiceOrCredit 		= each.InvoicedOrCreditMemo
							LocalTaxUsageIndicator 		= each.TaxUsageIndicator
							LocalGoodsAndServicesInd 	= each.GoodsAndServicesIndicator
							if (LocalGoodsAndServicesInd = "B")				
								LocalGoodsAndServicesInd = blank			
							for each VatReportingCodesRel					

								SelectTaxCode 			= each.VatUsageCode.VatCode

								if (EntityTaxCodeForVatRel.GoodsAndServicesIndicator = LocalGoodsAndServicesInd
								or  LocalGoodsAndServicesInd not entered) 


									include GetVatTaxTransactions
							include LoadVatTable	


							invoke Update each
								initialize invoked.TotalTaxAmount 
								invoked.TotalTaxAmount	= BoxNumberTotal  




					include UpdateSummaryLines			
					include PrintVatBoxes		












					VatReturnPreview = VatReturnPreview + EndTable		


					VatReturnPreview = VatReturnPreview + "<h4>VATReturnTest.Successfull" + CurrentTimestamp + "......</h4><br>"
					if (PrmPrintDetail)					
						include PrintVatBoxTable			
				else
					VatReturnPreview = "<pre> <h2> VATReturnTest...UnSuccessful.:ReportIDCombinationDoesNotExist.." + CurrentTimestamp + "......</h2></pre>"	


		AdjustedBoxTotalsAmt is an Instance Action	
	 		default label is untranslatable
			restricted		
			Action Rules
				include AdjustVatLineAmounts


		UpdateSummaryBoxTotals is an Instance Action	

	 		default label is untranslatable
			restricted		
			Action Rules
				for each VatReportingLine4ReturnSummaryRel
					initialize LocalTotalTaxAmount
					initialize Idx
					LocalVatReportingLine = each.VatReportingLine
					LocalBoxDescription	  = each.Description
					BoxNumber 	          = each.VATBoxNumber
					BoxNumberTotal		  = each.TotalTaxAmount
					for each VatReportingDetailRel	 							 




			            if (each.EffectOnVatBox.SubtractFromVatBox)
			            	LocalTotalTaxAmount -= each.DerivedLineTaxTotal
			            else
			        		LocalTotalTaxAmount += each.DerivedLineTaxTotal	     
			        		
			        include LoadVatTable	       				
					VatReturnPreview = VatReturnPreview + DisplayIdx + "(1)Box.:" + VatBoxTable.VatBoxData[Idx].BoxNumber + "<br>"		
					VatReturnPreview = VatReturnPreview + DisplayIdx + "(1)Amt.:" + VatBoxTable.VatBoxData[Idx].BoxTotal + "<br>"
					VatReturnPreview = VatReturnPreview + DisplayIdx + "(1)Desc:" + VatBoxTable.VatBoxData[Idx].BoxDescription + "<br>"
			        invoke Update each
			        	invoked.TotalTaxAmount = LocalTotalTaxAmount		
			        		

		AddUpNonSummaryLines is an Instance Action		

	 		default label is untranslatable
			restricted	
			Parameters
				PrmVatYear			is Year
				PrmVatPeriod		is Numeric 2		 
			Local Fields
			Parameter Rules
				PrmVatYear
					initial value is "2020"
				PrmVatPeriod
					initial value is "04"
			Action Rules
				VatYear						 = PrmVatYear
				LocalVatYear				 = VatYear
				VatPeriod					 = PrmVatPeriod
				LocalVatPeriod				 = VatPeriod

				initialize Idx



				if (VatReportIDForCountryRel exist)
					VatCountry = VatReportIDForCountryRel.VatReportIDForCountry.CountryCode 
					if (NonSummaryReportingLinesRel exist)
						Idx = Idx + 1
						for each VatReportingLine4ReturnRel	 
							initialize BoxNumberTotal
							LocalVatReportingLine   	= each.VatReportingLine
							LocalBoxDescription			= each.Description
							BoxNumber 	         		= each.VATBoxNumber
							LocalVATBoxNumber			= each.VATBoxNumber
							LocalSource 		 		= each.Source
							LocalInvoiceOrCredit 		= each.InvoicedOrCreditMemo
							LocalTaxUsageIndicator 		= each.TaxUsageIndicator
							LocalGoodsAndServicesInd 	= each.GoodsAndServicesIndicator
							for each VatReportingCodesRel
								SelectTaxCode 			= each.VatUsageCode.VatCode
								if (EntityTaxCodeForVatRel.GoodsAndServicesIndicator = LocalGoodsAndServicesInd
								or  LocalGoodsAndServicesInd not entered) 
									include GetVatTaxTransactions
							invoke Update each
								initialize invoked.TotalTaxAmount 
								invoked.TotalTaxAmount	= BoxNumberTotal  
								

		ClearLineBoxTotals is an Instance Action		

	 		default label is untranslatable
			restricted		

			Action Rules

				for each VatReportingLine4ReturnRel
					LocalVatReportingLine = each.VatReportingLine
					LocalLineBoxNumber    = each.VATBoxNumber				
					invoke Update each 	 
						initialize invoked.TotalTaxAmount
						initialize invoked.TotalAdjustmentAmount




		
		SendLCLTradeStatisticsNativeLPLBOD is an Instance Action
			restricted
			Entrance Rules
			Parameters
			Action Rules
				send ion bod
					bod is LCLEUSalesServiceXMLBOD
					bod type is "Sync.LCLTradeStatistics"	
					accounting entity is DerivedAccountingEntity
					document id is DerivedDocumentID
					variation id is DerivedBODVariationID
										        							
		TriggerEUSalesNativeLPLBOD is an Instance Action
			restricted
			Parameters
				PrmVatSalesCode		is Alpha size 10
				PrmTaxYear1 		is Numeric size 10
				PrmTaxYear2 		is Numeric size 10
				PrmTaxYear3 		is Numeric size 10
				PrmTaxPeriod1 		is Numeric size 10
				PrmTaxPeriod2 		is Numeric size 10
				PrmTaxPeriod3 		is Numeric size 10
			Action Rules
				LocalPrmVatSalesCode	= PrmVatSalesCode
				LocalPrmTaxYear1 		= PrmTaxYear1
				LocalPrmTaxYear2 		= PrmTaxYear2
				LocalPrmTaxYear3 		= PrmTaxYear3
				LocalPrmTaxPeriod1 		= PrmTaxPeriod1
				LocalPrmTaxPeriod2 		= PrmTaxPeriod2
				LocalPrmTaxPeriod3 		= PrmTaxPeriod3	
				invoke NativeLPLBODTriggerChecks FSMBODConfigurationRel
					invoked.PrmVerb 					= 1
					invoked.PrmNoun						= "LCLTradeStatistics"
					invoked.PrmDirection				= 1
					invoked.PrmTriggerFrom				= "VatReportIDForCountry"
					invoked.PrmFinanceEnterpriseGroup	= FinanceEnterpriseGroup
					invoked.PrmAccountingEntity			= TaxEntity
					invoked.PrmMainUserTemplate			= "IONSyncLCLTradeStatistics_VatReportIDForCountry_ST"
				NativeLPLBODTrigger = FSMBODConfigurationRel.NativeLPLBODTrigger
				if (FinanceEnterpriseGroup.BODTrigger and NativeLPLBODTrigger)
					include NativeLPLRuleblock
					if(FSMInboundBODTracker not entered)
						invoke Create FSMInboundBODTracker
							assign result to NewBODTracker
							invoked.Verb 					= 1
							invoked.Noun 					= "LCLTradeStatistics"					
							invoked.BODDocumentID			= DerivedDocumentID
							invoked.Status					= 1
							invoked.StartDate				= system current timestamp
							invoked.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
							invoked.Direction				= 1
							invoked.BODAccountingEntity		= DerivedAccountingEntity
							invoked.BODLocation				= VatReportIDForCountry.VatReportID
							invoked.Invoice					= LocalPrmVatSalesCode
							invoked.RunGroup				= TaxEntity
							invoked.Customer				= LocalPrmTaxYear1
							invoked.Reference1				= VatReportIDForCountry.CountryCode
							invoked.BODVariationID			= LocalPrmTaxYear2
							invoked.Reference2              = "VatReportIDForCountry" 
							invoked.Reference3				= LocalPrmTaxYear3 	
							invoked.Reference4				= LocalPrmTaxPeriod1 
							invoked.Reference5				= LocalPrmTaxPeriod2 
							invoked.Vendor					= LocalPrmTaxPeriod3
							initialize invoked.Error			
							initialize invoked.ErrorMessage					
						LocalFSMInboundBODTracker	= NewBODTracker.FSMInboundBODTracker
					else 
						LocalFSMInboundBODTracker		= FSMInboundBODTracker
						invoke Update FSMInboundBODTrackerRel
							invoked.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
							invoked.BODDocumentID			= DerivedDocumentID
							invoked.Status					= 1
							invoked.StartDate				= system current timestamp
							invoked.Direction				= 1
							invoked.BODAccountingEntity		= DerivedAccountingEntity
							invoked.BODLocation				= VatReportIDForCountry.VatReportID
							invoked.Invoice					= LocalPrmVatSalesCode
							invoked.RunGroup				= TaxEntity
							invoked.Customer				= LocalPrmTaxYear1
							invoked.Reference1				= VatReportIDForCountry.CountryCode
							invoked.BODVariationID			= LocalPrmTaxYear2
							invoked.Reference2              = "VatReportIDForCountry"
							invoked.Reference3				= LocalPrmTaxYear3 	
							invoked.Reference4				= LocalPrmTaxPeriod1 
							invoked.Reference5				= LocalPrmTaxPeriod2 
							invoked.Vendor					= LocalPrmTaxPeriod3
							initialize invoked.Error			
							initialize invoked.ErrorMessage
					invoke SendLCLTradeStatisticsNativeLPLBOD
						resume on error
	                   		Error            							= true
	                        ErrorMessage     							= error message
	                if(Error)
						invoke Update FSMInboundBODTrackerRel
							invoked.Error 								= Error
							invoked.ErrorMessage 						= ErrorMessage
							invoked.Status								= 2
							invoked.CloseDate							= system current timestamp
							invoked.BODID								= DerivedNativeBODID
							invoked.BODXML								= LCLEUSalesServiceXMLBOD
					else
						invoke Update FSMInboundBODTrackerRel
							invoked.Status									= 3
							invoked.CloseDate								= system current timestamp
							invoked.BODID									= DerivedNativeBODID
							invoked.BODXML									= LCLEUSalesServiceXMLBOD

		DisplaySummaryLines is an Instance Action
			default label is untranslatable
			restricted			

			Action Rules 
				initialize Idx
				if (VatReportingLine4ReturnRel exist)
					for each VatReportingLine4ReturnRel
						if (each.TaxUsageIndicator.Sum)
							LocalVatReportingLine 	= each.VatReportingLine
							LocalBoxDescription 	= each.Description
							BoxNumber 				= each.VATBoxNumber 
							BoxNumberTotal			= each.TotalTaxAmount

							VatReturnPreview = VatReturnPreview + DisplayIdx + "(1a)Line:" + LocalVatReportingLine + "<br>"
							VatReturnPreview = VatReturnPreview + DisplayIdx + "(1a)Box.:" + BoxNumber + "<br>"
							VatReturnPreview = VatReturnPreview + DisplayIdx + "(1a)Amt.:" + BoxNumberTotal + "<br>"
							VatReturnPreview = VatReturnPreview + DisplayIdx + "(1a)Desc:" + LocalBoxDescription + "<br>"							 

							include LoadVatTable						
				if (Idx > 0)
					include PrintVatBoxTable	
					

		ClearVatReturnPreview is an Instance Action		

	 		default label is untranslatable
			restricted		
			Action Rules
				initialize VatReturnPreview		
				

		CopyCurrentRecord is an Instance Action	


	 		Parameters
	 			NewTaxEntity				is a TaxEntity 
	 			NewVatReportID 				is a VatRptId
            	NewCountryCode 				is a Country
				CopyVatUsageCode			is Boolean	
					default label is "CopyAllLinesOfCodes"				 
				CopyVatReportingDetail		is Boolean		
					default label is "CopyAllLinesOfSummarize"			 


	 		Parameter Rules	
	 			NewTaxEntity
	 				initial value is TaxEntity
	 				required
	 			NewVatReportID
	 				initial value is VatReportIDForCountry.VatReportID
	 				required
	 			NewCountryCode
	 				initial value is VatReportIDForCountry.CountryCode
	 				required
	 		Action Rules
	 		    LocalNewCountryCode 		  = NewCountryCode
	 			LocalNewVatReportID     	  = NewVatReportID
	 			LocalNewTaxEntity	          = NewTaxEntity
	 			if (NewVatReportIDForCountryRel not exist)	
	 				invoke Create VatReportIDForCountry
	 					fill in fields from this instance
	 					invoked.FinanceEnterpriseGroup 			  = FinanceEnterpriseGroup	 
	 					invoked.TaxEntity						  = NewTaxEntity 	
               			invoked.VatReportIDForCountry.VatReportID = LocalNewVatReportID		 
                		invoked.VatReportIDForCountry.CountryCode = LocalNewCountryCode 		 								 
				 
				if (NewVatReportIDForCountryRel exist
				and VatReportingLineRel exist)
					for each VatReportingLineRel
		 				invoke Create VatReportingLine
		 					fill in fields from each
		 					invoked.FinanceEnterpriseGroup 			  = FinanceEnterpriseGroup	 
		 					invoked.TaxEntity						  = NewTaxEntity 				  
              				invoked.VatReportIDForCountry.VatReportID = LocalNewVatReportID		 
                			invoked.VatReportIDForCountry.CountryCode = LocalNewCountryCode 
						invoke CopyVatReportingLineDetails each		 
			 	 			invoked.NewTaxEntity				      		= NewTaxEntity
			 	 			invoked.NewVatReportIDForCountry.CountryCode    = NewCountryCode
				 			invoked.NewVatReportIDForCountry.VatReportID    = NewVatReportID  
							invoked.CopyVatUsageCode						= CopyVatUsageCode			 
							invoked.CopyVatReportingDetail					= CopyVatReportingDetail 					 


										
