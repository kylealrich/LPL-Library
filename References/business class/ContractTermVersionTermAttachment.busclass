ContractTermVersionTermAttachment is a BusinessClass
    owned by po
    prefix is CTVTA
    sql name is ContractTermVersionTermAtt

	Patterns

    Ontology
    	symbolic key is ContractTermVersionTermAttachment

    Persistent Fields
		Attachment							is an AlternateAttachment
		AttachmentReference 				is a Description
		DisplayOrder
		SpecificRequestType					is Numeric 2
			default label is "RequestType"
			States
				Create					value is 1
				UpdateTermAndCondition	value is 2
				AddAttachment			value is 3
				DeleteAttachment		value is 4
				DeleteTermAndCondition	value is 5
				Restore					value is 6
		ContractTermAndConditionAttachment	is Numeric 4

	Local Fields
		LocalAttributeCtr	is Numeric 2	

	Transient Fields
		
    Field Rules

	Create Rules  
		include IDM.CreateRules 
			replace AttachmentField with Attachment
							
	Delete Rules
		include IDM.DeleteRules
			replace AttachmentField with Attachment

	Commit Rules
		include IDM.CommitRules
			replace AttachmentField with Attachment

 	Sets

	Conditions
		HasAttachment
			restricted
			when (Attachment entered)
		ContractTermAndConditionUpdatePendingDeletion
			restricted
			when (ContractTermAndConditionUpdatePendingDeletionRel exists)

	Relations
		ContractTermVersionTermAttachmentOriginalRecordRel
			one-to-many relation to ContractTermVersionTermAttachment
			Field Mapping uses symbolic key
				related.ContractGroup 						= ContractGroup
				related.Contract 							= Contract
				related.ContractTermVersion 				= ContractTermVersion
				related.ContractTermVersionArticle 			= ContractTermVersionArticle
				related.ContractTermVersionTerm				= ContractTermVersionTerm
			Instance Selection
				where (related.UniqueID != UniqueID
				and	   related.ContractTermAndConditionAttachment = ContractTermAndConditionAttachment)

		ContractTermAndConditionUpdatePendingDeletionRel
			one-to-many relation to ContractTermAndConditionUpdate
			Field Mapping uses symbolic key
				related.ContractGroup  						= ContractGroup
				related.Contract  							= Contract
				related.ContractArticle						= ContractTermVersionArticle
				related.ContractTermAndCondition			= ContractTermVersionTerm
			Instance Selection
				where (related.TermNegotiationVersion <= ContractTermVersion
				and	   related.ContractTermAndConditionAttachment = ContractTermAndConditionAttachment
				and	   related.SpecificRequestType.DeleteAttachment
				and	   (related.Status.Draft
				or	    related.Status.Pending))

    Actions
	    Create is a Create Action
	    	restricted

	    Update is an Update Action
	    	restricted

	    Delete is a Delete Action
	    	restricted

		DeleteFromTermVersion is a Delete Action
			restricted

		UploadToIDM is an Instance Action  
			valid when (Attachment.ValidForIDMUpload)
			Action Rules
				include IDM.MoveAttachmentsToIDM
					replace AttachmentField   with Attachment	
														
		MoveAttachmentsToIDM is a Set Action
			restricted
			Instance Selection
				where (Attachment.IsLocal)

			Accumulators
				InstanceCount

			Action Rules
				Instance Rules
					increment InstanceCount	

					include IDM.MoveAttachmentsToIDM
						replace AttachmentField   with Attachment			

					commit transaction

					if (InstanceCount = config.IDM_MOVE_ATTACHMENTS_LIMIT)
						end set action instance loop	
