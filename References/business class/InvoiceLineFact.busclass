InvoiceLineFact is a BusinessClass
	owned by procurement
	prefix is ILFct

	Ontology
		symbolic key is InvoiceLineFact
		
    Patterns
        disable Auditing
        disable EffectiveDated
		implements AnalyticCube
 			disable continuous update
 		implements Archivable


    Persistent Fields

		Vendor					is a snapshot of PayablesInvoice.Vendor
		Invoice					is a snapshot of PayablesInvoice.Invoice
		Suffix					is a snapshot of PayablesInvoice.Suffix
        CompanyPurchaseOrder
        LineNumber         		is Numeric 6
        LineSequenceNumber		is Numeric 4
		PayablesDiversityCode
		ProcurementGroup		is like ProcurementGroup
		Buyer
		Location				is a SpendLocation
		RequestingLocation		is like RequestingLocation
		Item												
		ItemType
		ItemDescription			is Alpha 30
		VendorItem              is AlphaUpper 32
		InvoiceDate				is Date
		InvoiceAmount			is an InternationalAmount
		MatchedQuantity			is like Quantity
		VpriUom					is AlphaUpper 4
		VpriUomMult				is Decimal 13.7
		InvoiceUnitCost			is an InternationalCost
		PurchaseOrderUnitCost	is an InternationalCost
		CmContract				is Numeric 15
		MfgContract				is Numeric 15
		PreferredFlag			is Numeric size 1
			States
				No						value is 0
				Contract				value is 1
				Manufacturer			value is 2
				ContractAndManufacturer	value is 3
    	ReturnNumber			is Numeric 10
    	OffContract				is Boolean
    	CommodityCode
    	ManufacturerCode		is Alpha 4
    	ManufacturerDivision	is Alpha 4
    	ManufacturerNumber
    	UNSPSC					is a UNSPSCCode
    	PurchMajcl				is a MajorPurchasingClass
    	PurchMincl				is a MinorPurchasingClass
    	PoDate					is Date
    	CommodityCodeSegment1	is AlphaUpper 10
    	CommodityCodeSegment2 	is AlphaUpper 10
    	CommodityCodeSegment3   is AlphaUpper 10
    	CommodityCodeSegment4	is AlphaUpper 10
    	CommodityCodeSegment5 	is AlphaUpper 10
    	CommodityCodeSegment6   is AlphaUpper 10
    	CurrencyCode			is a Currency
    	OrigCnvRate				is Decimal 14.7
    	TaxTotalAmount			is an InternationalAmount
    	AddOnCostTotalAmount	is an InternationalAmount
        SpendCategory   		is Numeric size 1
        	States
        		OnContract			value is 1
        		OffContract			value is 2
        		NoContract			value is 3
        		ExpenseInvoice		value is 4
        SpendAmount				is Numeric 10
        MatchDate				is Date
        CreateDate				is Date
        SpendQuantity			is Numeric 10
        InvoiceBaseUnitCost		is an InternationalCost
        InvoiceYear				is Numeric size 4
        InvoiceQuarter			is Numeric 1
        InvoiceMonth			is Period
        InvoiceStatus			is Numeric 1
        	States
                Unreleased			value is 0
                Released			value is 1
                Approved			value is 2
                PendingApproval		value is 3
                Rejected      		value is 4
                Amended				value is 5 
                Cancelled			value is 6		//	TODO - Change to one 'L' or change the 1 "l's" to two "L's" 
                Paid				value is 8
                Historical			value is 9
        		





	Transient Fields

		TransientTransactionAmount			is a CurrencyAmount
		TransientExchangeDate				is an ExchangeDate
		TransientFromCurrency				is a FromCurrency
		TransientContextToCurrency			is a ToCurrency
		TransientCurrencyTable				is a CurrencyTable
		InvoiceDateRange					is a DateRange
		PercentVarianceThreshhold
		AmountVarianceThreshhold
		SpendWithContractOnly           
	





	Local Fields
        SpendDimension
        LocalItemGroup							is like ItemGroup
        LocalCommodityCode						is a CommodityCode
		LocalDiversityFlag						is Numeric size 1
		LocalProcurementGroup					is like ProcurementGroup
		LocalInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
		LocalUNSPSCBusinessClass				is an UNSPSCCode
		LocalInvoiceLineFactUNSPSC				is an InvoiceLineFactUNSPSC
		LocalInvoiceLineFactCommodityCode		is an InvoiceLineFactCommodityCode
		LocalContractCurrencyExchange			is a CurrencyExchange
		LocalTaxAmount							is an InternationalAmount
		

	


	Context Fields

		InvoiceLineFactConsolidate
		

	


	Derived Fields

		InvoiceExtendedCost is a DerivedField
			type is like InternationalAmount
			return (MatchedQuantity * InvoiceUnitCost)
			
		PurchaseOrderExtendedCost is a DerivedField
			type is like InternationalAmount
			return (MatchedQuantity * PurchaseOrderUnitCost)
			
		PercentVariance is a ComputeField
			type is Percent 5.2
			((InvoiceUnitCost - PurchaseOrderUnitCost) / PurchaseOrderUnitCost)
			
		AmountVariance is a DerivedField
			type is like InternationalAmount
			return (InvoiceExtendedCost - PurchaseOrderExtendedCost)
			
		NoConsolidationPhrase is a LabelField
			restricted
			"'NoSpendConsolidation'"
			
		MatchedQuantityInStockUOM is a ComputeField
			type is Decimal 13.4
			(MatchedQuantity * VpriUomMult)
			
		InvoiceBaseUnitCostInStockUOM is a ComputeField
			type is Decimal 13.5
			(InvoiceBaseUnitCost / VpriUomMult)
			
		DerivedSuffixString is a MessageField
			restricted
			"Suffix<PayablesInvoice.Suffix>"
			
		DerivedSuffixLiteral is a ConditionalField
			type is Text
			restricted
			if (PayablesInvoice.Suffix entered)
				DerivedSuffixString
			else
				blank

		CurrentDate is a DerivedField
			type is Date
        	restricted
			return current corporate date
			
		CurrentPeriod is a DerivedField
			type is Numeric 2
        	restricted
			return CurrentDate week
		
		CurrentYear is a DerivedField
			type is Numeric 4
        	restricted
			return CurrentDate year

		DueDatePeriod is a DerivedField
			type is Numeric 2
			default label is "Week /Year"
        	restricted
			return InvoiceDate week

		DueDateYear is a DerivedField
			type is Numeric 4
        	restricted
			return InvoiceDate year


	


	Dimensions

		Company
		Vendor
		Buyer
		Location
		Item
		ItemType
    	UNSPSC
    	PurchMajcl
    	PurchMincl
        SpendCategory
    	DueDatePeriod
	    	is a weekly period dimension with year of DueDateYear
	    		current year is CurrentYear
	    		current period is CurrentPeriod


	

	Measures

		InvoiceAmount


	



	Conditions
		OnContract
			restricted
			when (CmContract entered
			or    SpendCategory.OnContract)
			
		NoContract
			restricted
			when (CmContract not entered
			and   !OffContract
			and   !SpendCategory.OnContract)
		
		ExpenseInvoice 
			restricted
			when (CompanyPurchaseOrder.PurchaseOrder	not entered)
			
		PurchaseOrderInvoice
			restricted
			when (CompanyPurchaseOrder.PurchaseOrder	entered)
			
		WithinInvoiceDateRange
			restricted
			when (InvoiceDate within InvoiceDateRange)
			
		AbovePercentVariance
			restricted
			when ((PercentVarianceThreshhold entered
			and    PercentVariance 	> PercentVarianceThreshhold)
			or     PercentVarianceThreshhold not entered)
			
		AboveAmountVariance
			restricted
			when ((AmountVarianceThreshhold entered
			and    AmountVariance	> AmountVarianceThreshhold)
			or     AmountVarianceThreshhold not entered)

		HasUNSPSC
			restricted
			when (UNSPSC.UNSPSCSegment   entered
			or    UNSPSC.UNSPSCFamily    entered
			or    UNSPSC.UNSPSCClass     entered
			or    UNSPSC.UNSPSCCommodity entered)
			
		HasCommodityCode
			restricted
			when (CommodityCode entered)
						
		PayablesInvoiceExists
			restricted
			when (PayablesInvoice exists)
			
		Purchase
			restricted
			when (MatchedQuantity > 0
			and  !ReturnNumber entered)
			
	Relations
		RequestingLocationRel
			one-to-one relation to RequestingLocation
			Field Mapping uses symbolic key
				related.Company						= PayablesInvoice.Company
				related.RequestingLocation			= RequestingLocation
				
		CmContractRel
			one-to-one relation to Contract
			Field Mapping uses symbolic key
				related.ContractGroup				= ProcurementGroup
				related.Contract					= CmContract
				
		PurchorderRel
			one-to-one relation to PurchaseOrder
			Field Mapping uses symbolic key
				related.Company						= CompanyPurchaseOrder.PurchasingCompany
				related.PurchaseOrder				= CompanyPurchaseOrder.PurchaseOrder
				
		PurchaseOrderLineRel
			one-to-one relation to PurchaseOrderLine
			Field Mapping uses symbolic key
				related.Company					= CompanyPurchaseOrder.PurchasingCompany
				related.PurchaseOrder			= CompanyPurchaseOrder.PurchaseOrder
				related.PurchaseOrderLine		= LineNumber
				
		ProcurementGroupRel
			one-to-one relation to ProcurementGroup
			Field Mapping uses symbolic key
				related.ProcurementGroup			= ProcurementGroup

		ItemGroupRel
			one-to-one relation to ItemGroup
			Field Mapping uses symbolic key
				related.ItemGroup			= ProcurementGroup
		
		BuyerRel
			one-to-one relation to Buyer
			Field Mapping uses symbolic key
				related.HROrganization				= Company.FinanceEnterpriseGroup.HROrganization
				related.Buyer						= Buyer
				
		InvoiceLineFactCommodityCodeRel
			one-to-one relation to InvoiceLineFactCommodityCode
			Field Mapping uses symbolic key
				related.ProcurementGroup						= ProcurementGroup
				related.InvoiceLineFactConsolidateControl		= LocalInvoiceLineFactConsolidateControl
				related.InvoiceLineFactCommodityCode			= LocalCommodityCode

		InvoiceLineFactUNSPSCRel
			one-to-one relation to InvoiceLineFactUNSPSC
			Field Mapping uses symbolic key
				related.ProcurementGroup					= LocalProcurementGroup
				related.InvoiceLineFactConsolidateControl	= LocalInvoiceLineFactConsolidateControl
				related.InvoiceLineFactUNSPSC				= LocalInvoiceLineFactUNSPSC

		InvoiceLineFactDiversityConsolidateRel
			one-to-one relation to InvoiceLineFactDiversityConsolidate
			Field Mapping uses symbolic key
				related.ProcurementGroup 								  	= LocalProcurementGroup
				related.InvoiceLineFactConsolidateControl					= LocalInvoiceLineFactConsolidateControl
				related.InvoiceLineFactDiversityConsolidate.DiversityFlag 	= LocalDiversityFlag
				
		ItemmastRel
			one-to-one relation to Item
			Field Mapping uses symbolic key
				related.ItemGroup						= ProcurementGroup
				related.Item							= Item
					
	Sets
		ByItem
			duplicates
			Sort Order
				ProcurementGroup
				Item
				










		ByAmount
			duplicates
			Sort Order
				InvoiceAmount descending
				
		ByBuyerLocItem
			duplicates
			Sort Order
				ProcurementGroup
				Buyer
				Company
				Location
				Item
		
		ByBuyerReqLocItem
			duplicates
			Sort Order
				ProcurementGroup
				Buyer
				Company
				RequestingLocation
				Item
		
		ByVendor
			duplicates
			Sort Order
				Vendor
				InvoiceDate		descending
		
		ByDiversityCode
			duplicates
			Sort Order
				ProcurementGroup
				PayablesDiversityCode
				PayablesInvoice
				
		ByInvoice
			duplicates
			Sort Order
				ProcurementGroup
				Company
				Vendor
				PayablesInvoice.Invoice
				PayablesInvoice.Suffix
				PayablesInvoice.CancelSequence
								
		ByItemVendor
			duplicates
			Sort Order
				Item
				Vendor
				
		ByVendorItem
			duplicates
			Sort Order
				Vendor
				Item
				
		ByPurchorder
			Sort Order
				CompanyPurchaseOrder
				LineNumber
				LineSequenceNumber
				Company
				PayablesInvoice
				
		ByLocationBuyerItem
			duplicates
			Sort Order
				ProcurementGroup
				Company
				Location
				Buyer
				Item
				
		ByLocationReqLocItem
			duplicates
			Sort Order
				ProcurementGroup
				Company
				Location
				RequestingLocation
				Item
					
		ByCommCodesItem
			duplicates
			Sort Order
				ProcurementGroup
				CommodityCode
				Item
				
		UNSPSCSubsetByItem
			duplicates
			Sort Order
				ProcurementGroup
				Item
			Instance Selection
				where (HasUNSPSC)
				
		ByContractLine
			duplicates
			Sort Order
				ProcurementGroup
				CmContract
				Item
				VpriUom
			Instance Selection
				where (Purchase)

		ConsolidateUNSPSCItemSortSet
			duplicates
			Sort Order
				ProcurementGroup
				UNSPSC.UNSPSCSegment
				UNSPSC.UNSPSCFamily
				UNSPSC.UNSPSCClass
				UNSPSC.UNSPSCCommodity
				Item
				UniqueID
				
	Field Rules
		CommodityCodeSegment1		
			CommodityCodeSegment1	= CommodityCode.Segment[1]

		CommodityCodeSegment2		
			CommodityCodeSegment2	= CommodityCode.Segment[2]

		CommodityCodeSegment3		
			CommodityCodeSegment3	= CommodityCode.Segment[3]

		CommodityCodeSegment4		
			CommodityCodeSegment4	= CommodityCode.Segment[4]

		CommodityCodeSegment5		
			CommodityCodeSegment5	= CommodityCode.Segment[5]

		CommodityCodeSegment6		
			CommodityCodeSegment6	= CommodityCode.Segment[6]

	Actions
		Create is a Create Action
			restricted
		
		Update is an Update Action
		
		Delete is a Delete Action
			restricted
		
		Purge is a Purge Action
			restricted
			bypass relational integrity rules

		UpdateSnapshotFields is an Instance Action
			restricted
			Action Rules
				Vendor				= PayablesInvoice.Vendor
				Invoice				= PayablesInvoice.Invoice
				Suffix				= PayablesInvoice.Suffix
						
		ConsolidateCompanyLocationBuyerItem is a Set Action

			restricted
			completion message is "ConsolidationByCompanyLocationBuyerAndItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange
				ConsolidationOptions
				InvoiceList                             is an InvoiceLineFact group
				
			Local Fields
				CurrentCompany							is Numeric 4
				CurrentLocation							is like InventoryLocation
				CurrentBuyer							is a Buyer
				CurrentItem								is an Item
				CurrentItemType							is an ItemType
				CurrentItemDescription					is Alpha 30
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent							is Percent size 5.2
				SpendAccumulation	
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
															
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))
										
			Sort Order
				ProcurementGroup
				Company
				Location
				Buyer
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
					
				ProcurementGroup Set Rules
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 1
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
							
				Company Set Rules
					Entrance Rules
						CurrentCompany			= Company
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 2
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
							
				Location Set Rules
					Entrance Rules
						CurrentLocation				= Location
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 3
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Buyer Set Rules
					Entrance Rules
						CurrentBuyer				= Buyer
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 4
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.Level5.Type		= SpendDimension.Type.Item
								InvoiceLineFactConsolidateLookup.Level5.Value		= CurrentItem
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 5
									invoked.ItemType										= CurrentItemType
									invoked.ItemDescription									= CurrentItemDescription
									invoked.ConsolidationDateRange							= ConsolidationDateRange
									invoked.ShipToLocation									= CurrentLocation
									invoked.Buyer											= CurrentBuyer						
									invoked.LocationCompany									= CurrentCompany
								I1 += 1

				Instance Rules
				
					if (PayablesInvoiceExists)

						
						TotalOnOffSpend					+= InvoiceAmount
						if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
							if (Location entered
							and Buyer entered
							and ItemType entered)
								TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
						if (SpendCategory.OnContract)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
							TotalNoContractAmount		+= InvoiceAmount

		ConsolidateCompanyLocationRequestingLocationItem is a Set Action

			restricted
			completion message is "ConsolidationByCompanyLocationRequestingLocationAndItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange
				ConsolidationOptions
				InvoiceList                             is an InvoiceLineFact group				
				
			Local Fields
				CurrentCompany							is Numeric 4
				CurrentLocation							is like InventoryLocation
				CurrentRequestingLocation				is like RequestingLocation
				CurrentItem								is an Item
				CurrentItemType							is an ItemType
				CurrentItemDescription					is Alpha 30
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent                           is Percent size 5.2
				SpendAccumulation	
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))
								
			Sort Order
				ProcurementGroup
				Company
				Location
				RequestingLocation
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
							 
				Company Set Rules
					Entrance Rules
						CurrentCompany			= Company
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 2
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
							
				Location Set Rules
					Entrance Rules
						CurrentLocation				= Location
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 3
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				RequestingLocation Set Rules
					Entrance Rules
						CurrentRequestingLocation				= RequestingLocation
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.RequestingLocation
								InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentRequestingLocation
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 4
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateTotalSpend)								
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level1.Value		= ProcurementGroup
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Company
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentCompany
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.RequestingLocation
								InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentRequestingLocation
								InvoiceLineFactConsolidateLookup.Level5.Type		= SpendDimension.Type.Item
								InvoiceLineFactConsolidateLookup.Level5.Value		= CurrentItem
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 5
									invoked.ItemType										= CurrentItemType
									invoked.ItemDescription									= CurrentItemDescription
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Instance Rules
				
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
							if (Location entered
							and ItemType entered)
								TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
						if (SpendCategory.OnContract)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
							TotalNoContractAmount		+= InvoiceAmount
			
		ConsolidateBuyerLocationItem is a Set Action

			restricted
			completion message is "ConsolidationByBuyerLocationAndItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange
				ConsolidationOptions
				InvoiceList                             is an InvoiceLineFact group
								
			Local Fields
				CurrentBuyer							is a Buyer
				CurrentLocation							is like InventoryLocation
				CurrentItem								is an Item
				CurrentItemType							is an ItemType
				CurrentItemDescription					is Alpha 30
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent                            is Percent size 5.2
				CurrentCompany							is Numeric 4
				SpendAccumulation	
				I1										is Numeric 2

			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))
				
			Sort Order
				ProcurementGroup
				Buyer
				Location
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
									
				Buyer Set Rules
					Entrance Rules
						CurrentBuyer				= Buyer
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 1
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
								
				Location Set Rules
					Entrance Rules
						CurrentLocation				= Location
						CurrentCompany				= Company
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 2
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.ShipToLocation
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentLocation
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.Item
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentItem
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 3
									invoked.ItemType										= CurrentItemType
									invoked.ItemDescription									= CurrentItemDescription
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
									invoked.ShipToLocation									= CurrentLocation
								I1 += 1
						
				Instance Rules
				
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
							if (Location entered
							and ItemType entered)
								TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
						if (SpendCategory.OnContract)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
							TotalNoContractAmount		+= InvoiceAmount

		ConsolidateBuyerRequestingLocationItem is a Set Action

			restricted
			completion message is "ConsolidationByBuyerRequestingLocationAndItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange
				ConsolidateLastTwelveMonths				is Boolean
				ConsolidationOptions
				InvoiceList                             is an InvoiceLineFact group
				
			Local Fields
				CurrentBuyer							is a Buyer
				CurrentRequestingLocation				is like RequestingLocation
				CurrentItem								is an Item
				CurrentItemType							is an ItemType
				CurrentItemDescription					is Alpha 30
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent                            is Percent size 5.2
				CurrentCompany							is Numeric 4
				SpendAccumulation	
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))
				
			Sort Order
				ProcurementGroup
				Buyer
				RequestingLocation
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl

				Buyer Set Rules
					Entrance Rules
						CurrentBuyer				= Buyer
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 1
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1

				RequestingLocation Set Rules
					Entrance Rules
						CurrentRequestingLocation				= RequestingLocation
						CurrentCompany							= Company
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.RequestingLocation
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentRequestingLocation
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 2
									invoked.LocationCompany									= CurrentCompany
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateBuyerSpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							I1								= 1
							while (I1 < 4)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Buyer
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentBuyer
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.RequestingLocation
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentRequestingLocation
								InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.Item
								InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentItem
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.TotalOnOffQuantity								= TotalOnOffQuantity
									invoked.ConsolidationLevel								= 3
									invoked.LocationCompany									= CurrentCompany
									invoked.ItemType										= CurrentItemType
									invoked.ItemDescription									= CurrentItemDescription
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1
						
				Instance Rules
				
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
							if (ItemType entered)
								TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
						if (SpendCategory.OnContract)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
							TotalNoContractAmount		+= InvoiceAmount	

		ConsolidateCommodityCodeItem is a Set Action

			restricted
			completion message is "ConsolidationByCommodityCodeAndItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange
				ConsolidationOptions
								
			Local Fields
				CurrentCommodityCode					is a CommodityCode
				CurrentItem								is an Item
				CurrentItemType							is an ItemType
				CurrentItemDescription					is Alpha 30
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent                            is Percent size 5.2
				CurrentItemGroup						is like ItemGroup
				LocalItemGroup							is like ItemGroup
				InvoiceLineFactCommodityCodeLookup  	is an InvoiceLineFactCommodityCode
				CurrentSegment1							is AlphaUpper 10
				CurrentSegment2							is AlphaUpper 10
				CurrentSegment3							is AlphaUpper 10
				CurrentSegment4							is AlphaUpper 10
				CurrentSegment5							is AlphaUpper 10
				Segment1TotalOnOffSpend					is an InternationalAmount
				Segment2TotalOnOffSpend					is an InternationalAmount
				Segment3TotalOnOffSpend					is an InternationalAmount
				Segment4TotalOnOffSpend					is an InternationalAmount
				Segment5TotalOnOffSpend					is an InternationalAmount
				Segment1TotalOnSpend					is an InternationalAmount
				Segment2TotalOnSpend					is an InternationalAmount
				Segment3TotalOnSpend					is an InternationalAmount
				Segment4TotalOnSpend					is an InternationalAmount
				Segment5TotalOnSpend					is an InternationalAmount
				Segment1TotalOffSpend					is an InternationalAmount
				Segment2TotalOffSpend					is an InternationalAmount
				Segment3TotalOffSpend					is an InternationalAmount
				Segment4TotalOffSpend					is an InternationalAmount
				Segment5TotalOffSpend					is an InternationalAmount
				Segment1TotalNoSpend					is an InternationalAmount
				Segment2TotalNoSpend					is an InternationalAmount
				Segment3TotalNoSpend					is an InternationalAmount
				Segment4TotalNoSpend					is an InternationalAmount
				Segment5TotalNoSpend					is an InternationalAmount
				SavedLocalCommodityCode					is a CommodityCode
				Segment2ForSegment1						is Boolean								
				Segment3ForSegment1						is Boolean								
				Segment4ForSegment1						is Boolean								
				Segment5ForSegment1						is Boolean								
				Segment6ForSegment1						is Boolean								
				Segment3ForSegment2						is Boolean								
				Segment4ForSegment2						is Boolean								
				Segment5ForSegment2						is Boolean								
				Segment6ForSegment2						is Boolean								
				Segment4ForSegment3						is Boolean								
				Segment5ForSegment3						is Boolean								
				Segment6ForSegment3						is Boolean								
				Segment5ForSegment4						is Boolean								
				Segment6ForSegment4						is Boolean								
				Segment6ForSegment5						is Boolean	
				CurrentSegment1CommCodes				is like CommCodes
				CurrentSegment2CommCodes				is like CommCodes					
				CurrentSegment3CommCodes				is like CommCodes
				CurrentSegment4CommCodes				is like CommCodes							
				CurrentSegment5CommCodes				is like CommCodes	
				SpendAccumulation	
				I1										is Numeric 2
				LocalSegment1IsEntered					is Boolean
					
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmProcurementGroup)
				
			Sort Order
				ProcurementGroup
				CommodityCodeSegment1
				CommodityCodeSegment2
				CommodityCodeSegment3
				CommodityCodeSegment4
				CommodityCodeSegment5
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalItemGroup							= PrmProcurementGroup
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
									
				CommodityCodeSegment1 Set Rules
					Entrance Rules
						if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
							CurrentCommodityCode		= CommodityCode
							CurrentItemGroup			= PrmProcurementGroup
							CurrentSegment1				= CommodityCodeSegment1
							initialize Segment1TotalOnOffSpend
							initialize Segment1TotalOnSpend
							initialize Segment1TotalOffSpend
							initialize Segment1TotalNoSpend
							Segment2ForSegment1			= false
							Segment3ForSegment1			= false
							Segment4ForSegment1			= false
							Segment5ForSegment1			= false
							Segment6ForSegment1			= false
							if (CommodityCodeSegment1 entered)
								LocalSegment1IsEntered					= true							
								LocalItemGroup							= CurrentItemGroup
								LocalCommodityCode.Segment[1]			= CommodityCodeSegment1
								initialize LocalCommodityCode.Segment[2]
								initialize LocalCommodityCode.Segment[3]
								initialize LocalCommodityCode.Segment[4]
								initialize LocalCommodityCode.Segment[5]
								initialize LocalCommodityCode.Segment[6]
								LocalInvoiceLineFactCommodityCode.Segment[1]	= CommodityCodeSegment1
								initialize LocalInvoiceLineFactCommodityCode.Segment[2]
								initialize LocalInvoiceLineFactCommodityCode.Segment[3]
								initialize LocalInvoiceLineFactCommodityCode.Segment[4]
								initialize LocalInvoiceLineFactCommodityCode.Segment[5]
								initialize LocalInvoiceLineFactCommodityCode.Segment[6]
								if (!LocalInvoiceLineFactCommodityCode exists)
									invoke Create InvoiceLineFactCommodityCode
										invoked.ProcurementGroup						= PrmProcurementGroup
										invoked.InvoiceLineFactConsolidateControl		= PrmInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactCommodityCode			= LocalInvoiceLineFactCommodityCode
										invoked.CommodityCode							= CommodityCode
										invoked.Description								= LocalCommodityCode.Description
										initialize invoked.TotalOnOffSpend
										invoked.ConsolidationLevel						= 1
							else
								LocalSegment1IsEntered				= false
															
					Exit Rules
						if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
							if (CurrentSegment1 entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentSegment1
									initialize InvoiceLineFactConsolidateLookup.Level2.Type
									initialize InvoiceLineFactConsolidateLookup.Level2.Value
									initialize InvoiceLineFactConsolidateLookup.Level3.Type
									initialize InvoiceLineFactConsolidateLookup.Level3.Value
									initialize InvoiceLineFactConsolidateLookup.Level4.Type
									initialize InvoiceLineFactConsolidateLookup.Level4.Value
									initialize InvoiceLineFactConsolidateLookup.Level5.Type
									initialize InvoiceLineFactConsolidateLookup.Level5.Value
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 1
										invoked.ConsolidationDateRange							= ConsolidationDateRange
										invoked.CommodityCode									= CurrentSegment1CommCodes
									I1 += 1
	
								initialize InvoiceLineFactCommodityCodeLookup
								InvoiceLineFactCommodityCodeLookup.Segment[1]				= CurrentSegment1
								if (InvoiceLineFactCommodityCodeLookup exists)
									invoke Update InvoiceLineFactCommodityCodeLookup
										invoked.TotalOnOffSpend								= TotalOnOffSpend
					
				CommodityCodeSegment2 Set Rules
					Entrance Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 1)
									CurrentSegment2				= CommodityCodeSegment2
									initialize Segment2TotalOnOffSpend
									initialize Segment2TotalOnSpend
									initialize Segment2TotalOffSpend
									initialize Segment2TotalNoSpend
									Segment3ForSegment2			= false
									Segment4ForSegment2			= false
									Segment5ForSegment2			= false
									Segment6ForSegment2			= false
									LocalItemGroup							= CurrentItemGroup
									LocalCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalCommodityCode.Segment[2]		= "="
									else
										LocalCommodityCode.Segment[2]		= CommodityCodeSegment2
									initialize LocalCommodityCode.Segment[3]
									initialize LocalCommodityCode.Segment[4]
									initialize LocalCommodityCode.Segment[5]
									initialize LocalCommodityCode.Segment[6]
									LocalInvoiceLineFactCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[2]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[2]		= CommodityCodeSegment2
									initialize LocalInvoiceLineFactCommodityCode.Segment[3]
									initialize LocalInvoiceLineFactCommodityCode.Segment[4]
									initialize LocalInvoiceLineFactCommodityCode.Segment[5]
									initialize LocalInvoiceLineFactCommodityCode.Segment[6]
									if (!LocalInvoiceLineFactCommodityCode exists)
										invoke Create InvoiceLineFactCommodityCode
											invoked.ProcurementGroup						= PrmProcurementGroup
											invoked.InvoiceLineFactConsolidateControl		= PrmInvoiceLineFactConsolidateControl
											invoked.InvoiceLineFactCommodityCode			= LocalInvoiceLineFactCommodityCode
											invoked.Description								= LocalCommodityCode.Description
											invoked.CommodityCode							= CommodityCode
											invoked.ConsolidationLevel						= 2

					Exit Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 1)
									SpendAccumulation.Amount[1]		= TotalOnContractAmount
									SpendAccumulation.Amount[2]		= TotalOffContractAmount
									SpendAccumulation.Amount[3]		= TotalNoContractAmount
									I1								= 1
									while (I1 < 4)
										InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
										InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentSegment1
										InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.CommodityCodeSegment2
										if (CurrentSegment2 not entered)
											InvoiceLineFactConsolidateLookup.Level2.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level2.Value	= CurrentSegment2
										initialize InvoiceLineFactConsolidateLookup.Level3.Type
										initialize InvoiceLineFactConsolidateLookup.Level3.Value
										initialize InvoiceLineFactConsolidateLookup.Level4.Type
										initialize InvoiceLineFactConsolidateLookup.Level4.Value
										initialize InvoiceLineFactConsolidateLookup.Level5.Type
										initialize InvoiceLineFactConsolidateLookup.Level5.Value
										initialize InvoiceLineFactConsolidateLookup.Level6.Type
										initialize InvoiceLineFactConsolidateLookup.Level6.Value
										InvoiceLineFactConsolidateLookup.SpendCategory		= I1
										if (TotalOnOffSpend !=0)
											LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
											if (LocalPercent < 0)
												LocalPercent = 0
										else
											LocalPercent	= 0
										invoke Update InvoiceLineFactConsolidateLookup 
											invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
											invoked.OnOffPercent									= LocalPercent
											invoked.TotalOnOffSpend									= TotalOnOffSpend
											invoked.TotalOnOffQuantity								= TotalOnOffQuantity
											invoked.ConsolidationLevel								= 2
											invoked.ConsolidationDateRange							= ConsolidationDateRange
											invoked.CommodityCode									= CurrentSegment2CommCodes
										I1 += 1
		
									initialize InvoiceLineFactCommodityCodeLookup
									InvoiceLineFactCommodityCodeLookup.Segment[1]					= CurrentSegment1
									if (CurrentSegment2 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[2]				= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[2]				= CurrentSegment2
									if (InvoiceLineFactCommodityCodeLookup exists)
										invoke Update InvoiceLineFactCommodityCodeLookup
											invoked.TotalOnOffSpend									= TotalOnOffSpend
					
				CommodityCodeSegment3 Set Rules
					Entrance Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 2)
									CurrentSegment3				= CommodityCodeSegment3
									initialize Segment3TotalOnOffSpend
									initialize Segment3TotalOnSpend
									initialize Segment3TotalOffSpend
									initialize Segment3TotalNoSpend
									Segment4ForSegment3			= false
									Segment5ForSegment3			= false
									Segment6ForSegment3			= false
									LocalItemGroup							= CurrentItemGroup
									LocalCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalCommodityCode.Segment[2]		= "="
									else
										LocalCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalCommodityCode.Segment[3]		= "="
									else
										LocalCommodityCode.Segment[3]		= CommodityCodeSegment3
									initialize LocalCommodityCode.Segment[4]
									initialize LocalCommodityCode.Segment[5]
									initialize LocalCommodityCode.Segment[6]
									LocalInvoiceLineFactCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[2]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[3]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[3]		= CommodityCodeSegment3
									initialize LocalInvoiceLineFactCommodityCode.Segment[4]
									initialize LocalInvoiceLineFactCommodityCode.Segment[5]
									initialize LocalInvoiceLineFactCommodityCode.Segment[6]
									if (!LocalInvoiceLineFactCommodityCode exists)
										invoke Create InvoiceLineFactCommodityCode
											invoked.ProcurementGroup						= PrmProcurementGroup
											invoked.InvoiceLineFactConsolidateControl		= PrmInvoiceLineFactConsolidateControl
											invoked.InvoiceLineFactCommodityCode			= LocalInvoiceLineFactCommodityCode
											invoked.Description								= LocalCommodityCode.Description
											invoked.CommodityCode							= CommodityCode
											invoked.ConsolidationLevel						= 3

					Exit Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 2)
									SpendAccumulation.Amount[1]		= TotalOnContractAmount
									SpendAccumulation.Amount[2]		= TotalOffContractAmount
									SpendAccumulation.Amount[3]		= TotalNoContractAmount
									I1								= 1
									while (I1 < 4)
										InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
										InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentSegment1
										InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.CommodityCodeSegment2
										if (CurrentSegment2 not entered)
											InvoiceLineFactConsolidateLookup.Level2.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level2.Value	= CurrentSegment2
										InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.CommodityCodeSegment3
										if (CurrentSegment3 not entered)
											InvoiceLineFactConsolidateLookup.Level3.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level3.Value	= CurrentSegment3
										initialize InvoiceLineFactConsolidateLookup.Level4.Type
										initialize InvoiceLineFactConsolidateLookup.Level4.Value
										initialize InvoiceLineFactConsolidateLookup.Level5.Type
										initialize InvoiceLineFactConsolidateLookup.Level5.Value
										initialize InvoiceLineFactConsolidateLookup.Level6.Type
										initialize InvoiceLineFactConsolidateLookup.Level6.Value
										InvoiceLineFactConsolidateLookup.SpendCategory		= I1
										if (TotalOnOffSpend !=0)
											LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
											if (LocalPercent < 0)
												LocalPercent = 0
										else
											LocalPercent	= 0
										invoke Update InvoiceLineFactConsolidateLookup 
											invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
											invoked.OnOffPercent									= LocalPercent
											invoked.TotalOnOffSpend									= TotalOnOffSpend
											invoked.TotalOnOffQuantity								= TotalOnOffQuantity
											invoked.ConsolidationLevel								= 3
											invoked.ConsolidationDateRange							= ConsolidationDateRange
											invoked.CommodityCode									= CurrentSegment3CommCodes
										I1 += 1
		
									initialize InvoiceLineFactCommodityCodeLookup
									InvoiceLineFactCommodityCodeLookup.Segment[1]				= CurrentSegment1
									if (CurrentSegment2 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= CurrentSegment2
									if (CurrentSegment3 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= CurrentSegment3
									if (InvoiceLineFactCommodityCodeLookup exists)
										invoke Update InvoiceLineFactCommodityCodeLookup
											invoked.TotalOnOffSpend								= TotalOnOffSpend
					
				CommodityCodeSegment4 Set Rules
					Entrance Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 3)
									CurrentSegment4				= CommodityCodeSegment4
									initialize Segment4TotalOnOffSpend
									initialize Segment4TotalOnSpend
									initialize Segment4TotalOffSpend
									initialize Segment4TotalNoSpend
									Segment5ForSegment4			= false
									Segment6ForSegment4			= false
									LocalItemGroup							= CurrentItemGroup
									LocalCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalCommodityCode.Segment[2]		= "="
									else
										LocalCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalCommodityCode.Segment[3]		= "="
									else
										LocalCommodityCode.Segment[3]		= CommodityCodeSegment3
									if (CommodityCodeSegment4 not entered)
										LocalCommodityCode.Segment[4]		= "="
									else
										LocalCommodityCode.Segment[4]		= CommodityCodeSegment4
									initialize LocalCommodityCode.Segment[5]
									initialize LocalCommodityCode.Segment[6]
									LocalInvoiceLineFactCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[2]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[3]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[3]		= CommodityCodeSegment3
									if (CommodityCodeSegment4 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[4]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[4]		= CommodityCodeSegment4
									initialize LocalInvoiceLineFactCommodityCode.Segment[5]
									initialize LocalInvoiceLineFactCommodityCode.Segment[6]
									if (!LocalInvoiceLineFactCommodityCode exists)
										invoke Create InvoiceLineFactCommodityCode
											invoked.ProcurementGroup						= PrmProcurementGroup
											invoked.InvoiceLineFactConsolidateControl		= PrmInvoiceLineFactConsolidateControl
											invoked.InvoiceLineFactCommodityCode			= LocalInvoiceLineFactCommodityCode
											invoked.Description								= LocalCommodityCode.Description
											invoked.CommodityCode							= CommodityCode
											invoked.ConsolidationLevel						= 4

					Exit Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 3)
									SpendAccumulation.Amount[1]		= TotalOnContractAmount
									SpendAccumulation.Amount[2]		= TotalOffContractAmount
									SpendAccumulation.Amount[3]		= TotalNoContractAmount
									I1								= 1
									while (I1 < 4)
										InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
										InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentCommodityCode.Segment[1]
										InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.CommodityCodeSegment2
										if (CurrentSegment2 not entered)
											InvoiceLineFactConsolidateLookup.Level2.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level2.Value	= CurrentSegment2
										InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.CommodityCodeSegment3
										if (CurrentSegment3 not entered)
											InvoiceLineFactConsolidateLookup.Level3.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level3.Value	= CurrentSegment3
										InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.CommodityCodeSegment4
										if (CurrentSegment4 not entered)
											InvoiceLineFactConsolidateLookup.Level4.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level4.Value	= CurrentSegment4
										initialize InvoiceLineFactConsolidateLookup.Level5.Type
										initialize InvoiceLineFactConsolidateLookup.Level5.Value
										initialize InvoiceLineFactConsolidateLookup.Level6.Type
										initialize InvoiceLineFactConsolidateLookup.Level6.Value
										InvoiceLineFactConsolidateLookup.SpendCategory		= I1
										if (TotalOnOffSpend !=0)
											LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
											if (LocalPercent < 0)
												LocalPercent = 0
										else
											LocalPercent	= 0
										invoke Update InvoiceLineFactConsolidateLookup 
											invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
											invoked.OnOffPercent									= LocalPercent
											invoked.TotalOnOffSpend									= TotalOnOffSpend
											invoked.TotalOnOffQuantity								= TotalOnOffQuantity
											invoked.ConsolidationLevel								= 4
											invoked.ConsolidationDateRange							= ConsolidationDateRange
											invoked.CommodityCode									= CurrentSegment4CommCodes
										I1 += 1
		
									initialize InvoiceLineFactCommodityCodeLookup
									InvoiceLineFactCommodityCodeLookup.Segment[1]				= CurrentSegment1
									if (CurrentSegment2 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= CurrentSegment2
									if (CurrentSegment3 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= CurrentSegment3
									if (CurrentSegment4 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[4]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[4]			= CurrentSegment4
									if (InvoiceLineFactCommodityCodeLookup exists)
										invoke Update InvoiceLineFactCommodityCodeLookup
											invoked.TotalOnOffSpend								= TotalOnOffSpend
					
				CommodityCodeSegment5 Set Rules
					Entrance Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 4)
									CurrentSegment5				= CommodityCodeSegment5
									initialize Segment5TotalOnOffSpend
									initialize Segment5TotalOnSpend
									initialize Segment5TotalOffSpend
									initialize Segment5TotalNoSpend
									Segment6ForSegment5			= false
									LocalItemGroup							= CurrentItemGroup
									LocalCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalCommodityCode.Segment[2]		= "="
									else
										LocalCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalCommodityCode.Segment[3]		= "="
									else
										LocalCommodityCode.Segment[3]		= CommodityCodeSegment3
									if (CommodityCodeSegment4 not entered)
										LocalCommodityCode.Segment[4]		= "="
									else
										LocalCommodityCode.Segment[4]		= CommodityCodeSegment4
									if (CommodityCodeSegment5 not entered)
										LocalCommodityCode.Segment[5]		= "="
									else
										LocalCommodityCode.Segment[5]		= CommodityCodeSegment5
									initialize LocalCommodityCode.Segment[6]
									LocalInvoiceLineFactCommodityCode.Segment[1]			= CommodityCodeSegment1
									if (CommodityCodeSegment2 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[2]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[2]		= CommodityCodeSegment2
									if (CommodityCodeSegment3 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[3]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[3]		= CommodityCodeSegment3
									if (CommodityCodeSegment4 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[4]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[4]		= CommodityCodeSegment4
									if (CommodityCodeSegment5 not entered)
										LocalInvoiceLineFactCommodityCode.Segment[5]		= "="
									else
										LocalInvoiceLineFactCommodityCode.Segment[5]		= CommodityCodeSegment5
									initialize LocalInvoiceLineFactCommodityCode.Segment[6]
									if (!LocalInvoiceLineFactCommodityCode exists)
										invoke Create InvoiceLineFactCommodityCode
											invoked.ProcurementGroup						= PrmProcurementGroup
											invoked.InvoiceLineFactConsolidateControl		= PrmInvoiceLineFactConsolidateControl
											invoked.InvoiceLineFactCommodityCode			= LocalInvoiceLineFactCommodityCode
											invoked.Description								= LocalCommodityCode.Description
											invoked.CommodityCode							= CommodityCode
											invoked.ConsolidationLevel						= 5

					Exit Rules
						if (LocalSegment1IsEntered)
							if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
								if (ItemGroupRel.CommodityCodeStructure.MaxLevels > 4)
									SpendAccumulation.Amount[1]		= TotalOnContractAmount
									SpendAccumulation.Amount[2]		= TotalOffContractAmount
									SpendAccumulation.Amount[3]		= TotalNoContractAmount
									I1								= 1
									while (I1 < 4)
										InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
										InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentSegment1
										InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.CommodityCodeSegment2
										if (CurrentSegment2 not entered)
											InvoiceLineFactConsolidateLookup.Level2.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level2.Value	= CurrentSegment2
										InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.CommodityCodeSegment3
										if (CurrentSegment3 not entered)
											InvoiceLineFactConsolidateLookup.Level3.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level3.Value	= CurrentSegment3
										InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.CommodityCodeSegment4
										if (CurrentSegment4 not entered)
											InvoiceLineFactConsolidateLookup.Level4.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level4.Value	= CurrentSegment4
										InvoiceLineFactConsolidateLookup.Level5.Type		= SpendDimension.Type.CommodityCodeSegment5
										if (CurrentSegment5 not entered)
											InvoiceLineFactConsolidateLookup.Level5.Value	= "="
										else
											InvoiceLineFactConsolidateLookup.Level5.Value	= CurrentSegment5
										initialize InvoiceLineFactConsolidateLookup.Level6.Type
										initialize InvoiceLineFactConsolidateLookup.Level6.Value
										InvoiceLineFactConsolidateLookup.SpendCategory		= I1
										if (TotalOnOffSpend !=0)
											LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
											if (LocalPercent < 0)
												LocalPercent = 0
										else
											LocalPercent	= 0
										invoke Update InvoiceLineFactConsolidateLookup 
											invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
											invoked.OnOffPercent									= LocalPercent
											invoked.TotalOnOffSpend									= TotalOnOffSpend
											invoked.TotalOnOffQuantity								= TotalOnOffQuantity
											invoked.ConsolidationLevel								= 5
											invoked.ConsolidationDateRange							= ConsolidationDateRange
											invoked.CommodityCode									= LocalCommodityCode.CommodityCode
										I1 += 1
		
									initialize InvoiceLineFactCommodityCodeLookup
									InvoiceLineFactCommodityCodeLookup.Segment[1]				= CurrentSegment1
									if (CurrentSegment2 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[2]			= CurrentSegment2
									if (CurrentSegment3 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[3]			= CurrentSegment3
									if (CurrentSegment4 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[4]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[4]			= CurrentSegment4
									if (CurrentSegment5 not entered)
										InvoiceLineFactCommodityCodeLookup.Segment[5]			= "="
									else
										InvoiceLineFactCommodityCodeLookup.Segment[5]			= CurrentSegment5
									if (InvoiceLineFactCommodityCodeLookup exists)
										invoke Update InvoiceLineFactCommodityCodeLookup
											invoked.TotalOnOffSpend								= TotalOnOffSpend
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateCommodityCodeSpend)
							if (CurrentCommodityCode entered
							and CurrentItemType entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1 								= 1
								while (I1 < 4)
									initialize InvoiceLineFactConsolidateLookup
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
									InvoiceLineFactConsolidateLookup.Level1.Value		= CommodityCodeSegment1
									InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.CommodityCodeSegment2
									if (CurrentSegment2 not entered)
										InvoiceLineFactConsolidateLookup.Level2.Value	= "="
									else
										InvoiceLineFactConsolidateLookup.Level2.Value	= CurrentSegment2
									InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.CommodityCodeSegment3
									if (CurrentSegment3 not entered)
										InvoiceLineFactConsolidateLookup.Level3.Value	= "="
									else
										InvoiceLineFactConsolidateLookup.Level3.Value	= CurrentSegment3
									InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.CommodityCodeSegment4
									if (CurrentSegment4 not entered)
										InvoiceLineFactConsolidateLookup.Level4.Value	= "="
									else
										InvoiceLineFactConsolidateLookup.Level4.Value	= CurrentSegment4
									InvoiceLineFactConsolidateLookup.Level5.Type		= SpendDimension.Type.CommodityCodeSegment5
									if (CurrentSegment5 not entered)
										InvoiceLineFactConsolidateLookup.Level5.Value	= "="
									else
										InvoiceLineFactConsolidateLookup.Level5.Value	= CurrentSegment5
									InvoiceLineFactConsolidateLookup.Level6.Type		= SpendDimension.Type.Item
									InvoiceLineFactConsolidateLookup.Level6.Value		= CurrentItem
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend != 0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 6
										invoked.ItemType										= CurrentItemType
										invoked.ItemDescription									= CurrentItemDescription
										invoked.ConsolidationDateRange							= ConsolidationDateRange
										invoked.CommodityCode									= CommodityCode
									I1 += 1

				Instance Rules
					if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
						if (ItemType entered)
							TotalOnOffSpend					+= InvoiceAmount
							TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
							if (SpendCategory.OnContract)
								TotalOnContractAmount		+= InvoiceAmount
							else
							if (OffContract)
								TotalOffContractAmount		+= InvoiceAmount
							else
								TotalNoContractAmount		+= InvoiceAmount
								
							if	(CommodityCodeSegment1		entered
							and  CommodityCodeSegment2		not entered)
								Segment1TotalOnOffSpend					+= InvoiceAmount
								if (SpendCategory.OnContract)
									Segment1TotalOnSpend				+= InvoiceAmount
								else
								if (OffContract)
									Segment1TotalOffSpend				+= InvoiceAmount
								else
									Segment1TotalNoSpend				+= InvoiceAmount
								
							if	(CommodityCodeSegment2		entered
							and  CommodityCodeSegment3		not entered)
								Segment2TotalOnOffSpend					+= InvoiceAmount
								if (SpendCategory.OnContract)
									Segment2TotalOnSpend				+= InvoiceAmount
								else
								if (OffContract)
									Segment2TotalOffSpend				+= InvoiceAmount
								else
									Segment2TotalNoSpend				+= InvoiceAmount
								Segment2ForSegment1			= true
								
							if	(CommodityCodeSegment3		entered
							and  CommodityCodeSegment4		not entered)
								Segment3TotalOnOffSpend					+= InvoiceAmount
								if (SpendCategory.OnContract)
									Segment3TotalOnSpend				+= InvoiceAmount
								else
								if (OffContract)
									Segment3TotalOffSpend				+= InvoiceAmount
								else
									Segment3TotalNoSpend				+= InvoiceAmount
								Segment3ForSegment1			= true
								Segment3ForSegment2			= true
								
							if	(CommodityCodeSegment4		entered
							and  CommodityCodeSegment5		not entered)
								Segment4TotalOnOffSpend					+= InvoiceAmount
								if (SpendCategory.OnContract)
									Segment4TotalOnSpend				+= InvoiceAmount
								else
								if (OffContract)
									Segment4TotalOffSpend				+= InvoiceAmount
								else
									Segment4TotalNoSpend				+= InvoiceAmount
								Segment4ForSegment1			= true
								Segment4ForSegment2			= true
								Segment4ForSegment3			= true
								
							if	(CommodityCodeSegment5		entered
							and  CommodityCodeSegment6		not entered)
								Segment5TotalOnOffSpend					+= InvoiceAmount
								if (SpendCategory.OnContract)
									Segment5TotalOnSpend				+= InvoiceAmount
								else
								if (OffContract)
									Segment5TotalOffSpend				+= InvoiceAmount
								else
									Segment5TotalNoSpend				+= InvoiceAmount
								Segment5ForSegment1			= true
								Segment5ForSegment2			= true
								Segment5ForSegment3			= true
								Segment5ForSegment4			= true
								
							if (CommodityCodeSegment6		entered)
								Segment6ForSegment1			= true
								Segment6ForSegment2			= true
								Segment6ForSegment3			= true
								Segment6ForSegment4			= true
								Segment6ForSegment5			= true
								
		ConsolidateUNSPSCItem is a Set Action

			restricted
			completion message is "ConsolidationByUNSPSCAndItemIsComplete"
			Parameters
				PrmProcureGroupD1						is a GroupProcurement
				ConsolidationDateRange					is a DateRange
				ConsolidationOptions
				
			Parameter Rules
				PrmProcureGroupD1
					CurrentProcurementGroup						= PrmProcureGroupD1.ProcurementGroup
					CurrentInvoiceLineFactConsolidateControl	= PrmProcureGroupD1.InvoiceLineFactConsolidateControl

			Local Fields
				CurrentUNSPSCSegment						is AlphaUpper 2
				CurrentUNSPSCFamily							is AlphaUpper 2
				CurrentUNSPSCClass							is AlphaUpper 2
				CurrentUNSPSCCommodity						is AlphaUpper 2
				CurrentItem									is an Item
				CurrentItemType								is an ItemType
				CurrentItemDescription						is Alpha 30
				CurrentProcurementGroup						is a ProcurementGroup
				CurrentInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				InvoiceLineFactConsolidateLookup			is an InvoiceLineFactConsolidate
				LocalPercent                                is Percent size 5.2
				LocalUNSPSC									is an UNSPSCCode
				CurrentItemGroup							is like ItemGroup
				InvoiceLineFactUNSPSCLookup					is an InvoiceLineFactUNSPSC
				SpendAccumulation
				I1											is Numeric 2
								
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalOnOffSpend
				TotalOnOffQuantity
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= CurrentProcurementGroup)
				
			Sort Order
				ProcurementGroup
				UNSPSC.UNSPSCSegment
				UNSPSC.UNSPSCFamily
				UNSPSC.UNSPSCClass
				UNSPSC.UNSPSCCommodity
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalItemGroup								= PrmProcureGroupD1.ProcurementGroup
						CurrentProcurementGroup						= PrmProcureGroupD1.ProcurementGroup
						CurrentInvoiceLineFactConsolidateControl	= PrmProcureGroupD1.InvoiceLineFactConsolidateControl
						LocalProcurementGroup						= PrmProcureGroupD1.ProcurementGroup
						LocalInvoiceLineFactConsolidateControl		= PrmProcureGroupD1.InvoiceLineFactConsolidateControl

				UNSPSC.UNSPSCSegment Set Rules
					Entrance Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							CurrentUNSPSCSegment		= UNSPSC.UNSPSCSegment
							CurrentItemGroup			= PrmProcureGroupD1.ProcurementGroup
							if (CurrentUNSPSCSegment entered)
								LocalUNSPSC.UNSPSCSegment		= CurrentUNSPSCSegment
								LocalUNSPSC.UNSPSCFamily		= "00"
								LocalUNSPSC.UNSPSCClass			= "00"
								LocalUNSPSC.UNSPSCCommodity		= "00"
								LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
								initialize LocalInvoiceLineFactUNSPSC.Level[2]
								initialize LocalInvoiceLineFactUNSPSC.Level[3]
								initialize LocalInvoiceLineFactUNSPSC.Level[4]
								if (!LocalInvoiceLineFactUNSPSC exists)
									invoke Create InvoiceLineFactUNSPSC
										invoked.ProcurementGroup							= CurrentProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= CurrentInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.UNSPSCCode									= LocalUNSPSC
										invoked.ConsolidationLevel							= 1
																
					Exit Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							if (CurrentUNSPSCSegment entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.UNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentUNSPSCSegment
									initialize InvoiceLineFactConsolidateLookup.Level2.Type
									initialize InvoiceLineFactConsolidateLookup.Level2.Value
									initialize InvoiceLineFactConsolidateLookup.Level3.Type
									initialize InvoiceLineFactConsolidateLookup.Level3.Value
									initialize InvoiceLineFactConsolidateLookup.Level4.Type
									initialize InvoiceLineFactConsolidateLookup.Level4.Value
									initialize InvoiceLineFactConsolidateLookup.Level5.Type
									initialize InvoiceLineFactConsolidateLookup.Level5.Value
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 1
										invoked.ConsolidationDateRange							= ConsolidationDateRange
									I1 += 1
	
								if (TotalOnOffSpend		!= 0)
									LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
									initialize LocalInvoiceLineFactUNSPSC.Level[2]
									initialize LocalInvoiceLineFactUNSPSC.Level[3]
									initialize LocalInvoiceLineFactUNSPSC.Level[4]
									LocalProcurementGroup						= CurrentProcurementGroup
									LocalInvoiceLineFactConsolidateControl		= CurrentInvoiceLineFactConsolidateControl
									invoke Update InvoiceLineFactUNSPSCRel
										invoked.ProcurementGroup							= LocalProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= LocalInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.TotalSpend									+= TotalOnOffSpend

				UNSPSC.UNSPSCFamily Set Rules
					Entrance Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							CurrentUNSPSCFamily				= UNSPSC.UNSPSCFamily
							if (CurrentUNSPSCFamily entered)
								LocalUNSPSC.UNSPSCSegment		= CurrentUNSPSCSegment
								LocalUNSPSC.UNSPSCFamily		= CurrentUNSPSCFamily
								LocalUNSPSC.UNSPSCClass			= "00"
								LocalUNSPSC.UNSPSCCommodity		= "00"
								LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
								LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
								initialize LocalInvoiceLineFactUNSPSC.Level[3]
								initialize LocalInvoiceLineFactUNSPSC.Level[4]
								if (!LocalInvoiceLineFactUNSPSC exists)
									invoke Create InvoiceLineFactUNSPSC
										invoked.ProcurementGroup							= CurrentProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= CurrentInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.UNSPSCCode									= LocalUNSPSC
										invoked.ConsolidationLevel							= 2

					Exit Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							if (CurrentUNSPSCFamily entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.UNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentUNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.UNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentUNSPSCFamily
									initialize InvoiceLineFactConsolidateLookup.Level3.Type
									initialize InvoiceLineFactConsolidateLookup.Level3.Value
									initialize InvoiceLineFactConsolidateLookup.Level4.Type
									initialize InvoiceLineFactConsolidateLookup.Level4.Value
									initialize InvoiceLineFactConsolidateLookup.Level5.Type
									initialize InvoiceLineFactConsolidateLookup.Level5.Value
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 2
										invoked.ConsolidationDateRange							= ConsolidationDateRange
									I1 += 1
	
								if (TotalOnOffSpend		!= 0)
									LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
									LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
									initialize LocalInvoiceLineFactUNSPSC.Level[3]
									initialize LocalInvoiceLineFactUNSPSC.Level[4]
									LocalProcurementGroup						= CurrentProcurementGroup
									LocalInvoiceLineFactConsolidateControl		= CurrentInvoiceLineFactConsolidateControl
									invoke Update InvoiceLineFactUNSPSCRel
										invoked.ProcurementGroup							= LocalProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= LocalInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.TotalSpend									+= TotalOnOffSpend
					
				UNSPSC.UNSPSCClass Set Rules
					Entrance Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							CurrentUNSPSCClass				= UNSPSC.UNSPSCClass
							if (CurrentUNSPSCClass entered)
								LocalUNSPSC.UNSPSCSegment		= CurrentUNSPSCSegment
								LocalUNSPSC.UNSPSCFamily		= CurrentUNSPSCFamily
								LocalUNSPSC.UNSPSCClass			= CurrentUNSPSCClass
								LocalUNSPSC.UNSPSCCommodity		= "00"
								LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
								LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
								LocalInvoiceLineFactUNSPSC.Level[3]			= CurrentUNSPSCClass
								initialize LocalInvoiceLineFactUNSPSC.Level[4]
								if (!LocalInvoiceLineFactUNSPSC exists)
									invoke Create InvoiceLineFactUNSPSC
										invoked.ProcurementGroup							= CurrentProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= CurrentInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.UNSPSCCode									= LocalUNSPSC
										invoked.ConsolidationLevel							= 3
					
					Exit Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							if (CurrentUNSPSCClass entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.UNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentUNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.UNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentUNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.UNSPSCClass
									InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentUNSPSCClass
									initialize InvoiceLineFactConsolidateLookup.Level4.Type
									initialize InvoiceLineFactConsolidateLookup.Level4.Value
									initialize InvoiceLineFactConsolidateLookup.Level5.Type
									initialize InvoiceLineFactConsolidateLookup.Level5.Value
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 3
										invoked.ConsolidationDateRange							= ConsolidationDateRange
									I1 += 1
	
								if (TotalOnOffSpend		!= 0)
									LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
									LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
									LocalInvoiceLineFactUNSPSC.Level[3]			= CurrentUNSPSCClass
									initialize LocalInvoiceLineFactUNSPSC.Level[4]
									LocalProcurementGroup						= CurrentProcurementGroup
									LocalInvoiceLineFactConsolidateControl		= CurrentInvoiceLineFactConsolidateControl
									invoke Update InvoiceLineFactUNSPSCRel
										invoked.ProcurementGroup							= LocalProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= LocalInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.TotalSpend									+= TotalOnOffSpend
					
				UNSPSC.UNSPSCCommodity Set Rules
					Entrance Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							CurrentUNSPSCCommodity		= UNSPSC.UNSPSCCommodity
							if (CurrentUNSPSCCommodity entered)
								LocalUNSPSC.UNSPSCSegment		= CurrentUNSPSCSegment
								LocalUNSPSC.UNSPSCFamily		= CurrentUNSPSCFamily
								LocalUNSPSC.UNSPSCClass			= CurrentUNSPSCClass
								LocalUNSPSC.UNSPSCCommodity		= CurrentUNSPSCCommodity
								LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
								LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
								LocalInvoiceLineFactUNSPSC.Level[3]			= CurrentUNSPSCClass
								LocalInvoiceLineFactUNSPSC.Level[4]			= CurrentUNSPSCCommodity
								if (!LocalInvoiceLineFactUNSPSC exists)
									invoke Create InvoiceLineFactUNSPSCRel
										invoked.ProcurementGroup							= CurrentProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= CurrentInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.UNSPSCCode									= LocalUNSPSC
										invoked.ConsolidationLevel							= 4
					
					Exit Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							if (CurrentUNSPSCCommodity entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.UNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentUNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.UNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentUNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.UNSPSCClass
									InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentUNSPSCClass
									InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.UNSPSCCommodity
									InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentUNSPSCCommodity
									initialize InvoiceLineFactConsolidateLookup.Level5.Type
									initialize InvoiceLineFactConsolidateLookup.Level5.Value
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 4
										invoked.ConsolidationDateRange							= ConsolidationDateRange
									I1 += 1
	
								if (TotalOnOffSpend		!= 0)
									LocalInvoiceLineFactUNSPSC.Level[1]			= CurrentUNSPSCSegment
									LocalInvoiceLineFactUNSPSC.Level[2]			= CurrentUNSPSCFamily
									LocalInvoiceLineFactUNSPSC.Level[3]			= CurrentUNSPSCClass
									LocalInvoiceLineFactUNSPSC.Level[4]			= CurrentUNSPSCCommodity
									LocalProcurementGroup						= CurrentProcurementGroup
									LocalInvoiceLineFactConsolidateControl		= CurrentInvoiceLineFactConsolidateControl
									invoke Update InvoiceLineFactUNSPSCRel
										invoked.ProcurementGroup							= LocalProcurementGroup
										invoked.InvoiceLineFactConsolidateControl			= LocalInvoiceLineFactConsolidateControl
										invoked.InvoiceLineFactUNSPSC						= LocalInvoiceLineFactUNSPSC
										invoked.TotalSpend									+= TotalOnOffSpend
					
				Item Set Rules
					Entrance Rules
						CurrentItem				= Item
						CurrentItemType			= ItemType
						CurrentItemDescription	= ItemDescription
					Exit Rules
						if (ConsolidationOptions.ConsolidateUNSPSCSpend)
							if ((CurrentUNSPSCSegment entered
							or   CurrentUNSPSCFamily entered
							or   CurrentUNSPSCClass entered
							or   CurrentUNSPSCCommodity entered)
							and CurrentItemType entered)
								SpendAccumulation.Amount[1]		= TotalOnContractAmount
								SpendAccumulation.Amount[2]		= TotalOffContractAmount
								SpendAccumulation.Amount[3]		= TotalNoContractAmount
								I1								= 1
								while (I1 < 4)
									InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.UNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentUNSPSCSegment
									InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.UNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentUNSPSCFamily
									InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.UNSPSCClass
									InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentUNSPSCClass
									InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.UNSPSCCommodity
									InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentUNSPSCCommodity
									InvoiceLineFactConsolidateLookup.Level5.Type		= SpendDimension.Type.Item
									InvoiceLineFactConsolidateLookup.Level5.Value		= CurrentItem
									initialize InvoiceLineFactConsolidateLookup.Level6.Type
									initialize InvoiceLineFactConsolidateLookup.Level6.Value
									InvoiceLineFactConsolidateLookup.SpendCategory		= I1
									if (TotalOnOffSpend !=0)
										LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
										if (LocalPercent < 0)
											LocalPercent = 0
									else
										LocalPercent	= 0
									invoke Update InvoiceLineFactConsolidateLookup 
										invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
										invoked.OnOffPercent									= LocalPercent
										invoked.TotalOnOffSpend									= TotalOnOffSpend
										invoked.TotalOnOffQuantity								= TotalOnOffQuantity
										invoked.ConsolidationLevel								= 5
										invoked.ItemType										= CurrentItemType
										invoked.ItemDescription									= CurrentItemDescription
										invoked.ConsolidationDateRange							= ConsolidationDateRange
										invoked.UNSPSCSegment									= CurrentUNSPSCSegment
										invoked.UNSPSCFamily									= CurrentUNSPSCFamily
										invoked.UNSPSCClass										= CurrentUNSPSCClass
										invoked.UNSPSCCommodity									= CurrentUNSPSCCommodity
									I1 += 1

				Instance Rules
				
					if (InvoiceLineFact.CompanyPurchaseOrder.PurchaseOrder	entered)
						if (UNSPSC entered)
							TotalOnOffSpend					+= InvoiceAmount
							TotalOnOffQuantity				+= (MatchedQuantity * VpriUomMult)
							if (SpendCategory.OnContract)
								TotalOnContractAmount		+= InvoiceAmount
							else
							if (OffContract)
								TotalOffContractAmount		+= InvoiceAmount
							else
								TotalNoContractAmount		+= InvoiceAmount	
								
		ConsolidateYearQuarterMonthItem is a Set Action

			restricted
			completion message is "ConsolidateYearQuarterMonthItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				InvoiceList								is an InvoiceLineFact group
				
			Parameter Rules
				PrmProcurementGroup
					required
						"ProcurementGroupRequired"
						
			Local Fields
				CurrentYear								is Year
				CurrentQuarter							is Numeric 1
				CurrentMonth							is Period
				CurrentItem								is an Item
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent							is Percent size 5.2
				SpendAccumulation		
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalNoPurchaseOrderAmount
				TotalOnOffSpend
				TotalDiversitySpend
				TotalNonDiversitySpend
				TotalLocalSpend
											
			Instance Selection
				where (ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))		
			Sort Order
				ProcurementGroup
				InvoiceYear
				InvoiceQuarter
				InvoiceMonth
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
							
				InvoiceYear Set Rules
					Entrance Rules
						CurrentYear				= InvoiceYear
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 1
							I1 += 1

				InvoiceQuarter Set Rules
					Entrance Rules
						CurrentQuarter				= InvoiceQuarter
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Quarter
							InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentQuarter
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 2
							I1 += 1

				InvoiceMonth Set Rules
					Entrance Rules
						CurrentMonth				= InvoiceMonth
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Quarter
							InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentQuarter
							InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.Month
							InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentMonth
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 3

							I1 += 1

				Item Set Rules
					Entrance Rules
						CurrentItem					= Item
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Quarter
							InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentQuarter
							InvoiceLineFactConsolidateLookup.Level3.Type		= SpendDimension.Type.Month
							InvoiceLineFactConsolidateLookup.Level3.Value		= CurrentMonth
							InvoiceLineFactConsolidateLookup.Level4.Type		= SpendDimension.Type.Item
							InvoiceLineFactConsolidateLookup.Level4.Value		= CurrentItem
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 4
							I1 += 1

				Instance Rules
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (CmContract entered)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
						if (CompanyPurchaseOrder.PurchaseOrder entered)
							TotalNoContractAmount		+= InvoiceAmount
						else
							TotalNoPurchaseOrderAmount	+= InvoiceAmount	
								
		ConsolidateYearItem is a Set Action

			restricted
			completion message is "ConsolidateYearItemIsComplete"
			Parameters
				PrmProcurementGroup						is a ProcurementGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				InvoiceList								is an InvoiceLineFact group
				
			Parameter Rules
				PrmProcurementGroup
					required
						"ProcurementGroupRequired"
						
			Local Fields
				CurrentYear								is Year
				CurrentItem								is an Item
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent							is Percent size 5.2
				SpendAccumulation	
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalNoPurchaseOrderAmount
				TotalOnOffSpend
				TotalDiversitySpend
				TotalNonDiversitySpend
				TotalLocalSpend
											
			Instance Selection
				where (ProcurementGroup	= PrmProcurementGroup
				and   (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))
										
			Sort Order
				InvoiceYear
				Item
								
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
						
				InvoiceYear Set Rules
					Entrance Rules
						CurrentYear				= InvoiceYear
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 1
							I1 += 1

				Item Set Rules
					Entrance Rules
						CurrentItem					= Item
					Exit Rules
						SpendAccumulation.Amount[1]		= TotalOnContractAmount
						SpendAccumulation.Amount[2]		= TotalOffContractAmount
						SpendAccumulation.Amount[3]		= TotalNoContractAmount
						SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
						I1 								= 1
						while (I1 < 5)
							initialize InvoiceLineFactConsolidateLookup
							InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.Year
							InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentYear
							InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Item
							InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentItem
							InvoiceLineFactConsolidateLookup.SpendCategory		= I1
							if (TotalOnOffSpend !=0)
								LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
								if (LocalPercent < 0)
									LocalPercent = 0
							else
								LocalPercent	= 0
							invoke Update InvoiceLineFactConsolidateLookup 
								invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
								invoked.OnOffPercent									= LocalPercent
								invoked.TotalOnOffSpend									= TotalOnOffSpend
								invoked.ConsolidationLevel								= 2
							I1 += 1

				Instance Rules
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (CmContract entered)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
						if (CompanyPurchaseOrder.PurchaseOrder entered)
							TotalNoContractAmount		+= InvoiceAmount
						else
							TotalNoPurchaseOrderAmount	+= InvoiceAmount	
								
		ConsolidateDiverseCodeVendor is a Set Action

			restricted
			completion message is "ConsolidateDiverseCodeVendorIsComplete"
			Parameters
				PrmVendorGroup							is a VendorGroup
				PrmInvoiceLineFactConsolidateControl	is an InvoiceLineFactConsolidateControl
				ConsolidationDateRange					is a DateRange	
				ConsolidateLastTwelveMonths				is Boolean
				ConsolidationOptions
				InvoiceList								is an InvoiceLineFact group
				
			Parameter Rules
				PrmVendorGroup
					required
						"VendorGroupRequired"
						
			Local Fields
				CurrentDiverseCode						is a PayablesDiversityCode
				CurrentSupplier							is a Vendor
				InvoiceLineFactConsolidateLookup		is an InvoiceLineFactConsolidate
				LocalPercent							is Percent size 5.2
				CurrentProcurementGroup					is AlphaUpper 4
				SpendAccumulation	
				I1										is Numeric 2
				
			Accumulators
				TotalOnContractAmount
				TotalOffContractAmount
				TotalNoContractAmount
				TotalNoPurchaseOrderAmount
				TotalOnOffSpend
				TotalDiversitySpend
				TotalNonDiversitySpend
				TotalLocalSpend
											
			Instance Selection
				where (InvoiceDate		within ConsolidationDateRange
				and    ProcurementGroup	= PrmVendorGroup.ProcurementGroupRel.ProcurementGroup
				and    (InvoiceList not entered
				or     InvoiceLineFact within InvoiceList))				
			Sort Order
				ProcurementGroup
				PayablesDiversityCode
				Vendor
				
			Action Rules
				Set Rules
					Entrance Rules
						LocalProcurementGroup					= PrmVendorGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl

				ProcurementGroup Set Rules
					Entrance Rules
						LocalItemGroup						= PrmVendorGroup

					Exit Rules
						LocalProcurementGroup					= PrmVendorGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
						LocalDiversityFlag 					= 1
						invoke Update InvoiceLineFactDiversityConsolidateRel
							invoked.ProcurementGroup									= LocalProcurementGroup
							invoked.InvoiceLineFactConsolidateControl					= LocalInvoiceLineFactConsolidateControl
							invoked.InvoiceLineFactDiversityConsolidate.DiversityFlag	= LocalDiversityFlag
							invoked.TotalExtendedAmount									= TotalDiversitySpend
							invoked.TotalSpend											= TotalOnOffSpend
						LocalProcurementGroup					= PrmVendorGroup.ProcurementGroupRel.ProcurementGroup
						LocalInvoiceLineFactConsolidateControl	= PrmInvoiceLineFactConsolidateControl
						LocalDiversityFlag 					= 2
						invoke Update InvoiceLineFactDiversityConsolidateRel
							invoked.ProcurementGroup									= LocalProcurementGroup
							invoked.InvoiceLineFactConsolidateControl					= LocalInvoiceLineFactConsolidateControl
							invoked.InvoiceLineFactDiversityConsolidate.DiversityFlag	= LocalDiversityFlag
							invoked.TotalExtendedAmount									= TotalNonDiversitySpend
							invoked.TotalSpend											= TotalOnOffSpend

				PayablesDiversityCode Set Rules
					Entrance Rules
						CurrentDiverseCode			= PayablesDiversityCode

					Exit Rules
						if (ConsolidationOptions.ConsolidateDiversitySpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
							I1 								= 1
							while (I1 < 5)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.DiversityCode
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentDiverseCode
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.ConsolidationLevel								= 1
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1

				Vendor Set Rules
					Entrance Rules
						CurrentSupplier				= Vendor
					Exit Rules
						if (ConsolidationOptions.ConsolidateDiversitySpend)
							SpendAccumulation.Amount[1]		= TotalOnContractAmount
							SpendAccumulation.Amount[2]		= TotalOffContractAmount
							SpendAccumulation.Amount[3]		= TotalNoContractAmount
							SpendAccumulation.Amount[4]		= TotalNoPurchaseOrderAmount
							I1 								= 1
							while (I1 < 5)
								initialize InvoiceLineFactConsolidateLookup
								InvoiceLineFactConsolidateLookup.Level1.Type		= SpendDimension.Type.DiversityCode
								InvoiceLineFactConsolidateLookup.Level1.Value		= CurrentDiverseCode
								InvoiceLineFactConsolidateLookup.Level2.Type		= SpendDimension.Type.Supplier
								InvoiceLineFactConsolidateLookup.Level2.Value		= CurrentSupplier
								InvoiceLineFactConsolidateLookup.SpendCategory		= I1
								if (TotalOnOffSpend !=0)
									LocalPercent	= (SpendAccumulation.Amount[I1] / TotalOnOffSpend)
									if (LocalPercent < 0)
										LocalPercent = 0
								else
									LocalPercent	= 0
								invoke Update InvoiceLineFactConsolidateLookup 
									invoked.TotalExtendedAmount				 				= SpendAccumulation.Amount[I1]
									invoked.OnOffPercent									= LocalPercent
									invoked.TotalOnOffSpend									= TotalOnOffSpend
									invoked.ConsolidationLevel								= 2
									invoked.ConsolidationDateRange							= ConsolidationDateRange
								I1 += 1

				Instance Rules
					if (PayablesInvoiceExists)
						
						TotalOnOffSpend					+= InvoiceAmount
						if (SpendCategory.OnContract)
							TotalOnContractAmount		+= InvoiceAmount
						else
						if (OffContract)
							TotalOffContractAmount		+= InvoiceAmount
						else
							TotalNoContractAmount		+= InvoiceAmount	
							
						if (PayablesDiversityCode	entered)
							TotalDiversitySpend			+= InvoiceAmount
						else
							TotalNonDiversitySpend		+= InvoiceAmount
							
		PurgeInvoiceLineFact is a Set Action

			restricted
			completion message is "PurgeInvoiceLineFactIsComplete"
			Parameters
				PrmVendorGroup					is a VendorGroup
				PrmBeginDate					is Date
				PrmEndDate                      is Date
				
			Parameter Rules
				PrmVendorGroup
					required
						"VendorGroupRequired"
				
				PrmBeginDate
					required
						"BeginDateIsRequired"
						
				PrmEndDate
					default to current corporate date
					
 		           	constraint (PrmEndDate >= PrmBeginDate)
        		    	"EndDateCannotPrecedeBeginDate"
					
			Local Fields
				CurrentProcurementGroupSetActionInvoiceSpendExportAndConsolidate	is a ProcurementGroupSetAction

			Instance Selection
				where (ProcurementGroup			= PrmVendorGroup.ProcurementGroupRel.ProcurementGroup
				and   (InvoiceDate              >= PrmBeginDate
				and    InvoiceDate              <= PrmEndDate))
				
			Sort Order
				ProcurementGroup
				InvoiceDate
				
			Action Rules
				ProcurementGroup Set Rules
					Entrance Rules
						CurrentProcurementGroupSetActionInvoiceSpendExportAndConsolidate	= 11

					Exit Rules
						invoke Update CurrentProcurementGroupSetActionInvoiceSpendExportAndConsolidate
							invoked.ProcurementGroup		= PrmVendorGroup.ProcurementGroupRel.ProcurementGroup
							invoked.LoadType				= 11
							initialize invoked.LastRunEndDate 

				Instance Rules
					invoke Purge 			

		UpdateUnreleasedInvoiceLineFact is a Set Action

			restricted
			completion message is "UpdateUnreleasedInvoiceLineFactIsComplete"
			Parameters
				PrmVendorGroup					is a VendorGroup
				
			Parameter Rules
				PrmVendorGroup
					required
						"VendorGroupRequired"
					
			Instance Selection
				where (ProcurementGroup			= PrmVendorGroup.ProcurementGroupRel.ProcurementGroup
				and    InvoiceStatus.Unreleased)
				
			Sort Order
				ProcurementGroup
				InvoiceStatus
				
			Action Rules
				Instance Rules
					if (PayablesInvoice not exist)
						invoke Purge
					else
						TransientTransactionAmount 		= PayablesInvoice.TotalTaxAmount
						TransientFromCurrency			= PayablesInvoice.InvoiceCurrency
						TransientExchangeDate			= PayablesInvoice.InvoiceDate
						TransientCurrencyTable			= PayablesInvoice.Company.CurrencyTable
						if (PayablesInvoice.InvoiceCurrency		!= PayablesInvoice.Company.Currency)
							LocalContractCurrencyExchange.ToCurrency			= PayablesInvoice.Company.Currency
							LocalContractCurrencyExchange.EnteredCurrencyRate	= PayablesInvoice.InvoiceAmount.FunctionalAmount.EnteredCurrencyRate
							initialize LocalContractCurrencyExchange.EnteredCurrencyAmount
							LocalTaxAmount				= LocalContractCurrencyExchange.OutputCurrencyAmount
						else
							LocalTaxAmount				= PayablesInvoice.TotalTaxAmount

						invoke Update
							invoked.InvoiceStatus			= PayablesInvoice.Status
							invoked.PayablesDiversityCode	= PayablesInvoice.DiversityCode
							invoked.ProcurementGroup		= PayablesInvoice.Company.VendorGroup.ProcurementGroupRel.ProcurementGroup
							invoked.InvoiceDate				= PayablesInvoice.InvoiceDate
							invoked.MatchDate				= PayablesInvoice.MatchDate
							invoked.CreateDate				= PayablesInvoice.CreateDate
							invoked.InvoiceAmount			= PayablesInvoice.InvoiceAmount.FunctionalAmount.EnteredCurrencyAmount
							invoked.SpendAmount				= PayablesInvoice.InvoiceAmount.FunctionalAmount.EnteredCurrencyAmount
							invoked.CurrencyCode			= PayablesInvoice.InvoiceCurrency
							invoked.OrigCnvRate				= PayablesInvoice.InvoiceAmount.FunctionalAmount.EnteredCurrencyRate
							invoked.Buyer					= PayablesInvoice.Buyer
							invoked.TaxTotalAmount			= LocalTaxAmount
