GLZoneBalance is a BusinessClass
    owned by GeneralLedger
    prefix is GLZBT
    default label is "GlobalLedgerZoneBalance"

    Ontology
    	symbolic key is GLZoneBalance

    Patterns
 		implements DynamicCreation
 		disable Auditing 
 		disable EffectiveDated
		disable AsOfDateProcessing

    Persistent Fields
		BaseZoneAmount				is a FinanceAmountOnlyGroup 
		ZoneAmount					is a FinanceAmountOnlyGroup 

	Transient Fields
		TransientCalendarYear	is Alpha 4
			derive value from DerivedCalendarYear

		BaseTransactionAmount		is an InternationalAmount
			precision is GLZoneBalance.Currency.NumberOfDecimals
		BaseFunctionalAmount		is an InternationalAmount
			precision is AccountingEntity.FunctionalCurrency.NumberOfDecimals
		BaseAlternateAmount			is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency.NumberOfDecimals
		BaseAlternateAmount2		is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency2.NumberOfDecimals
		BaseAlternateAmount3		is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency3.NumberOfDecimals
		BaseProjectAmount			is an InternationalAmount
		BaseReportAmount1			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyOne.NumberOfDecimals
		BaseReportAmount2			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyTwo.NumberOfDecimals
		BaseReportAmount3			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyThree.NumberOfDecimals
		BaseReportAmount4			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFour.NumberOfDecimals
		BaseReportAmount5			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFive.NumberOfDecimals
		BaseUnitsAmount				is an UnitsAmount

		ZoneTransactionAmount		is an InternationalAmount
			precision is GLZoneBalance.Currency.NumberOfDecimals
		ZoneFunctionalAmount		is an InternationalAmount
			precision is AccountingEntity.FunctionalCurrency.NumberOfDecimals
		ZoneAlternateAmount			is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency.NumberOfDecimals
		ZoneAlternateAmount2		is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency2.NumberOfDecimals
		ZoneAlternateAmount3		is an InternationalAmount
			precision is AccountingEntity.AlternateCurrency3.NumberOfDecimals
		ZoneProjectAmount			is an InternationalAmount
		ZoneReportAmount1			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyOne.NumberOfDecimals
		ZoneReportAmount2			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyTwo.NumberOfDecimals
		ZoneReportAmount3			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyThree.NumberOfDecimals
		ZoneReportAmount4			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFour.NumberOfDecimals
		ZoneReportAmount5			is an InternationalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFive.NumberOfDecimals
		ZoneUnitsAmount				is an UnitsAmount

	Derived Fields
		DerivedCalendarYear			is a DerivedField
			type is Alpha 4
			restricted
			initialize LocalCalendarYear
			if (GLZoneBalance.EntityYearPeriod.PeriodType.EndDate
			or  GLZoneBalance.EntityYearPeriod.PeriodType.BeginningBalance)
				LocalCalendarYear	= GLZoneBalance.EntityYearPeriod.Year 
				if (!LocalCalendarYear entered)
					LocalCalendarYear	= GLZoneBalance.EntityYearPeriod[1:4] 
				return LocalCalendarYear
    	DerivedBaseZoneAmountsExist 	is a ConditionalField
    		type is Boolean

			if (BaseZoneAmount.TransactionAmount entered
			or  BaseZoneAmount.FunctionalAmount  entered
			or  BaseZoneAmount.AlternateAmount   entered
			or  BaseZoneAmount.AlternateAmount2  entered
			or  BaseZoneAmount.AlternateAmount3  entered

			or  BaseZoneAmount.ReportAmount1     entered
			or  BaseZoneAmount.ReportAmount2     entered
			or  BaseZoneAmount.ReportAmount3     entered
			or  BaseZoneAmount.ReportAmount4     entered
			or  BaseZoneAmount.ReportAmount5     entered)
				true
			else
				false    		
    	DerivedZoneAmountsExist 	is a ConditionalField
    		type is Boolean

			if (ZoneAmount.TransactionAmount entered
			or  ZoneAmount.FunctionalAmount  entered
			or  ZoneAmount.AlternateAmount   entered
			or  ZoneAmount.AlternateAmount2  entered
			or  ZoneAmount.AlternateAmount3  entered

			or  ZoneAmount.ReportAmount1     entered
			or  ZoneAmount.ReportAmount2     entered
			or  ZoneAmount.ReportAmount3     entered
			or  ZoneAmount.ReportAmount4     entered
			or  ZoneAmount.ReportAmount5     entered)
				true
			else
				false    		

	Local Fields
		LocalCalendarYear					is Alpha 4

	Relations
		GeneralLedgerTransactionRel
			one-to-many relation to GeneralLedgerTransaction
			Field Mapping uses ByGeneralLedgerTotalOrder
				related.FinanceEnterpriseGroup						= FinanceEnterpriseGroup
				related.AccountingEntity							= AccountingEntity
				related.GeneralLedgerCalendarPeriod					= GLZoneBalance.EntityYearPeriod				
				related.FinanceCodeBlock.Ledger						= GLZoneBalance.Ledger
				related.System										= GLZoneBalance.System
				related.CurrencyCode								= GLZoneBalance.Currency
            Instance Selection
                where ((related.FinanceCodeBlock.AccountingUnit				= GLZoneBalance.BaseZoneAccountingUnit
				and     related.FinanceCodeBlock.FinanceDimension1			= GLZoneBalance.BaseZoneFinanceDimension
				or     (related.FinanceCodeBlock.AccountingUnit				= GLZoneBalance.ZoneAccountingUnit
				and     related.FinanceCodeBlock.FinanceDimension1			= GLZoneBalance.ZoneFinanceDimension))
				and    (related.FinanceCodeBlock.GeneralLedgerChartAccount	= GLZoneBalance.BaseZoneAccount
				or      related.FinanceCodeBlock.GeneralLedgerChartAccount	= GLZoneBalance.ZoneAccount))
		AccountingEntitySecurityGroupMemberRel
			one-to-one relation to AccountingEntityGroupMember
			Field Mapping uses part of key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.AccountingEntityGroup	= actor.context.AccountingEntitySecurityGroup.FinanceDimensionStructure
				related.AccountingEntity		= AccountingEntity

	Conditions
		AlternateCurrencyExists
			restricted
			when (AccountingEntity.AlternateCurrencyEntered)
		AlternateCurrency2Exists
			restricted
			when (AccountingEntity.AlternateCurrency2Entered)
		AlternateCurrency3Exists
			restricted
			when (AccountingEntity.AlternateCurrency3Entered)			
		ReportCurrencyOneExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyOneEntered)
		ReportCurrencyTwoExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyTwoEntered)
		ReportCurrencyThreeExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyThreeEntered)
		ReportCurrencyFourExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyFourEntered)
		ReportCurrencyFiveExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyFiveEntered)
		AccountingUnitUsed
			restricted
			when (FinanceEnterpriseGroup.AccountingUnitLabel entered)
		Dim1ZoneBalancing
			restricted
			when (FinanceEnterpriseGroup.Dimension1ZoneBalancing)
		EntityZoneBalancing
			restricted
			when (AccountingEntity.AccountingUnitZoneBalancing)
		SecurityGroupAllowsAccess
			when (actor.context.AccountingEntitySecurityGroup = blank
			or   (AccountingEntitySecurityGroupMemberRel exists))

	Sets				
		ByBaseZone
			duplicates
			Sort Order
				FinanceEnterpriseGroup
				AccountingEntity
	        	GLZoneBalance.Ledger 
    	    	GLZoneBalance.System
    	    	GLZoneBalance.Currency
    	    	GLZoneBalance.EntityYearPeriod
	        	GLZoneBalance.BaseZoneAccountingUnit 
    	    	GLZoneBalance.BaseZoneFinanceDimension
    	    	GLZoneBalance.BaseZoneAccount
		ByZone
			duplicates
			Sort Order
				FinanceEnterpriseGroup
				AccountingEntity
	        	GLZoneBalance.Ledger 
    	    	GLZoneBalance.System
    	    	GLZoneBalance.Currency
    	    	GLZoneBalance.EntityYearPeriod
	        	GLZoneBalance.ZoneAccountingUnit 
    	    	GLZoneBalance.ZoneFinanceDimension
    	    	GLZoneBalance.ZoneAccount

	Field Rules
	Rule Blocks
		InitializeAmounts
			initialize BaseZoneAmount.TransactionAmount
			initialize BaseZoneAmount.FunctionalAmount
			initialize BaseZoneAmount.AlternateAmount
			initialize BaseZoneAmount.AlternateAmount2
			initialize BaseZoneAmount.AlternateAmount3
			initialize BaseZoneAmount.ProjectAmount
			initialize BaseZoneAmount.ReportAmount1
			initialize BaseZoneAmount.ReportAmount2
			initialize BaseZoneAmount.ReportAmount3
			initialize BaseZoneAmount.ReportAmount4
			initialize BaseZoneAmount.ReportAmount5

			initialize ZoneAmount.TransactionAmount
			initialize ZoneAmount.FunctionalAmount
			initialize ZoneAmount.AlternateAmount
			initialize ZoneAmount.AlternateAmount2
			initialize ZoneAmount.AlternateAmount3
			initialize ZoneAmount.ProjectAmount
			initialize ZoneAmount.ReportAmount1
			initialize ZoneAmount.ReportAmount2
			initialize ZoneAmount.ReportAmount3
			initialize ZoneAmount.ReportAmount4
			initialize ZoneAmount.ReportAmount5

		UpdateActualTotal
			BaseZoneAmount.TransactionAmount	+= BaseTransactionAmount
			BaseZoneAmount.FunctionalAmount		+= BaseFunctionalAmount
			BaseZoneAmount.AlternateAmount		+= BaseAlternateAmount
			BaseZoneAmount.AlternateAmount2		+= BaseAlternateAmount2
			BaseZoneAmount.AlternateAmount3		+= BaseAlternateAmount3

			BaseZoneAmount.ReportAmount1		+= BaseReportAmount1
			BaseZoneAmount.ReportAmount2		+= BaseReportAmount2
			BaseZoneAmount.ReportAmount3		+= BaseReportAmount3
			BaseZoneAmount.ReportAmount4		+= BaseReportAmount4
			BaseZoneAmount.ReportAmount5		+= BaseReportAmount5
			BaseZoneAmount.UnitsAmount			+= BaseUnitsAmount

			ZoneAmount.TransactionAmount		+= ZoneTransactionAmount
			ZoneAmount.FunctionalAmount			+= ZoneFunctionalAmount
			ZoneAmount.AlternateAmount			+= ZoneAlternateAmount
			ZoneAmount.AlternateAmount2			+= ZoneAlternateAmount2
			ZoneAmount.AlternateAmount3			+= ZoneAlternateAmount3

			ZoneAmount.ReportAmount1			+= ZoneReportAmount1
			ZoneAmount.ReportAmount2			+= ZoneReportAmount2
			ZoneAmount.ReportAmount3			+= ZoneReportAmount3
			ZoneAmount.ReportAmount4			+= ZoneReportAmount4
			ZoneAmount.ReportAmount5			+= ZoneReportAmount5
			ZoneAmount.UnitsAmount				+= ZoneUnitsAmount

	Actions
		Create is a Create Action
			restricted
			bypass field rules
			Action Rules
				include UpdateActualTotal

		Update is an Update Action
			restricted
			bypass field rules
			Action Rules
				include UpdateActualTotal

		Delete is a Delete Action
			restricted
			Action Rules

		InitializeZoneTotals is a Set Action
			restricted
			Parameters
				PrmFinanceEnterpriseGroup	is a FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmAccountingEntity			is a AccountingEntity
					default label is "AccountingEntity"
				PrmFrCalendarPeriod			is a GeneralLedgerCalendarPeriod
					default label is "GlobalLedgerClosePeriod"
				PrmToCalendarPeriod			is a GeneralLedgerCalendarPeriod
					default label is "GlobalLedgerClosePeriod"
				
			Parameter Rules
				PrmFinanceEnterpriseGroup
					required
				PrmAccountingEntity
					required
				PrmFrCalendarPeriod
					required
				PrmToCalendarPeriod
					required

			Queue Mapping Fields
				PrmAccountingEntity.PostingCategory
				
			Instance Selection
				where (FinanceEnterpriseGroup			= PrmFinanceEnterpriseGroup
				and	   AccountingEntity					= PrmAccountingEntity
				and   ((PrmFrCalendarPeriod				= PrmToCalendarPeriod
				and     GLZoneBalance.EntityYearPeriod	<= PrmToCalendarPeriod)
				or     (GLZoneBalance.EntityYearPeriod	> PrmFrCalendarPeriod
				and     GLZoneBalance.EntityYearPeriod	<= PrmToCalendarPeriod)))

			Sort Order
				FinanceEnterpriseGroup
				AccountingEntity
				GLZoneBalance.EntityYearPeriod

			Action Rules
				Empty Set Rules

				Set Rules

				Instance Rules
					if (first GeneralLedgerTransactionRel exists)
						include InitializeAmounts
					else
						invoke Delete
					
