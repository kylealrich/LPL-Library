EscheatmentOutputFileDetail is a BusinessClass
    owned by cb
    prefix is EDOFD

    Ontology
        symbolic key is EscheatmentOutputFileDetail

    Patterns
        implements StaticJava
        disable AuditIndex

    Persistent Fields
		Company                 		
        ProcessLevel               		
        CashCode                		
        BankTransactionCode     		
        TransactionNumber       		
        CashLedgerTransaction
        IssueDate						is Date
        StaleDate               		is Date
        EscheatDate               		is Date   
        IssuedBankAmount         		is an InternationalAmount
        Vendor                  		
        VendorName             			
        LegalName               		is a VendorName 
        	holds pii
        Address							is a PostalAddressV2	
        	holds pii
		StaleDateAccount   				is a FinanceCodeBlock
		EscheatmentAccount 				is a FinanceCodeBlock

        VendorGroup
        	disable surrogates
		PostDate						is Date		
        CashLedgerSourceRecord 
		CashLedgerTransactionIdentifier
		TransactionStatus				is Numeric 1
			States
				StaleDated 	value is 5
				Escheated 	value is 6
		Status							is Numeric 1
			States
				Selected	value is 1
				Processed	value is 2
		PayeeFirstName						is a FirstName			
		PayeeMiddleName						is a MiddleName			
						  
	Transient Fields
				
	Rule Blocks

    Derived Fields
			
        DoubleQuote        is a StringField
            type is Alpha 2048
            restricted
            "\""
		CsvHeader         is a StringField
            type is Alpha 2048
            restricted
			DoubleQuote
			EscheatmentOutputFileHeader.CashManagementGroup label
			DoubleQuote
			","
			Company label
			","
			DoubleQuote
			CashCode label
			DoubleQuote
			","
			DoubleQuote
			ProcessLevel label
			DoubleQuote
			","
			DoubleQuote
			BankTransactionCode label
			DoubleQuote
			","
			TransactionNumber label
			","
			CashLedgerTransaction label
			","
			IssueDate label
			","
			StaleDate label
			","
			EscheatDate label
			","
			IssuedBankAmount label
			","
			Vendor label
			","
			DoubleQuote
			VendorName label
			DoubleQuote
			","
			DoubleQuote
			LegalName label
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine1 label
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine2 label
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine3 label
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine4 label
			DoubleQuote
			","
			DoubleQuote
			Address.Municipality label
			DoubleQuote
			","
			DoubleQuote
			Address.StateProvince label
			DoubleQuote
			","
			DoubleQuote
			Address.PostalCode label
			DoubleQuote
			","
			DoubleQuote
			Address.Country label
			DoubleQuote
			","
			DoubleQuote
			StaleDateAccount label
			DoubleQuote
			","
			DoubleQuote
			EscheatmentAccount label
			DoubleQuote
			","
			DoubleQuote
			PayeeFirstName label 
			DoubleQuote
			","
			DoubleQuote
			PayeeMiddleName label	
			DoubleQuote

        CsvOutput        is a StringField
            type is Alpha 2048
            restricted
			DoubleQuote
			EscheatmentOutputFileHeader.CashManagementGroup
			DoubleQuote
			","
			Company
			","
			DoubleQuote
			CashCode
			DoubleQuote
			","
			DoubleQuote
			ProcessLevel
			DoubleQuote
			","
			DoubleQuote
			BankTransactionCode
			DoubleQuote
			","
			TransactionNumber
			","
			CashLedgerTransaction
			","
			IssueDate
			","
			StaleDate
			","
			EscheatDate
			","
			IssuedBankAmount
			","
			Vendor
			","
			DoubleQuote
			VendorName
			DoubleQuote
			","
			DoubleQuote
			LegalName
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine1
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine2
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine3
			DoubleQuote
			","
			DoubleQuote
			Address.DeliveryAddress.AddressLine4
			DoubleQuote
			","
			DoubleQuote
			Address.Municipality
			DoubleQuote
			","
			DoubleQuote
			Address.StateProvince
			DoubleQuote
			","
			DoubleQuote
			Address.PostalCode
			DoubleQuote
			","
			DoubleQuote
			Address.Country
			DoubleQuote
			","
			DoubleQuote
			StaleDateAccount
			DoubleQuote
			","
			DoubleQuote
			EscheatmentAccount
			DoubleQuote
			","
			DoubleQuote
			PayeeFirstName	
			DoubleQuote
			","
			DoubleQuote
			PayeeMiddleName	
			DoubleQuote

	Local Fields
		LocalEscheatmentOutputFileHeader	is a EscheatmentOutputFileHeader
					
	Context Fields

    Conditions
		CanRemoveFromSelectedList
    		restricted
    		when (Status.Selected)
    		
    Relations
		LastEscheatmentOutputFileDetailRel
			one-to-many relation to EscheatmentOutputFileDetail
			Field Mapping uses symbolic key
				related.CashManagementGroup			= CashManagementGroup
				related.EscheatmentOutputFileHeader	= EscheatmentOutputFileHeader

		CashLedgerTransactionRel
			one-to-one relation to CashLedgerTransaction
			Field Mapping uses symbolic key
				related.CashManagementGroup 	= CashManagementGroup	
				related.BankTransactionCode		= BankTransactionCode
				related.CashLedgerSourceRecord	= CashLedgerSourceRecord
				related.CashLedgerTransaction   = CashLedgerTransaction
	
		EscheatmentOutputFileHeaderRel
			one-to-one relation to EscheatmentOutputFileHeader
			Field Mapping uses symbolic key
				related.CashManagementGroup			= CashManagementGroup
				related.EscheatmentOutputFileHeader	= LocalEscheatmentOutputFileHeader
											
    Sets
    	ByStatus
    		indexed
			Sort Order
				CashManagementGroup
				EscheatmentOutputFileHeader
				Status		
				Company
				ProcessLevel
    			CashCode
    			BankTransactionCode
    			TransactionNumber
				EscheatmentOutputFileDetail
    					
    	ByCashCode
    		duplicates
			Sort Order
				CashManagementGroup
				EscheatmentOutputFileHeader		
				Company
				CashCode
				BankTransactionCode
		
		ByProcessLevel
			duplicates
			Sort Order
				CashManagementGroup
				EscheatmentOutputFileHeader
				Company
				ProcessLevel
				CashCode
				BankTransactionCode
			
		NoProcessLevelTotals
    		duplicates
			Sort Order
				Company
    			CashCode
    			BankTransactionCode
    			EscheatDate
				
		ProcessLevelTotals
    		duplicates
			Sort Order
				Company
				ProcessLevel
    			CashCode
    			BankTransactionCode
    			EscheatDate
		
				
    Field Rules
		Status
			initial value is 1	
			default to 1
			
	Actions
        Create is a Create Action
        	restricted
        	bypass field rules	
			Entrance Rules
				EscheatmentOutputFileDetail = last LastEscheatmentOutputFileDetailRel.EscheatmentOutputFileDetail + 1	
				
        Update is an Update Action
        	restricted
        	bypass field rules	
						
        Delete is a Delete Action
        	restricted
			Entrance Rules
				if (Status.Selected)
					if (CashLedgerTransactionRel exists
					and EscheatmentOutputFileHeader = CashLedgerTransactionRel.EscheatmentOutputFileHeader)
						invoke RemoveTransactionFromEscheatmentProcess CashLedgerTransactionRel
			Action Rules
						
        RemoveFromSelectedList is an Instance Action
			valid when (CanRemoveFromSelectedList)
			Entrance Rules
				if (CashLedgerTransactionRel exists
				and EscheatmentOutputFileHeader = CashLedgerTransactionRel.EscheatmentOutputFileHeader)
					invoke RemoveTransactionFromEscheatmentProcess CashLedgerTransactionRel
			Action Rules	
				LocalEscheatmentOutputFileHeader = EscheatmentOutputFileHeader
				invoke Delete
				invoke StatusUpdate EscheatmentOutputFileHeaderRel	
				
        ProcessEscheatmentDetails is a Set Action
        	default label is untranslatable
        	restricted
        	run in background	
        	Parameters
        		PrmCashManagementGroup			is a CashManagementGroup
				PrmEscheatmentOutputFileHeader	is an EscheatmentOutputFileHeader
        	Parameter Rules
					
			Instance Selection
				where (CashManagementGroup	 		= PrmCashManagementGroup
				and    EscheatmentOutputFileHeader	= PrmEscheatmentOutputFileHeader)

			Local Fields
  				
			Sort Order
				
			Action Rules
				Instance Rules
					if (CashLedgerTransactionRel exists)
						invoke UpdateSelectedEscheatmentTransactions CashLedgerTransactionRel
							invoked.PrmEscheatDate					= EscheatDate
							invoked.PrmPostDate						= PostDate
							invoked.PrmEscheatmentOutputFileHeader	= EscheatmentOutputFileHeader
							invoked.PrmEscheatmentOutputFileDetail	= EscheatmentOutputFileDetail

						
		DeleteEscheatmentOutputFileDetails is a Set Action	
			default label is untranslatable
			restricted
			Parameters
				PrmCashManagementGroup			is a CashManagementGroup
				PrmEscheatmentOutputFileHeader	is an EscheatmentOutputFileHeader
			
			Instance Selection
				where (EscheatmentOutputFileHeader = PrmEscheatmentOutputFileHeader)	
                
			Action Rules
				Set Rules
					Exit Rules
						invoke Delete PrmEscheatmentOutputFileHeader
				Instance Rules
					invoke Delete
					
															
