ExternalUserTransaction is a BusinessClass
    owned by person
    prefix is EXUST
    stored in environment

    Ontology
        symbolic key is ExternalUserTransaction

    Patterns
    	implements CRUD
    	implements CreateStamp
    	implements UpdateStamp
        disable AuditIndex
        disable AsOfDateProcessing
        disable EffectiveDated
        disable Auditing
	
	Persistent Fields
		Status 								is Numeric size 1
			States
				New 						value is 0				
				InProgress 					value is 1				
				IFSCompleted				value is 2				
				LmrkCompleted				value is 3				
					default label is "Landmark Completed"
				LmrkCompletedWithErrors		value is 4				
					default label is "Landmark Completed With Errors"
				CompletedSuccessfully 		value is 5				
				CompletedWithErrors 		value is 6				
		StatusMsg 							is Text
		
		IFSRequestCount						is Numeric size 3		
		IFSStartTimeStamp					is TimeStamp			
		IFSCompletedTimeStamp				is TimeStamp			
		LandmarkStartTimeStamp				is TimeStamp			
		LandmarkCompletedTimeStamp			is TimeStamp			
		UpdateAppStartTimeStamp				is TimeStamp			
			default label is "UpdateApplicationStartTimeStamp"
		UpdateAppCompletedTimeStamp			is TimeStamp			
			default label is "UpdateApplicationCompletedTimeStamp"

	Local Fields
		ElapseTime							is Numeric size 10
		DayTime								is Numeric size 6
		HourTime 							is Numeric size 2
		MinuteTime 							is Numeric size 2
		SecTime	 							is Numeric size 2
				
	Derived Fields
		ExternalEntityId is a DerivedField
			type is Alpha size 50
			return ExternalUserMigrationProcess.ExternalEntityId
		
		DataArea is a DerivedField
			type is Alpha size 40
			return ExternalUserMigrationProcess.DataArea
				
		Service is a DerivedField
			type is Alpha size 100
			return ExternalUserMigrationProcess.Service
			
		IFSProcessTime is a DerivedField
			type is Alpha size 40
			if(IFSCompletedTimeStamp != blank)
				ElapseTime = IFSCompletedTimeStamp - IFSStartTimeStamp
				
				DayTime = ((ElapseTime / 86400) - .5)
				if(DayTime < 0)
					DayTime = 0
					
				HourTime = (((ElapseTime - (DayTime * 86400)) / 3600) - .5)
				if(HourTime < 0)
					HourTime = 0
				
				MinuteTime = (((ElapseTime - (DayTime * 86400) - (HourTime * 3600)) / 60) - .5)
				if(MinuteTime < 0)
					MinuteTime = 0
					
				SecTime = ((ElapseTime -  (DayTime * 86400) - (HourTime * 3600) - (MinuteTime * 60)) - .5)
				if(SecTime < 0)
					SecTime = 0	
				
				return IFSProcessTimeMsg
				
		LandmarkProcessTime is a DerivedField
			type is Alpha size 40
			if(LandmarkCompletedTimeStamp != blank)
				ElapseTime = LandmarkCompletedTimeStamp - LandmarkStartTimeStamp
				
				DayTime = ((ElapseTime / 86400) - .5)
				if(DayTime < 0)
					DayTime = 0
					
				HourTime = (((ElapseTime - (DayTime * 86400)) / 3600) - .5)
				if(HourTime < 0)
					HourTime = 0
				
				MinuteTime = (((ElapseTime - (DayTime * 86400) - (HourTime * 3600)) / 60) - .5)
				if(MinuteTime < 0)
					MinuteTime = 0
					
				SecTime = ((ElapseTime -  (DayTime * 86400) - (HourTime * 3600) - (MinuteTime * 60)) - .5)
				if(SecTime < 0)
					SecTime = 0	
					
				return LandmarkProcessTimeMsg
				
		ApplicationProcessTime is a DerivedField
			type is Alpha size 40
			if(UpdateAppCompletedTimeStamp != blank)
				ElapseTime = UpdateAppCompletedTimeStamp - UpdateAppStartTimeStamp
				
				DayTime = ((ElapseTime / 86400) - .5)
				if(DayTime < 0)
					DayTime = 0
					
				HourTime = (((ElapseTime - (DayTime * 86400)) / 3600) - .5)
				if(HourTime < 0)
					HourTime = 0
				
				MinuteTime = (((ElapseTime - (DayTime * 86400) - (HourTime * 3600)) / 60) - .5)
				if(MinuteTime < 0)
					MinuteTime = 0
					
				SecTime = ((ElapseTime -  (DayTime * 86400) - (HourTime * 3600) - (MinuteTime * 60)) - .5)
				if(SecTime < 0)
					SecTime = 0	
				
				return ApplicationProcessMsg
				
        IFSProcessTimeMsg is a MessageField
            "<DayTime>D<HourTime>H<MinuteTime>M<SecTime>S"
            
        LandmarkProcessTimeMsg is a MessageField
            "<DayTime>D<HourTime>H<MinuteTime>M<SecTime>S"
            
        ApplicationProcessMsg is a MessageField
            "<DayTime>D<HourTime>H<MinuteTime>M<SecTime>S"
		
	Field Rules
		Status
			initial value is 0
			default to 0
		IFSRequestCount
			initial value is 0
			default to 0
				
	Conditions
    	AwaitingIFSUpdate
    		default label is "AwaitingIFSUpdate"
    		when (Status.New or Status.InProgress)
    		
    	AwaitingUpdate
    		default label is "AwaitingUpdate"
    		when (Status.IFSCompleted or Status.LmrkCompleted or Status.LmrkCompletedWithErrors)
    		    			
    	IsLmrkCompleted
    		default label is "Landmark Completed"
    		when (Status.LmrkCompleted or Status.LmrkCompletedWithErrors)

	Relations

		ExternalUserMigrationRel
			one-to-many relation to ExternalUserMigration
			Field Mapping uses symbolic key
				related.ExternalUserMigrationProcess = ExternalUserMigrationProcess
				related.ExternalUserTransaction = ExternalUserTransaction
		

		FailedExternalUserMigrationRel
			one-to-many relation to ExternalUserMigration
			Field Mapping uses symbolic key
				related.ExternalUserMigrationProcess = ExternalUserMigrationProcess
				related.ExternalUserTransaction = ExternalUserTransaction
			Instance Selection
				where (related.IsFailed)
		

		NotFailedExternalUserMigrationRel
			one-to-many relation to ExternalUserMigration
			Field Mapping uses symbolic key
				related.ExternalUserMigrationProcess = ExternalUserMigrationProcess
				related.ExternalUserTransaction = ExternalUserTransaction
			Instance Selection
				where (not related.IsFailed)	
		    
	Sets
		ByStamp
			indexed
			Sort Order
				create stamp
				ExternalUserMigrationProcess
				ExternalUserTransaction
		
		AwaitingIFSUpdateSet
			Sort Order
				ExternalUserMigrationProcess
			Instance Selection
				where (AwaitingIFSUpdate)
				
		AwaitingUpdateSet
			Sort Order
				ExternalUserMigrationProcess
			Instance Selection
				where (AwaitingUpdate)
				
	Actions
		Create is a Create Action
		
		Update is an Update Action
		
		Delete is a Delete Action
		
		Purge is a Purge Action
		
		PurgeAll is a Set Action
			Action Rules
				Instance Rules
					invoke Purge
