InvoiceLineFactConsolidateControl is a BusinessClass
	owned by procurement
	prefix is ILFCl
	sql name is InvoiceLFConsCntrl
	
	Ontology
		symbolic key is InvoiceLineFactConsolidateControl
		
	Patterns
        disable Auditing
        disable EffectiveDated

	Persistent Fields
		ConsolidationDateRange			is a DateRange
		ConsolidateLastTwelveMonths		is Boolean
		ConsolidationOptions
		InvoiceList						is an InvoiceLineFact group
		TimeConsolidation				is Boolean
		PreviousConsolidationsPurged	is Boolean
			
	Local Fields
        SpendDimension
        
  	Conditions
  		HasTotalSpend
  			restricted
  			when (TotalSpendInvoiceLineFactConsolidatesRel exists)
  			
  		HasBuyerSpend
  			restricted
  			when (BuyerSpendInvoiceLineFactConsolidatesRel exists)

  		HasDiversitySpend
  			restricted
  			when (DiversitySpendInvoiceLineFactConsolidatesRel exists)

  		HasCommodityCodeSpend
  			restricted
  			when (CommodityCodeSpendInvoiceLineFactConsolidatesRel exists)

  		HasUnspscSpend
  			restricted
  			when (UnspscSpendInvoiceLineFactConsolidatesRel exists)

		HasConsolidationDetails
			restricted
			when (InvoiceLineFactConsolidatesForProcurementGroupRel exists)
					
	Relations
		InvoiceLineFactConsolidatesForProcurementGroupRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.ProcurementGroup
				
		TotalSpendInvoiceLineFactConsolidatesRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.ProcurementGroup
				
		BuyerSpendInvoiceLineFactConsolidatesRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.Buyer
				
		DiversitySpendInvoiceLineFactConsolidatesRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.DiversityCode
				
		CommodityCodeSpendInvoiceLineFactConsolidatesRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.CommodityCodeSegment1
				
		UnspscSpendInvoiceLineFactConsolidatesRel 
			one-to-many relation to InvoiceLineFactConsolidate
			Field Mapping uses ByConsolidationLevel
				related.ConsolidationLevel 							= 1
				related.ProcurementGroup 						   	= ProcurementGroup
				related.InvoiceLineFactConsolidateControl			= InvoiceLineFactConsolidateControl
				related.InvoiceLineFactConsolidate.Level1.Type		= SpendDimension.Type.UNSPSCSegment
				
	Actions
		Create is a Create Action

			Local Fields
				LocalLastControl						is Numeric size 4

			Entrance Rules
				LocalLastControl						= ProcurementGroup.ContractGroupRel.LastInvoiceLineFactConsolidateControl
			
			Action Rules 

				if (ConsolidateLastTwelveMonths
				and ConsolidationDateRange !entered)
					ConsolidationDateRange.End		= current corporate date
					ConsolidationDateRange.Begin	= current corporate date - 1 year			
			
			Exit Rules
				invoke PurgeInvoiceLineFactConsolidate InvoiceLineFactConsolidate in background
					invoked.PrmProcurementGroup										= ProcurementGroup
					invoked.PrmLastInvoiceLineFactConsolidateControl				= LocalLastControl
					invoked.PrmConsolidationOptions.ConsolidateTotalSpend			= ConsolidationOptions.ConsolidateTotalSpend
					invoked.PrmConsolidationOptions.ConsolidateBuyerSpend			= ConsolidationOptions.ConsolidateBuyerSpend
					invoked.PrmConsolidationOptions.ConsolidateDiversitySpend		= ConsolidationOptions.ConsolidateDiversitySpend
					invoked.PrmConsolidationOptions.ConsolidateCommodityCodeSpend	= ConsolidationOptions.ConsolidateCommodityCodeSpend
					invoked.PrmConsolidationOptions.ConsolidateUNSPSCSpend			= ConsolidationOptions.ConsolidateUNSPSCSpend
				
				if (ConsolidationOptions.ConsolidateDiversitySpend)
					invoke ConsolidateDiverseCodeVendor InvoiceLineFact in background
						invoked.PrmVendorGroup							= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions
						invoked.InvoiceList								= InvoiceList

				if (ConsolidationOptions.ConsolidateTotalSpend)
					invoke ConsolidateCompanyLocationBuyerItem InvoiceLineFact in background
						invoked.PrmProcurementGroup						= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions
						invoked.InvoiceList                             = InvoiceList
						
				if (ConsolidationOptions.ConsolidateTotalSpend)
					invoke ConsolidateCompanyLocationRequestingLocationItem InvoiceLineFact in background
						invoked.PrmProcurementGroup						= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions
						invoked.InvoiceList                             = InvoiceList
						
				if (ConsolidationOptions.ConsolidateBuyerSpend)						
					invoke ConsolidateBuyerLocationItem InvoiceLineFact in background
						invoked.PrmProcurementGroup						= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions
						invoked.InvoiceList                             = InvoiceList
						
				if (ConsolidationOptions.ConsolidateBuyerSpend)						
					invoke ConsolidateBuyerRequestingLocationItem InvoiceLineFact in background
						invoked.PrmProcurementGroup						= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions
						invoked.InvoiceList                             = InvoiceList

				if (ConsolidationOptions.ConsolidateCommodityCodeSpend)  
					invoke ConsolidateCommodityCodeItem InvoiceLineFact in background
						invoked.PrmProcurementGroup						= ProcurementGroup
						invoked.PrmInvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange					= ConsolidationDateRange
						invoked.ConsolidationOptions					= ConsolidationOptions

				if (ConsolidationOptions.ConsolidateUNSPSCSpend)   
					invoke ConsolidateUNSPSCItem InvoiceLineFact in background
						invoked.PrmProcureGroupD1.ProcurementGroup					= ProcurementGroup
						invoked.PrmProcureGroupD1.InvoiceLineFactConsolidateControl	= InvoiceLineFactConsolidateControl
						invoked.ConsolidationDateRange								= ConsolidationDateRange
						invoked.ConsolidationOptions								= ConsolidationOptions

		Update is an Update Action
		
		Delete is a Delete Action
		
		Purge is a Purge Action
