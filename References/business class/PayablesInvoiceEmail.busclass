PayablesInvoiceEmail is a BusinessClass
	owned by ap
	prefix is PIEML
	
	Ontology
		symbolic key is PayablesInvoiceEmail
	
	Patterns
		implements Archivable
		
	Persistent Fields
		SentToFinanceResource			is a FinanceResource
		SentToEmailAddress				is EmailAddressField with multiple addresses 
			holds pii
			default label is "To"
		SentToEmailAddressText			is Text 
			holds pii
			default label is "To"
		SentToCc                        is EmailAddressField with multiple addresses	
			default label is "Cc"
		SentToCcText                    is Text
			default label is "Cc"
		SentToBcc                       is EmailAddressField with multiple addresses	
			default label is "Bcc"
		SentToBccText                   is Text
			default label is "Bcc"
		SentFromFinanceResource			is a FinanceResource
		SentFromEmailAddress			is an EmailAddress 
			holds pii
			default label is "From"
		EmailSubjectLine				is Alpha size up to 250
			default label is "Subject"
		EmailContent					is RichText
			default label is "Content"
		Comment							is Alpha size up to 500
		ActionReason					is AlphaUpper 20
		NotificationType				is Numeric 1
			States
				InvoiceSubmittedForApproval	value is 1
				InvoiceRejected				value is 2
				ManuallySentToApprover		value is 3
				ManuallySent				value is 4
				InvoiceApproved				value is 5
		SentTimeStamp					is TimeStamp
			default label is "Sent"
			
	Transient Fields

	Derived Fields
		DerivedActionReason is a DerivedField
			type is Alpha 40
			
			if (ActionReason entered)
				return "Rejection Reason: " + ActionReason
			else
				return blank

	Field Rules
		SentTimeStamp
			default to current timestamp
			
	Conditions
		ActionReasonEntered
			restricted
			when (ActionReason entered)
		CommentEntered
			restricted
			when (Comment entered)
		CCEntered
			restricted
			when (SentToCcText entered)
		BCCEntered
			restricted
			when (SentToBccText entered)

	Relations

	Sets
		ByTimeDescending
			duplicates
			Sort Order
				Company
				PayablesInvoice
				SentTimeStamp descending
	
	Actions
		Create is a Create Action
			restricted

		Update is an Update Action
			restricted
			
		Delete is a Delete Action
			restricted

		Purge is a Purge Action
			restricted
			bypass relational integrity rules

		RepairEmailAddresses is a Set Action
			restricted
			Instance Selection
				where ((SentToEmailAddressText not entered
				and     SentToEmailAddress entered)
				or     (SentToCcText not entered
				and     SentToCc entered)
				or     (SentToBccText not entered
				and     SentToBcc entered))
			Action Rules
				Instance Rules
					if (SentToEmailAddressText not entered)
						SentToEmailAddressText	= SentToEmailAddress
					if (SentToCcText not entered)
						SentToCcText			= SentToCc
					if (SentToBccText not entered)
						SentToBccText			= SentToBcc
