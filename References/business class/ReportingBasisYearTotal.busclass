ReportingBasisYearTotal is a BusinessClass
    owned by GeneralLedger
    prefix is GLRYT

    Ontology
    	symbolic key is ReportingBasisYearTotal
        
    Patterns
 		implements DynamicCreation 
 		disable Auditing 
 		disable EffectiveDated
		disable AsOfDateProcessing

	Context Fields
		ReportingBasisCloseResult

    Persistent Fields
    	TotalsUpdated					is Boolean
		FinanceDimension1
		FinanceDimension2
		FinanceDimension3
		FinanceDimension4
		FinanceDimension5
		FinanceDimension6
		FinanceDimension7
		FinanceDimension8
		FinanceDimension9
		FinanceDimension10		
		TransactionAmount				is an TotalAmount
			precision is ReportingBasisYearTotal.Currency.NumberOfDecimals
		FunctionalAmount				is an TotalAmount
			precision is ReportingBasisYearTotal.AccountingEntity.FunctionalCurrency.NumberOfDecimals
		AlternateAmount					is an TotalAmount
			precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency.NumberOfDecimals
		AlternateAmount2				is an TotalAmount
			precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency2.NumberOfDecimals
		AlternateAmount3				is an TotalAmount
			precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency3.NumberOfDecimals
		ProjectAmount					is an TotalAmount
			precision is ReportingBasisYearTotal.Project.Currency.NumberOfDecimals
		ReportAmount1					is an TotalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyOne.NumberOfDecimals
		ReportAmount2					is an TotalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyTwo.NumberOfDecimals
		ReportAmount3					is an TotalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyThree.NumberOfDecimals
		ReportAmount4					is an TotalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFour.NumberOfDecimals
		ReportAmount5					is an TotalAmount
			precision is FinanceEnterpriseGroup.ReportCurrencyFive.NumberOfDecimals
		UnitsAmount
		OrigAccount						is a GeneralLedgerChartAccount

	Transient Fields
		PrmTransactionAmount		is an TotalAmount
		PrmFunctionalAmount			is an TotalAmount
		PrmAlternateAmount			is an TotalAmount
		PrmAlternateAmount2			is an TotalAmount
		PrmAlternateAmount3			is an TotalAmount
		PrmProjectAmount			is an TotalAmount
		PrmReportAmount1			is an TotalAmount
		PrmReportAmount2			is an TotalAmount
		PrmReportAmount3			is an TotalAmount
		PrmReportAmount4			is an TotalAmount
		PrmReportAmount5			is an TotalAmount
		PrmUnitsAmount				is an UnitsAmount

	Local Fields
		LocalYear					is Year
		LocalTotalsAccumulated		is Boolean
		LocalTransactionAmount		is an TotalAmount
		LocalFunctionalAmount		is an TotalAmount
		LocalAlternateAmount		is an TotalAmount
		LocalAlternateAmount2		is an TotalAmount
		LocalAlternateAmount3		is an TotalAmount
		LocalProjectAmount			is an TotalAmount
		LocalReportAmount1			is an TotalAmount
		LocalReportAmount2			is an TotalAmount
		LocalReportAmount3			is an TotalAmount
		LocalReportAmount4			is an TotalAmount
		LocalReportAmount5			is an TotalAmount
		LocalUnitsAmount			is an UnitsAmount
		LocalReportingChart			is like ReportingChart

	Derived Fields
		PreviousReportingBasisYearTotalRelExists is a DerivedField
			type is Boolean
			if (PreviousReportingBasisYearTotalRel exists)
				return true
					
		DerivedReportingBasisYear		is a DerivedField
			type is Year
			restricted
			LocalYear	= ReportingBasisYearTotal.EntityYear[1:4]
			return (LocalYear - 1)
		ChangedTotalsOnly	is a DerivedField
			type is Boolean
			restricted
			return ReportingBasisCloseResultRel.ChangedTotalsOnly
		DerivedTransactionAmount	is a DerivedField
			type is like TotalAmount
			if (!LocalTotalsAccumulated)
				for each PreviousReportingBasisYearTotalRel
					LocalTransactionAmount	= each.TransactionAmount
					LocalFunctionalAmount	= each.FunctionalAmount
					LocalAlternateAmount	= each.AlternateAmount
					LocalAlternateAmount2	= each.AlternateAmount2
					LocalAlternateAmount3	= each.AlternateAmount3
					LocalProjectAmount		= each.ProjectAmount
					LocalReportAmount1		= each.ReportAmount1
					LocalReportAmount2		= each.ReportAmount2
					LocalReportAmount3		= each.ReportAmount3
					LocalReportAmount4		= each.ReportAmount4
					LocalReportAmount5		= each.ReportAmount5
				LocalTotalsAccumulated	= true
			return LocalTransactionAmount
		
		ChangedTransactionAmount	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.Currency.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.TransactionAmount - DerivedTransactionAmount)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.TransactionAmount
		ChangedFunctionalAmount	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.AccountingEntity.FunctionalCurrency.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.FunctionalAmount - LocalFunctionalAmount)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.FunctionalAmount
		ChangedAlternateAmount	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalAlternateAmount)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.AlternateAmount
		ChangedAlternateAmount2	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency2.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalAlternateAmount2)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.AlternateAmount2
		ChangedAlternateAmount3	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.AccountingEntity.AlternateCurrency3.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalAlternateAmount3)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.AlternateAmount3
		ChangedProjectAmount	is a DerivedField
			type is like TotalAmount
				precision is ReportingBasisYearTotal.Project.Currency.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalProjectAmount)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ProjectAmount
		ChangedReportAmount1	is a DerivedField
			type is like TotalAmount
				precision is FinanceEnterpriseGroup.ReportCurrencyOne.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalReportAmount1)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ReportAmount1
		ChangedReportAmount2	is a DerivedField
			type is like TotalAmount
				precision is FinanceEnterpriseGroup.ReportCurrencyTwo.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalReportAmount2)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ReportAmount2
		ChangedReportAmount3	is a DerivedField
			type is like TotalAmount
				precision is FinanceEnterpriseGroup.ReportCurrencyThree.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalReportAmount3)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ReportAmount3
		ChangedReportAmount4	is a DerivedField
			type is like TotalAmount
				precision is FinanceEnterpriseGroup.ReportCurrencyFour.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalReportAmount4)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ReportAmount4
		ChangedReportAmount5	is a DerivedField
			type is like TotalAmount
				precision is FinanceEnterpriseGroup.ReportCurrencyFive.NumberOfDecimals
			if  (PreviousReportingBasisYearTotalRelExists
			and !ChangedTotalsOnly)
				return (CurrentReportingBasisYearTotalRel.AlternateAmount - LocalReportAmount5)
			else
				if (CurrentReportingBasisYearTotalRel exists)
					return CurrentReportingBasisYearTotalRel.ReportAmount5

    Conditions
        ProjectExists
        	restricted
        	when (ReportingBasisYearTotal.Project entered)
		ReportCurrencyOneExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyOneEntered)
		ReportCurrencyTwoExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyTwoEntered)
		ReportCurrencyThreeExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyThreeEntered)
		ReportCurrencyFourExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyFourEntered)
		ReportCurrencyFiveExists
			restricted
			when (FinanceEnterpriseGroup.ReportCurrencyFiveEntered)
		AccountingUnitUsed
			restricted
			when (FinanceEnterpriseGroup.AccountingUnitLabel entered)
        EntityAlternateExists
        	restricted
        	when (ReportingBasisYearTotal.AccountingEntity.AlternateCurrency entered)
        EntityAlternate2Exists
        	restricted
        	when (ReportingBasisYearTotal.AccountingEntity.AlternateCurrency2 entered)
        EntityAlternate3Exists
        	restricted
        	when (ReportingBasisYearTotal.AccountingEntity.AlternateCurrency3 entered)
        RetainedEarningsAccount
        	restricted
        	when (ReportingBasisYearTotal.GeneralLedgerChartAccount.SystemAccount.RetainedEarnings)
        OrigAccountEntered
        	restricted
        	when (OrigAccount entered)
 		SecurityGroupAllowsAccess
			when (actor.context.AccountingEntitySecurityGroup = blank
			or   (AccountingEntitySecurityGroupMemberRel exists))

	Relations
		PreviousReportingBasisYearTotalRel
			one-to-many relation to ReportingBasisYearTotal
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.ReportingBasis				= ReportingBasis
			Instance Selection
				where  (related.ReportingBasisYearTotal.AccountingEntity	= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.AccountingEntity
				and		related.ReportingBasisYearTotal.CloseLedger			= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.CloseLedger
				and		related.ReportingBasisYearTotal.EntityYear			= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.EntityYear
				and		related.ReportingBasisYearTotal.AccountingUnit		= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.AccountingUnit
				and		related.ReportingBasisYearTotal.GeneralLedgerChartAccount	= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.GeneralLedgerChartAccount
				and		related.ReportingBasisYearTotal.Project				= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.Project
				and		related.ReportingBasisYearTotal.DimensionCode		= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.DimensionCode
				and		related.ReportingBasisYearTotal.System				= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.System
				and		related.ReportingBasisYearTotal.Currency			= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.Currency
				and		related.ReportingBasisYearTotal.PrimaryLedger		= CurrentReportingBasisYearTotalRel.ReportingBasisYearTotal.PrimaryLedger
				and	   (related.ReportingBasisYearTotal.SequenceNumber		>= last PreviousFullCloseResultRel.ReportingBasisCloseResult
				and		related.ReportingBasisYearTotal.SequenceNumber		< ReportingBasisCloseResult))
		CurrentReportingBasisYearTotalRel

			one-to-one relation to ReportingBasisYearTotal			
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.ReportingBasis				= ReportingBasis
				related.ReportingBasisYearTotal.AccountingEntity	= ReportingBasisYearTotal.AccountingEntity
				related.ReportingBasisYearTotal.CloseLedger			= ReportingBasisYearTotal.CloseLedger
				related.ReportingBasisYearTotal.EntityYear			= ReportingBasisYearTotal.EntityYear
				related.ReportingBasisYearTotal.AccountingUnit		= ReportingBasisYearTotal.AccountingUnit
				related.ReportingBasisYearTotal.GeneralLedgerChartAccount	= ReportingBasisYearTotal.GeneralLedgerChartAccount
				related.ReportingBasisYearTotal.Project				= ReportingBasisYearTotal.Project
				related.ReportingBasisYearTotal.DimensionCode		= ReportingBasisYearTotal.DimensionCode
				related.ReportingBasisYearTotal.System				= ReportingBasisYearTotal.System
				related.ReportingBasisYearTotal.Currency			= ReportingBasisYearTotal.Currency
				related.ReportingBasisYearTotal.PrimaryLedger		= ReportingBasisYearTotal.PrimaryLedger
				related.ReportingBasisYearTotal.SequenceNumber		= ReportingBasisCloseResult				












		ReportingBasisCloseResultRel
			one-to-one relation to ReportingBasisCloseResult
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.ReportingBasis				= ReportingBasis
				related.ReportingBasisYear			= DerivedReportingBasisYear
				related.ReportingBasisCloseResult	= ReportingBasisCloseResult
		PreviousFullCloseResultRel
			one-to-many relation to ReportingBasisCloseResult
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.ReportingBasis				= ReportingBasis
				related.ReportingBasisYear			= DerivedReportingBasisYear
			Instance Selection
				where (related.ReportingBasisCloseResult	< ReportingBasisCloseResult
				and   !related.ChangedTotalsOnly)
		ReportingChartCloseToAccountRel
			one-to-many relation to ReportingChartAccount
			Field Mapping uses ByCloseToAccount
				related.FinanceEnterpriseGroup			= FinanceEnterpriseGroup
				related.ReportingChart					= LocalReportingChart
				related.CloseToAccount					= ReportingBasisYearTotal.GeneralLedgerChartAccount

		AccountingEntitySecurityGroupMemberRel
			one-to-one relation to AccountingEntityGroupMember
			Field Mapping uses part of key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.AccountingEntityGroup	= actor.context.AccountingEntitySecurityGroup.FinanceDimensionStructure
				related.AccountingEntity		= ReportingBasisYearTotal.AccountingEntity

    Sets
    	ByBasisEntityYear
			duplicates
    		Sort Order
    			FinanceEnterpriseGroup
    			ReportingBasis
    			ReportingBasisYearTotal.EntityYear

    	ByBasisYearSequence
			duplicates
    		Sort Order
    			FinanceEnterpriseGroup
    			ReportingBasis
    			ReportingBasisYearTotal.EntityYear
    			ReportingBasisYearTotal.SequenceNumber

	Field Rules
			
	Rule Blocks
		UpdateAccountTotal
			TransactionAmount		+= PrmTransactionAmount
			FunctionalAmount 		+= PrmFunctionalAmount
			AlternateAmount			+= PrmAlternateAmount
			AlternateAmount2		+= PrmAlternateAmount2
			AlternateAmount3		+= PrmAlternateAmount3
			ProjectAmount 			+= PrmProjectAmount
			ReportAmount1			+= PrmReportAmount1
			ReportAmount2			+= PrmReportAmount2
			ReportAmount3			+= PrmReportAmount3
			ReportAmount4			+= PrmReportAmount4
			ReportAmount5			+= PrmReportAmount5
			UnitsAmount				+= PrmUnitsAmount
		
			initialize PrmTransactionAmount
			initialize PrmFunctionalAmount
			initialize PrmAlternateAmount
			initialize PrmAlternateAmount2
			initialize PrmAlternateAmount3
			initialize PrmProjectAmount
			initialize PrmReportAmount1
			initialize PrmReportAmount2
			initialize PrmReportAmount3
			initialize PrmReportAmount4
			initialize PrmReportAmount5
			initialize PrmUnitsAmount

    Actions
		Create is a Create Action
			restricted
			bypass field rules
			Action Rules
				include UpdateAccountTotal

		Update is an Update Action
			restricted
			bypass field rules
			Action Rules
				include UpdateAccountTotal

		Delete is a Delete Action
			restricted

		DeleteData is a Set Action
			restricted
			Parameters
				PrmFinanceEnterpriseGroup	is like FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmReportingBasis			is like ReportingBasis
					default label is "ReportingBasis"
				PrmAccountingEntity			is like AccountingEntity
					default label is "AccountingEntity"
				PrmPrimaryLedger			is like Ledger
					default label is "Ledger"

			Instance Selection
				where (FinanceEnterpriseGroup		= PrmFinanceEnterpriseGroup
				and	   ReportingBasis				= PrmReportingBasis
				and   ((PrmAccountingEntity entered
				and	   ReportingBasisYearTotal.AccountingEntity = PrmAccountingEntity)				
				or	  (!PrmAccountingEntity entered))
				and   ((PrmPrimaryLedger entered
				and    	ReportingBasisYearTotal.PrimaryLedger	=  PrmPrimaryLedger)
				or	  (!PrmPrimaryLedger entered)))

			Set Is
				PrmFinanceEnterpriseGroup
				PrmReportingBasis
				PrmAccountingEntity

			Sort Order
				FinanceEnterpriseGroup
				ReportingBasis
				ReportingBasisYearTotal.AccountingEntity
				ReportingBasisYearTotal.PrimaryLedger

			Action Rules
				Empty Set Rules
				Instance Rules
					invoke Delete 

		InitializeCloseToAccountNextYearBalance is a Set Action
			restricted

			Parameters
				PrmEnterpriseGroup				is a FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmReportingBasis				is a ReportingBasis
					default label is "ReportingBasis"
				PrmCloseLedger					is a Ledger
					default label is "CloseLedger"
				PrmNewYear						is a GeneralLedgerCalendarPeriod
					default label is "NewYear"

			Parameter Rules
				PrmReportingBasis
					LocalReportingChart		= PrmReportingBasis.ReportingChart

			Set Is
				PrmEnterpriseGroup
				PrmReportingBasis
				PrmNewYear

			Local Fields	

			Instance Selection
				where (FinanceEnterpriseGroup					= PrmEnterpriseGroup
				and    ReportingChartCloseToAccountRel exists
				and    ReportingBasisYearTotal.CloseLedger		= PrmCloseLedger
				and    ReportingBasisYearTotal.EntityYear		= PrmNewYear)

			Sort Order
				FinanceEnterpriseGroup
				ReportingBasisYearTotal.CloseLedger
				ReportingBasisYearTotal.EntityYear
        	    ReportingBasisYearTotal.GeneralLedgerChartAccount

			Action Rules
				Empty Set Rules

				Set Rules
				
				Instance Rules
					invoke Delete 

