PayablesBatch is a BusinessClass
	deprecated 			
    owned by ap
    prefix is APB
    classic name is APBATCH


    Ontology
        symbolic key is PayablesBatch
            classic set name is APBSET1
            classic name is BATCH-NUM


    Patterns
        implements StaticJava
        disable AuditIndex


    Persistent Fields
        BatchDate              is Date
        DistributionDate       is Date
            classic name is DISTRIB-DATE
        NetAmount              is an InternationalAmount
            classic name is CTL-NET-TOT
        NumberOfInvoices       is an ActualNumberOfInvoices
            classic name is CTL-NBR-INV
        VendorHashTotal        is an ActualVendorHashTotal
            classic name is CTL-VEND-HASH
        ActualInvoiceTotal     is an InternationalAmount
            classic name is ACT-INV-TOT
        ActualDebitTotal       is an InternationalAmount
            classic name is ACT-DB-TOT
        ActualCreditTotal      is an InternationalAmount
            classic name is ACT-CR-TOT
        ActualNumberOfInvoices
            classic name is ACT-NBR-INV
        ActualVendorHashTotal
            classic name is ACT-VEND-HASH
        InvoiceCurrency        is a Currency
            classic name is INV-CURRENCY
        OriginCode             is AlphaUpper size 2
            States
                AccountsPayable value is "AP"
                PurchaseOrder   value is "PO"
                MatchInvoice    value is "MA"


	Local Fields

		LocalRunProgram					is a RunProgram







		
		
	
    Derived Fields
        ActualNetAmount is a DerivedField                                 
            type is like InternationalAmount
            restricted
            classic name is ACT-NET-AMT
            return (ActualInvoiceTotal + ActualDebitTotal + ActualCreditTotal)


    Conditions
		HasPayableInvoices
			restricted
			when (first PayablesInvoiceRel exists)

	Field Rules




		BatchDate
			default to current corporate date

		OriginCode
			default to OriginCode.AccountsPayable


    Relations
		AllPayablesInvoiceRel
			one-to-many relation to PayablesInvoice
			delete cascades
			Field Mapping uses Set2		
				related.Company     = Company
				related.BatchNumber = PayablesBatch
		






				









        PayablesInvoiceRel
            classic name is APINVOICE
            one-to-many relation to PayablesInvoice
            Field Mapping uses Set3
                related.Status      = blank
                related.Company     = Company
                related.BatchNumber = PayablesBatch





				
       	TaxEntityRel				 
            one-to-one relation to TaxEntity
            Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= Company.FinanceEnterpriseGroup
                related.TaxEntity 				= Company.AccountingEntity

	Rule Blocks
		ClearBatch
			BatchDate = 0
			DistributionDate = 0
			NetAmount = 0
			NumberOfInvoices = 0
			VendorHashTotal = 0
			ActualInvoiceTotal = 0
			ActualDebitTotal = 0
			ActualCreditTotal = 0
			ActualNumberOfInvoices = 0
			ActualVendorHashTotal = 0
			InvoiceCurrency = blank
			OriginCode = "AP"
	
	
		572IntrastatCheck		//	Called from "Release" action (within a for loop)
			display "PayablesBatch:572IntrastatCheck:In"





























	Actions
		Create is a Create Action
			Field Rules
				PayablesBatch



					required
						"MustEnterBatchNumber"		      


		Update is an Update Action
			Action Rules
				if (InvoiceCurrency changed)
					constraint (ActualNumberOfInvoices not entered)
						"InvoicesExist;CannotUpdateBatchCurrency"                
				
		Delete is a Delete Action
			Entrance Rules
				invoke DeleteInvoice AllPayablesInvoiceRel
						















































































































					
		UpdateBatchActuals is an Instance Action
			restricted
			Parameters
				ActionTaken			is Alpha size 6
					States
						Add					  value is "Add"
						Remove				  value is "Remove"
				Vendor	
				Amount        		is an InternationalAmount				
		        InvoiceType      	is AlphaUpper size 1
		            States
		                Invoice               value is blank
		                CreditMemo            value is "C"
		                DebitMemo             value is "D"
		                Prepayment            value is "P"
		                PrepaymentCredit      value is "Y"
		                EmployeeAdvance       value is "A"
		                EmployeeAdvanceCredit value is "M"
		                EmployeeExpense       value is "E"
		                MatchPrepayment       value is "R"
			Local Fields

				VendorNumber	is like Vendor
			Entrance Rules






				VendorNumber = Vendor

			Action Rules
				LocalRunProgram = "APREL"
				if (ActionTaken.Add)
					ActualNumberOfInvoices 		+= 1

					ActualVendorHashTotal 		+= VendorNumber
						
					if (InvoiceType.DebitMemo)
						ActualDebitTotal 		+= Amount
					else
					if (InvoiceType.CreditMemo)
						ActualCreditTotal 		+= Amount
					else
						ActualInvoiceTotal 		+= Amount
						
				else

					ActualNumberOfInvoices 		-= 1

					ActualVendorHashTotal 		-= VendorNumber
						
					if (InvoiceType.DebitMemo)
						ActualDebitTotal 		-= Amount
					else
					if (InvoiceType.CreditMemo)
						ActualCreditTotal 		-= Amount
					else
						ActualInvoiceTotal 		-= Amount
						



		ResetBatchActuals is an Instance Action
			Action Rules
				initialize ActualNumberOfInvoices
				initialize ActualVendorHashTotal
				initialize ActualDebitTotal
				initialize ActualCreditTotal
				initialize ActualInvoiceTotal
				for each PayablesInvoiceRel
					ActualNumberOfInvoices 	+= 1

					ActualVendorHashTotal 	+= each.Vendor
						
					if (each.InvoiceType.DebitMemo)
						ActualDebitTotal 		+= each.InvoiceAmount
					else
					if (each.InvoiceType.CreditMemo)
						ActualCreditTotal 		+= each.InvoiceAmount
					else
						ActualInvoiceTotal 		+= each.InvoiceAmount

						

							
								
		UpdateBatchTotals is an Instance Action
			restricted
			Parameters
				ActionTaken			is Alpha size 6
					States
						Add					value is "Add"
						Change				value is "Change"
						Delete				value is "Delete"
				Vendor
				OldAmount        	is an InternationalAmount
				NewAmount        	is an InternationalAmount
		        InvoiceType      	is AlphaUpper size 1
		            States
		                Invoice               value is blank
		                CreditMemo            value is "C"
		                DebitMemo             value is "D"
		                Prepayment            value is "P"
		                PrepaymentCredit      value is "Y"
		                EmployeeAdvance       value is "A"
		                EmployeeAdvanceCredit value is "M"
		                EmployeeExpense       value is "E"
		                MatchPrepayment       value is "R"
			Local Fields
				VendorNumber	is Numeric 9
			Entrance Rules






				VendorNumber = Vendor

			Action Rules
				LocalRunProgram = "APREL"
				if (InvoiceType.DebitMemo)
					ActualDebitTotal = ActualDebitTotal - OldAmount + NewAmount
				else
				if (InvoiceType.CreditMemo)
					ActualCreditTotal = ActualCreditTotal - OldAmount + NewAmount
				else
					ActualInvoiceTotal = ActualInvoiceTotal - OldAmount + NewAmount
				
				if (ActionTaken.Add)
					increment ActualNumberOfInvoices

					ActualVendorHashTotal 	+= VendorNumber
				else
				if (ActionTaken.Delete)
					decrement ActualNumberOfInvoices

					ActualVendorHashTotal 	-= VendorNumber
								
