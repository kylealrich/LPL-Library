AssetItemFund is a BusinessClass
	owned by am
	
	prefix is AIteF
	
	Ontology
		symbolic key is AssetItemFund
		
	
	Patterns
		implements StaticJava
		
	Persistent Fields
		AccountingEntity				
		AccountingUnit					
		Fund 							is an AssetFundField
		Project 								
		FinanceDimension1									
		FinanceDimension2					
		FinanceDimension3					
		FinanceDimension4			
		FinanceDimension5					
		FinanceDimension6					
		FinanceDimension7					
		FinanceDimension8			
		FinanceDimension9					
		FinanceDimension10
		AssetManagementInterfaceResult
			delete ignored
		TransactionAmount				is an InternationalAmount
        	default label is "Amount"
		PercentContribution				is Percent size 9.6
		RecordType						is Numeric 1
			States
				Active				value is 0
				Old 				value is 1
				AdjustmentAddition 	value is 2
		RecordsDeleted					is Boolean

	Transient Fields
		PercentAllocated				is Percent size 9.6
			derive value from ThisInstanceRel.TotalItemAllocationPercent	
		LocalCurrency					is a FromCurrency
			derive value from Asset.Currency	
		UpdateFromTransfer				is Boolean
						
	Local Fields
		LocalTotalItemFunds				is like InternationalAmount
		LocalEachPct					is Percent size 9.6
				
	Derived Fields
		TotalItemAllocationPercent is a DerivedField
			type is Percent size 6.3
			return sum AssetItemFundsRel.PercentContribution			
			
		DerivedItemCost is a DerivedField
			type is like InternationalAmount
			return AssetItem.TransactionItemCost
			
		DerivedTransferAmount is a DerivedField
			type is like InternationalAmount
			return (AssetItemTransferRel.ToTransactionItemCost * PercentContribution)
						
		CalculatedFundAmountsMayBeRounded is a MessageField
			"CalculatedFundAmountsMayBeRounded"								
	Conditions	
		FundOverride
			when (Asset.FundOverride)
	
		UpdateAllowed
			when (Asset.FundAccounting
			and Asset.FundOverride = false)	
			
		Complete
			when (AssetItem.FundAllocationComplete
			and !FundOverride)	

		AccountingUnitIsFundDimension
			restricted
			when (FinanceEnterpriseGroup.FundDimension = 1)
			
		NewAssetItemFund
			restricted
			when (AssetItemAdjustmentRel exists) 		
			
		IsTransferred
			restricted
			when (AssetItemTransferRel exists)
					
        AccountingUnitSelected
        	when (AssetFundControlRel.AccountingUnit)
        ProjectSelected
        	when (AssetFundControlRel.Project)      	
		FinanceDimension1Selected
        	when (AssetFundControlRel.FinanceDimension1)
		FinanceDimension2Selected
        	when (AssetFundControlRel.FinanceDimension2)
		FinanceDimension3Selected
        	when (AssetFundControlRel.FinanceDimension3)
		FinanceDimension4Selected
        	when (AssetFundControlRel.FinanceDimension4)
		FinanceDimension5Selected
        	when (AssetFundControlRel.FinanceDimension5)
		FinanceDimension6Selected
        	when (AssetFundControlRel.FinanceDimension6)
		FinanceDimension7Selected
        	when (AssetFundControlRel.FinanceDimension7)
		FinanceDimension8Selected
        	when (AssetFundControlRel.FinanceDimension8)
		FinanceDimension9Selected
        	when (AssetFundControlRel.FinanceDimension9)
		FinanceDimension10Selected
        	when (AssetFundControlRel.FinanceDimension10)

		IsNotReleasedOrDisposed
			restricted
			when (Asset.FundAccounting
			and Asset.FundOverride = false
			and	!Asset.Status.Released
			and !Asset.Status.Disposed
			and !AssetInProgress)
		
		AssetInProgress
			restricted
			when ((Asset.Status.PostRelease)
			and	 (Asset.AssetProcess.Transfer
			or	 Asset.AssetProcess.Disposal
			or	 Asset.AssetProcess.Reinstatement
			or	 Asset.AssetProcess.Revalue
			or	 Asset.AssetProcess.Impairment))

		AllowDelete
			restricted
			when (Asset.FundAccounting
			and Asset.FundOverride = false
			and	!Asset.Status.Released
			and !Asset.Status.Disposed
			and !AssetInProgress
			and Asset.Status.Unreleased)

		AllowDeleteFund
			restricted
			when (Asset.FundAccounting
			and Asset.FundOverride = false
			and	!Asset.Status.Released
			and !Asset.Status.Disposed
			and !AssetInProgress
			and Asset.AdjustmentInProgress)

		IsValidForActorContext
			restricted
			when (GeneralLedgerCompanyRel.FinanceEnterpriseGroup = actor.context.FinanceEnterpriseGroup)
        	
	Relations
		AssetFundControlRel
			one-to-one relation to AssetFundControl
			Field Mapping uses symbolic key
				related.AssetFundControl		= FinanceEnterpriseGroup
				
		AssetItemRel
			one-to-one relation to AssetItem
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.Asset 					= Asset
				related.AssetItem 				= AssetItem
		
		AssetFundRel 
			one-to-one relation to AssetFund
			Field Mapping uses ByAssetFund
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.Asset					= Asset
				related.RecordType				= 0
				related.AccountingEntity		= AccountingEntity
				related.AccountingUnit			= AccountingUnit				
				related.Project					= Project
				related.FinanceDimension1		= FinanceDimension1
				related.FinanceDimension2		= FinanceDimension2
				related.FinanceDimension3		= FinanceDimension3				
				related.FinanceDimension4		= FinanceDimension4
				related.FinanceDimension5		= FinanceDimension5
				related.FinanceDimension6		= FinanceDimension6		
				related.FinanceDimension7		= FinanceDimension7
				related.FinanceDimension8		= FinanceDimension8
				related.FinanceDimension9		= FinanceDimension9
				related.FinanceDimension10		= FinanceDimension10
								
		ThisInstanceRel
			one-to-one relation to AssetItemFund
			Field Mapping uses ByAssetFundItem
				related.Asset					= Asset 
				related.RecordType				= 0 
				related.AccountingEntity		= AccountingEntity
				related.AccountingUnit			= AccountingUnit
				related.Project					= Project
				related.FinanceDimension1		= FinanceDimension1
				related.FinanceDimension2		= FinanceDimension2
				related.FinanceDimension3		= FinanceDimension3				
				related.FinanceDimension4		= FinanceDimension4
				related.FinanceDimension5		= FinanceDimension5
				related.FinanceDimension6		= FinanceDimension6		
				related.FinanceDimension7		= FinanceDimension7
				related.FinanceDimension8		= FinanceDimension8
				related.FinanceDimension9		= FinanceDimension9
				related.FinanceDimension10		= FinanceDimension10
				related.AssetItem 				= AssetItem			

		AssetItemFundsRel 
			one-to-many relation to AssetItemFund
			Field Mapping uses ByAssetItemFund
				related.Asset					= Asset
				related.AssetItem				= AssetItem
				related.RecordType				= 0

		AssetItemAdjustmentRel
			one-to-one relation to AssetItemAdjustment
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.Asset					= Asset
				related.AssetAdjustment			= Asset.LastAssetSequence
				related.AssetItem				= AssetItem		

		AssetItemTransferRel
			one-to-one relation to AssetItemTransfer
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.Asset					= Asset
				related.AssetTransfer			= Asset.LastAssetSequence
				related.AssetItem				= AssetItem		

		AssetItemFundOldRel
			one-to-many relation to AssetItemFund
			Field Mapping uses ByAssetFundItem				
				related.Asset					= Asset
				related.RecordType				= 1 
				related.AccountingEntity		= AccountingEntity		
				related.AccountingUnit			= AccountingUnit
				related.Project					= Project
				related.FinanceDimension1		= FinanceDimension1
				related.FinanceDimension2		= FinanceDimension2
				related.FinanceDimension3		= FinanceDimension3				
				related.FinanceDimension4		= FinanceDimension4
				related.FinanceDimension5		= FinanceDimension5
				related.FinanceDimension6		= FinanceDimension6		
				related.FinanceDimension7		= FinanceDimension7
				related.FinanceDimension8		= FinanceDimension8
				related.FinanceDimension9		= FinanceDimension9
				related.FinanceDimension10		= FinanceDimension10
				related.AssetItem 				= AssetItem		

		GeneralLedgerCompanyRel
			one-to-one relation to GeneralLedgerCompany
            Field Mapping uses symbolic key
            	related.Company = Asset.Company
											
	Field Groups
		FundFieldGroup		
			AccountingEntity
			AccountingUnit
			Project
			FinanceDimension1
			FinanceDimension2
			FinanceDimension3				
			FinanceDimension4
			FinanceDimension5
			FinanceDimension6		
			FinanceDimension7
			FinanceDimension8
			FinanceDimension9
			FinanceDimension10
			
	Field Rules
		AccountingEntity
			required
				"<actor.context.FinanceEnterpriseGroup.AccountingEntityLabel>IsRequired"					
		AccountingUnit					
			if (AccountingUnitIsFundDimension)
				required	
					"<actor.context.FinanceEnterpriseGroup.AccountingUnitLabel>IsRequired"
			if (AccountingUnit entered)
				constraint (AccountingUnitSelected)
					"<actor.context.FinanceEnterpriseGroup.AccountingUnitLabel>IsNotAValidFundDimension"
		Project		
			if (Project entered)
				constraint (ProjectSelected)
					"<actor.context.FinanceEnterpriseGroup.ProjectLabel>IsNotAValidFundDimension"					
		FinanceDimension1
			if (!AccountingUnitIsFundDimension)
				required	
			if (FinanceDimension1 entered)
				constraint (FinanceDimension1Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension1Label>IsNotAValidFundDimension"		
		FinanceDimension2
			if (FinanceDimension2 entered)
				constraint (FinanceDimension2Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension2Label>IsNotAValidFundDimension"		
		FinanceDimension3
			if (FinanceDimension3 entered)
				constraint (FinanceDimension3Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension3Label>IsNotAValidFundDimension"
		FinanceDimension4
			if (FinanceDimension4 entered)
				constraint (FinanceDimension4Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension4Label>IsNotAValidFundDimension"
		FinanceDimension5
			if (FinanceDimension5 entered)
				constraint (FinanceDimension5Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension5Label>IsNotAValidFundDimension"
		FinanceDimension6
			if (FinanceDimension6 entered)
				constraint (FinanceDimension6Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension6Label>IsNotAValidFundDimension"
		FinanceDimension7
			if (FinanceDimension7 entered)
				constraint (FinanceDimension7Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension7Label>IsNotAValidFundDimension"
		FinanceDimension8
			if (FinanceDimension8 entered)
				constraint (FinanceDimension8Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension8Label>IsNotAValidFundDimension"
		FinanceDimension9
			if (FinanceDimension9 entered)
				constraint (FinanceDimension9Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension9Label>IsNotAValidFundDimension"
		FinanceDimension10
			if (FinanceDimension10 entered)
				constraint (FinanceDimension10Selected)
					"<actor.context.FinanceEnterpriseGroup.FinanceDimension10Label>IsNotAValidFundDimension"	
		RecordType
			default to 0
			

	Sets
		ByAssetFundItem
			Sort Order
				Asset
				RecordType
				AccountingEntity
				AccountingUnit
				Project			
				FinanceDimension1
				FinanceDimension2
				FinanceDimension3
				FinanceDimension4
				FinanceDimension5
				FinanceDimension6
				FinanceDimension7
				FinanceDimension8
				FinanceDimension9
				FinanceDimension10
                AssetItem
                
		ByAssetItemFund
            Sort Order
                Asset
                AssetItem
				RecordType       
                AccountingEntity
                AccountingUnit
				Project	
				FinanceDimension1						
				FinanceDimension2
				FinanceDimension3
				FinanceDimension4
				FinanceDimension5
				FinanceDimension6
				FinanceDimension7
				FinanceDimension8
				FinanceDimension9
				FinanceDimension10
		
		
		ByAssetManagementInterfaceResult
            indexed
            Sort Order
                FinanceEnterpriseGroup
				AssetManagementInterfaceResult
                Asset
                AssetItem		
				AssetItemFund
                              
	Actions
		Create is an Action
			valid when (IsNotReleasedOrDisposed)
			
			Field Rules
			
										
			Entrance Rules
				constraint (!ThisInstanceRel exists)
					"RecordAlreadyExistsForFundDimension"												
		

			Action Rules
				if (AssetItemFundsRel exists)
					LocalTotalItemFunds		= 	sum AssetItemFundsRel.TransactionAmount
					LocalEachPct			= 	sum AssetItemFundsRel.PercentContribution			
				if (FinanceEnterpriseGroup.FundDimension.AccountingUnit)
					constraint (AccountingUnit entered)
						"FundDimensionIsRequired"
				else
					constraint (FinanceDimension1 entered)	
						"FundDimensionIsRequired"
					Fund = FinanceDimension1	

				if (!Asset.FundOverride)
					if (TransactionAmount entered)
						PercentContribution = (TransactionAmount / AssetItem.TransactionItemCost)	
					else
						if (PercentContribution entered
						and ((LocalEachPct + PercentContribution) = 1))
							TransactionAmount 	= (AssetItem.TransactionItemCost - LocalTotalItemFunds)
						else
							TransactionAmount 	= (PercentContribution * AssetItem.TransactionItemCost)	
				else 
					if (AssetFundRel exists)
						PercentContribution = AssetFundRel.PercentContribution
				if (Asset.Status.PostRelease
				and parentcontext.name = "AssetItemFund")
					RecordType		= 2
					invoke Update Asset.UnreleasedAssetAdjustmentRel
						invoked.FundsAllocationUpdated         = true
			Exit Rules
				if (RecordType.Active)
					invoke UpdateFundAllocation Asset
					
		CreateFromItem is a Create Action
			restricted
				
		
		ImportCreate is a Create Action
			restricted							
			Exit Rules
				invoke UpdateFundAllocation Asset
											
						
						
						
						
		Update is an Action
			valid when (IsNotReleasedOrDisposed)
			Field Rules

				AccountingEntity
					cannot be changed
						"CannotBeChanged"
				AccountingUnit
					cannot be changed
						"CannotBeChanged"
				Fund
					cannot be changed
						"CannotBeChanged"						
				Project
					cannot be changed
						"CannotBeChanged"	
				FinanceDimension1
					cannot be changed
						"CannotBeChanged"
				FinanceDimension2
					cannot be changed
						"CannotBeChanged"
				FinanceDimension3
					cannot be changed
						"CannotBeChanged"
				FinanceDimension4
					cannot be changed
						"CannotBeChanged"
				FinanceDimension5						
					cannot be changed
						"CannotBeChanged"
				FinanceDimension6						
					cannot be changed
						"CannotBeChanged"
				FinanceDimension7
					cannot be changed
						"CannotBeChanged"
				FinanceDimension8
					cannot be changed
						"CannotBeChanged"
				FinanceDimension9						
					cannot be changed
						"CannotBeChanged"
				FinanceDimension10						
					cannot be changed
						"CannotBeChanged"						

							
							
		
			Action Rules
				if(Asset.Status.PostRelease)
					if(RecordType.Active)
						if(AssetItemFundOldRel not exist)
							invoke CreateOldItemFund AssetItemFund
								invoked.AccountingEntity		= old AccountingEntity
								invoked.AccountingUnit			= old AccountingUnit
								invoked.Fund					= old Fund
								invoked.Project					= old Project
								invoked.FinanceDimension1		= old FinanceDimension1
								invoked.FinanceDimension2 		= old FinanceDimension2
								invoked.FinanceDimension3 		= old FinanceDimension3
								invoked.FinanceDimension4		= old FinanceDimension4
								invoked.FinanceDimension5 		= old FinanceDimension5
								invoked.FinanceDimension6 		= old FinanceDimension6
								invoked.FinanceDimension7		= old FinanceDimension7
								invoked.FinanceDimension8 		= old FinanceDimension8
								invoked.FinanceDimension9 		= old FinanceDimension9
								invoked.FinanceDimension10		= old FinanceDimension10
								invoked.PercentContribution     = old PercentContribution
								invoked.TransactionAmount		= old TransactionAmount
								invoked.RecordType				= 1
							
							if (AssetItemAdjustmentRel not exists)
								invoke Create AssetItemAdjustmentRel
									invoked.PurchaseDate		   		= AssetItem.PurchaseDate
									invoked.ItemQuantity				= AssetItem.ItemQuantity
									invoked.AssetItem					= AssetItem.AssetItem
									invoked.ItemNumber					= AssetItem.ItemNumber
									invoked.Description					= AssetItem.Description
									invoked.BaseItemCost				= AssetItem.BaseItemCost
									invoked.BaseItemTax					= AssetItem.BaseItemTax
									invoked.TransactionItemCost			= AssetItem.TransactionItemCost
									invoked.TransactionItemTax			= AssetItem.TransactionItemTax
									invoked.BaseNumberOfDecimals		= AssetItem.BaseNumberOfDecimals
									invoked.PONumber					= AssetItem.InvoiceAndPurchaseOrderInformation.PurchaseOrder
									invoked.Vendor						= AssetItem.InvoiceAndPurchaseOrderInformation.Vendor
									invoked.VendorName					= AssetItem.VendorName
									invoked.PayablesInvoice				= AssetItem.InvoiceAndPurchaseOrderInformation.PayablesInvoice
									invoked.DistributionSequence		= AssetItem.InvoiceAndPurchaseOrderInformation.DistributionSequence
									invoked.ModelNumber					= AssetItem.ModelNumber
									invoked.SerialNumber				= AssetItem.SerialNumber
									invoked.AssetProject				= AssetItem.AssetProject
									invoked.LocationDetail				= AssetItem.LocationDetail
									invoked.BarCode						= AssetItem.BarCode
									invoked.InventoryDate				= AssetItem.InventoryDate
									invoked.ItemCondition				= AssetItem.ItemCondition
									invoked.GeographicalLatitude		= AssetItem.GeographicalLatitude
									invoked.GeographicalLongitude		= AssetItem.GeographicalLongitude
									invoked.GeographicalAltitude		= AssetItem.GeographicalAltitude
									invoked.InvoiceCompany  			= AssetItem.InvoiceAndPurchaseOrderInformation.InvoiceCompany
									invoked.PurchaseOrderLine    		= AssetItem.InvoiceAndPurchaseOrderInformation.PurchaseOrderLine
									invoked.AssetItemReferenceFields.ReferenceCompany			= AssetItem.AssetItemReferenceFields.ReferenceCompany
									invoked.AssetItemReferenceFields.ReferenceVendor			= AssetItem.AssetItemReferenceFields.ReferenceVendor
									invoked.AssetItemReferenceFields.ReferenceInvoice			= AssetItem.AssetItemReferenceFields.ReferenceInvoice
									invoked.AssetItemReferenceFields.ReferencePurchaseOrder		= AssetItem.AssetItemReferenceFields.ReferencePurchaseOrder
									invoked.AssetItemReferenceFields.ReferenceSequenceNumber	= AssetItem.AssetItemReferenceFields.ReferenceSequenceNumber
									invoked.AssetItemReferenceFields.ReferenceProject			= AssetItem.AssetItemReferenceFields.ReferenceProject
							invoke Update Asset.UnreleasedAssetAdjustmentRel
								invoked.FundsAllocationUpdated         = true

				if (!Asset.FundOverride)
					if (TransactionAmount changed)
						if (PercentContribution changed)
							confirmation required
								"BothAmountAndPercentHaveBeenChanged,TheAssignedPercentWillTakePrecedence;SelectYesToContinue"
							TransactionAmount 	= (PercentContribution * AssetItem.TransactionItemCost)	
						else 
							PercentContribution = (TransactionAmount / AssetItem.TransactionItemCost)
					else 
						if (PercentContribution changed)
							TransactionAmount 		= (PercentContribution * AssetItem.TransactionItemCost)

			Exit Rules
				if (!Asset.Status.PostRelease)
					invoke UpdateFundAllocation Asset

		CreateOldItemFund is a Create Action
			restricted						

		UpdateFromAssetFund is an Update Action
			bypass field rules
			restricted
			Action Rules
				if (PercentContribution changed)
					TransactionAmount = (PercentContribution * AssetItem.TransactionItemCost)	
		
		UpdateFromItemImportFund is an Update Action
			restricted				

		CreateFromAssetFund is a Create Action
			restricted
				
		CreateUpdate is an Update Action
			restricted
			Field Rules
				Fund
					cannot be changed
						"FundCannotBeChanged"
			
			Action Rules
				if (TransactionAmount changed)
					PercentContribution = (TransactionAmount / AssetItem.TransactionItemCost)
				else 
					if (PercentContribution changed)
						TransactionAmount = (PercentContribution * AssetItem.TransactionItemCost)	

					if (AssetFundRel exists)
						invoke UpdateFromItemFund AssetFundRel
					else 
						invoke CreateFromItemFund AssetFundRel
			Exit Rules
				invoke UpdateFundAllocation Asset
				

		RefreshAssetItemFunds is an Update Action
			restricted
			Action Rules
				if (Asset.FundOverrideSelected)
					PercentContribution = AssetFundRel.PercentContribution
					TransactionAmount  	= (AssetItem.TransactionItemCost * AssetFundRel.PercentContribution)
				else 	
					TransactionAmount  	= (AssetItem.TransactionItemCost * PercentContribution)

		UpdateAssetItemFund is an Update Action
			restricted							
										
		Delete is an Action
			valid when (AllowDelete)
			Action Rules

				if (!Asset.FundOverride) 
					if (AssetFundRel.TransactionAmount <= TransactionAmount)
						display "AIF_379Delete__AssetFundRel"
						invoke Delete AssetFundRel
					else 
						invoke Update AssetFundRel
							invoked.TransactionAmount -= TransactionAmount
					invoke UpdateFundAllocation Asset		
		
		DeleteAssetItemFund is an Action
			default label is "Delete"
			valid when (AllowDeleteFund)
			Action Rules
				if(AssetItemFundOldRel not exists)
					invoke CreateOldItemFund
						fill in fields from this instance
						invoked.RecordType				=  1
				invoke DeleteItemFund

		DeleteFromAsset is a Delete Action
			restricted
				              		
		DeleteItemFund is a Delete Action
			restricted
