VendorBalance is a BusinessClass
    owned by ap
    prefix is VBA
    classic name is APVENBAL

    Ontology
        symbolic key is VendorBalance
            classic set name is VBASET4
            classic name for VendorLocation is LOCATION-CODE

    Patterns
        implements DynamicCreation
        implements StaticJava
        disable AuditIndex
        disable Auditing
        implements BODId
		implements CreateStamp		
		implements UpdateStamp		

    Persistent Fields

        BalanceCurrency              is a Currency
            classic name is BAL-CURRENCY
        NumberOfDecimals             is Numeric size 1
            classic name is TRAN-ND
        VendorBalanceDate
            classic name for VendorBalanceDate.LastPurchaseDate is LAST-PUR-DATE
            classic name for VendorBalanceDate.LastPaymentDate is LAST-PMT-DATE
        HighestBalance               is a CurrencyAmount	
            classic name is HIGHEST-BAL
        CurrentBalance               is a CurrencyAmount	
            classic name is CURRENT-BAL
        DraftBalance                 is a CurrencyAmount	
            classic name is DRAFT-BAL
        CurrentYearIncomeWithholding is a CurrencyAmount	
            classic name is CY-INC-WH
        LastYearIncomeWithholding    is a CurrencyAmount	
            classic name is LY-INC-WH
        CurrentPeriodPurchases       is a CpPurchX14InApvenbal
            classic name is CP-PURCH
        LastYearPeriodPurchases      is a LyPurchX13InApvenbal
            classic name is LY-PURCH
        CurrentPeriodPayments        is a CpPaymentX14InApvenbal
            classic name is CP-PAYMENT
        LastYearPeriodPayments       is a LyPaymentX13InApvenbal
            classic name is LY-PAYMENT
        CurrentPeriodDiscountTaken   is a CpDsctakeX14InApvenbal
            classic name is CP-DSCTAKE
        LastYearDiscountsTaken       is a LyDsctakeX13InApvenbal
            classic name is LY-DSCTAKE
        CurrentPeriodDiscountLost    is a CpDsclostX14InApvenbal
            classic name is CP-DSCLOST
        LastYearDiscountsLost        is a LyDsclostX13InApvenbal
            classic name is LY-DSCLOST
        CurrentPeriodGainLoss        is a CpGainlosX14InApvenbal
            classic name is CP-GAINLOS
        LastYearGainLoss             is a LyGainlosX13InApvenbal
            classic name is LY-GAINLOS
        CurrentPeriodNbrOfPayments   is a CpNbrPmtsX14InApvenbal
            classic name is CP-NBR-PMTS
        LastYearNbrOfPayments        is a LyNbrPmtsX13InApvenbal
            classic name is LY-NBR-PMTS
        
		VendorConversionResult

	Context Fields
		FSMInboundBODTracker
    Transient Fields			
		EnteredPeriod									is Numeric 2
			derive value from DerivedPeriod
		TransNetVendorBalance							is like InternationalAmount
			derive value from DerivedNetVendorBalance
		TransNetCustomerBalance							is like InternationalAmount
			derive value from DerivedNetCustomerBalance
					
	Local Fields
		MaxPeriod							is Numeric 2
		LocalCurrentPeriod					is Numeric 2
		LocalPeriodEndDate					is Date

		LocalInvoiceDate					is Date
		LocalNbrOfPayments					is Numeric 6
		PeriodIdx							is Numeric 2
		PeriodIdx2							is Numeric 2
		PeriodIdx3							is Numeric 2
		PeriodIdx4							is Numeric 2
		PeriodIdx5							is Numeric 2
		PeriodIdx6							is Numeric 2
		PeriodIdx7							is Numeric 2
		LocalYTDPurchase					is an InternationalAmount
		LocalYTDPayments					is an InternationalAmount	
		LocalLastYearPurchase				is an InternationalAmount
		LocalLastYearPayments				is an InternationalAmount	
		LocalLastYearNbrOfPayments			is Numeric 6
		LocalVendorBalanceAmt				is an InternationalAmount	
		LocalTitle 				            is Alpha size 255
		ActionCode							is Alpha size 1
			States
				Create  value is "C"
				Update	value is "U"
				Delete	value is "D"

		LocalNativeLPLBODTrigger					is Boolean
		NewBODTracker  				is a FSMInboundBODTracker view
		LocalFSMInboundBODTracker	is Numeric 15
		Error            			is Boolean
	    ErrorMessage     			is Alpha 300
	    LocalBODTrigger				is Boolean

		LocalConfigurationParameter	is Alpha size up to 200
		LocalPeriod							is Numeric 2	

    Derived Fields

		DerivedAmountCurrency is a DerivedField
			type is Alpha size 30
			return CurrentBalance + " " + BalanceCurrency
		
		DerivedAmountHighest is a DerivedField
			type is Alpha size 30
			return HighestBalance + " "+BalanceCurrency
	

		ContextMessageEntityType is a StringField
			type is Alpha 30
			restricted
			"InforSupplierBalance"  
		
		ContextMessageText is a MessageField
			restricted
			"Vendor<Vendor>VendorLocation<VendorLocation>VendorBalance<VendorBalance>"
			
		FormTitle	is a DerivedField
			type is Alpha size up to 132
			default label is "_"
			if (VendorLocation entered)
				return "Location " + VendorLocation + "Balances For " + Vendor.VendorName 
			else
				return "Balances for " + Vendor.VendorName

		DerivedVendorBalanceInterfaceTitle	is a DerivedField		
			type is Alpha size up to 200
			default label is "_"
			if (Vendor.Customer entered)
				return "Balances For Vendor ( " + Vendor + " - " + Vendor.VendorName + ") And For Customer ( " + Vendor.Customer + " - " + Vendor.Customer.Name  + ")"
			else
				return "Balances For Vendor: " + Vendor + " - " + Vendor.VendorName 

		DerivedMessage1 is a LabelField		
			"BalancesForVendor_"

		DerivedMessage2 is a LabelField		
			"AndCustomer_"

		InvoicePeriodBucket is a DerivedField								
			type is Numeric size 2
			restricted
			if (LocalInvoiceDate <= Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1])
				return 1
			LocalCurrentPeriod = 1
			while (LocalCurrentPeriod <= 13	)
			 	if (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalCurrentPeriod] >= LocalInvoiceDate)
			 		return LocalCurrentPeriod 		
				LocalCurrentPeriod += 1
			return 14

		DerivedCurrentPerPurchases 	is a DerivedField		
			type is like InternationalAmount
			return (CurrentPeriodPurchases.PurchaseAmount[DerivedPeriod])

		DerivedCurrentPerPayments 	is a DerivedField		
			type is like InternationalAmount
			return (CurrentPeriodPayments.PaymentAmount[DerivedPeriod])

		DerivedCurrentPerNbrOfPayments 	is a DerivedField		
			type is Decimal size 6
			return (CurrentPeriodNbrOfPayments.NbrOfPayments[DerivedPeriod])

		DerivedCurrentPerDiscountTaken 	is a DerivedField		
			type is like InternationalAmount
			return (CurrentPeriodDiscountTaken.DiscountTakenAmount[DerivedPeriod])

		DerivedCurrentPerDiscountLost 	is a DerivedField		
			type is like InternationalAmount
			return (CurrentPeriodDiscountLost.DiscountLostAmount[DerivedPeriod])

		DerivedCurrentPerGainLoss 	is a DerivedField		
			type is like InternationalAmount
			return (CurrentPeriodGainLoss.GainLossAmount[DerivedPeriod])

		DerivedPeriodEndDate is a DerivedField
			type is Date
			if (EnteredPeriod entered					
			and EnteredPeriod	!= 14)					
				return Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[EnteredPeriod]		
			if (LocalCurrentPeriod not entered)
				LocalCurrentPeriod = 1
			else
			if (LocalCurrentPeriod != 14)
				return Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalCurrentPeriod]  
			LocalPeriodEndDate = current corporate date
			if (LocalPeriodEndDate > Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[13])
				return Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[13]
			else
			if (LocalPeriodEndDate <= Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1])
				return Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1]
			else
			if (LocalPeriodEndDate > Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1])					
				while (LocalCurrentPeriod <= 13)
				 	if (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalCurrentPeriod] >= LocalPeriodEndDate)
				 		return Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalCurrentPeriod]				 		
					LocalCurrentPeriod += 1
					
		DerivedPeriod is a DerivedField
			type is Numeric size 2
			if (EnteredPeriod entered)	
				LocalCurrentPeriod = EnteredPeriod
				if (EnteredPeriod	!= 14)
					LocalPeriodEndDate = Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[EnteredPeriod]				 	
				return EnteredPeriod				
			if (current corporate date <= Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1])
				return 1
			LocalCurrentPeriod = 1
			while (LocalCurrentPeriod <= 13)
			 	if (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalCurrentPeriod] >= current corporate date)
			 		return LocalCurrentPeriod 		
				LocalCurrentPeriod += 1
			return 14


		DerivedYTDPeriodPurchases	is a DerivedField
			type is like InternationalAmount
			if (EnteredPeriod 	entered
			and EnteredPeriod	!= 14)					
				MaxPeriod = EnteredPeriod + 1		
			else
				MaxPeriod = 14	
			PeriodIdx = 1
			initialize LocalYTDPurchase	
			while (PeriodIdx < MaxPeriod)
				LocalYTDPurchase = LocalYTDPurchase + CurrentPeriodPurchases.PurchaseAmount[PeriodIdx]
			 	PeriodIdx += 1
			return LocalYTDPurchase 	

		DerivedYTDPeriodPayments	is a DerivedField
			type is like InternationalAmount
			if (EnteredPeriod 	entered
			and EnteredPeriod	!= 14)					
				MaxPeriod = EnteredPeriod + 1		
			else
				MaxPeriod = 14	
			PeriodIdx2 = 1
			initialize LocalYTDPayments		
			while (PeriodIdx2 < MaxPeriod)
				LocalYTDPayments = LocalYTDPayments + CurrentPeriodPayments.PaymentAmount[PeriodIdx2]
			 	PeriodIdx2 += 1
			return LocalYTDPayments 				   	 		
				
		DerivedLastYearPurchases	is a DerivedField		
			type is like InternationalAmount 	
			PeriodIdx5 = 1
			initialize LocalLastYearPurchase		
			while (PeriodIdx5 < 14)
				LocalLastYearPurchase += LastYearPeriodPurchases.PurchaseAmount[PeriodIdx5]
			 	PeriodIdx5 += 1
			return LocalLastYearPurchase 	

		DerivedLastYearPayments	is a DerivedField		
			type is like InternationalAmount 	
			PeriodIdx6 = 1
			initialize LocalLastYearPayments		
			while (PeriodIdx6 < 14)
				LocalLastYearPayments += LastYearPeriodPayments.PaymentAmount[PeriodIdx6]
			 	PeriodIdx6 += 1
			return LocalLastYearPayments 	
								
		DerivedLastYearNbrOfPayments	is a DerivedField		
			type is Decimal size 6 	
			PeriodIdx7 = 1
			initialize LocalLastYearNbrOfPayments		
			while (PeriodIdx7 < 14)
				LocalLastYearNbrOfPayments += LastYearNbrOfPayments.NbrOfPayments[PeriodIdx7]
			 	PeriodIdx7 += 1
			return LocalLastYearNbrOfPayments 	
								
		DerivedYTDNbrOfPayments	is a DerivedField
			type is Decimal size 6




			if (EnteredPeriod 	entered					
			and EnteredPeriod	!= 14)					
				MaxPeriod = EnteredPeriod + 1		
			else
				MaxPeriod = 14	
			PeriodIdx4 = 1
			initialize LocalNbrOfPayments		
			while (PeriodIdx4 < MaxPeriod)
				LocalNbrOfPayments += CurrentPeriodNbrOfPayments.NbrOfPayments[PeriodIdx4]
			 	PeriodIdx4 += 1
			return LocalNbrOfPayments 				   	 		

		LastYearPeriod01EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[1] - 1 year)

		LastYearPeriod02EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[2] - 1 year)

		LastYearPeriod03EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[3] - 1 year)
		
		LastYearPeriod04EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[4] - 1 year)

		LastYearPeriod05EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[5] - 1 year)

		LastYearPeriod06EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[6] - 1 year)

		LastYearPeriod07EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[7] - 1 year)

		LastYearPeriod08EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[8] - 1 year)

		LastYearPeriod09EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[9] - 1 year)

		LastYearPeriod10EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[10] - 1 year)

		LastYearPeriod11EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[11] - 1 year)

		LastYearPeriod12EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[12] - 1 year)

		LastYearPeriod13EndingDate is a DerivedField
			type is Date
			return (Company.VendorGroup.PeriodEndingDates.PeriodEndingDate[13] - 1 year)

		CurrentPeriodPayment01       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-01
            restricted
            CurrentPeriodPayments.PaymentAmount[1]

        CurrentPeriodPayment02       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-02
            restricted
            CurrentPeriodPayments.PaymentAmount[2]

        CurrentPeriodPayment03       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-03
            restricted
            CurrentPeriodPayments.PaymentAmount[3]

        CurrentPeriodPayment04       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-04
            restricted
            CurrentPeriodPayments.PaymentAmount[4]

        CurrentPeriodPayment05       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-05
            restricted
            CurrentPeriodPayments.PaymentAmount[5]

        CurrentPeriodPayment06       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-06
            restricted
            CurrentPeriodPayments.PaymentAmount[6]

        CurrentPeriodPayment07       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-07
            restricted
            CurrentPeriodPayments.PaymentAmount[7]

        CurrentPeriodPayment08       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-08
            restricted
            CurrentPeriodPayments.PaymentAmount[8]

        CurrentPeriodPayment09       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-09
            restricted
            CurrentPeriodPayments.PaymentAmount[9]

        CurrentPeriodPayment10       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-10
            restricted
            CurrentPeriodPayments.PaymentAmount[10]

        CurrentPeriodPayment11       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-11
            restricted
            CurrentPeriodPayments.PaymentAmount[11]

        CurrentPeriodPayment12       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-12
            restricted
            CurrentPeriodPayments.PaymentAmount[12]

        CurrentPeriodPayment13       is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-PMT-13
            restricted
            CurrentPeriodPayments.PaymentAmount[13]

        CurrentPeriodDiscountTaken01 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-01
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[1]

        CurrentPeriodDiscountTaken02 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-02
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[2]

        CurrentPeriodDiscountTaken03 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-03
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[3]

        CurrentPeriodDiscountTaken04 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-04
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[4]

        CurrentPeriodDiscountTaken05 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-05
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[5]

        CurrentPeriodDiscountTaken06 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-06
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[6]

        CurrentPeriodDiscountTaken07 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-07
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[7]

        CurrentPeriodDiscountTaken08 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-08
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[8]

        CurrentPeriodDiscountTaken09 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-09
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[9]

        CurrentPeriodDiscountTaken10 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-10
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[10]

        CurrentPeriodDiscountTaken11 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-11
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[11]

        CurrentPeriodDiscountTaken12 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-12
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[12]

        CurrentPeriodDiscountTaken13 is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-TK-13
            restricted
            CurrentPeriodDiscountTaken.DiscountTakenAmount[13]

        CurrentPeriodDiscountLost01  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-01
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[1]

        CurrentPeriodDiscountLost02  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-02
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[2]

        CurrentPeriodDiscountLost03  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-03
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[3]

        CurrentPeriodDiscountLost04  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-04
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[4]

        CurrentPeriodDiscountLost05  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-05
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[5]

        CurrentPeriodDiscountLost06  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-06
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[6]

        CurrentPeriodDiscountLost07  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-07
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[7]

        CurrentPeriodDiscountLost08  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-08
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[8]

        CurrentPeriodDiscountLost09  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-09
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[9]

        CurrentPeriodDiscountLost10  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-10
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[10]

        CurrentPeriodDiscountLost11  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-11
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[11]

        CurrentPeriodDiscountLost12  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-12
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[12]

        CurrentPeriodDiscountLost13  is an ArrayValueField
            type is Decimal size 15.2
            classic name is CP-DISC-LST-13
            restricted
            CurrentPeriodDiscountLost.DiscountLostAmount[13]

        CurrentPeriodNbrOfPayments01 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-01
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[1]

        CurrentPeriodNbrOfPayments02 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-02
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[2]

        CurrentPeriodNbrOfPayments03 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-03
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[3]

        CurrentPeriodNbrOfPayments04 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-04
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[4]

        CurrentPeriodNbrOfPayments05 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-05
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[5]

        CurrentPeriodNbrOfPayments06 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-06
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[6]

        CurrentPeriodNbrOfPayments07 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-07
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[7]

        CurrentPeriodNbrOfPayments08 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-08
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[8]

        CurrentPeriodNbrOfPayments09 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-09
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[9]

        CurrentPeriodNbrOfPayments10 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-10
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[10]

        CurrentPeriodNbrOfPayments11 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-11
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[11]

        CurrentPeriodNbrOfPayments12 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-12
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[12]

        CurrentPeriodNbrOfPayments13 is an ArrayValueField
            type is Decimal size 6
            classic name is CP-NBR-PMTS-13
            restricted
            CurrentPeriodNbrOfPayments.NbrOfPayments[13]
    
		DerivedNetVendorBalance is a DerivedField
			type is like InternationalAmount
			restricted
			if (CompanyCustomerRel exists
			and BalanceCurrency = CompanyCustomerRel.Currency)
				return (CurrentBalance - CompanyCustomerRel.CurrentBalance)		
			else
			if (CompanyCustomerRel not exists)
				return CurrentBalance
				
		DerivedNetCustomerBalance  is a DerivedField
			type is like InternationalAmount
			restricted
			if (CompanyCustomerRel exists
			and BalanceCurrency = CompanyCustomerRel.Currency)
				return (CompanyCustomerRel.CurrentBalance - CurrentBalance)
			else
			if (CompanyCustomerRel not exists)
				return CurrentBalance * -1


		MobileCompanyDisplay is a LabelField
			"<Company>_-_<Company.Name>"
			
		MobileVendorDisplay is a LabelField
			"<Vendor>_-_<Vendor.VendorName>"
			
		MobileVendorLocationDisplay is a LabelField
			"<first VendorLocationRel.VendorLocation>_-_<first VendorLocationRel.VendorLocation.VendorName>"

				

		DerivedBODStatus is a DerivedField
			type is Alpha 10
			restricted
			if (ActionCode="C")
				return "Open"
			else
			if (ActionCode="U")
				return "Open"
			else
			if (ActionCode="D")
				return "Deleted"
			else
				return ""
		
		DerivedBODActionCode is a DerivedField
			type is Alpha 10
			restricted
			if (ActionCode="C")
				return "Add"
			else
			if (ActionCode="U")
				return "Replace"
			else
			if (ActionCode="D")
				return "Replace"
			else
				return ""
				
		DerivedFinanceEnterpriseGroup is a DerivedField
			type is Alpha 25
			restricted
			return Company.FinanceEnterpriseGroup
			
		DerivedCompany is a DerivedField
			type is Alpha size 12
			restricted
			return Company using "%d"
			
		DerivedDocumentID is a DerivedField
			type is Alpha size 60
			restricted
			if (VendorLocation="")
				return DerivedCompany+DerivedDelimiter+VendorGroup+DerivedDelimiter+Vendor
			else
				return DerivedCompany+DerivedDelimiter+VendorGroup+DerivedDelimiter+Vendor+DerivedDelimiter+VendorLocation
			
		DerivedContactID is a DerivedField
			type is Alpha size 25
			restricted
			if (VendorLocation="")
				return Vendor+DerivedDelimiter+"PRIME"
			else
				return Vendor+DerivedDelimiter+VendorLocation+DerivedDelimiter+"PRIME"
			
		DerivedLastModDate is a DerivedField
			type is Alpha size 25
			restricted
			if (VendorBalanceDate.LastPaymentDate>=VendorBalanceDate.LastPurchaseDate)
				DerivedLastModDate = VendorBalanceDate.LastPaymentDate
				return DerivedLastModDate
			if (VendorBalanceDate.LastPaymentDate<=VendorBalanceDate.LastPurchaseDate)
				DerivedLastModDate = VendorBalanceDate.LastPurchaseDate
				return DerivedLastModDate
			
		DerivedFormattedLastModDate is a DerivedField
			type is Alpha size 25
			restricted
			return DerivedLastModDate[1:4] + "-" + DerivedLastModDate[5:6] + "-" + DerivedLastModDate[7:8]+ "T00:00:00"
			
		DerivedVendorName is a DerivedField
			type is Alpha size 25
			restricted
			return VendorLocation.VendorName
		
		DerivedBODRevision is a DerivedField
			type is Alpha 25
			restricted
			return ""
					
		Derivedlocation is a DerivedField
			type is Alpha 25
			restricted
			return ""
			
		DerivedBODVariationID is a DerivedField
			type is Alpha size 25
			restricted
			return  bod id.VariationID
			
		DerivedBODCurrentTimeStamp is a DerivedField
			type is Alpha size 25
			restricted
			return current timestamp
			
		DerivedBODFormattedCurrentTimeStamp is a DerivedField
			type is Alpha size 25
			restricted
			return DerivedBODCurrentTimeStamp[1:4] + "-" + DerivedBODCurrentTimeStamp[5:6] + "-" + DerivedBODCurrentTimeStamp[7:8] + "T" + DerivedBODCurrentTimeStamp[9:10] + ":" + DerivedBODCurrentTimeStamp[11:12] + ":" + DerivedBODCurrentTimeStamp[13:14] + "Z"
		
		DerivedVName is a DerivedField	
			type is Alpha size 120
			restricted
			return Vendor.VendorName
				
		DerivedContactName is a DerivedField	
			type is Alpha size 120
			restricted
			return Vendor.first VendorContactRel.VendorContact.ContactName
			
		DerivedInternationalPrefix is a DerivedField	
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.PhoneNumber.InternationalPrefix
			
		DerivedSubscriberNumber is a DerivedField
			type is Alpha size 25
			restricted
			return	Vendor.first VendorContactRel.VendorContact.PhoneNumber.SubscriberNumber	
			
		DerivedExtension is a DerivedField
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.PhoneNumber.Extension
			
		DerivedMInternationalPrefix is a DerivedField	
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.MobileNumber.MobilePhoneNumber.InternationalPrefix
			
		DerivedMSubscriberNumber is a DerivedField
			type is Alpha size 25
			restricted
			return	Vendor.first VendorContactRel.VendorContact.MobileNumber.MobilePhoneNumber.SubscriberNumber	
			
		DerivedMExtension is a DerivedField
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.MobileNumber.MobilePhoneNumber.Extension
			
		DerivedFInternationalPrefix is a DerivedField	
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.FaxNumber.InternationalPrefix
			
		DerivedFSubscriberNumber is a DerivedField
			type is Alpha size 25
			restricted
			return	Vendor.first VendorContactRel.VendorContact.FaxNumber.SubscriberNumber	
			
		DerivedFExtension is a DerivedField
			type is Alpha size 25
			restricted
			return Vendor.first VendorContactRel.VendorContact.FaxNumber.Extension
			
		DerivedEmailAddress is a DerivedField
			type is Alpha size 30
			restricted
			return Vendor.first VendorContactRel.VendorContact.EmailAddress
		
		DerivedCurBal is a DerivedField
			type is Alpha size 25
			restricted
			return CurrentBalance 
			
		DerivedBODDisplayID is a DerivedField
			type is Alpha size 25
			restricted
			return Vendor
			
		DerivedAccountingEntity is a DerivedField
			type is Alpha size 25
			restricted
			return DerivedFinanceEnterpriseGroup+DerivedDelimiter+DerivedaccountingEntity
			
		DerivedaccountingEntity is a DerivedField
			type is Alpha size 10
			restricted
			return Company.AccountingEntity 
				
		DerivedBODID is a DerivedField
			type is Alpha 100
			restricted
			return "infor-nid:" + DerivedTenantID +":" + DerivedAccountingEntity + ":" + Derivedlocation + ":"+DerivedDocumentID + ":" +DerivedBODRevision+"?SupplierBalance&verb=Sync&TrackerID="+ LocalFSMInboundBODTracker
		
		DerivedDelimiter is a DerivedField
			type is Alpha size 2
			restricted
			LocalConfigurationParameter	= "Generic_Delimiter"
			if(FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
					
		DerivedTenantID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter	= "tenantID"
			if(FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedReleaseID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter	= "releaseID"
			if(FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedLogicalID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter	= "logicalID"
			if(FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value
		
		DerivedVersionID is a DerivedField
			type is Alpha size 60
			restricted
			LocalConfigurationParameter	= "VersionID"
			if(FSMBODConfigurationParameterRel exists)
				return FSMBODConfigurationParameterRel.Value


		SupplierBalanceBODXML is a DerivedField
			type is XMLDocument
			restricted
			SupplierBalanceBODXML = template.IONSyncSupplierBalance_VendorBalance_ST document for this instance


	Rule Blocks
					
		TriggerSupplierBalanceRules
			trigger PayablesService.SupplierBalanceService PA service
				resume on error
				title is "<LocalTitle>"
				Criteria
					Company.FinanceEnterpriseGroup
					Company
				Variables
					ActionCode
					include persistent fields from VendorBalance
					include persistent fields from Vendor.first VendorContactRel.VendorContact
					VendorLocation.VendorName
						variable name is VendorName
					Vendor.VendorName
						variable name is VName
					bod id.VariationID
						variable name is VariationId
					Company.FinanceEnterpriseGroup
						variable name is FinanceEnterpriseGroup	
					Company.GeneralLedgerCompany.AccountingEntity
						variable name is AccountingEntity
	
    Field Rules
    	BalanceCurrency
    		default to Vendor.BalanceCurrency
    		default to Company.Currency
            required

    
    Conditions
		RecordExists
			restricted
			when (VendorBalance exists)
			
        IsVendorLocation
            classic name is APVENLOC
            restricted
            when (VendorLocation entered)

        IsVendor
            classic name is APVENMAST
            restricted
            when (VendorLocation not entered)

        LocationMatches
            classic name is LOCATION-MATCH
            restricted
            when (VendorLocation = VendorLocation.VendorLocation)

		HasCurrencyMismatch
			when (CompanyCustomerRel exists
			and   BalanceCurrency != CompanyCustomerRel.Currency)
			
		DisplayCYPeriod13
			when (CurrentPeriodPurchases.PurchaseAmount[13]		entered
			or    CurrentPeriodPayments.PaymentAmount[13]		entered
			or    CurrentPeriodNbrOfPayments.NbrOfPayments[13]	entered)
			
		DisplayLYPeriod13
			when (LastYearPeriodPurchases.PurchaseAmount[13]	entered
			or    LastYearPeriodPayments.PaymentAmount[13]		entered
			or    LastYearNbrOfPayments.NbrOfPayments[13]		entered)
			
		DisplayPeriod14
			when (CurrentPeriodPurchases.PurchaseAmount[14]		entered
			or    CurrentPeriodPayments.PaymentAmount[14]		entered
			or    CurrentPeriodNbrOfPayments.NbrOfPayments[14]	entered)

		HasPurchaseOrders		
			restricted
			when (Vendor.PurchaseOrdersRel exists)

		HasPurchaseOrderReceipts		
			restricted
			when (Vendor.PurchaseOrderReceiptsRel exists)

		RelatedProjectContractsExist		
			restricted
			when (Vendor.ProjectContractsRel exists)

		ValidateVAT		
			restricted
			when (Vendor.VendorGroup.BusinessGroup.FinanceEnterpriseGroup.TaxConfiguration.ValidateVAT)

    Relations

    	VendorLocationRel
			one-to-many relation to VendorLocation
			Field Mapping uses symbolic key
				related.VendorGroup    = VendorGroup
				related.Vendor		   = Vendor

        PayablesInvoicePaymentHistoryRel
            classic name is APAPPHIST
            one-to-many relation to PayablesInvoicePaymentHistory
            Field Mapping uses symbolic key
                related.Company = Company
                related.Vendor  = Vendor

        PayablesBillOfExchangeRel
            classic name is APDRAFTS
            one-to-many relation to PayablesBillOfExchange
            Field Mapping uses Set8
                related.VendorGroup = VendorGroup
                related.Vendor      = Vendor
                related.Company     = Company
        







		CompanyCustomerRel
			one-to-one relation to CompanyCustomer
			Field Mapping uses symbolic key
            	related.Company											= Company
				related.Customer										= Vendor.Customer
				

		FSMBODConfigurationParameterRel
    		one-to-one relation to FSMBODConfigurationParameter
    		Field Mapping uses symbolic key
    			related.FSMBODConfigurationParameter	= LocalConfigurationParameter
		
		FSMBODConfigurationRel
        	one-to-one relation to FSMBODConfiguration
			Field Mapping uses symbolic key
            	related.FSMBODConfiguration.Verb 		= 1
            	related.FSMBODConfiguration.Noun 		= "SupplierBalance"
            	related.FSMBODConfiguration.Direction 	= 1

		FSMInboundBODTrackerRel
            one-to-one relation to FSMInboundBODTracker
            Field Mapping uses symbolic key
                related.FSMInboundBODTracker	= LocalFSMInboundBODTracker
    
    

	

	Actions
        Create is a Create Action
        	restricted				
        	Entrance Rules

        	Action Rules

        	Exit Rules


        Update is an Update Action
        	
        Delete is a Delete Action
        	restricted				
        	
		VendorBalanceYearEndUpdate is a Set Action
			default label is untranslatable
			restricted
			Parameters
				PrmVendorGroup		is a VendorGroup
			Parameter Rules
				PrmVendorGroup
					required
						"VendorGroupRequired"
			Instance Selection
				where (PrmVendorGroup = VendorGroup)
			Sort Order is Set1
			Action Rules
				Set Rules
				Instance Rules
					 	LastYearIncomeWithholding = CurrentYearIncomeWithholding
					 	CurrentYearIncomeWithholding = 0
					 	MaxPeriod = 14	
						PeriodIdx = 1
						while (PeriodIdx <= MaxPeriod)
							if(PeriodIdx  = 14)
								CurrentPeriodPurchases.PurchaseAmount[1] = CurrentPeriodPurchases.PurchaseAmount[PeriodIdx] 
								CurrentPeriodPayments.PaymentAmount[1] = CurrentPeriodPayments.PaymentAmount[PeriodIdx]
								CurrentPeriodDiscountTaken.DiscountTakenAmount[1] = CurrentPeriodDiscountTaken.DiscountTakenAmount[PeriodIdx]
								CurrentPeriodDiscountLost.DiscountLostAmount[1] = CurrentPeriodDiscountLost.DiscountLostAmount[PeriodIdx] 
								CurrentPeriodGainLoss.GainLossAmount[1] = CurrentPeriodGainLoss.GainLossAmount[PeriodIdx] 
								CurrentPeriodNbrOfPayments.NbrOfPayments[1] = CurrentPeriodNbrOfPayments.NbrOfPayments[PeriodIdx] 
								CurrentPeriodPurchases.PurchaseAmount[PeriodIdx] = 0
								CurrentPeriodPayments.PaymentAmount[PeriodIdx] = 0
								CurrentPeriodDiscountTaken.DiscountTakenAmount[PeriodIdx] = 0
								CurrentPeriodDiscountLost.DiscountLostAmount[PeriodIdx] = 0
								CurrentPeriodGainLoss.GainLossAmount[PeriodIdx] = 0
								CurrentPeriodNbrOfPayments.NbrOfPayments[PeriodIdx]= 0
								end while
								
							LastYearPeriodPurchases.PurchaseAmount[PeriodIdx] = CurrentPeriodPurchases.PurchaseAmount[PeriodIdx]
							CurrentPeriodPurchases.PurchaseAmount[PeriodIdx] = 0
							LastYearPeriodPayments.PaymentAmount[PeriodIdx] = CurrentPeriodPayments.PaymentAmount[PeriodIdx]
							CurrentPeriodPayments.PaymentAmount[PeriodIdx] = 0
							LastYearDiscountsTaken.DiscountTakenAmount[PeriodIdx] = CurrentPeriodDiscountTaken.DiscountTakenAmount[PeriodIdx]
							CurrentPeriodDiscountTaken.DiscountTakenAmount[PeriodIdx] = 0 
							LastYearDiscountsLost.DiscountLostAmount[PeriodIdx] = CurrentPeriodDiscountLost.DiscountLostAmount[PeriodIdx]
							CurrentPeriodDiscountLost.DiscountLostAmount[PeriodIdx] = 0
							LastYearGainLoss.GainLossAmount[PeriodIdx] = CurrentPeriodGainLoss.GainLossAmount[PeriodIdx]
							CurrentPeriodGainLoss.GainLossAmount[PeriodIdx] = 0
							LastYearNbrOfPayments.NbrOfPayments[PeriodIdx] = CurrentPeriodNbrOfPayments.NbrOfPayments[PeriodIdx]
							CurrentPeriodNbrOfPayments.NbrOfPayments[PeriodIdx] = 0
								
							PeriodIdx += 1
							
        UpdateCurrentBalance is an Instance Action					
			default label is untranslatable
			restricted
			Parameters
				UpdateAmount is an InternationalAmount		
			Action Rules
				CurrentBalance += UpdateAmount								

		UpdateBODIdFields is an Instance Action
			default label is untranslatable
			restricted
			Parameters
				PrmAccountingEntity  is Alpha size 22
					default label is "AccountingEntity"
				PrmLocation          is Alpha size 22
					default label is "Location" 
				PrmDocumentID        is Alpha size 100
					default label is "DocumentID"
				PrmVariationID       is Alpha size 22
					default label is "VariationID"	
				PrmSystemOfRecord    is Alpha size 1
					default label is "SystemOfRecord"
			Action Rules
				if (bod id.AccountingEntity != PrmAccountingEntity)
					bod id.AccountingEntity 	= PrmAccountingEntity
				if (bod id.Location != PrmLocation)
					bod id.Location				= PrmLocation
				if (bod id.DocumentID != PrmDocumentID)
					bod id.DocumentID			= PrmDocumentID
				if (bod id.VariationID != PrmVariationID)
					bod id.VariationID			= PrmVariationID
				if (bod id.SystemOfRecord != PrmSystemOfRecord)
					bod id.SystemOfRecord		= PrmSystemOfRecord
		
				
		TriggerSupplierBalance is an Instance Action
			default label is untranslatable
			restricted
			Action Rules	
				if (Company.FinanceEnterpriseGroup.BODTrigger)
    				if (!action type.Delete)
						if (action != "UpdateBODIdFields") 
							ActionCode = ActionCode.Update
							if (old HighestBalance = 0)
								ActionCode = ActionCode.Create
							if(VendorLocation entered)
								LocalTitle = "EG:"+Company.FinanceEnterpriseGroup+" CO:"+Company+" VG:"+VendorGroup+" VN:"+Vendor+" VL:"+VendorLocation
							else
								LocalTitle = "EG:"+Company.FinanceEnterpriseGroup+" CO:"+Company+" VG:"+VendorGroup+" VN:"+Vendor
							increment bod id.VariationID
							include TriggerSupplierBalanceRules

										

		BODDataInitialLoadSupplierBalanceCriteria is a Set Action
			default label is untranslatable
			restricted
			Parameters
				PrmFromVendorGroup				is a VendorGroup
				PrmFromVendor					is a Vendor
				PrmToVendor						is a Vendor
				PrmFromLocation					is a VendorLocation
					context of PrmFromVendor
				PrmToLocation					is a VendorLocation
					context of PrmFromVendor
			Parameter Rules
			Instance Selection			
				where  (((PrmFromVendorGroup entered
				and		 PrmFromVendorGroup = VendorGroup)
				or		 PrmFromVendorGroup not entered)
				and    ((PrmFromVendor entered
				and		 PrmFromVendor <= Vendor)
				or		 PrmFromVendor not entered)
				and    ((PrmToVendor entered
				and		 PrmToVendor >= Vendor)
				or		 PrmToVendor not entered)
				and    ((PrmFromLocation entered
				and		 PrmFromLocation <= VendorLocation)
				or		 PrmFromLocation not entered)
				and    ((PrmToLocation entered
				and		 PrmToLocation >= VendorLocation)
				or		 PrmToLocation not entered))
			Sort Order
			Action Rules								
				Instance Rules	
					if (Company.FinanceEnterpriseGroup.BODTrigger)
						ActionCode = ActionCode.Create
						if(VendorLocation != "")
							LocalTitle = "EG:"+Company.FinanceEnterpriseGroup+" CO:"+Company+" VG:"+VendorGroup+" VN:"+Vendor+" VL:"+VendorLocation
						else
							LocalTitle = "EG:"+Company.FinanceEnterpriseGroup+" CO:"+Company+" VG:"+VendorGroup+" VN:"+Vendor
						increment bod id.VariationID
						include TriggerSupplierBalanceRules

								

        VendorImportUpdate is an Instance Action					
			default label is untranslatable
			restricted
			Parameters
				PrmCurrentBalance					is a CurrencyAmount
				PrmCurrentYearIncomeWithholding		is a CurrencyAmount
				PrmLastYearIncomeWithholding		is a CurrencyAmount
				PrmHighestBalance					is a CurrencyAmount
				PrmLastPaymentDate 					is Date
				PrmLastPurchaseDate 				is Date
				PrmVendorConversionResult 			is like VendorConversionResult
			Action Rules
				CurrentBalance							+= PrmCurrentBalance
				CurrentYearIncomeWithholding			+= PrmCurrentYearIncomeWithholding
				LastYearIncomeWithholding				+= PrmLastYearIncomeWithholding
				if (PrmHighestBalance > HighestBalance)
					HighestBalance						= PrmHighestBalance
				if (PrmLastPaymentDate > VendorBalanceDate.LastPaymentDate)
					VendorBalanceDate.LastPaymentDate	= PrmLastPaymentDate
				if (PrmLastPurchaseDate > VendorBalanceDate.LastPurchaseDate)
					VendorBalanceDate.LastPurchaseDate	= PrmLastPurchaseDate
				
				VendorConversionResult					= PrmVendorConversionResult


        UpdateVendorBalance is an Instance Action					
			default label is untranslatable
			restricted
			refresh and lock this instance
			Parameters
				PassedUpdatePeriodBalance			is Boolean
				PassedUpdateCurrAndHighBal			is Boolean
				PassedAddToVendorBalance			is Boolean
				PassedDraftBalanceStatus			is Alpha 1
					States
						Accepted		value is "A"
						Rejected		value is "R"
				PassedInvoiceDate					is Date
				PassedPaymentDate					is Date
				PassedCurrentPeriod					is Numeric 2
				PassedInvoiceAmt 					is an InternationalAmount		
				PassedActualPurchaseAmt 			is an InternationalAmount
				PassedOriginalBaseAmount			is an InternationalAmount
				PassedVendorBalanceCurrency			is a Currency
				PassedInvoiceType					is a InvoiceType	
			Action Rules
				VendorBalanceDate.LastPurchaseDate	= PassedInvoiceDate
				PeriodIdx3 = VendorGroup.PeriodBucket								
				LocalInvoiceDate = PassedInvoiceDate
				if (PassedUpdateCurrAndHighBal)			
					if (PassedAddToVendorBalance)
						CurrentBalance += PassedInvoiceAmt										
						if (CurrentBalance > HighestBalance
						or HighestBalance not entered)
							HighestBalance				= CurrentBalance
					else	
						if (PassedInvoiceAmt > CurrentBalance)
							CurrentBalance	-= PassedInvoiceAmt		
						else
							LocalVendorBalanceAmt = CurrentBalance - PassedInvoiceAmt	
							CurrentBalance = LocalVendorBalanceAmt
				if (PassedUpdatePeriodBalance)			
					if (PassedAddToVendorBalance)
						LocalVendorBalanceAmt = CurrentPeriodPurchases.PurchaseAmount[PeriodIdx3] + PassedInvoiceAmt						
						CurrentPeriodPurchases.PurchaseAmount[PeriodIdx3] = LocalVendorBalanceAmt
					else
						LocalVendorBalanceAmt = CurrentPeriodPurchases.PurchaseAmount[PeriodIdx3] - PassedInvoiceAmt
						CurrentPeriodPurchases.PurchaseAmount[PeriodIdx3] = LocalVendorBalanceAmt
						if (PassedInvoiceType = "E"
						or  PassedInvoiceType not entered)
							if (PassedInvoiceDate > VendorBalanceDate.LastPurchaseDate)
								VendorBalanceDate.LastPurchaseDate		= PassedInvoiceDate
								
				if (PassedDraftBalanceStatus entered)		
					if (PassedDraftBalanceStatus.Rejected)
						if (BalanceCurrency not entered
						and PassedVendorBalanceCurrency not entered)
							CurrentBalance 	+= PassedInvoiceAmt
							DraftBalance 	-= PassedInvoiceAmt
						else
							CurrentBalance 	+= PassedOriginalBaseAmount
							DraftBalance 	-= PassedOriginalBaseAmount
			Exit Rules
        		invoke TriggerSupplierBalance
			
        UpdateHistoricalPaymentBalances is an Instance Action					
			default label is untranslatable
			restricted
			Parameters
				PrmPaymentDate			is Date
				PrmPaymentAmount 		is an InternationalAmount		
				PrmDiscountTaken		is an InternationalAmount
				PrmDiscountLost 		is an InternationalAmount
				PrmIncomeWithholding	is an InternationalAmount

			Action Rules
				LocalInvoiceDate = PrmPaymentDate

				CurrentPeriodPayments.PaymentAmount[InvoicePeriodBucket]			+= PrmPaymentAmount
				CurrentPeriodDiscountTaken.DiscountTakenAmount[InvoicePeriodBucket]	+= PrmDiscountTaken
				CurrentPeriodDiscountLost.DiscountLostAmount[InvoicePeriodBucket]	+= PrmDiscountLost
				CurrentYearIncomeWithholding										+= PrmIncomeWithholding

        UpdateHistoricalNumberOfPayments is an Instance Action					
			default label is untranslatable
			restricted
			Parameters
				PrmNumberOfPayments		is a CpNbrPmtsX14InApvenbal

			Action Rules
				CurrentPeriodNbrOfPayments.NbrOfPayments[1]		+= PrmNumberOfPayments.NbrOfPayments[1]
				CurrentPeriodNbrOfPayments.NbrOfPayments[2]		+= PrmNumberOfPayments.NbrOfPayments[2]
				CurrentPeriodNbrOfPayments.NbrOfPayments[3]		+= PrmNumberOfPayments.NbrOfPayments[3]
				CurrentPeriodNbrOfPayments.NbrOfPayments[4]		+= PrmNumberOfPayments.NbrOfPayments[4]
				CurrentPeriodNbrOfPayments.NbrOfPayments[5]		+= PrmNumberOfPayments.NbrOfPayments[5]
				CurrentPeriodNbrOfPayments.NbrOfPayments[6]		+= PrmNumberOfPayments.NbrOfPayments[6]
				CurrentPeriodNbrOfPayments.NbrOfPayments[7]		+= PrmNumberOfPayments.NbrOfPayments[7]
				CurrentPeriodNbrOfPayments.NbrOfPayments[8]		+= PrmNumberOfPayments.NbrOfPayments[8]
				CurrentPeriodNbrOfPayments.NbrOfPayments[9]		+= PrmNumberOfPayments.NbrOfPayments[9]
				CurrentPeriodNbrOfPayments.NbrOfPayments[10]	+= PrmNumberOfPayments.NbrOfPayments[10]
				CurrentPeriodNbrOfPayments.NbrOfPayments[11]	+= PrmNumberOfPayments.NbrOfPayments[11]
				CurrentPeriodNbrOfPayments.NbrOfPayments[12]	+= PrmNumberOfPayments.NbrOfPayments[12]
				CurrentPeriodNbrOfPayments.NbrOfPayments[13]	+= PrmNumberOfPayments.NbrOfPayments[13]
		


		SendSupplierBalanceBODNativeLPL is an Instance Action
			restricted
			Entrance Rules
			Parameters
			Action Rules
				send ion bod
					bod is SupplierBalanceBODXML
					bod type is "Sync.SupplierBalance"
					accounting entity is DerivedAccountingEntity
					document id is DerivedDocumentID
					variation id is DerivedBODVariationID



		TriggerSupplierBalanceNativeLPLBOD is an Instance Action
			restricted
			Entrance Rules
			Parameters
			Action Rules	
				invoke NativeLPLBODTriggerChecks FSMBODConfigurationRel
					invoked.PrmVerb 					= 1
					invoked.PrmNoun						= "SupplierBalance"
					invoked.PrmDirection				= 1
					invoked.PrmTriggerFrom				= "VendorBalance"
					invoked.PrmFinanceEnterpriseGroup	= Company.FinanceEnterpriseGroup 
					invoked.PrmCompany					= Company
					invoked.PrmBusinessGroup			= VendorGroup
					invoked.PrmAccountingEntity			= Company.AccountingEntity
					invoked.PrmMainUserTemplate			= "IONSyncSupplierBalance_VendorBalance_ST"
				LocalNativeLPLBODTrigger = FSMBODConfigurationRel.NativeLPLBODTrigger
				if (Company.FinanceEnterpriseGroup.BODTrigger and LocalNativeLPLBODTrigger)
					if(FSMInboundBODTracker not entered)
						invoke Create FSMInboundBODTracker
							assign result to NewBODTracker
							invoked.Verb 					= 1
							invoked.Noun 					= "SupplierBalance"					
							invoked.BODDocumentID			= DerivedDocumentID
							invoked.BODVariationID			= DerivedBODVariationID
							invoked.BODID					= DerivedBODID
							invoked.Status					= 1
							invoked.StartDate				= system current timestamp
							invoked.FinanceEnterpriseGroup	= DerivedFinanceEnterpriseGroup
							invoked.Direction				= 1
							invoked.Reference1				= VendorGroup
							invoked.Vendor					= Vendor
							invoked.Reference2				= VendorLocation
							invoked.Reference3				= DerivedCompany
							invoked.BODAccountingEntity		= DerivedAccountingEntity
							initialize invoked.Error			
							initialize invoked.ErrorMessage					
						LocalFSMInboundBODTracker	= NewBODTracker.FSMInboundBODTracker
					else 
						LocalFSMInboundBODTracker		= FSMInboundBODTracker
						invoke Update FSMInboundBODTrackerRel
							invoked.BODDocumentID			= DerivedDocumentID
							invoked.BODVariationID			= DerivedBODVariationID
							invoked.BODID					= DerivedBODID
							invoked.Status					= 1
							invoked.StartDate				= system current timestamp
							invoked.FinanceEnterpriseGroup	= DerivedFinanceEnterpriseGroup
							invoked.Direction				= 1
							invoked.Reference1				= VendorGroup
							invoked.Vendor					= Vendor
							invoked.Reference2				= VendorLocation
							invoked.Reference3				= DerivedCompany
							invoked.BODAccountingEntity		= DerivedAccountingEntity
							initialize invoked.Error			
							initialize invoked.ErrorMessage
					invoke SendSupplierBalanceBODNativeLPL
						resume on error
							Error            							= true
							ErrorMessage     							= error message
					if(Error)
						invoke Update FSMInboundBODTrackerRel
							invoked.Error 								= Error
							invoked.ErrorMessage 						= ErrorMessage
							invoked.Status								= 2
							invoked.CloseDate							= system current timestamp
							invoked.BODID								= DerivedBODID
							invoked.BODXML								= SupplierBalanceBODXML
					else
						invoke Update FSMInboundBODTrackerRel
							invoked.Status									= 3
							invoked.CloseDate								= system current timestamp
							invoked.BODID									= DerivedBODID
							invoked.BODXML									= SupplierBalanceBODXML
		

		UpdateVendorBalanceFields is an Instance Action		
			Parameters
				PrmLastYearPeriodPurchases      is a LyPurchX13InApcvenbal
				PrmLastYearPeriodPayments       is a LyPaymentX13InApcvenbal
				PrmLastYearDiscountsTaken       is a LyDsctakeX13InApcvenbal
				PrmLastYearDiscountsLost        is a LyDsclostX13InApcvenbal
				PrmLastYearGainLoss             is a LyGainlosX13InApcvenbal
				PrmLastYearNbrOfPayments        is a LyNbrPmtsX13InApcvenbal				
				PrmCurrentPeriodPayments        is a CpPaymentX14InApcvenbal
				PrmCurrentPeriodPurchases       is a CpPurchX14InApcvenbal
				PrmCurrentPeriodDiscountTaken   is a CpDsctakeX14InApcvenbal
				PrmCurrentPeriodDiscountLost    is a CpDsclostX14InApcvenbal
				PrmCurrentPeriodGainLoss        is a CpGainlosX14InApcvenbal
				PrmCurrentPeriodNbrOfPayments   is a CpNbrPmtsX14InApcvenbal		

			Action Rules
				LocalPeriod = 1
				while (LocalPeriod <= 14)
					CurrentPeriodPayments.PaymentAmount[LocalPeriod] 			+= PrmCurrentPeriodPayments.CpPayment[LocalPeriod]
					CurrentPeriodPurchases.PurchaseAmount[LocalPeriod] 			+= PrmCurrentPeriodPurchases.CpPurch[LocalPeriod] 
					CurrentPeriodDiscountTaken.DiscountTakenAmount[LocalPeriod] += PrmCurrentPeriodDiscountTaken.CpDsctake[LocalPeriod]
					CurrentPeriodDiscountLost.DiscountLostAmount[LocalPeriod] 	+= PrmCurrentPeriodDiscountLost.CpDsclost[LocalPeriod] 
					CurrentPeriodGainLoss.GainLossAmount[LocalPeriod] 			+= PrmCurrentPeriodGainLoss.CpGainlos[LocalPeriod] 	
					CurrentPeriodNbrOfPayments.NbrOfPayments[LocalPeriod] 		+= PrmCurrentPeriodNbrOfPayments.CpNbrPmts[LocalPeriod] 
					LocalPeriod += 1

				LocalPeriod = 1
				while (LocalPeriod <= 13)
					LastYearPeriodPurchases.PurchaseAmount[LocalPeriod] 		+= PrmLastYearPeriodPurchases.LyPurch[LocalPeriod]
					LastYearPeriodPayments.PaymentAmount[LocalPeriod] 			+= PrmLastYearPeriodPayments.LyPayment[LocalPeriod]
					LastYearDiscountsTaken.DiscountTakenAmount[LocalPeriod] 	+= PrmLastYearDiscountsTaken.LyDsctake[LocalPeriod]
					LastYearDiscountsLost.DiscountLostAmount[LocalPeriod] 		+= PrmLastYearDiscountsLost.LyDsclost[LocalPeriod]  
					LastYearGainLoss.GainLossAmount[LocalPeriod] 				+= PrmLastYearGainLoss.LyGainlos[LocalPeriod] 	
					LastYearNbrOfPayments.NbrOfPayments[LocalPeriod] 			+= PrmLastYearNbrOfPayments.LyNbrPmts[LocalPeriod]
					LocalPeriod += 1

		UpdateConsolidatedVendorBalances is an Instance Action
			default label is untranslatable
			restricted
			refresh and lock this instance
			Parameters
				PrmCurrentBalance				is a CurrencyAmount
				PrmLastPaymentDate				is Date
				PrmCurrentPeriodPayments        is a CurrencyAmount
				PrmCurrentPeriodDiscountTaken   is a CurrencyAmount
				PrmCurrentPeriodDiscountLost    is a CurrencyAmount
				PrmCurrentPeriodGainLoss        is a CurrencyAmount
				PrmCurrentYearIncomeWithholding	is a CurrencyAmount

			Local Fields
				LocalSub1						is Numeric size 2
				LocalSub2						is Numeric size 2

			Action Rules
				LocalSub1 = 1
				LocalSub2 = 0
				while (LocalSub1 <= 13
				and    LocalSub2 = 0)
					if (PrmLastPaymentDate <= VendorGroup.PeriodEndingDates.PeriodEndingDate[LocalSub1])
						LocalSub2 = LocalSub1
					LocalSub1 += 1
				if (LocalSub2 	= 0)
					LocalSub2	= 14

				if (PrmLastPaymentDate > VendorBalanceDate.LastPaymentDate)
					VendorBalanceDate.LastPaymentDate = PrmLastPaymentDate
				CurrentBalance 			        								-= PrmCurrentBalance
				CurrentPeriodPayments.PaymentAmount[LocalSub2] 					+= PrmCurrentPeriodPayments
				CurrentPeriodDiscountLost.DiscountLostAmount[LocalSub2] 		+= PrmCurrentPeriodDiscountLost
				CurrentPeriodGainLoss.GainLossAmount[LocalSub2] 				+= PrmCurrentPeriodGainLoss
				CurrentPeriodDiscountTaken.DiscountTakenAmount[LocalSub2] 		+= PrmCurrentPeriodDiscountTaken
				CurrentYearIncomeWithholding 									+= PrmCurrentYearIncomeWithholding

		Purge is a Purge Action
			restricted
		
    Sets









        Set3
            indexed
            Sort Order
                VendorGroup
                Vendor
                BalanceCurrency
                VendorLocation
                Company

        Set1
            indexed
            Sort Order
                VendorGroup
                Company
                Vendor
                VendorLocation

        Set5
            indexed
            Sort Order
                Company
                Vendor
                VendorLocation
                BalanceCurrency
                VendorGroup
                

		ByVendorConversionResult
			Sort Order
				VendorConversionResult
                VendorGroup
                Company
                Vendor
                VendorLocation
		

































