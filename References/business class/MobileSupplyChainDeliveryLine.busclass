MobileSupplyChainDeliveryLine is a BusinessClass
    owned by mscm
    prefix is MSDVL
    sql name is "MSCMDeliveryLine"

    Ontology
        symbolic key is MobileSupplyChainDeliveryLine

    Patterns
        implements StaticJava
        disable AuditIndex

    Persistent Fields
        OriginatingLineNumber       is like MiscellaneousReceiptLine
        LastPerformedAction         is a PerformedAction
        Item
        Quantity
        UnitOfMeasure
        CatchWeightQuantity         is a Quantity
        CatchWeightUOM              is a UnitOfMeasure


        OrderedQuantity             is a Quantity
        OrderedUOM                  is a UnitOfMeasure
        BackorderedQuantity         is a Quantity
        

        VendorItem                  is like VendorItem
        SourceDocumentLineNumber    is Numeric size 6

        Bin                         is like Bin 
        Lot                         is like ItemLot
        Sublot                      is like Sublot
        Serial                      is like ItemSerialNumber
        ExpirationDate              is Date        

        Requisition                 is like Requisition
        Requester                   is like Requester

    Local Fields
        LocalDockLogTimestamp       is TimeStamp
        LocalRequisitionLine        is like RequisitionLine
    Derived Fields
        DerivedItem is a DerivedField
            type is like Item
            default label is "Item"
            if (Item entered)
                return Item

            return "-"

        DerivedItemDescription is a DerivedField
            type is like Item
            default label is "ItemDescription"
            if (Item entered)
                return Item.Description

            return "-"
    
        DerivedCurrentCompany is a DerivedField
            type is like MobileSupplyChainCompany
            if (TransferredDeliveryLineRel exists)
                return last TransferredDeliveryLineRel.MobileSupplyChainDeliveryEvent.EventCompanyLocation.MobileSupplyChainCompany
            return Company

        DerivedCurrentLocation is a DerivedField
            type is like MobileSupplyChainLocation
            if (TransferredDeliveryLineRel exists)
                return last TransferredDeliveryLineRel.MobileSupplyChainDeliveryEvent.EventCompanyLocation.MobileSupplyChainLocation
            return MobileSupplyChainLocation

        DerivedOrderedQuantityAndUOM is a DerivedField
            type is AlphaUpper size 20
            default label is "OrderedQuantityAndUOM"
            if (OrderedQuantity entered)
                return (OrderedQuantity + blank + OrderedUOM)

            return "-"

        DerivedQuantityAndUOM is a DerivedField
            type is AlphaUpper size 20
            default label is "DeliveredQuantityAndUOM"
            return (Quantity + blank + UnitOfMeasure)

        DerivedBlankDisplay is a DerivedField
            type is Alpha size 1
            return "-"

        ProcessDeliveryDocumentLineDetailXML is a DerivedField
            type is XMLDocument
            restricted
            if (MobileSupplyChainDeliveryLineDetailsRel exists)
                for each MobileSupplyChainDeliveryLineDetailsRel
                    ProcessDeliveryDocumentLineDetailXML += template.DeliveryTicketDocumentLineDetail_ST document for each
            else
                return ""

        DerivedRequesterName is a DerivedField
            type is like Name
            return RequisitionRel.Requester.Name

        DerivedRequestedDate is a DerivedField
            type is TimeStamp
            return RequisitionRel.CreationDate

        DerivedWarehouseZone is a DerivedField
            type is like WarehouseZone
            if (ItemLocationRel.IsAWarehouseLocationItem)
                return BinRel.WarehouseStorageLocationRel.WarehouseZone

        DerivedWarehouseZoneComponent is a DerivedField
            type is like WarehouseZoneComponent
            if (ItemLocationRel.IsAWarehouseLocationItem)
                return BinRel.WarehouseStorageLocationRel.WarehouseZoneComponent

        DerivedWarehouseAisle is a DerivedField
            type is like WarehouseAisle
            if (ItemLocationRel.IsAWarehouseLocationItem)
                return BinRel.WarehouseStorageLocationRel.WarehouseZoneComponent.WarehouseAisle

        DerivedWarehouseRow is a DerivedField
            type is Numeric size 2
            if (ItemLocationRel.IsAWarehouseLocationItem)
                return BinRel.WarehouseStorageLocationRel.Row

        DerivedStorageType is a DerivedField
            type is like StorageLocationType
            if (ItemLocationRel.IsAWarehouseLocationItem)
                return BinRel.WarehouseStorageLocationRel.StorageLocationType

        DerivedSpecialHandlingCode is a DerivedField
            type is like SpecialHandlingCode
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                return PurchaseOrderReceiptLineRel.DerivedSpecialHandlingCode
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                return RequisitionLineRel.SpecialHandlingCode

        DerivedSpecialHandlingDescription is a DerivedField
            type is like Description
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                return PurchaseOrderReceiptLineRel.DerivedSpecialHandlingDescription
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                return RequisitionLineRel.SpecialHandlingCode.Description

        DerivedSpecialHandlingInstructions is a DerivedField
            type is like Description4
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                return PurchaseOrderReceiptLineRel.DerivedSpecialHandlingInstructions
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                return RequisitionLineRel.SpecialHandlingInstructions

        DerivedTimeSensitive is a DerivedField
            type is Boolean
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                return PurchaseOrderReceiptLineRel.DerivedTimeSensitive
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                return RequisitionLineRel.SpecialHandlingCode.TimeSensitive

        DerivedHandlingTimeInMinutes is a DerivedField
            type is Numeric 3
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                return PurchaseOrderReceiptLineRel.DerivedHandlingTimeInMinutes
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                return RequisitionLineRel.HandlingTimeInMinutes

        ProcessDeliveryLineCommentXML is a DerivedField
            type is XMLDocument
            if (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
                for each PurchaseOrderReceiptLineCommentRel
                    ProcessDeliveryLineCommentXML += template.DeliveryTicketDocumentLineComment_ST document for each
            else
            if (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)
                for each RequisitionLineCommentRel
                    ProcessDeliveryLineCommentXML += template.DeliveryTicketDocumentLineComment_ST document for each
            else
                return ""
        
        ProcessDeliveryLineDistributionAccountXML is a DerivedField
            type is XMLDocument
            if (Requisition entered)
                initialize LocalRequisitionLine
                if (IsFromPOReceipt)
                    LocalRequisitionLine = SourceDocumentLineNumber
                else
                if (IsFromPicking)
                    LocalRequisitionLine = OriginatingLineNumber

                if (LocalRequisitionLine entered)    
                    for each RequisitionLineDistributionRel
                        ProcessDeliveryLineDistributionAccountXML += template.DeliveryTicketDocumentRQLineDistributionAccount_ST document for each               
            else
            if (IsFromPOReceipt)
                for each PurchaseOrderLineDistributionRel
                    ProcessDeliveryLineDistributionAccountXML += template.DeliveryTicketDocumentPOLineDistributionAccount_ST document for each

        DerivedManufacturerNumber is a DerivedField
            type is like ManufacturerNumber
            return PurchaseOrderReceiptLineRel.ManufacturerNumber

    Field Rules
        Quantity
            if (IsFromMiscReceipt or IsFromDockLog)
                default to 1

        OrderedQuantity
            if (IsFromMiscReceipt or IsFromDockLog)
                default to 1

        UnitOfMeasure
            if (IsFromPicking or IsFromPOReceipt)
                required

        OrderedUOM
            if (IsFromPicking or IsFromPOReceipt)
                required
    
    Sets
        ByLot
            Sort Order
                Company
                MobileSupplyChainLocation
                MobileSupplyChainDeliveryTicket
                OriginatingLineNumber
                Lot
                MobileSupplyChainDeliveryUnit
                MobileSupplyChainDeliveryLine  

    Actions
        Create is a Create Action
            restricted

        Update is an Update Action
            restricted

        Delete is a Delete Action
            restricted
    
        CreateEventLine is an Instance Action
            restricted
            Parameters
                PrmMobileSupplyChainDeliveryEvent   is a MobileSupplyChainDeliveryEvent
                PrmDeliveryNoteCode                 is a DeliveryNoteCode
                PrmDeliveryNote                     is a DeliveryNote
            Action Rules
                invoke Create MobileSupplyChainDeliveryEventLine
                    invoked.Company                         = Company
                    invoked.MobileSupplyChainLocation       = MobileSupplyChainLocation
                    invoked.MobileSupplyChainDeliveryTicket = MobileSupplyChainDeliveryTicket
                    invoked.MobileSupplyChainDeliveryEvent  = PrmMobileSupplyChainDeliveryEvent
                    invoked.MobileSupplyChainDeliveryUnit   = MobileSupplyChainDeliveryUnit
                    invoked.MobileSupplyChainDeliveryLine   = MobileSupplyChainDeliveryLine

                LastPerformedAction = PrmMobileSupplyChainDeliveryEvent.PerformedAction
                
                if (PrmDeliveryNoteCode entered)
                    invoke Create MobileSupplyChainDeliveryNote
                        invoked.Company                         = Company
                        invoked.MobileSupplyChainLocation       = MobileSupplyChainLocation
                        invoked.MobileSupplyChainDeliveryTicket = MobileSupplyChainDeliveryTicket
                        invoked.MobileSupplyChainDeliveryUnit   = MobileSupplyChainDeliveryUnit
                        invoked.MobileSupplyChainDeliveryLine   = MobileSupplyChainDeliveryLine
                        invoked.DeliveryNoteCode                = PrmDeliveryNoteCode
                        invoked.DeliveryNote                    = PrmDeliveryNote

        CreateAllEventLines is a Set Action
            restricted
            Parameters
                PrmMobileSupplyChainCompany         is a MobileSupplyChainCompany
                PrmMobileSupplyChainLocation        is a MobileSupplyChainLocation
                PrmMobileSupplyChainDeliveryTicket  is a MobileSupplyChainDeliveryTicket
                PrmMobileSupplyChainDeliveryEvent   is a MobileSupplyChainDeliveryEvent

            Instance Selection
                where (Company                          = PrmMobileSupplyChainCompany
                and    MobileSupplyChainLocation        = PrmMobileSupplyChainLocation
                and    MobileSupplyChainDeliveryTicket  = PrmMobileSupplyChainDeliveryTicket)

            Sort Order is primary

            Action Rules
                MobileSupplyChainDeliveryTicket Set Rules
                    Exit Rules
                        invoke Update MobileSupplyChainDeliveryTicket
                            invoked.Status = MobileSupplyChainDeliveryTicket.Status.ReadyToDeliver
                Instance Rules
                    invoke CreateEventLine
                        invoked.PrmMobileSupplyChainDeliveryEvent  = PrmMobileSupplyChainDeliveryEvent
                            

        CreateDockLogEvent is a Set Action
            restricted
            Parameters
                PrmCompany                          is a MobileSupplyChainCompany
                PrmMobileSupplyChainLocation        is a MobileSupplyChainLocation
                PrmMobileSupplyChainDeliveryTicket  is a MobileSupplyChainDeliveryTicket
            
            Instance Selection
                where (Company                          = PrmCompany
                and    MobileSupplyChainLocation        = PrmMobileSupplyChainLocation
                and    MobileSupplyChainDeliveryTicket  = PrmMobileSupplyChainDeliveryTicket)
            
            Sort Order is primary

            Local Fields
                LocalCompany                                    is a Company
                LocalMobileSupplyChainLocation                  is a MobileSupplyChainLocation
                LocalMobileSupplyChainDeliveryEvent             is like MobileSupplyChainDeliveryEvent

            Action Rules
                MobileSupplyChainDeliveryUnit Set Rules
                    Entrance Rules
                        initialize LocalMobileSupplyChainDeliveryEvent


                        if (MobileSupplyChainDeliveryUnit.OnLoadingDockDeliveryUnitRel exists)
                            LocalCompany                    = MobileSupplyChainDeliveryUnit.first OnLoadingDockDeliveryUnitRel.Company
                            LocalMobileSupplyChainLocation  = MobileSupplyChainDeliveryUnit.first OnLoadingDockDeliveryUnitRel.MobileSupplyChainLocation
                            LocalDockLogTimestamp           = MobileSupplyChainDeliveryUnit.first OnLoadingDockDeliveryUnitRel.MobileSupplyChainDeliveryTicket.create stamp
                            

                            for each MobileSupplyChainDeliveryUnit.OnLoadingDockDeliveryUnitRel
                                invoke Update each
                                    invoked.Status = MobileSupplyChainDeliveryUnit.Status.Inactive


                            if (DockLogDeliveryEventRel not exists) 
                                invoke CreateEvent PrmMobileSupplyChainDeliveryTicket
                                    invoked.PrmEventCompanyLocation.MobileSupplyChainCompany      = LocalCompany
                                    invoked.PrmEventCompanyLocation.MobileSupplyChainLocation     = LocalMobileSupplyChainLocation
                                    invoked.PrmPerformedAction                                    = PerformedAction.Docklogged
                                    invoked.PrmTimeSubmitted                                      = LocalDockLogTimestamp

                                LocalMobileSupplyChainDeliveryEvent = PrmMobileSupplyChainDeliveryTicket.TransientMobileSupplyChainDeliveryEvent
                            else

                                LocalMobileSupplyChainDeliveryEvent = first DockLogDeliveryEventRel.MobileSupplyChainDeliveryEvent

                Instance Rules
                    if (LocalMobileSupplyChainDeliveryEvent entered)
                        invoke CreateEventLine
                            invoked.PrmMobileSupplyChainDeliveryEvent  = LocalMobileSupplyChainDeliveryEvent

                        
    Relations
        MobileSupplyChainDeliveryEventLineRel
            one-to-many relation to MobileSupplyChainDeliveryEventLine
            Field Mapping uses ByDeliveryLine
                related.Company                                   = Company
                related.MobileSupplyChainLocation                 = MobileSupplyChainLocation
                related.MobileSupplyChainDeliveryTicket           = MobileSupplyChainDeliveryTicket
                related.MobileSupplyChainDeliveryUnit             = MobileSupplyChainDeliveryUnit
                related.MobileSupplyChainDeliveryLine             = MobileSupplyChainDeliveryLine

        TransferredDeliveryLineRel
            one-to-many relation to MobileSupplyChainDeliveryEventLine
            Field Mapping uses ByTimeSubmitted
                related.Company                                   = Company
                related.MobileSupplyChainLocation                 = MobileSupplyChainLocation
                related.MobileSupplyChainDeliveryTicket           = MobileSupplyChainDeliveryTicket
                related.MobileSupplyChainDeliveryUnit             = MobileSupplyChainDeliveryUnit
                related.MobileSupplyChainDeliveryLine             = MobileSupplyChainDeliveryLine
            Instance Selection
                where (related.MobileSupplyChainDeliveryEvent.PerformedAction.TransferConfirmed
                or     related.MobileSupplyChainDeliveryEvent.PerformedAction.TransferReleased)

        DockLogDeliveryEventRel
            one-to-many relation to MobileSupplyChainDeliveryEvent
            Field Mapping uses symbolic key
                related.Company                                 = MobileSupplyChainDeliveryTicket.Company
                related.MobileSupplyChainLocation               = MobileSupplyChainDeliveryTicket.MobileSupplyChainLocation
                related.MobileSupplyChainDeliveryTicket         = MobileSupplyChainDeliveryTicket
            Instance Selection
                where (related.PerformedAction                  = PerformedAction.Docklogged
                and    related.TimeSubmitted                    = LocalDockLogTimestamp)

        ItemLocationRel
            one-to-one relation to ItemLocation
            Field Mapping uses symbolic key
                related.Company                 = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainCompany
                related.InventoryLocation       = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainLocation
                related.Item                    = Item

        BinRel
            one-to-one relation to Bin
            Field Mapping uses symbolic key
                related.Company                 = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainCompany
                related.InventoryLocation       = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainLocation
                related.Bin                     = Bin
        
        MobileSupplyChainDeliveryLineDetailsRel
            one-to-many relation to MobileSupplyChainDeliveryLine
            Field Mapping uses symbolic key
                related.Company                                 = Company
                related.MobileSupplyChainLocation               = MobileSupplyChainLocation
                related.MobileSupplyChainDeliveryTicket         = MobileSupplyChainDeliveryTicket
            Instance Selection
                where (related.Item                             = Item
                and    related.OriginatingLineNumber            = OriginatingLineNumber)

        RequisitionRel
            one-to-one relation to Requisition
            Field Mapping uses symbolic key
                related.Company                 = Company
                related.Requisition             = Requisition

        WarehouseShipmentLineRel
            one-to-one relation to WarehouseShipmentLine
            Field Mapping uses symbolic key
                related.Company                         = Company
                related.InventoryLocation               = MobileSupplyChainLocation
                related.WarehouseShipment               = MobileSupplyChainDeliveryTicket.OriginatingTransaction(WarehouseShipment).WarehouseShipment
                related.WarehouseShipmentLine           = OriginatingLineNumber

        RequisitionLineRel
            one-to-one relation to RequisitionLine
            Field Mapping uses symbolic key
                related.Company                     = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainCompany
                related.Requisition                 = Requisition
                related.RequisitionLine             = OriginatingLineNumber

        RequisitionLineCommentRel
            one-to-many relation to RequisitionLineComment
            Field Mapping uses part of key
                related.Company             = MobileSupplyChainDeliveryTicket.DeliverToCompanyLocation.MobileSupplyChainCompany
                related.Requisition         = Requisition
                related.RequisitionLine     = OriginatingLineNumber

        PurchaseOrderLineDistributionRel
            one-to-many relation to PurchaseOrderLineDistribution
            Field Mapping uses symbolic key
                related.Company             = Company
                related.PurchaseOrder       = MobileSupplyChainDeliveryTicket.PurchaseOrder
                related.PurchaseOrderLine   = OriginatingLineNumber
        
        RequisitionLineDistributionRel
            one-to-many relation to RequisitionLineDistribution
            Field Mapping uses symbolic key
                related.Company             = Company
                related.Requisition         = Requisition
                related.RequisitionLine     = LocalRequisitionLine

        PurchaseOrderReceiptLineCommentRel
            one-to-many relation to PurchaseOrderReceiptLineComment
            Field Mapping uses part of key
                related.Company                     = Company
                related.PurchaseOrderReceipt        = MobileSupplyChainDeliveryTicket.DocumentNumber
                related.PurchaseOrderReceiptLine    = OriginatingLineNumber
            Instance Selection
                where (related.CommentType.PrintOnInternalDocuments
                or     related.CommentType.PrintOnDeliveryTicket)
        
        PurchaseOrderReceiptLineRel
            one-to-one relation to PurchaseOrderReceiptLine
            Field Mapping uses symbolic key
                related.Company                     = Company
                related.PurchaseOrderReceipt        = MobileSupplyChainDeliveryTicket.DocumentNumber
                related.PurchaseOrderReceiptLine    = OriginatingLineNumber

    Conditions
        IsFromPicking
            when (MobileSupplyChainDeliveryTicket.DeliveryType.Shipment)

        IsFromPOReceipt
            when (MobileSupplyChainDeliveryTicket.DeliveryType.PurchaseOrderReceipt)
        
        IsFromMiscReceipt
            when (MobileSupplyChainDeliveryTicket.DeliveryType.MiscellaneousReceipt)

        IsFromDockLog
            when (MobileSupplyChainDeliveryTicket.DeliveryType.DockLog)

        IsDelivered
            when (LastPerformedAction.DeliveryConfirmed or LastPerformedAction.DeliveryReleased)
