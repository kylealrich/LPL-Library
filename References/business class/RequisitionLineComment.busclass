RequisitionLineComment is a BusinessClass
    owned by rq
    prefix is RLCMT

    Ontology
    	part of RequisitionLine
    		delete cascades
    		relative key is SequenceNumber
  
  	Patterns
		implements StaticJava
		
    Persistent Fields
    	CommentTitle					is a CommentName
    	CommentType						is AlphaUpper size 1
    		States
                PrintOnInternalDocuments	value is "I"
                PrintOnPurchaseOrder		value is "P"
                PrintOnReceivers			value is "R"
                PrintOnPickList				value is "L"
                PrintOnDeliveryTicket		value is "D"
                PrintOnRequisition			value is "Q"
				DisplayOnlyOnInternalDocuments value is "S"
                DisplayOnly					value is "O"
                InvoiceComments				value is "N"
    	CommentText
		Attachment						is an AlternateAttachment



		
	
	Transient Fields
		TransientRequisition is like Requisition
			derive value from Requisition	
        TransientPrintOnInternalDocuments		is Boolean
        	default label is "PrintOnInternalDocuments"
        TransientPrintOnPurchaseOrder			is Boolean
        	default label is "PrintOnPurchaseOrder"
        TransientPrintOnReceivers				is Boolean
        	default label is "PrintOnReceivers"
        TransientPrintOnPickList				is Boolean
        	default label is "PrintOnPickList"
        TransientPrintOnDeliveryTicket			is Boolean
        	default label is "PrintOnDeliveryTicket"
        TransientPrintOnRequisition				is Boolean
        	default label is "PrintOnRequisition"
		TransientDisplayOnlyOnInternalDocuments	is Boolean
			default label is "DisplayOnlyOnInternalDocuments"
        TransientDisplayOnly					is Boolean
        	default label is "DisplayOnly"
        TransientInvoiceComments				is Boolean
        	default label is "InvoiceComments"

	Field Rules
		SequenceNumber
			autosequence
				minimize contention
			
		CommentType
            initial value is Requisition.DefaultCommentType
	        default to Requisition.DefaultCommentType
			required

		CommentTitle
			required
			
		TransientPrintOnInternalDocuments
			initial value is IsDefaultToPrintOnInternalDocuments
			
		TransientPrintOnPurchaseOrder
			initial value is IsDefaultToPrintOnPurchaseOrder
			
		TransientPrintOnReceivers
			initial value is IsDefaultToPrintOnReceivingDocument
			
		TransientPrintOnPickList
			initial value is IsDefaultToPrintOnPickList
			
		TransientPrintOnDeliveryTicket
			initial value is IsDefaultToPrintOnDeliveryTicket
			
		TransientPrintOnRequisition
			initial value is IsDefaultToPrintOnRequisition
		
		TransientDisplayOnlyOnInternalDocuments
			initial value is IsDefaultToDisplayOnlyOnInternalDocuments

		TransientDisplayOnly
			initial value is IsDefaultToPrintDisplayOnly
			
		TransientInvoiceComments
			initial value is IsDefaultToInvoiceComments

	Local Fields
		LocalCommentType	is like CommentType
		LocalAttributeCtr   is Numeric 2
		
	Derived Fields
		DerivedInitialCommentType	is a DerivedField
			type is like CommentType
			restricted
			if (CommentType entered)
				if (CommentType != Requisition.DefaultCommentType.PrintOnPurchaseOrderTrailer)
					return CommentType
				else
	    			return CommentType.PrintOnRequisition				
			else
			if (TransientPrintOnInternalDocuments)
				return CommentType.PrintOnInternalDocuments
			else
    		if (TransientPrintOnPurchaseOrder)
    			return CommentType.PrintOnPurchaseOrder
    		else
    		if (TransientPrintOnReceivers)
    			return CommentType.PrintOnReceivers
    		else
    		if (TransientPrintOnPickList)
    			return CommentType.PrintOnPickList
    		else
    		if (TransientPrintOnDeliveryTicket)
    			return CommentType.PrintOnDeliveryTicket
    		else
    		if (TransientPrintOnRequisition)
    			return CommentType.PrintOnRequisition
    		else
			if (TransientDisplayOnlyOnInternalDocuments)
    			return CommentType.DisplayOnlyOnInternalDocuments
    		else
    		if (TransientDisplayOnly)
    			return CommentType.DisplayOnly
    		else
    		if (TransientInvoiceComments)
    			return CommentType.InvoiceComments
			
		CommentTextNoFormatting	is a DerivedField
			type is Text
			return CommentText plain text
		
		CommentTitleMessage is a MessageField
			"Requisition_Comment"
    			
	Rule Blocks
		CreateComment    				
			invoke SystemCreate RequisitionLineComment
				invoked.Company				= Company
				invoked.Requisition			= Requisition
				invoked.RequisitionLine		= RequisitionLine
				invoked.CommentTitle		= CommentTitle
				invoked.CommentType			= LocalCommentType
				invoked.CommentText			= CommentText
				invoked.Attachment.File		= Attachment.File
				invoked.Attachment.MimeType	= Attachment.MimeType
				invoked.Attachment.Title	= Attachment.Title
	Relations
		RequesterRel
            one-to-one relation to Requester
            Field Mapping uses symbolic key
            	related.HROrganization = actor.agent(Employee).HROrganization
                related.Requester = actor.agent(Employee).Employee.Requester.Requester

    Conditions
    	IsCommentTypeSelected
    		restricted
    		when (TransientPrintOnInternalDocuments
    		or    TransientPrintOnPurchaseOrder
    		or    TransientPrintOnReceivers
    		or    TransientPrintOnPickList
    		or    TransientPrintOnDeliveryTicket
    		or    TransientPrintOnRequisition
			or	  TransientDisplayOnlyOnInternalDocuments
    		or    TransientDisplayOnly
    		or    TransientInvoiceComments)
    
    	HasAttachment
    		restricted
    		when (Attachment entered)
    		
    	IsDefaultToPrintOnInternalDocuments
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnInternalDocuments)
    		
    	IsDefaultToPrintOnPurchaseOrder
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnPurchaseOrder)
    		
    	IsDefaultToPrintOnReceivingDocument
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnReceivingDocument)
    		
    	IsDefaultToPrintOnPickList	
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnPickList)
    		
    	IsDefaultToPrintOnDeliveryTicket
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnDeliveryTicket)
    		
    	IsDefaultToPrintOnRequisition
    		restricted
    		when (Requisition.DefaultCommentType.PrintOnRequisition)
    	
		IsDefaultToDisplayOnlyOnInternalDocuments
			restricted
    		when (Requisition.DefaultCommentType.DisplayOnlyOnInternalDocuments)

    	IsDefaultToPrintDisplayOnly
    		restricted
    		when (Requisition.DefaultCommentType.DisplayOnly)
    		
    	IsDefaultToInvoiceComments
    		restricted
    		when (Requisition.DefaultCommentType.InvoiceComments)    		
    		
		DisplayAllowAllCommentTypes
			restricted 
			when (RequesterRel.DisplayAllowAllCommentTypes)
    		
	Sets
  		ByCommentType
  			Sort Order
  				Company	
  				Requisition
  				RequisitionLine
				CommentType
				SequenceNumber

	Create Rules  
		include IDM.CreateRules 
			replace AttachmentField with Attachment
							
	Delete Rules
		include IDM.DeleteNoArchiveRules
			replace AttachmentField with Attachment

	Commit Rules
		include IDM.CommitRules
			replace AttachmentField with Attachment

	Actions
		SystemCreate is a Create Action
			restricted
	
		Create is a Create Action
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)
			Action Rules
				if (CommentType not entered)
					constraint (TransientRequisition not entered  
					or          IsCommentTypeSelected)
						"CommentTypeIsRequired"	
				else
					constraint (not IsCommentTypeSelected)
						"CannotEnterBothCommentTypeAndTransientCommentTypes"			
				
				invoke SystemCreate this instance
					invoked.CommentType	= DerivedInitialCommentType
									
			Exit Rules
				initialize LocalCommentType
				if (TransientPrintOnInternalDocuments
				and not CommentType.PrintOnInternalDocuments)
					LocalCommentType = CommentType.PrintOnInternalDocuments
					include CreateComment
						
				if (TransientPrintOnPurchaseOrder
				and not CommentType.PrintOnPurchaseOrder)
					LocalCommentType = CommentType.PrintOnPurchaseOrder
					include CreateComment											

				if (TransientPrintOnReceivers
				and not CommentType.PrintOnReceivers)
					LocalCommentType = CommentType.PrintOnReceivers
					include CreateComment
						
				if (TransientPrintOnPickList
				and not CommentType.PrintOnPickList)
					LocalCommentType = CommentType.PrintOnPickList
					include CreateComment
						
				if (TransientPrintOnDeliveryTicket
				and not CommentType.PrintOnDeliveryTicket)
					LocalCommentType = CommentType.PrintOnDeliveryTicket
					include CreateComment
						
				if (TransientPrintOnRequisition
				and not CommentType.PrintOnRequisition)
					LocalCommentType = CommentType.PrintOnRequisition
					include CreateComment

				if (TransientDisplayOnlyOnInternalDocuments
				and not CommentType.DisplayOnlyOnInternalDocuments)
					LocalCommentType = CommentType.DisplayOnlyOnInternalDocuments
					include CreateComment

				if (TransientDisplayOnly
				and not CommentType.DisplayOnly)
					LocalCommentType = CommentType.DisplayOnly
					include CreateComment
						
				if (TransientInvoiceComments
				and not CommentType.InvoiceComments)
					LocalCommentType = CommentType.InvoiceComments
					include CreateComment			
			
		CreateAttachment is a Create Action
			default label is "CreateAttachment(s)"
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)
			Action Rules
				if (CommentType not entered)
					constraint (TransientRequisition not entered  
					or          IsCommentTypeSelected)
						"CommentTypeIsRequired"	
				else
					constraint (not IsCommentTypeSelected)
						"CannotEnterBothCommentTypeAndTransientCommentTypes"			
				
				if (CommentTitle not entered
				and Attachment entered)
					CommentTitle = Attachment.Title

				invoke SystemCreate this instance
					invoked.CommentType	= DerivedInitialCommentType
									
			Exit Rules
				initialize LocalCommentType
				if (TransientPrintOnInternalDocuments
				and not CommentType.PrintOnInternalDocuments)
					LocalCommentType = CommentType.PrintOnInternalDocuments
					include CreateComment
						
				if (TransientPrintOnPurchaseOrder
				and not CommentType.PrintOnPurchaseOrder)
					LocalCommentType = CommentType.PrintOnPurchaseOrder
					include CreateComment											

				if (TransientPrintOnReceivers
				and not CommentType.PrintOnReceivers)
					LocalCommentType = CommentType.PrintOnReceivers
					include CreateComment
						
				if (TransientPrintOnPickList
				and not CommentType.PrintOnPickList)
					LocalCommentType = CommentType.PrintOnPickList
					include CreateComment
						
				if (TransientPrintOnDeliveryTicket
				and not CommentType.PrintOnDeliveryTicket)
					LocalCommentType = CommentType.PrintOnDeliveryTicket
					include CreateComment
						
				if (TransientPrintOnRequisition
				and not CommentType.PrintOnRequisition)
					LocalCommentType = CommentType.PrintOnRequisition
					include CreateComment
				
				if (TransientDisplayOnlyOnInternalDocuments
				and not CommentType.DisplayOnlyOnInternalDocuments)
					LocalCommentType = CommentType.DisplayOnlyOnInternalDocuments
					include CreateComment

				if (TransientDisplayOnly
				and not CommentType.DisplayOnly)
					LocalCommentType = CommentType.DisplayOnly
					include CreateComment
						
				if (TransientInvoiceComments
				and not CommentType.InvoiceComments)
					LocalCommentType = CommentType.InvoiceComments
					include CreateComment			

		RSSLPLCreate is a Create Action
			default label is "CreateComment"
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)
			Entrance Rules
				if (CommentType not entered
				and not IsCommentTypeSelected
				and not DisplayAllowAllCommentTypes)
					CommentType = CommentType.PrintOnRequisition
			Action Rules
				invoke Create this instance

		RSSLPLCreateAttachment is a Create Action
			default label is "CreateAttachment(s)"
			valid when (Requisition.AllowCreateUpdateDeleteComments)
			Entrance Rules
				if (CommentType not entered
				and not IsCommentTypeSelected
				and not DisplayAllowAllCommentTypes)
					CommentType = CommentType.PrintOnRequisition
			Action Rules
				if (CommentType not entered)
					constraint (TransientRequisition not entered  
					or          IsCommentTypeSelected)
						"CommentTypeIsRequired"	
				else
					constraint (not IsCommentTypeSelected)
						"CannotEnterBothCommentTypeAndTransientCommentTypes"			
				
				if (CommentTitle not entered
				and Attachment entered)
					CommentTitle = Attachment.Title

				invoke SystemCreate this instance
					invoked.CommentType	= DerivedInitialCommentType
									
			Exit Rules
				initialize LocalCommentType
				if (TransientPrintOnInternalDocuments
				and not CommentType.PrintOnInternalDocuments)
					LocalCommentType = CommentType.PrintOnInternalDocuments
					include CreateComment
						
				if (TransientPrintOnPurchaseOrder
				and not CommentType.PrintOnPurchaseOrder)
					LocalCommentType = CommentType.PrintOnPurchaseOrder
					include CreateComment											

				if (TransientPrintOnReceivers
				and not CommentType.PrintOnReceivers)
					LocalCommentType = CommentType.PrintOnReceivers
					include CreateComment
						
				if (TransientPrintOnPickList
				and not CommentType.PrintOnPickList)
					LocalCommentType = CommentType.PrintOnPickList
					include CreateComment
						
				if (TransientPrintOnDeliveryTicket
				and not CommentType.PrintOnDeliveryTicket)
					LocalCommentType = CommentType.PrintOnDeliveryTicket
					include CreateComment
						
				if (TransientPrintOnRequisition
				and not CommentType.PrintOnRequisition)
					LocalCommentType = CommentType.PrintOnRequisition
					include CreateComment
				
				if (TransientDisplayOnlyOnInternalDocuments
				and not CommentType.DisplayOnlyOnInternalDocuments)
					LocalCommentType = CommentType.DisplayOnlyOnInternalDocuments
					include CreateComment
						
				if (TransientDisplayOnly
				and not CommentType.DisplayOnly)
					LocalCommentType = CommentType.DisplayOnly
					include CreateComment
						
				if (TransientInvoiceComments
				and not CommentType.InvoiceComments)
					LocalCommentType = CommentType.InvoiceComments
					include CreateComment	

		Update is an Update Action
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)

		ModalUpdate is an Update Action
			default label is "Update"
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)
		
		Delete is a Delete Action
			valid when (RequisitionLine.AllowCreateUpdateDeleteLineComments)

		Purge is a Purge Action
			restricted

		UploadToIDM is an Instance Action  
			valid when (Attachment.ValidForIDMUpload)
			Action Rules
				include IDM.MoveAttachmentsToIDM
					replace AttachmentField   with Attachment	
						
									
		MoveAttachmentsToIDM is a Set Action
			restricted
			Instance Selection
				where (Attachment.IsLocal)

			Accumulators
				InstanceCount

			Action Rules
				Instance Rules
					increment InstanceCount	

					include IDM.MoveAttachmentsToIDM
						replace AttachmentField   with Attachment			

					commit transaction

					if (InstanceCount = config.IDM_MOVE_ATTACHMENTS_LIMIT)
						end set action instance loop
		
