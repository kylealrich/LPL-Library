AccountingUnitHierarchy is a BusinessClass
	owned by GeneralLedger
	
	prefix is AcUHy
	
	Ontology
		symbolic key is AccountingUnitHierarchy
		
	Patterns
           	  
	Context Fields
		ReportingBasis

    Persistent Fields
    	ParentNodeGroup					is an AccountingUnitTopNodeGroup
    	DisplayAccountingUnit			is Alpha 60 
		AccountingUnitType
    	SystemAccountingUnit			is Boolean
    	IsAZoneAccountingUnit			is Boolean
    	ZoneAccountingUnit				is an AccountingUnit
    	EntityZoneAccountingUnit		is Boolean
    	DefaultZoneAccountingUnit		is Boolean		
    	IncludeInBudgetEdit				is Boolean
    	InterEntityAccountingUnit		is Boolean
    	
    Transient Fields
		StructureAccountingUnitNew		is Numeric 1
			derive value from StructureAccountingUnitExists
		RetainDefaultValues 			is Boolean

	Rule Blocks

		FindParent
			if (LocalAccountingUnit.Level < LocalLevel)
				LocalAccountingUnit	= AccountingUnit
			else
				while (LocalAccountingUnit.Level > LocalLevel)
					LocalAccountingUnit				= LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode

		FindParentLevel1
			if (!LocalParentLevel1Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 1
				include FindParent
				LocalParentLevel1Found 	= true

		FindParentLevel2
			if (!LocalParentLevel2Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 2
				include FindParent
				LocalParentLevel2Found 	= true

		FindParentLevel3
			if (!LocalParentLevel3Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 3
				include FindParent
				LocalParentLevel3Found 	= true

		FindParentLevel4
			if (!LocalParentLevel4Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 4
				include FindParent
				LocalParentLevel4Found 	= true

		FindParentLevel5
			if (!LocalParentLevel5Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 5
				include FindParent
				LocalParentLevel5Found 	= true

		FindParentLevel6
			if (!LocalParentLevel6Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 6
				include FindParent
				LocalParentLevel6Found 	= true

		FindParentLevel7
			if (!LocalParentLevel7Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 7
				include FindParent
				LocalParentLevel7Found 	= true

		FindParentLevel8
			if (!LocalParentLevel8Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 8
				include FindParent
				LocalParentLevel8Found 	= true

		FindParentLevel9
			if (!LocalParentLevel9Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 9
				include FindParent
				LocalParentLevel9Found 	= true

		FindParentLevel10
			if (!LocalParentLevel10Found
			or	LocalLevel != LocalLastLevel)
				LocalLastLevel			= LocalLevel
				LocalAccountingUnit		= FirstParentRel.AccountingUnit
				LocalLevel				= 10
				include FindParent
				LocalParentLevel10Found	= true

	Derived Fields
		StructureAccountingUnitExists	is a DerivedField
			type is Boolean
			restricted
			if (this instance exists)
				return true

		DerivedOldPrefix	is a StringField
			type is AlphaUpper 25
			restricted
			LocalOldStructureSequence
			"_"
			
		DerivedNewPrefix    is a StringField
			type is AlphaUpper 25
			restricted
			LocalNewStructureSequence
			"_"
			
		DerivedNewAccountingUnit   is a DerivedField
			type is AlphaUpper 25
			restricted
			I1 = DerivedOldPrefix size
			I1 += 1
			DerivedNewAccountingUnit = DerivedNewPrefix + LocalCopyAccountingUnit[I1:25]
  
      	DerivedEntityNode   is a StringField
    		type is AlphaUpper 25
    		restricted
    		AccountingUnitStructure.StructureSequence
 			"_"
			AccountingEntity
			"_ENTITY"   	

		IsAPostingZoneAccountingUnit	is a DerivedField
			type is Boolean
			restricted
			if  (AccountingUnit			= ZoneAccountingUnit
			and  AccountingUnitType.Posting)
				return true

		DerivedLevel1Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel1Found	= false
			include FindParentLevel1
			return LocalAccountingUnit
		
		DerivedLevel1ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel1
			return LocalAccountingUnit.Description
			
		DerivedLevel1ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel1
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel2Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel2Found	= false
			include FindParentLevel2
			return LocalAccountingUnit
		
		DerivedLevel2ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel2
			return LocalAccountingUnit.Description
			
		DerivedLevel2ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel2
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel3Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel3Found	= false
			include FindParentLevel3
			return LocalAccountingUnit
		
		DerivedLevel3ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel3
			return LocalAccountingUnit.Description
			
		DerivedLevel3ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel3
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel4Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel4Found	= false
			include FindParentLevel4
			return LocalAccountingUnit
		
		DerivedLevel4ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel4
			return LocalAccountingUnit.Description
			
		DerivedLevel4ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel4
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel5Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel5Found	= false
			include FindParentLevel5
			return LocalAccountingUnit
		
		DerivedLevel5ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel5
			return LocalAccountingUnit.Description
			
		DerivedLevel5ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel5
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel6Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel6Found	= false
			include FindParentLevel6
			return LocalAccountingUnit
		
		DerivedLevel6ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel6
			return LocalAccountingUnit.Description
			
		DerivedLevel6ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel6
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel7Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel7Found	= false
			include FindParentLevel7
			return LocalAccountingUnit
		
		DerivedLevel7ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel7
			return LocalAccountingUnit.Description
			
		DerivedLevel7ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel7
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel8Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel8Found	= false
			include FindParentLevel8
			return LocalAccountingUnit
		
		DerivedLevel8ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel8
			return LocalAccountingUnit.Description
			
		DerivedLevel8ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel8
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel9Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel9Found	= false
			include FindParentLevel9
			return LocalAccountingUnit
		
		DerivedLevel9ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel9
			return LocalAccountingUnit.Description
			
		DerivedLevel9ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel9
			return LocalAccountingUnit.AccountingUnitType

		DerivedLevel10Parent is a DerivedField
			type is like AccountingUnit
			LocalParentLevel10Found	= false
			include FindParentLevel10
			return LocalAccountingUnit
		
		DerivedLevel10ParentDescription is a DerivedField
			type is like Description
			include FindParentLevel10
			return LocalAccountingUnit.Description
			
		DerivedLevel10ParentDimensionType is a DerivedField
			type is like AccountingUnitType
			include FindParentLevel10
			return LocalAccountingUnit.AccountingUnitType

	Local Fields
		LocalReportingBasis			is a ReportingBasis
		LocalCopyAccountingUnit		is an AccountingUnit
		LocalNewAccountingUnit      is an AccountingUnit
		LocalNewStructureSequence   is Numeric 4
		LocalOldStructureSequence   is Numeric 4		
		LocalParentAccountingUnitGroup is an AccountingUnitTopNodeGroup 
		I1					    	is Numeric 2
		LocalAccountingUnit			is an AccountingUnit
		LocalLevel					is Numeric 3
		TopNodeFound				is Boolean
		LocalEntityGroup			is like AccountingEntityGroup
		LocalSummaryEntity			is like AccountingEntity		
		LocalSummaryAccountingUnit  is like AccountingUnit
		TemplatesWithIncludeInBudgetEditCount						is Numeric 6
		LocalLastLevel				is Numeric 3
		LocalParentLevel1Found		is Boolean
		LocalParentLevel2Found		is Boolean
		LocalParentLevel3Found		is Boolean
		LocalParentLevel4Found		is Boolean
		LocalParentLevel5Found		is Boolean
		LocalParentLevel6Found		is Boolean
		LocalParentLevel7Found		is Boolean
		LocalParentLevel8Found		is Boolean
		LocalParentLevel9Found		is Boolean
		LocalParentLevel10Found		is Boolean
		LocalParentDisplayOrder		is Numeric 6
				
	Conditions
		NotUsedInAStructure
			restricted
			when (AccountingUnit.AccountingUnitType.Posting
			and   !AccountingUnitInOtherStructureRel exists)

		
	Sets
		ByParentAccountingUnit
			Sort Order
				FinanceEnterpriseGroup
				ParentNodeGroup.DimensionEntity
				ParentNodeGroup.DimensionNode
				AccountingEntity
				AccountingUnit
		BySubordinateAccountingUnit
			Sort Order
				FinanceEnterpriseGroup
				AccountingEntity				
				AccountingUnit
				ParentNodeGroup.DimensionEntity
				ParentNodeGroup.DimensionNode








		ChildrenInStructure
			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				ParentNodeGroup.DimensionEntity			
				ParentNodeGroup.DimensionNode
				AccountingEntity
				AccountingUnit
		BySystemAccountingUnitInStructure
			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				AccountingEntity
			Instance Selection
				where (SystemAccountingUnit)
		ByDefaultZoneAccountingUnitInStructure
			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				AccountingEntity				
			Instance Selection
				where (DefaultZoneAccountingUnit)
		ByEntityZoneAccountingUnitInStructure
			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				AccountingEntity				
			Instance Selection
				where (EntityZoneAccountingUnit)
		ByInterEntityAccountingUnitInStructure
			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				AccountingEntity
			Instance Selection
				where (InterEntityAccountingUnit)

	Relations















		NotifyBudgetTemplateRel
			one-to-many relation to BudgetTemplate
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup         = FinanceEnterpriseGroup
			Instance Selection
				where (related.NotifyOnAccountingUnit
				and    related.AccountingUnitStructure = AccountingUnitStructure)

		TemplatesWithIncludeInBudgetEditRel
			one-to-many relation to BudgetTemplate
			Field Mapping uses ByStatus
				related.FinanceEnterpriseGroup    	= FinanceEnterpriseGroup 
				related.Status 						= 2 
			Instance Selection
				where (related.PostingAccountingUnit
				and related.AccountingUnitStructure	= AccountingUnitStructure)

    	ParentNodeAccountingUnitRel
    		one-to-one relation to AccountingUnit
    		Field Mapping uses symbolic key
    			related.FinanceEnterpriseGroup 	= FinanceEnterpriseGroup
    			related.AccountingEntity		= ParentNodeGroup.DimensionEntity
    			related.AccountingUnit  		= ParentNodeGroup.DimensionNode

		LocalAccountingUnitHierarchyRel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup			 = FinanceEnterpriseGroup
				related.AccountingUnitStructure			 = AccountingUnitStructure
				related.AccountingEntity				 = AccountingEntity
				related.AccountingUnit					 = LocalAccountingUnit

		AccountingUnitShadowRel
			one-to-many relation to AccountingUnitShadow
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.AccountingUnitStructure		= AccountingUnitStructure
				related.AccountingEntity			= AccountingEntity
				related.AccountingUnit				= AccountingUnit

		AccountingUnitShadowOTORel
			one-to-one relation to AccountingUnitShadow
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.AccountingUnitStructure		= AccountingUnitStructure
				related.AccountingEntity			= AccountingEntity
				related.AccountingUnit				= AccountingUnit
				related.SummaryEntity				= LocalSummaryEntity   
            	related.SummaryAccountingUnit		= LocalSummaryAccountingUnit
				
		MemberOfUnusedStructureRel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup		= FinanceEnterpriseGroup
				related.AccountingUnitStructure		= FinanceEnterpriseGroup.UnusedAUStructure
				related.AccountingEntity			= AccountingEntity
				related.AccountingUnit				= AccountingUnit
		
		AccountingEntityGroupMemberRel
			one-to-one relation to AccountingEntityGroupMember
			Field Mapping uses part of key
				related.FinanceEnterpriseGroup 		= FinanceEnterpriseGroup
				related.AccountingEntityGroup		= LocalEntityGroup
				related.AccountingEntity			= AccountingEntity
	
		AccountingUnitInOtherStructureRel
			one-to-many relation to AccountingUnitHierarchy
			Field Mapping uses BySubordinateAccountingUnit
				related.FinanceEnterpriseGroup 		= FinanceEnterpriseGroup
				related.AccountingEntity			= AccountingEntity
				related.AccountingUnit				= AccountingUnit
			Instance Selection
				where (related.AccountingUnitStructure != AccountingUnitStructure)


		FirstParentRel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = ParentNodeGroup.DimensionNode
		NextParent1Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = FirstParentRel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = FirstParentRel.ParentNodeGroup.DimensionNode
		NextParent2Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent1Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent1Rel.ParentNodeGroup.DimensionNode
		NextParent3Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent2Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent2Rel.ParentNodeGroup.DimensionNode
		NextParent4Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent3Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent3Rel.ParentNodeGroup.DimensionNode
		NextParent5Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent4Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent4Rel.ParentNodeGroup.DimensionNode
		NextParent6Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent5Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent5Rel.ParentNodeGroup.DimensionNode
		NextParent7Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent6Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent6Rel.ParentNodeGroup.DimensionNode
		NextParent8Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent7Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent7Rel.ParentNodeGroup.DimensionNode
		NextParent9Rel
			one-to-one relation to AccountingUnitHierarchy
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup  = FinanceEnterpriseGroup
				related.AccountingUnitStructure = AccountingUnitStructure
				related.AccountingEntity        = NextParent8Rel.ParentNodeGroup.DimensionEntity
				related.AccountingUnit          = NextParent8Rel.ParentNodeGroup.DimensionNode

	Field Rules
		DisplayAccountingUnit
			default to AccountingUnit.DisplayAccountingUnit
 		AccountingUnitType
 			AccountingUnitType = AccountingUnit.AccountingUnitType
 		IncludeInBudgetEdit
 			if (IncludeInBudgetEdit changed)
				if (!ParentNodeGroup.DimensionNode like "*TOP_NODE") 
	 				invoke NotifyChangeIncludeAccountingUnit NotifyBudgetTemplateRel
						invoked.PrmAccountingEntity     = AccountingEntity
						invoked.PrmAccountingUnit       = AccountingUnit
						invoked.PrmParentAccountingUnit = ParentNodeGroup.DimensionNode
 
 	Action Exit Rules
 		if ((action = "Create"
 		or   action = "CreateNoRules"
 		or   action = "Delete")
 		or  (action = "Update"
 		and  ParentNodeGroup.DimensionNode != old ParentNodeGroup.DimensionNode))
	 		if (AccountingUnitStructure.SecurityGroupsNotRequiringRebuildRel exists)
 				invoke SetRequiresRebuild AccountingUnitStructure.SecurityGroupsNotRequiringRebuildRel 
 						
    Actions
		Create is a Create Action
			restricted
			Action Rules
			Exit Rules
				if (!ParentNodeGroup.DimensionNode like "*TOP_NODE") 
					invoke NotifyCreateAccountingUnit NotifyBudgetTemplateRel
						invoked.PrmAccountingEntity     = AccountingEntity
						invoked.PrmAccountingUnit       = AccountingUnit
						invoked.PrmParentAccountingUnit = ParentNodeGroup.DimensionNode
				
				if (!AccountingUnitStructure.UnusedDimensionStructure)
					if (MemberOfUnusedStructureRel exists)
						invoke RemoveAccountingUnitFromUnusedStructure FinanceEnterpriseGroup.UnusedAUStructure
							invoked.PrmAccountingEntity	 = AccountingEntity
							invoked.PrmAccountingUnit	 = AccountingUnit
	
		CreateNoRules is a Create Action
			restricted
			bypass field rules
				
		Update is an Update Action
			restricted
			Entrance Rules
				if (IncludeInBudgetEdit changed)
					if (not IncludeInBudgetEdit
					and TemplatesWithIncludeInBudgetEditRel exists) 
						TemplatesWithIncludeInBudgetEditCount		= instance count of TemplatesWithIncludeInBudgetEditRel
						if (TemplatesWithIncludeInBudgetEditCount	= 1)
							confirmation required
								"BudgetTemplate<first TemplatesWithIncludeInBudgetEditRel.BudgetTemplate>UsesPosting<DisplayAccountingUnit>.Proceed?"
						else
						if (TemplatesWithIncludeInBudgetEditCount >  1)
							TemplatesWithIncludeInBudgetEditCount -= 1
							if (TemplatesWithIncludeInBudgetEditCount	= 1)
								confirmation required
									"BudgetTemplate<first TemplatesWithIncludeInBudgetEditRel.BudgetTemplate>And<last TemplatesWithIncludeInBudgetEditRel.BudgetTemplate>UsePosting<DisplayAccountingUnit>.Proceed?"
							else
								confirmation required
									"BudgetTemplate<first TemplatesWithIncludeInBudgetEditRel.BudgetTemplate>And<TemplatesWithIncludeInBudgetEditCount>OtherTemplatesUsePosting<DisplayAccountingUnit>.Proceed?"
			
			Action Rules
			Exit Rules	
				if (AccountingUnit.AccountingUnitType.Summary)
					for each AccountingUnit.NextLevelChildRecordsRel
						invoke UpdateAccountingUnitHierarchy each.AccountingUnit.AccountingUnitInContextStructureRel 
							invoked.PrmZoneAccountingUnit = ZoneAccountingUnit				

		UpdateAccountingUnitHierarchy is an Instance Action
			restricted
			Parameters
				PrmZoneAccountingUnit		is a AccountingUnit
					default label is "ZoneAccountingUnit"

			Action Rules
				ZoneAccountingUnit			= PrmZoneAccountingUnit

				if (AccountingUnit.AccountingUnitType.Summary)
					invoke UpdateAccountingUnit AccountingUnit
						invoked.PrmZoneAccountingUnit		= ZoneAccountingUnit

		Delete is a Delete Action
			restricted
			Exit Rules
				if (AccountingUnitStructure != FinanceEnterpriseGroup.UnusedAUStructure
				and NotUsedInAStructure)
					invoke AddAccountingUnitToUnusedStructure FinanceEnterpriseGroup.UnusedAUStructure
						invoked.PrmAccountingEntity = AccountingEntity
						invoked.PrmAccountingUnit   = AccountingUnit				

		DeleteAllInStructure	is a Set Action
			restricted
			Parameters
				PrmFinanceEnterpriseGroup	is a FinanceEnterpriseGroup
				PrmAccountingUnitStructure	is a AccountingUnitStructure
			Instance Selection
				where(FinanceEnterpriseGroup = PrmFinanceEnterpriseGroup
				and	AccountingUnitStructure = PrmAccountingUnitStructure)
			Action Rules
				Empty Set Rules	
					invoke DeleteStructure PrmAccountingUnitStructure
				Set Rules
                	Exit Rules
						invoke DeleteStructure PrmAccountingUnitStructure
				Instance Rules
					invoke Delete

		CopyAccountingUnits is a Set Action
			restricted
			Parameters
				PrmFinanceEnterpriseGroup		is a FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmStructure					is a AccountingUnitStructure
					default label is "Structure"
				PrmNewStructure					is a AccountingUnitStructure
					default label is "NewStructure"

			Instance Selection
				where (FinanceEnterpriseGroup	= PrmFinanceEnterpriseGroup
				and    AccountingUnitStructure  = PrmStructure)

			Sort Order
				FinanceEnterpriseGroup
				AccountingUnitStructure
				AccountingEntity
				AccountingUnit

			Local Fields
				LocalSequence					is Numeric 7
				
			Action Rules

				Instance Rules
					LocalOldStructureSequence      = PrmStructure.StructureSequence
					LocalNewStructureSequence      = PrmNewStructure.StructureSequence				
					LocalCopyAccountingUnit		   = ParentNodeGroup.DimensionNode
					LocalParentAccountingUnitGroup = ParentNodeGroup
					if (LocalParentAccountingUnitGroup.DimensionNode.AccountingUnitType.Node)
						LocalParentAccountingUnitGroup               = PrmNewStructure.AccountingUnitTopNodeGroup
					else
						LocalParentAccountingUnitGroup.DimensionNode = DerivedNewAccountingUnit											
					if (!AccountingUnit.AccountingUnitType.Posting)
						LocalCopyAccountingUnit   = AccountingUnit
						LocalNewAccountingUnit    = DerivedNewAccountingUnit
						if (!LocalNewAccountingUnit exists)
							increment FinanceEnterpriseGroup.AccountingUnitLastSeq
							LocalSequence		  = FinanceEnterpriseGroup.AccountingUnitLastSeq						
							invoke CreateNoRules AccountingUnit
								fill in fields from LocalCopyAccountingUnit
								invoked.AccountingUnit          = LocalNewAccountingUnit
								invoked.DimensionStructure 	    = PrmNewStructure
								invoked.ParentAccountingUnit 	= LocalParentAccountingUnitGroup.DimensionNode
								invoked.SequenceNumber 			= LocalSequence
					else
						LocalNewAccountingUnit       = AccountingUnit
							
					invoke CreateNoRules
						fill in fields from this instance
						invoked.AccountingUnitStructure	= PrmNewStructure
						invoked.ParentNodeGroup	 		= LocalParentAccountingUnitGroup
						invoked.AccountingUnit		    = LocalNewAccountingUnit

		BuildShadowFile is a Set Action
			restricted
			
			Parameters
				PrmFinanceEnterpriseGroup		is a FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmAccountingUnitStructure		is an AccountingUnitStructure
					default label is "AccountingUnitStructure"
				PrmAccountingEntity				is an AccountingEntity
					default label is "AccountingEntity"
				PrmAccountingUnit				is an AccountingUnit
					default label is "AccountingUnit"
				
			Instance Selection
				where (FinanceEnterpriseGroup  = PrmFinanceEnterpriseGroup
				and    AccountingUnitStructure = PrmAccountingUnitStructure
				and  ((PrmAccountingUnit entered
				and    AccountingEntity = PrmAccountingEntity
				and    AccountingUnit   = PrmAccountingUnit)
				or   (!PrmAccountingUnit entered
				and   !AccountingUnitType.Node)))

			Action Rules
			
				Set Rules
						
				Instance Rules
					LocalAccountingUnit			= AccountingUnit
					TopNodeFound   		  	    = false
					if (PrmAccountingUnit entered)
						invoke Delete AccountingUnitShadowRel
					while (!TopNodeFound)
						invoke Create AccountingUnitShadow
							invoked.FinanceEnterpriseGroup 	  	= FinanceEnterpriseGroup
							invoked.AccountingUnitStructure 	= AccountingUnitStructure
							invoked.AccountingEntity			= AccountingEntity
							invoked.AccountingUnit		  		= AccountingUnit
							invoked.AccountingUnitType			= AccountingUnitType
							invoked.SummaryEntity			    = LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionEntity
							invoked.SummaryAccountingUnit	    = LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode
						if (LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode.AccountingUnitType.Node)
							TopNodeFound = true
						else
							LocalAccountingUnit = LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode		
					if (AccountingUnitType.Summary)
						invoke SetLevel
			
		SetLevel is an Instance Action
			restricted
			
			Action Rules	
				LocalLevel = 0
				if (AccountingUnitType.Summary)
					LocalAccountingUnit 	= AccountingUnit
					LocalLevel		        = 0
					while (LocalAccountingUnit.AccountingUnitType.Summary)
						LocalAccountingUnit	= LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode
						LocalLevel			+= 1
						
				invoke UpdateLevel AccountingUnit
					invoked.PrmLevel 		 	      = LocalLevel
					invoked.PrmParentAccountingUnit   = LocalAccountingUnitHierarchyRel.ParentNodeGroup.DimensionNode	

		ExportToUpload is a Set Action
			restricted
			
			Parameters
				PrmFinanceEnterpriseGroup is a FinanceEnterpriseGroup
					default label is "FinanceEnterpriseGroup"
				PrmAccountingUnitStructure is an AccountingUnitStructure
					default label is "AccountingUnitStructure"
				PrmRunGroup				 is AlphaUpper 30
					default label is "RunGroup"					
				PrmAccountingUnitGroup   is an AccountingUnit group
					default label is "CustomGroup"		
	    				
	    	Instance Selection
	    		where (FinanceEnterpriseGroup  = PrmFinanceEnterpriseGroup
	    		and	   AccountingUnitStructure = PrmAccountingUnitStructure
	    		and   (!AccountingUnitType.Entity)
	    		and	  (!AccountingUnitType.Node)
	    		and	   AccountingUnit within PrmAccountingUnitGroup)
	    		
	    	Action Rules
	    	
	    		Instance Rules
	    		
    				invoke ExportToUpload AccountingUnit
						invoked.PrmFinanceEnterpriseGroup		 = PrmFinanceEnterpriseGroup
						invoked.PrmAccountingUnitStructure		 = PrmAccountingUnitStructure
    					invoked.PrmRunGroup 	    = PrmRunGroup
    					invoked.PrmSingleRecordOnly = true
    					
#ifdef module reconciliation     					
    	CreateReconciliationAccounts is a Set Action
			restricted
			Parameters
				PrmChartAccountRule		 		  is a GeneralLedgerChartAccount group
				PrmReconcileFrequency			  is a ReconcileFrequency
				PrmPeriodWithinQuarter			  is a PeriodWithinQuarter
				PrmAccountType					  is a ReconciliationAccountType
				PrmCashManagementAccount		  is a CashManagementAccount
				PrmReconciliationAccountGroup	  is a ReconciliationAccountGroup
				PrmRisk							  is Numeric 1
					States
						Low			value is 0
						Medium		value is 1
						High		value is 2
				PrmPriority						  is Numeric 1
					States
						Low			value is 0
						Medium		value is 1
						High		value is 2
				PrmCloseTask					  is a CloseTask
				PrmFinanceTeam					  is a FinanceTeam
				PrmFinanceTeamMember			  is a FinanceTeamMember
				PrmRequiresApproval				  is Boolean
				PrmApprovalCode					  is an ApprovalCode
				PrmRequireSupportingDoco		  is Boolean
				PrmReconciliationPolicy			  is a ReconciliationPolicy
				PrmReconciliationManagementGroup  is a ReconciliationManagementGroup
				PrmReportingChart 				  is a ReportingChart
	    		PrmReconciliationAccountStructure is a ReconciliationAccountStructure
	    		PrmAccountingEntity				  is a AccountingEntity
	    		PrmCloseConfiguration             is a GeneralLedgerCloseConfiguration
	    		PrmReconciliationLevel            is a StructureRow
	    		PrmAccountingUnitStructure		  is a AccountingUnitStructure
				BypassActiveCodeBlockEdit
									
	    	Instance Selection
	    		where (FinanceEnterpriseGroup     = PrmReconciliationManagementGroup.FinanceEnterpriseGroup
	    		and	   AccountingUnitStructure 	  = PrmAccountingUnitStructure
	    		and    AccountingEntity           = PrmAccountingEntity
	    		and    AccountingUnitType.Posting
	    		and    PrmAccountingEntity        = PrmAccountingEntity)
				
			Sort Order is primary
								    		
	    	Action Rules
	    	
	    		Instance Rules
					invoke CreateReconciliationAccounts ReportingChartAccount
						invoked.PrmChartAccountRule	              = PrmChartAccountRule	 		
						invoked.PrmReconcileFrequency             = PrmReconcileFrequency
						invoked.PrmPeriodWithinQuarter            = PrmPeriodWithinQuarter
						invoked.PrmAccountType	                  = PrmAccountType
						invoked.PrmCashManagementAccount          = PrmCashManagementAccount		
						invoked.PrmReconciliationAccountGroup     = PrmReconciliationAccountGroup
						invoked.PrmRisk		                      = PrmRisk				
						invoked.PrmPriority		                  = PrmPriority				
						invoked.PrmCloseTask                      = PrmCloseTask
						invoked.PrmFinanceTeam                    = PrmFinanceTeam
						invoked.PrmFinanceTeamMember              = PrmFinanceTeamMember
						invoked.PrmRequiresApproval	              = PrmRequiresApproval		
						invoked.PrmApprovalCode			          = PrmApprovalCode
						invoked.PrmRequireSupportingDoco          = PrmRequireSupportingDoco	
						invoked.PrmReconciliationPolicy           = PrmReconciliationPolicy
						invoked.PrmReconciliationManagementGroup  = PrmReconciliationManagementGroup
						invoked.PrmReportingChart 				  = PrmReportingChart
			    		invoked.PrmReconciliationAccountStructure = PrmReconciliationAccountStructure
			    		invoked.PrmAccountingEntity				  = PrmAccountingEntity
			    		invoked.PrmCloseConfiguration             = PrmCloseConfiguration
			    		invoked.PrmAccountingUnit				  = AccountingUnit
			    		invoked.PrmReconciliationLevel	          = PrmReconciliationLevel
			    		invoked.BypassActiveCodeBlockEdit		  = BypassActiveCodeBlockEdit
#endif
