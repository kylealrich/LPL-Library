SESupplierQuestionValue is a BusinessClass
    owned by ss
    prefix is ESQV

    Ontology
    	symbolic key is SESupplierQuestionValue
    
    Patterns
		implements DynamicCreation
		implements Resequence on DisplayOrder
			new sequence field is NewDisplayOrder
			set is ByDisplayOrder

    Dynamic Creation Rules 
    	DynamicallyCreated = true
    	constraint (parentcontext.name = "SourcingEventQuestionAllocation")
    		"TheAnswer-<SESupplierQuestionValue>-ForQuestion-<SourcingEventSupplierQuestion.QuestionText>-DoesNotExist"
    				
    Persistent Fields
    	DisplayOrder
		QuestionToCreate	is like Question

	Transient Fields
		NewDisplayOrder				is a DisplayOrder
		DynamicallyCreated			is Boolean
		FromTemplateOrCopy          is Boolean

	Local Fields
		LastDisplayOrder			is a DisplayOrder		
		LocalConditionalQuestion	is like Question 

	Conditions
    	ValidCreateAction
    		restricted
    		when (SourcingEventSupplierQuestion.ResponseType.List
    		and	  SourcingEvent.InActionableState)		

		RepositoryHasConditionalQuestions 
			restricted
			when (RepositoryConditionalQuestionRel exists)

		HasSourcingEventConditionalQuestions
			restricted
			when (ConditionalQuestionsDirectRel exists)
	
	Relations

		LocalConditionalQuestionRel 
			one-to-many relation to ConditionalQuestion
			Field Mapping uses symbolic key 
				related.ProcurementGroup						= Company.SourcingGroup 
				related.Question								= SourcingEventSupplierQuestion.Question
				related.QuestionAnswer							= SESupplierQuestionValue

		SameRepositoryQuestionRel 
			one-to-many relation to SourcingEventSupplierQuestion 
			Field Mapping uses ByQuestion
				related.NotifiedSupplier.SupplierGroup			= actor.agent(SupplierSourceId).SupplierGroup
				related.NotifiedSupplier.Supplier				= actor.agent(SupplierSourceId).Supplier
				related.NotifiedSupplier.SupplierSourceId		= actor.agent(SupplierSourceId).SupplierSourceId
				related.Company									= Company 
				related.SourcingEvent							= SourcingEvent 
				related.Question								= LocalConditionalQuestion 

		RepositoryConditionalQuestionRel 
			one-to-many relation to ConditionalQuestion 
			Field Mapping uses ByListAnswer
				related.ProcurementGroup										= Company.SourcingGroup 
				related.Question                        						= SourcingEventSupplierQuestion.Question 
				related.QuestionAnswer.QuestionAnswerGroup.QuestionListValue	= SESupplierQuestionValue 		

		SourcingEventQuestionRel 
			one-to-one relation to SourcingEventQuestion 
			Field Mapping uses symbolic key
				related.Company									= Company 
				related.SourcingEvent							= SourcingEvent
				related.SourcingEventQuestion					= SourcingEventSupplierQuestion.Question 

		ConditionalQuestionsDirectRel 
			one-to-many relation to ConditionalQuestion 
			Field Mapping uses symbolic key 
				related.ProcurementGroup						= Company.SourcingGroup 
				related.Question								= SourcingEventSupplierQuestion.Question 

    Sets
    	ByDisplayOrder
    		duplicates
    		Sort Order
    			Company
    			SourcingEvent
    			SourcingEventSupplierQuestion
    			DisplayOrder
    
    Actions
    	Create is a Create Action
			valid when (ValidCreateAction)
			Field Rules
				DisplayOrder
					if (!SourcingEvent.CreateByCopy)
						autosequence using SourcingEventSupplierQuestion.LastQuestionValueDisplayOrder

    		Action Rules
    			constraint (SourcingEventSupplierQuestion.ResponseType.List)
    				"CanOnlyAddValuesToListTypeQuestions"
				constraint (SourcingEvent.InActionableState)
					"CannotAddQuestionValueWhileEventIsPendingAward,Cancelled,OrClosed"

    			if (!DynamicallyCreated
    			and SourcingEventSupplierQuestion.Question entered)  
    				invoke Update SourcingEventSupplierQuestion
    					initialize invoked.Question				

				if (SourcingEvent.InInitiateAmendmentState
				and Company.AmendmentCriteria.AddQuestion)
					invoke Amend Open.Notified SourcingEvent
								
    	CreateDisplay is a Create Action
    		restricted
			valid when (ValidCreateAction)

    		Action Rules


    	CreateDisplayValue is a Create Action
			restricted
			valid when (ValidCreateAction)
    		Action Rules
    			constraint (SourcingEventSupplierQuestion.ResponseType.List)
    				"CanOnlyAddValuesToListTypeQuestions"
				constraint (SourcingEvent.InActionableState)
					"CannotAddQuestionValueWhileEventIsPendingAward,Cancelled,OrClosed"
				if (SourcingEvent.InInitiateAmendmentState
				and Company.AmendmentCriteria.AddQuestion)
					invoke Amend Open.Notified SourcingEvent

			Exit Rules
				if (LastDisplayOrder entered)
					if (LastDisplayOrder > SourcingEventSupplierQuestion.LastQuestionValueDisplayOrder)
						invoke Update SourcingEventSupplierQuestion
							invoked.LastQuestionValueDisplayOrder = LastDisplayOrder

    	Update is an Update Action
    		valid when (SourcingEvent.InActionableState)
    		Action Rules
    			constraint (SourcingEvent.InActionableState)
					"CannotUpdateQuestionValueWhileEventIsPendingAward,Cancelled,OrClosed"
				if (SourcingEvent.InInitiateAmendmentState
				and Company.AmendmentCriteria.UpdateQuestion)
					invoke Amend Open.Notified SourcingEvent

		CreateConditionalQuestion is an Instance Action
			valid when (SourcingEventQuestionRel.CanCreateConditionalListQuestion)
			Parameters 
				ParmConditionalQuestion is a Question
					default label is "ConditionalQuestion"

			Parameter Rules 
				ParmConditionalQuestion 
					required
			Action Rules

				constraint (ParmConditionalQuestion.Active)
					"CannotUseAnInactiveQuestion"
				LocalConditionalQuestion	= ParmConditionalQuestion
				constraint (SameRepositoryQuestionRel !exists)
					"ConditionalQuestionAlreadyExistsAsASourcingEventQuestion"
				constraint (LocalConditionalQuestionRel !exists)
					"ConditionalQuestionAlreadyExists"
				if (SourcingEventSupplierQuestion.Question entered)
					constraint (ParmConditionalQuestion != SourcingEventSupplierQuestion.Question)
						"ConditionalQuestionCannotBeTheSameAsQuestion"








    	CopySourcingEventConditionalQuestions is an Instance Action 
			restricted 
			Parameters 
				NewSourcingEvent	is a SourcingEvent 
				NewQuestion			is a SourcingEventSupplierQuestion 

			Action Rules 







		
    	Delete is a Delete Action
			valid when (SourcingEvent.InActionableState)
			Action Rules
				constraint (SourcingEvent.InActionableState)
					"CannotDeleteQuestionValueWhileEventIsPendingAward,Cancelled,OrClosed"

    			if (SourcingEventSupplierQuestion.Question entered) 
    				invoke Update SourcingEventSupplierQuestion
    					initialize invoked.Question				

				if (SourcingEvent.InInitiateAmendmentState
				and Company.AmendmentCriteria.DeleteQuestion)
					invoke Amend Open.Notified SourcingEvent
