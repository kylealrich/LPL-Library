ProjectBillingRateTable is a BusinessClass
    owned by Projects
    prefix is PJBRT

    Ontology
        symbolic key is ProjectBillingRateTable

    Persistent Fields
        Description  
		Currency
		AccountingEntityOrder	is a BillingBlockOrder
		AccountingUnitOrder		is a BillingBlockOrder
		AccountOrder			is a BillingBlockOrder
		ProjectOrder			is a BillingBlockOrder
		Dimension1Order			is a BillingBlockOrder
		Dimension2Order			is a BillingBlockOrder
		Dimension3Order			is a BillingBlockOrder
		Dimension4Order			is a BillingBlockOrder
		Dimension5Order			is a BillingBlockOrder
		Dimension6Order			is a BillingBlockOrder
		Dimension7Order			is a BillingBlockOrder
		Dimension8Order			is a BillingBlockOrder
		Dimension9Order			is a BillingBlockOrder
		Dimension10Order		is a BillingBlockOrder
		EmployeeOrder			is a BillingBlockOrder
			
	Derived Fields
		ContextMessageEntityType is a StringField
			type is Alpha 30
			restricted
			"InforProjectBillingRateTable"
			
		ContextMessageText is a StringField
			type is Alpha 30
			restricted
			"EffectiveDate<Effective Date>"
			
		EmployeeMF is a StringField
			type is Alpha 25
			"Employee"

	Local Fields
		LocalOrderTotal			is Numeric 3
		LocalOrderCount			is Numeric 2
		LocalOrderCheck			is a AlphaArray

	Conditions
		AccountingEntityInUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.AccountingEntity entered)
		AccountingUnitInUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.AccountingUnit entered)
		AccountInUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.GeneralLedgerChartAccount entered)
		ProjectInUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.Project entered)
		Dimension1InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension1 entered)
		Dimension2InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension2 entered)
		Dimension3InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension3 entered)
		Dimension4InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension4 entered)
		Dimension5InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension5 entered)
		Dimension6InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension6 entered)
		Dimension7InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension7 entered)
		Dimension8InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension8 entered)
		Dimension9InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension8 entered)
		Dimension10InUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.FinanceDimension10 entered)
		EmployeeInUse
			restricted
			when (any ProjectBillingRateTableLine set.BillingCodeBlock.Employee entered)

	Relations
		OtherVersionsRel
			one-to-many relation to ProjectBillingRateTable
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.ProjectBillingRateTable	= ProjectBillingRateTable
			Instance Selection
				where (related.EffectiveDate != EffectiveDate)
				
		ProjectBillingRateTableLineRel
			one-to-many relation to ProjectBillingRateTableLine
			Field Mapping uses ByCodeBlockString
				related.FinanceEnterpriseGroup	= FinanceEnterpriseGroup
				related.ProjectBillingRateTable	= ProjectBillingRateTable
				related.EffectiveDate		    = EffectiveDate

	Rule Blocks
		InitializeUnusedDimensions
			if (FinanceEnterpriseGroup.AccountingEntityLabel not entered)
				initialize AccountingEntityOrder
			if (FinanceEnterpriseGroup.AccountingUnitLabel not entered)
				initialize AccountingUnitOrder
			if (FinanceEnterpriseGroup.AccountLabel not entered)
				initialize AccountOrder
			if (FinanceEnterpriseGroup.ProjectLabel not entered)
				initialize ProjectOrder
			if (FinanceEnterpriseGroup.FinanceDimension1Label not entered)
				initialize Dimension1Order
			if (FinanceEnterpriseGroup.FinanceDimension2Label not entered)
				initialize Dimension2Order
			if (FinanceEnterpriseGroup.FinanceDimension3Label not entered)
				initialize Dimension3Order
			if (FinanceEnterpriseGroup.FinanceDimension4Label not entered)
				initialize Dimension4Order
			if (FinanceEnterpriseGroup.FinanceDimension5Label not entered)
				initialize Dimension5Order
			if (FinanceEnterpriseGroup.FinanceDimension6Label not entered)
				initialize Dimension6Order
			if (FinanceEnterpriseGroup.FinanceDimension7Label not entered)
				initialize Dimension7Order
			if (FinanceEnterpriseGroup.FinanceDimension8Label not entered)
				initialize Dimension8Order
			if (FinanceEnterpriseGroup.FinanceDimension9Label not entered)
				initialize Dimension9Order
			if (FinanceEnterpriseGroup.FinanceDimension10Label not entered)
				initialize Dimension10Order

		BillingBlockOrderEdit
			initialize LocalOrderTotal
			initialize LocalOrderCount
			if (AccountingEntityOrder entered)
				LocalOrderTotal += AccountingEntityOrder
				LocalOrderCount += 1
			if (AccountingUnitOrder entered)
				LocalOrderTotal += AccountingUnitOrder
				LocalOrderCount += 1				
			if (AccountOrder entered)
				LocalOrderTotal += AccountOrder
				LocalOrderCount += 1
			if (ProjectOrder entered)
				LocalOrderTotal += ProjectOrder
				LocalOrderCount += 1
			if (Dimension1Order entered)
				LocalOrderTotal += Dimension1Order
				LocalOrderCount += 1
			if (Dimension2Order entered)
				LocalOrderTotal += Dimension2Order
				LocalOrderCount += 1
			if (Dimension3Order entered)
				LocalOrderTotal += Dimension3Order
				LocalOrderCount += 1
			if (Dimension4Order entered)
				LocalOrderTotal += Dimension4Order
				LocalOrderCount += 1
			if (Dimension5Order entered)
				LocalOrderTotal += Dimension5Order
				LocalOrderCount += 1
			if (Dimension6Order entered)
				LocalOrderTotal += Dimension6Order
				LocalOrderCount += 1
			if (Dimension7Order entered)
				LocalOrderTotal += Dimension7Order
				LocalOrderCount += 1
			if (Dimension8Order entered)
				LocalOrderTotal += Dimension8Order
				LocalOrderCount += 1
			if (Dimension9Order entered)
				LocalOrderTotal += Dimension9Order
				LocalOrderCount += 1
			if (Dimension10Order entered)
				LocalOrderTotal += Dimension10Order
				LocalOrderCount += 1				
			if (EmployeeOrder entered)
				LocalOrderTotal += EmployeeOrder
				LocalOrderCount += 1				

			constraint (LocalOrderCount <= 5)
				"MaximumOf5DimensionsMayBeIncluded"

			if (AccountingEntityOrder entered)
				constraint (!LocalOrderCheck.AlphaElement[AccountingEntityOrder] = AccountingEntityOrder)
					"DuplicateOrderNumber<AccountingEntityOrder>"
				LocalOrderCheck.AlphaElement[AccountingEntityOrder] = AccountingEntityOrder
			else
				if (AccountingEntityInUse)
					constraint (AccountingEntityOrder entered)
						"<FinanceEnterpriseGroup.AccountingEntityLabel>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (AccountingUnitOrder entered)
				constraint (!LocalOrderCheck.AlphaElement[AccountingUnitOrder] = AccountingUnitOrder)
					"DuplicateOrderNumber<AccountingUnitOrder>"
				LocalOrderCheck.AlphaElement[AccountingUnitOrder] = AccountingUnitOrder
			else
				if (AccountingUnitInUse)
					constraint (AccountingUnitOrder entered)
						"<FinanceEnterpriseGroup.AccountingUnitLabel>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (AccountOrder entered)
				constraint (!LocalOrderCheck.AlphaElement[AccountOrder] = AccountOrder)
					"DuplicateOrderNumber<AccountOrder>"
				LocalOrderCheck.AlphaElement[AccountOrder] = AccountOrder
			else
				if (AccountInUse)
					constraint (AccountOrder entered)
						"<FinanceEnterpriseGroup.AccountLabel>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (ProjectOrder entered)
				constraint (!LocalOrderCheck.AlphaElement[ProjectOrder] = ProjectOrder)
					"DuplicateOrderNumber<ProjectOrder>"
				LocalOrderCheck.AlphaElement[ProjectOrder] = ProjectOrder
			else
				if (ProjectInUse)
					constraint (ProjectOrder entered)
						"<FinanceEnterpriseGroup.ProjectLabel>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension1Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension1Order] = Dimension1Order)
					"DuplicateOrderNumber<Dimension1Order>"
				LocalOrderCheck.AlphaElement[Dimension1Order] = Dimension1Order
			else
				if (Dimension1InUse)
					constraint (Dimension1Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension1Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension2Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension2Order] = Dimension2Order)
					"DuplicateOrderNumber<Dimension2Order>"
				LocalOrderCheck.AlphaElement[Dimension2Order] = Dimension2Order
			else
				if (Dimension2InUse)
					constraint (Dimension2Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension2Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension3Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension3Order] = Dimension3Order)
					"DuplicateOrderNumber<Dimension3Order>"
				LocalOrderCheck.AlphaElement[Dimension3Order] = Dimension3Order
			else
				if (Dimension3InUse)
					constraint (Dimension3Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension3Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension4Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension4Order] = Dimension4Order)
					"DuplicateOrderNumber<Dimension4Order>"
				LocalOrderCheck.AlphaElement[Dimension4Order] = Dimension4Order
			else
				if (Dimension4InUse)
					constraint (Dimension4Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension4Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension5Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension5Order] = Dimension5Order)
					"DuplicateOrderNumber<Dimension5Order>"
				LocalOrderCheck.AlphaElement[Dimension5Order] = Dimension5Order
			else
				if (Dimension5InUse)
					constraint (Dimension5Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension5Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension6Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension6Order] = Dimension6Order)
					"DuplicateOrderNumber<Dimension6Order>"
				LocalOrderCheck.AlphaElement[Dimension6Order] = Dimension6Order
			else
				if (Dimension6InUse)
					constraint (Dimension6Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension6Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension7Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension7Order] = Dimension7Order)
					"DuplicateOrderNumber<Dimension7Order>"
				LocalOrderCheck.AlphaElement[Dimension7Order] = Dimension7Order
			else
				if (Dimension7InUse)
					constraint (Dimension7Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension7Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension8Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension8Order] = Dimension8Order)
					"DuplicateOrderNumber<Dimension8Order>"
				LocalOrderCheck.AlphaElement[Dimension8Order] = Dimension8Order
			else
				if (Dimension8InUse)
					constraint (Dimension8Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension8Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension9Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension9Order] = Dimension9Order)
					"DuplicateOrderNumber<Dimension9Order>"
				LocalOrderCheck.AlphaElement[Dimension9Order] = Dimension9Order
			else
				if (Dimension9InUse)
					constraint (Dimension9Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension9Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (Dimension10Order entered)
				constraint (!LocalOrderCheck.AlphaElement[Dimension10Order] = Dimension10Order)
					"DuplicateOrderNumber<Dimension10Order>"
				LocalOrderCheck.AlphaElement[Dimension10Order] = Dimension10Order
			else
				if (Dimension10InUse)
					constraint (Dimension10Order entered)
						"<FinanceEnterpriseGroup.FinanceDimension10Label>OrderIsRequired;_ValuesHaveBeenEnteredInTable"
			if (EmployeeOrder entered)
				constraint (!LocalOrderCheck.AlphaElement[EmployeeOrder] = EmployeeOrder)
					"DuplicateOrderNumber<EmployeeOrder>"
				LocalOrderCheck.AlphaElement[EmployeeOrder] = EmployeeOrder
			else
				if (EmployeeInUse)
					constraint (EmployeeOrder entered)
						"EmployeeOrderIsRequired;_ValuesHaveBeenEnteredInTable"

			if (LocalOrderCount = 1)
				constraint (LocalOrderTotal = 1)
					"InvalidOrder"
			else
			if (LocalOrderCount = 2)
				constraint (LocalOrderTotal = 3)
					"InvalidOrder"
			else
			if (LocalOrderCount  = 3)
				constraint (LocalOrderTotal = 6)
					"InvalidOrder"
			else
			if (LocalOrderCount  = 4)
				constraint (LocalOrderTotal = 10)
					"InvalidOrder"
			else
			if (LocalOrderCount  = 5)
				constraint (LocalOrderTotal = 15)
					"InvalidOrder"


    Field Rules
        Description
            required

		Currency
			required
			if (OtherVersionsRel exists)
				constraint (Currency = first OtherVersionsRel.Currency)
					"CurrencyMustBe<first OtherVersionsRel.Currency>"
			if (ProjectContract set exists)
				cannot be changed
					"CannotChangeCurrency;_BillingRateTableAttachedToContract"
			if (Project set exists)
				cannot be changed
					"CannotChangeCurrency;_BillingRateTableAttachedTo<FinanceEnterpriseGroup.ProjectLabel>"
			if (ProjectBillingOverride set exists)
				cannot be changed
					"CannotChangeCurrency;_BillingRateTableAttachedTo<FinanceEnterpriseGroup.ProjectLabel>BillingOverride"

    Actions
        Create is a Create Action
        	Entrance Rules
        		include InitializeUnusedDimensions
			Action Rules
				include BillingBlockOrderEdit
        Update is an Update Action
        	Entrance Rules
				include InitializeUnusedDimensions
			Action Rules
				include BillingBlockOrderEdit
			Exit Rules
				if (AccountingEntityOrder	changed
				or  AccountingUnitOrder		changed
				or  AccountOrder			changed
				or  ProjectOrder			changed
				or  Dimension1Order			changed
				or  Dimension2Order			changed
				or  Dimension3Order			changed
				or  Dimension4Order			changed
				or  Dimension5Order			changed
				or  Dimension6Order			changed
				or  Dimension7Order			changed
				or  Dimension8Order			changed
				or  Dimension9Order			changed
				or  Dimension10Order		changed
				or  EmployeeOrder			changed)
					invoke Update ProjectBillingRateTableLine set
		
        Delete is a Delete Action
        
        CopyTable is an Instance Action
        	Parameters
        		NewTable			is like ProjectBillingRateTable
        		NewDescription		is like Description
				NewEffectiveDate	is Date
					default label is "EffectiveDate"
				Multiplier			is Decimal size 6.3
			Parameter Rules
				NewTable
					required
				NewDescription
					required
				NewEffectiveDate
					required
				Multiplier
					initial value is 1
					default to 1
			Action Rules
				invoke Create
					fill in fields from this instance
					invoked.ProjectBillingRateTable	= NewTable
					invoked.Description				= NewDescription
					invoked.EffectiveDate			= NewEffectiveDate
				for each ProjectBillingRateTableLine set
					invoke Create ProjectBillingRateTableLine
						fill in fields from each
						invoked.ProjectBillingRateTable	= NewTable
						invoked.EffectiveDate 			= NewEffectiveDate
						invoked.Rate		  			= each.Rate * Multiplier

        CreateNewVersion is an Instance Action
        	Parameters
				NewEffectiveDate	is Date
					default label is "EffectiveDate"
				Multiplier			is Decimal size 6.3
			Parameter Rules
				NewEffectiveDate
					initial value is current corporate date
					required
				Multiplier
					initial value is 1
					default to 1
			Action Rules
				invoke Create
					fill in fields from this instance
					invoked.EffectiveDate	= NewEffectiveDate
				for each ProjectBillingRateTableLine set
					invoke Create ProjectBillingRateTableLine
						fill in fields from each
						invoked.EffectiveDate = NewEffectiveDate
						invoked.Rate		  = each.Rate * Multiplier



