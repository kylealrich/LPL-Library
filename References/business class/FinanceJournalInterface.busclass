FinanceJournalInterface is a BusinessClass
	owned by sharedfinance
	prefix is FiJI
	
	Ontology
    	symbolic key is FinanceJournalInterface
	
	Persistent Fields
		RunGroup					is AlphaUpper 15
		Description 				is AlphaUpper 30
		PostingDate 				is Date		
		LastGLSequence				is Numeric size 6
		ApprovalCode
		ApprovalLevel				is Numeric 8
		ReassignToApprovalLevel		is an ApprovalCodeResource
		Approver					is a FinanceResource
		ApproverTeam				is a FinanceTeamField
		Status						is Numeric 2
			States
				Open				value is 0
				PendingApproval		value is 1
				ReadyToInterface	value is 3
				Archived			value is 9
	
	Local Fields
		LocalApprovalLevel			   	is Numeric 8
		LocalApprover				   	is a FinanceResource  
		LocalApproverTeam			   	is a FinanceTeamField  
		LocalApproverList			   	is Alpha 250
		LocalFirstApproverAssigned	  	is Boolean
		LocalFinanceGroup			   	is Numeric 4



		LocalFinanceJournalInterface	is a FinanceJournalInterface

	
	Transient Fields



	Rule Blocks
		












		
		BuildTeamApproverActorList
			LocalApproverList = ""
			LocalFirstApproverAssigned = false
			for each FinanceTeamMembersFromCurrentApprovalLevelRel
				if (LocalFirstApproverAssigned)
					LocalApproverList = LocalApproverList + "," + each.FinanceTeamMember.TeamMember.FinanceResourceActor
				else
					LocalApproverList = each.FinanceTeamMember.TeamMember.FinanceResourceActor
					LocalFirstApproverAssigned = true

		GetNextEscalationApprovalLevel
			LocalApprovalLevel		= ApprovalLevel
			if (first LocalApprovalCodeLevelRel.EscalateTo.NextApprovalLevel)
				LocalApprovalLevel	= ApprovalLevel + 1
				LocalApprover		= first LocalApprovalCodeLevelRel.Approver
				LocalApproverTeam	= first LocalApprovalCodeLevelRel.ApprovalTeam
			else
				LocalApprovalLevel	= first LocalApprovalCodeLevelRel.EscalationApprovalLevel.ApprovalLevel
				LocalApprover		= first LocalApprovalCodeLevelRel.Approver
				LocalApproverTeam	= first LocalApprovalCodeLevelRel.ApprovalTeam

		GetNextApprovalLevel
			if (ApprovalLevel < 1)
				LocalApprovalLevel	= first ApprovalCodeResourceRel.ApprovalLevel
				LocalApprover		= first ApprovalCodeResourceRel.Approver
				LocalApproverTeam	= first ApprovalCodeResourceRel.ApprovalTeam
			else
				LocalApprovalLevel		= ApprovalLevel + 1
				if (LocalApprovalCodeLevelRel exists)
					LocalApprovalLevel	= first LocalApprovalCodeLevelRel.ApprovalLevel
					LocalApprover		= first LocalApprovalCodeLevelRel.Approver
					LocalApproverTeam	= first LocalApprovalCodeLevelRel.ApprovalTeam
				else
					initialize LocalApprovalLevel
					initialize LocalApprover
					initialize LocalApproverTeam
					
	Derived Fields
	
		DerivedCurrentApprovalResource is a DerivedField
			type is Numeric 9
			restricted
			return first CurrentApprovalCodeLevelRel.Approver

		DerivedCurrentApprovalActor is a DerivedField
			type is Actor
			restricted
			return first CurrentApprovalCodeLevelRel.Approver.FinanceResourceActor

		DerivedCurrentApprovalTeam is a DerivedField
			type is AlphaUpper 20
			restricted
			return first CurrentApprovalCodeLevelRel.ApprovalTeam

		DerivedCurrentTeamActorList is a DerivedField
			type is Alpha 250
			restricted
			include BuildTeamApproverActorList
			return LocalApproverList

		DerivedCurrentApproverEscalationDays is a DerivedField
			type is Numeric 6
			restricted
			if (first CurrentApprovalCodeLevelRel.EscalationDays > 0)
				return first CurrentApprovalCodeLevelRel.EscalationDays	
			else
				return 10000

		DerivedCurrentApproverEscalationHours is a DerivedField
			type is Decimal 6.2
			restricted
			if (first CurrentApprovalCodeLevelRel.EscalationHours > 0)
				return first CurrentApprovalCodeLevelRel.EscalationHours
			else
				return 9999.99

	Field Rules
		RunGroup
			initial value is FinanceGroup.DefaultRunGroup
			default to FinanceGroup.DefaultRunGroup

		ApprovalCode
			if (FinanceGroup.JournalEntryApprovalRequired)
				required
					"JournalEntryApprovalIsRequiredOnFinanceGroup;MustSelectApprovalCode"
			




					
	Relations







				
































		FinanceCompanyRel
			one-to-many relation to FinanceCompany
			Field Mapping uses ByFinanceGroup
				related.FinanceGroup	= FinanceGroup
		
		CashManagementInterfaceLinesRel	is a FinanceJournalInterfaceLine set
			Instance Selection
				where (related.System = "CT")

		PeriodEndJournalInterfaceLinesRel is a FinanceJournalInterfaceLine set
			Instance Selection
				where (related.System = "RM")
				
		CurrentApprovalCodeLevelRel
			one-to-many relation to ApprovalCodeResource
			Field Mapping uses ByApprovalLevel
				related.FinanceEnterpriseGroup	= FinanceGroup
				related.ApprovalCode			= ApprovalCode
				related.ApprovalLevel			= ApprovalLevel

		ApprovalCodeResourceRel
			one-to-many relation to ApprovalCodeResource
			Field Mapping uses ByApprovalLevel
				related.FinanceEnterpriseGroup	= FinanceGroup
				related.ApprovalCode			= ApprovalCode

		LocalApprovalCodeLevelRel
			one-to-many relation to ApprovalCodeResource
			Field Mapping uses ByApprovalLevel
				related.FinanceEnterpriseGroup	= FinanceGroup
				related.ApprovalCode			= ApprovalCode
				related.ApprovalLevel			= LocalApprovalLevel
		
		FinanceTeamMembersFromCurrentApprovalLevelRel
			one-to-many relation to FinanceTeamMember
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	= FinanceGroup
				related.FinanceTeam				= first CurrentApprovalCodeLevelRel.ApprovalTeam

	Conditions




			
		ApprovalRequiredUpdateable
			restricted
			when (FinanceGroup.JournalEntryApprovalRequired
			and   Status.Open)





		FinanceJournalInterfaceExists
			restricted
			when (FinanceJournalInterface exists)




		HasInterfaceLines
			restricted
			when (FinanceJournalInterfaceLine set exists)
			
























			
















			
 		RejectJournalEntryReasonCodeRequired
 			restricted
			when (FinanceGroup.RejectJournalEntryReasonCodeRequired)
			








		HasApprovalComments
			restricted
			when (JEReasonCodeUsage set.Comment entered)
			

	Sets
		ByRunGroup
			Sort Order
				FinanceGroup
				RunGroup
				FinanceJournalInterface descending
				
		ByStatus
			Sort Order
				FinanceGroup
				Status
				FinanceJournalInterface

	Actions















































































						

		UpdateApprovalLevel is an Instance Action
			restricted
			Parameters
				ParmEscalate	is Boolean
				ParmReassign	is Boolean
			Action Rules
				if (ParmReassign)
					if (ReassignToApprovalLevel entered)
						ApprovalLevel = ReassignToApprovalLevel.ApprovalLevel
						initialize ReassignToApprovalLevel
				else
				if (ParmEscalate)
					include GetNextEscalationApprovalLevel
					ApprovalLevel		= LocalApprovalLevel
					Approver			= LocalApprover
					ApproverTeam		= LocalApproverTeam
				else
					include GetNextApprovalLevel
					ApprovalLevel		= LocalApprovalLevel
					Approver			= LocalApprover
					ApproverTeam		= LocalApproverTeam

		Update is an Update Action







		
		Delete is a Delete Action

			Entrance Rules





		ArchiveInterfacedJournals is a Set Action
			restricted
			Parameters
				PrmFinanceGroup	is a FinanceGroup
				
			Instance Selection
				where (FinanceGroup	= PrmFinanceGroup
				and    Status.ReadyToInterface) 


			Sort Order
				FinanceGroup
				Status
				FinanceJournalInterface

			Action Rules
				Instance Rules
					make transition to Archived







	StateCycles

		JournalInterfaceCycle is a StateCycle
			state field is Status

			Open is a State
				Create is a Create Action
					Action Rules


		
				SubmitForApproval is an Instance Action
					valid when (FinanceGroup.JournalEntryApprovalRequired)
					completion message is "JournalHasBeenSubmittedForApproval"
					Action Rules
						if (ApprovalCode entered)
							constraint (ApprovalCode.HasApprovalLevels) 
								"CannotComplete;TheApprovalCodeHasNoApprovalLevels"
							constraint (!ApprovalCode.HasTeamWithNoMembers) 
								"CannotComplete;TheApprovalCodeHasATeamWithNoMembers"
							constraint (!ApprovalCode.HasInvalidEscalations)
								"CannotComplete:TheApprovalCodeHasInvalidEscalationSettings"
							constraint (!ApprovalCode.HasInactiveResources)
								"CannotComplete;TheApprovalCodeHasInactiveResources"
						
						include GetNextApprovalLevel
						ApprovalLevel = LocalApprovalLevel
						Approver = LocalApprover
						ApproverTeam = LocalApproverTeam

						
						make transition to PendingApproval


			PendingApproval is a State
				on entrance to PendingApproval
					Action Rules
						Status = Status.PendingApproval
						
				Approve is an Instance Action
					restricted
					Action Rules


















		
						make transition to ReadyToInterface
		
		
		   		ManualApprove is an Instance Action
		    		valid when (Status.PendingApproval)
					confirmation required
						"ThisWillBypassTheProcessFlowApprovalProcess;DoYouWantToContinue?"
					Action Rules			


















						
						make transition to ReadyToInterface
						
						initialize ApprovalLevel
						initialize Approver
						initialize ApproverTeam
						
						cancel JournalEntryApproval process
		
				Reject is an Instance Action
					restricted
					Action Rules
						make transition to Open
						
						initialize ApprovalLevel
						initialize Approver
						initialize ApproverTeam	
		


























						





















						
			ReadyToInterface is a State
				on entrance to ReadyToInterface
					Action Rules
						Status = Status.ReadyToInterface


























			Archived is a State
				on entrance to Archived
					Action Rules
						Status = Status.Archived
