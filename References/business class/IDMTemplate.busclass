IDMTemplate is a BusinessClass
	owned by idm
	
	prefix is IDMT
	
	Ontology
		symbolic key is IDMTemplate
		
	
	Patterns
	
	Persistent Fields
		Name
			translatable
		Description 			is Text
		IDMUniqueId				is an IDMPID
		IDMDocumentType			is Numeric size 3
			States

				PurchaseOrder				value is 1
				ReceivablesStatement		value is 2
				BasicDunningLetter      	value is 3
				ReceivingDeliveryAndPutaway	value is 4
				AdvancedDunningLetter		value is 5				
				PaymentRequestNotice		value is 6
				InvoiceRegister				value is 7
				BillingInvoice				value is 8
				PickListPrintByShipmentDocumentLine		value is 9
				PickListPrintByShipmentBinLotSerial		value is 10
				PickListPrintByShipmentBinLotSerialRQ	value is 11
				PickListPrintByBinItemUOMLotSerial		value is 12
				ProjectContractInvoice		value is 13
				BillofLading                value is 14
                FederalFinancialReport      value is 15
                PayablesPaymentOutput       value is 16
				Requisition					value is 17
                PayablesChargeback			value is 18
                WarehouseProofOfDelivery	value is 19
				IntercompanyBillingInvoice	value is 20
				EFTNotificationPrint		value is 21
				ContractDocument			value is 22
				VendorStatement				value is 23
				DailyShipmentJournal		value is 24
				PayablesDebitMemo			value is 25
				WarehousePackingList		value is 26
				LetterOfRetention			value is 27
				US1099DIVCopyAOriginalForm	value is 28		
				US1099DIVCopyBLaserCopy		value is 29	
				US1099DIVCopyCLaserCopy		value is 30			
				US1099GCopyAOriginalForm	value is 31			
				US1099GCopyBLaserCopy		value is 32		
				US1099GCopyCLaserCopy		value is 33		
				US1099INTCopyAOriginalForm	value is 34			
				US1099INTCopyBLaserCopy		value is 35		
				US1099INTCopyCLaserCopy		value is 36			
				US1099KCopyAOriginalForm	value is 37		
				US1099KCopyBLaserCopy		value is 38
				US1099KCopyCLaserCopy		value is 39
				US1099MISCCopyAOriginalForm	value is 40			
				US1099MISCCopyBLaserCopy	value is 41
				US1099MISCCopyCLaserCopy    value is 42
				US1099NECCopyAOriginalForm	value is 43
				US1099NECCopyBLaserCopy		value is 44
				US1099NECCopyCLaserCopy		value is 45
				ReceivableInvoice			value is 46
				ProjectContractInvoiceReversal value is 47
				AddendumDocument			value is 48
				KitchenOrder				value is 49
				Recipe						value is 50
				US1099DIVCopyBConsolidated	value is 51
				US1099GCopyBConsolidated 	value is 52	
				US1099INTCopyBConsolidated	value is 53	
				US1099KCopyBConsolidated	value is 54
				US1099MISCCopyBConsolidated	value is 55
				US1099NECCopyBConsolidated	value is 56
				SubleaseBillingInvoice		value is 57
				EscheatmentNotice			value is 58
				PaymentReceipt				value is 59
				ReceivableInvoiceExpanded	value is 60
												

				PurchaseOrderEmailTemplate	value is 100
				ReceivableStatementEmail 	value is 101
				BasicDunningLetterEmail		value is 102
				AdvancedDunningLetterEmail  value is 103
				PaymentRequestNoticeEmail 	value is 104
				BillingInvoiceEmail			value is 105
				PayablesChargebackEmail		value is 106
				ProjectContractInvoiceEmail value is 107
				FederalFinancialReportEmail	value is 108
				PayablesPaymentOutputEmail  value is 109
				PayablesDebitMemoEmail		value is 110
				EFTNotificationEmail		value is 111
				ReceivableInvoiceEmail		value is 112
				InvoiceAndRegisterEmail		value is 113
				ProjectContractInvoiceReversalEmail value is 114
				IntercompanyBillingInvoiceEmail value is 115			
				SubleaseBillingInvoiceEmail value is 116
				EscheatmentNoticeEmail		value is 117
				PaymentReceiptEmail			value is 118
				ReceivableInvoiceExpandedEmail value is 119
				IDMUserTemplate				value is 999
		OutputFormat			is Numeric size 1
			States
				PDF					value is 0
				WordDocument		value is 1
		Active					is Boolean
		Email					is Boolean
		IDMStoredTemplate		is an IDMAttachment
			protected
		TemplateYear			is Numeric size 4
		UseRichText				is Boolean
		
	
	Attach Rules
		constraint (Active)
			"IDMTemplateMustBeActive"
		
		constraint (CheckIDMDocumentExistence)
			"IDMTemplateDocumentDoesNotExistInIDM"
	
	Transient Fields
		DocumentTemplate 			is an IDMAttachment
	
	Conditions
		OutputTemplate
			restricted
			when ((IDMUniqueId entered and not Email)
			or (IDMUniqueId not entered))

		US1099Templates
			restricted
			when (IDMDocumentType.US1099INTCopyAOriginalForm
			or   IDMDocumentType.US1099INTCopyBLaserCopy
			or   IDMDocumentType.US1099INTCopyCLaserCopy
			or   IDMDocumentType.US1099MISCCopyAOriginalForm
			or   IDMDocumentType.US1099MISCCopyBLaserCopy
			or   IDMDocumentType.US1099MISCCopyCLaserCopy
			or   IDMDocumentType.US1099DIVCopyAOriginalForm
			or   IDMDocumentType.US1099DIVCopyBLaserCopy
			or   IDMDocumentType.US1099DIVCopyCLaserCopy
			or   IDMDocumentType.US1099GCopyAOriginalForm
			or   IDMDocumentType.US1099GCopyBLaserCopy
			or   IDMDocumentType.US1099GCopyCLaserCopy		
			or   IDMDocumentType.US1099KCopyAOriginalForm
			or   IDMDocumentType.US1099KCopyBLaserCopy
			or   IDMDocumentType.US1099KCopyCLaserCopy
			or   IDMDocumentType.US1099NECCopyAOriginalForm
			or   IDMDocumentType.US1099NECCopyBLaserCopy
			or   IDMDocumentType.US1099NECCopyCLaserCopy
			or   IDMDocumentType.US1099DIVCopyBConsolidated
			or   IDMDocumentType.US1099GCopyBConsolidated
			or   IDMDocumentType.US1099INTCopyBConsolidated
			or   IDMDocumentType.US1099KCopyBConsolidated
			or   IDMDocumentType.US1099MISCCopyBConsolidated
			or   IDMDocumentType.US1099NECCopyBConsolidated)			

		IncludeTemplatesInTenantRefresh
			restricted
			when (FinanceEnterpriseGroup.IDMConfigurationRel.IncludeTemplatesInTenantRefresh)
	
	Field Rules
		
		Active
			initial value is true
		
		OutputFormat
			initial value is 1 
				when (IDMDocumentType = IDMDocumentType.ContractDocument
				or    IDMDocumentType = IDMDocumentType.AddendumDocument)
		
		IDMStoredTemplate
			if (DocumentTemplate entered
			and IncludeTemplatesInTenantRefresh)
				IDMStoredTemplate = DocumentTemplate
			
	Local Fields
		IDMItem
		IDMAttributes
		Execute				is Boolean
		LocalDocumentType	is like IDMDocumentType
		LocalLink			is Alpha size 2083
		Retrieved			is Boolean
		LocalResult		is Boolean
	
	Rule Blocks
	
		IDMUpload
			IDMAttributes.SingleValue.IDMAttribute[1].IDMAttributeName	= "Name"
			IDMAttributes.SingleValue.IDMAttribute[1].IDMAttributeValue	= DocumentTemplate.Title
			IDMAttributes.SingleValue.IDMAttribute[2].IDMAttributeName	= "Type"
			IDMAttributes.SingleValue.IDMAttribute[2].IDMAttributeValue	= DocumentType
			
			IDMItem.DocumentType			= OutputTemplateDocumentType
			IDMItem.Attachment				= DocumentTemplate
			IDMItem.IDMAttributes 			= IDMAttributes
			IDMItem.IDMAccessControlList	= "Public"
			if (IDMItem.Upload)
				IDMUniqueId						= IDMItem.IDMUniqueId
				
		DefaultsAndValidations
			constraint (Name entered)
				"NameIsRequired"
			
			constraint (Description entered)
				"DescriptionIsRequired"
			
			constraint (IDMDocumentType entered)
				"DocumentTypeIsRequired"
				
		CreateValidations
			constraint (DocumentTemplate.MimeType entered)
					"TemplateFileIsRequired"
				
			constraint (DocumentTemplate.MimeType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
				"TemplateMustBeA(.docx)File")
				
	Relations
		DuplicateTemplatesRel
			one-to-many relation to IDMTemplate
			Field Mapping uses ByName
				related.FinanceEnterpriseGroup = FinanceEnterpriseGroup
				related.Name	= Name
	
	Derived Fields
		
		CheckIDMDocumentExistence	is a DerivedField
			type is Boolean
			if (IDMUniqueId entered)
				IDMItem.DocumentType 	= OutputTemplateDocumentType
				IDMItem.IDMUniqueId		= IDMUniqueId
				LocalResult				= IDMItem.GetItemDetails
				return LocalResult

		TemplateExistsInIDM	is a DerivedField
			type is Boolean
			if (IDMUniqueId entered)
				IDMItem.DocumentType 	= OutputTemplateDocumentType
				IDMItem.IDMUniqueId		= IDMUniqueId
				IDMItem.OverrideUser	= true 		
				LocalResult				= IDMItem.GetItemDetails
				return LocalResult
	
		RetrieveUrl is a DerivedField
			type is Alpha size 2083
			if (not Retrieved)
				if (IDMUniqueId entered)
					IDMItem.DocumentType = OutputTemplateDocumentType
					IDMItem.IDMUniqueId	= IDMUniqueId
					Retrieved			= true
					LocalLink			= IDMItem.GetLink
			
			if (LocalLink entered)
				return LocalLink
			else
				return blank
		
		DocumentType is a DerivedField
			type is like IDMDocumentType
			if (IDMDocumentType.PurchaseOrder)
				LocalDocumentType	= "PurchaseOrder"
			else 
			if (IDMDocumentType.ReceivablesStatement)
				LocalDocumentType	= "ReceivablesStatement"
			else 
			if (IDMDocumentType.BasicDunningLetter)
				LocalDocumentType   = "BasicDunningLetter"
			else
			if (IDMDocumentType.ReceivingDeliveryAndPutaway)
				LocalDocumentType	= "ReceivingDeliveryAndPutaway"
			else
			if (IDMDocumentType.AdvancedDunningLetter)
				LocalDocumentType   = "AdvancedDunningLetter"
			else 
			if (IDMDocumentType.PaymentRequestNotice)
				LocalDocumentType   = "ReceivablesPaymentRequest"
			else
			if (IDMDocumentType.InvoiceRegister)
				LocalDocumentType   = "InvoiceRegister"
			else 
			if (IDMDocumentType.BillingInvoice)
				LocalDocumentType   = "BillingInvoice"
			else 
			if (IDMDocumentType.PickListPrintByShipmentDocumentLine)
				LocalDocumentType   = "WarehousePickListPrintByShipmentDocumentLine"
			else 
			if (IDMDocumentType.PickListPrintByShipmentBinLotSerial)
				LocalDocumentType   = "WarehousePickListPrintByBinLotSerial"
			else 
			if (IDMDocumentType.PickListPrintByShipmentBinLotSerialRQ)
				LocalDocumentType   = "WarehousePickListPrintByBinLotSerialRQBased"
			else 
			if (IDMDocumentType.PickListPrintByBinItemUOMLotSerial)
				LocalDocumentType   = "WarehousePickListPrintByBinItemUOMLotSerial"
			else
			if (IDMDocumentType.PurchaseOrderEmailTemplate)
				LocalDocumentType   = "PurchaseOrderEmailTemplate"
			else
			if (IDMDocumentType.ProjectContractInvoice
			or  IDMDocumentType.ProjectContractInvoiceReversal)
				LocalDocumentType   = "ProjectContractInvoice"
			else
			if (IDMDocumentType.BillofLading)
                LocalDocumentType   = "BillofLading"
            else
            if (IDMDocumentType.FederalFinancialReport)
                LocalDocumentType   = "FederalFinancialReport"
            else
            if (IDMDocumentType.PayablesPaymentOutput)
                LocalDocumentType    =    "PayablesPaymentOutput"	
	    	else
            if (IDMDocumentType.Requisition)
            	LocalDocumentType    =    "Requisition"	
            else
            if (IDMDocumentType.PayablesChargeback)
            	LocalDocumentType    =    "PayablesChargeback"
            else
            if (IDMDocumentType.ReceivableStatementEmail)
             	LocalDocumentType    =    "ReceivableStatementEmail"
            else
            if (IDMDocumentType.BasicDunningLetterEmail)
             	LocalDocumentType    =    "BasicDunningLetterEmail"
            else
            if (IDMDocumentType.AdvancedDunningLetterEmail)
             	LocalDocumentType    =    "AdvancedDunningLetterEmail"             	
            else             	
            if (IDMDocumentType.PaymentRequestNoticeEmail)
             	LocalDocumentType    =    "PaymentRequestNoticeEmail"
			else
            if (IDMDocumentType.EFTNotificationEmail)
             	LocalDocumentType    =    "EFTNotificationEmail"
            else
			if (IDMDocumentType.WarehouseProofOfDelivery)
				LocalDocumentType		=	"WarehouseProofOfDelivery"
			else
			if (IDMDocumentType.IntercompanyBillingInvoice)
				LocalDocumentType	= "IntercompanyBillingInvoice"
			else
			if (IDMDocumentType.BillingInvoiceEmail)
				LocalDocumentType		=	"BillingInvoiceEmail"
			else
			if (IDMDocumentType.EFTNotificationPrint)
				LocalDocumentType       =   "EFTNotificationPrint"
			else
			if (IDMDocumentType.PayablesChargebackEmail)
				LocalDocumentType       =   "PayablesChargebackEmail"
			else
			if (IDMDocumentType.ContractDocument)
				LocalDocumentType		=	"ContractDocument"
			else
			if (IDMDocumentType.VendorStatement)
				LocalDocumentType		=	"VendorStatement"
			else
			if (IDMDocumentType.ProjectContractInvoiceEmail
			or  IDMDocumentType.ProjectContractInvoiceReversalEmail)
				LocalDocumentType       =   "ProjectContractInvoiceEmail"
			else
			if (IDMDocumentType.FederalFinancialReportEmail)
				LocalDocumentType		=   "FederalFinancialReportEmail"
			else
			if (IDMDocumentType.DailyShipmentJournal)
				LocalDocumentType		=	"DailyShipmentJournal"
			else
			if (IDMDocumentType.PayablesPaymentOutputEmail)
				LocalDocumentType		= 	"PayablesPaymentOutputEmail"
			else
			if (IDMDocumentType.PayablesDebitMemo)
				LocalDocumentType		=	"PayablesDebitMemo"
			else
			if (IDMDocumentType.PayablesDebitMemoEmail)
				LocalDocumentType		=	"PayablesDebitMemoEmail"	
			else
			if (IDMDocumentType.WarehousePackingList)
				LocalDocumentType		=	"WarehousePackingList"
			else
			if (IDMDocumentType.LetterOfRetention)
				LocalDocumentType		=	"LetterOfRetention"
			else
			if (IDMDocumentType.US1099MISCCopyAOriginalForm
			or  IDMDocumentType.US1099MISCCopyBLaserCopy
			or  IDMDocumentType.US1099MISCCopyBConsolidated	
			or  IDMDocumentType.US1099MISCCopyCLaserCopy)
				LocalDocumentType	    =   "US1099MiscellaneousIncome"
			else		
			if (IDMDocumentType.US1099NECCopyAOriginalForm	
			or  IDMDocumentType.US1099NECCopyBLaserCopy
			or  IDMDocumentType.US1099NECCopyBConsolidated	
			or  IDMDocumentType.US1099NECCopyCLaserCopy)
				LocalDocumentType	    =   "US1099NonEmployeeCompensation"
			else
			if (IDMDocumentType.US1099INTCopyAOriginalForm
			or  IDMDocumentType.US1099INTCopyBLaserCopy
			or  IDMDocumentType.US1099INTCopyBConsolidated	
			or  IDMDocumentType.US1099INTCopyCLaserCopy)	
				LocalDocumentType       =   "US1099InterestIncome"
			else				
			if (IDMDocumentType.US1099DIVCopyAOriginalForm
			or  IDMDocumentType.US1099DIVCopyBLaserCopy
			or  IDMDocumentType.US1099DIVCopyBConsolidated	
			or  IDMDocumentType.US1099DIVCopyCLaserCopy)
				LocalDocumentType       =   "US1099DividendsAndDistributions"
			else					
			if (IDMDocumentType.US1099GCopyAOriginalForm
			or  IDMDocumentType.US1099GCopyBLaserCopy
			or  IDMDocumentType.US1099GCopyBConsolidated 
			or  IDMDocumentType.US1099GCopyCLaserCopy)
				LocalDocumentType       =   "US1099CertainGovernmentPayments"
			else						
			if (IDMDocumentType.US1099KCopyAOriginalForm
			or  IDMDocumentType.US1099KCopyBLaserCopy
			or  IDMDocumentType.US1099KCopyBConsolidated	
			or  IDMDocumentType.US1099KCopyCLaserCopy)
				LocalDocumentType       =   "US1099PaymentCardAndThirdParty"
			else
			if (IDMDocumentType.ReceivableInvoice
			or  IDMDocumentType.ReceivableInvoiceExpanded)
				LocalDocumentType		=	"ReceivableInvoice"
			else
			if (IDMDocumentType.ReceivableInvoiceEmail
			or  IDMDocumentType.ReceivableInvoiceExpandedEmail)
				LocalDocumentType		=	"ReceivableInvoiceEmail"
			else
			if (IDMDocumentType.IDMUserTemplate)
				LocalDocumentType		=	"IDMUserTemplate"
			else
			if (IDMDocumentType.InvoiceAndRegisterEmail)
				LocalDocumentType 		=   "InvoiceAndRegisterEmail"
			else
			if (IDMDocumentType.IntercompanyBillingInvoiceEmail)
				LocalDocumentType 		=   "IntercompanyBillingInvoiceEmail"
			else
			if (IDMDocumentType.AddendumDocument)
				LocalDocumentType		=	"AddendumDocument"
			else
			if (IDMDocumentType.KitchenOrder)
				LocalDocumentType		=	"KitchenOrder"
			else
			if (IDMDocumentType.Recipe)
				LocalDocumentType		=	"Recipe"
			else
			if (IDMDocumentType.SubleaseBillingInvoiceEmail)
				LocalDocumentType		=	"SubleaseBillingInvoiceEmail"
			else
			if (IDMDocumentType.SubleaseBillingInvoice)
				LocalDocumentType		=	"SubleaseBillingInvoice"
			else
			if (IDMDocumentType.EscheatmentNotice)
				LocalDocumentType		= 	"EscheatmentNotice"
			else
			if (IDMDocumentType.EscheatmentNoticeEmail)
				LocalDocumentType		=	"EscheatmentNoticeEmail"
			else
			if (IDMDocumentType.PaymentReceipt)
				LocalDocumentType		=	"PaymentReceipt"
			else
			if (IDMDocumentType.PaymentReceiptEmail)
				LocalDocumentType		=	"PaymentReceiptEmail"

			if (Email)
				return LocalDocumentType
			else
				return "FSM_" + LocalDocumentType
		
		OutputTemplateMessage is a DerivedField
			type is MessageField
			default label is "TemplateDocumentType"
			return "OutputTemplate"
			
		DerivedOutputFormat is a DerivedField
			type is Alpha size 50
			restricted
			if(OutputFormat.PDF)
				return ".pdf"
			if(OutputFormat.WordDocument)
				return ".docx"
	
		OutputTemplateDocumentType is a StringField
			type is Alpha size 20
			restricted
			"FSM_OutputTemplate"

		DocxNotSupportedByIDMPrint is a MessageField
			"Printing_Word_DocumentIsNotSupportedByIDM_Enterprise_Print."

	Sets
		ByName
			indexed
			Sort Order
				FinanceEnterpriseGroup
				Name
	
	Actions
		
		GenerateDocument is an Instance Action
			restricted
			Parameters
				XML 			is XMLDocument
				DocumentType 	is an IDMDocumentType
				FileName 		is an IDMFileName  
				ACL				is an IDMAccessControlList
				IDMAttributes 
				
			Parameter Rules
    			XML
    				required
    			DocumentType
    				required
    			FileName
    				required	
				  
			Action Rules
				invoke CreateFromGenerateDocument IDMJob
					invoked.IDMGenerateDocument.DocumentType 			= DocumentType
					invoked.IDMGenerateDocument.TemplateUniqueId   		= IDMUniqueId
					invoked.IDMGenerateDocument.XML			   			= XML
					invoked.IDMGenerateDocument.FileName     			= FileName + DerivedOutputFormat
					invoked.Description 								= FileName
					invoked.IDMGenerateDocument.IDMAccessControlList 	= ACL
					invoked.IDMGenerateDocument.IDMAttributes			= IDMAttributes
		
		Create is a Create Action
			Field Rules
			Entrance Rules
				include DefaultsAndValidations
				include CreateValidations
				
			Action Rules
				include IDMUpload
		
		CreateEmailTemplate is a Create Action
			default label is "Create"
			Field Rules
			Entrance Rules
				Email = true
				include DefaultsAndValidations
				include CreateValidations
				
			Action Rules
				include IDMUpload
		
		Update is an Update Action
			
			Entrance Rules
				include DefaultsAndValidations
				
				constraint (Name not changed)
					"CannotChangename"
				
				constraint (DocumentTemplate.MimeType not entered 
				or  		DocumentTemplate.MimeType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
					"TemplateMustBeA(.docx)File")
						
			Action Rules
				IDMItem.IDMUniqueId		= IDMUniqueId
				IDMItem.DocumentType	= OutputTemplateDocumentType
				if (DocumentTemplate entered)
					IDMItem.Attachment	= DocumentTemplate
					Execute 			= IDMItem.Update
		
		Delete is a Delete Action
			Local Fields
				Execute is Boolean
			Action Rules
				IDMItem.IDMUniqueId		= IDMUniqueId
				IDMItem.DocumentType	= OutputTemplateDocumentType
				Execute					= IDMItem.Delete


		IDMUpload is an Update Action	
			restricted
			Action Rules	
				initialize IDMUniqueId
				include IDMUpload


		Activate is an Instance Action
			valid when (not Active)
			Action Rules
				Active = true
		
		Deactivate is an Instance Action
			valid when (Active)
			Action Rules
				initialize Active
		
		BackUpIDMTemplates is a Set Action
			restricted
			Parameters
				PrmFinanceEnterpriseGroup is a FinanceEnterpriseGroup
			
			Instance Selection
				where (FinanceEnterpriseGroup = PrmFinanceEnterpriseGroup)
			
			Action Rules					
				Instance Rules
					IDMItem.IDMUniqueId     = IDMUniqueId
					IDMItem.DocumentType    = OutputTemplateDocumentType
					IDMItem.OverrideUser	= true
					if (IDMItem.RetrieveResource)
						IDMStoredTemplate	= IDMItem.RetrievedAttachment

		UploadIDMTemplates is a Set Action	
			restricted
			
			Instance Selection
				where (IncludeTemplatesInTenantRefresh
				and    IDMStoredTemplate entered)
			
			Action Rules
				Instance Rules
					IDMItem.OverrideUser	= true
					DocumentTemplate		= IDMStoredTemplate
					include IDMUpload
		
