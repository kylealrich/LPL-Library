TrueCostDriverEventInterface is a BusinessClass
	owned by truecost	
	prefix is TCDVI
	default label is "True\CostDriverEventInterfaceMaintenance"
	Ontology
		symbolic key is TrueCostDriverEventInterface
		
	Patterns
		disable Auditing
		disable EffectiveDated
		disable AsOfDateProcessing
			
	Persistent Fields
		
		TrueCostDriver						is Alpha 25
		AccountingEntity					is like AccountingEntity
		Department							is Alpha 15
		CostObject							is Alpha 15
        Amount								is Decimal 19.3
        	default label is "Value"
        EventDate							is Date
        ErrorDescription					is Alpha 60
       
    Local Fields    	
    	LocalLastSequence			        is Numeric 4
    	LocalTrueCostConfiguration			is like TrueCostConfiguration
    	LocalRunGroup						is like RunGroup
    	LocalAlphaDay						is Alpha 3
		LocalAlphaYear						is Alpha 4
		LocalDeleteRunGroup					is like RunGroup
		LocalCopyFromRunGroup				is like RunGroup
    
    Transient Fields
    	TransientTrueCostDriver				is AlphaUpper 25
			default label is "True\CostDriver"
			derive value from TrueCostDriver
    	  	
	Derived Fields
		DriverIsNotDefined					is a MessageField
			restricted
			"DriverIsNotDefined"
		DriverIsRequired					is a MessageField
			restricted
			"DriverFieldIsRequired"
		DriverEventAlreadyExist				is a MessageField
			restricted
			"DriverEventAlreadyExist"
		DepartmentIsRequired				is a MessageField
			restricted
			"DepartmentFieldIsRequired"
		DepartmentNotDefined				is a MessageField
			restricted
			"DepartmentIsNotDefined"
		DepartmentMustBePosting				is a MessageField
			restricted
			"DepartmentMustBePosting"
		CostObjectNotDefined				is a MessageField
			restricted
			"CostObjectIsNotDefined"
		AccountingEntityNotDefined			is a MessageField
			restricted
			"AccountingEntityIsNotDefined"
		AmountCannotBeNegative				is a MessageField
			restricted
			"DriverEventCannotBeNegative"
		JulianDate is a DerivedField
			type is AlphaUpper 7
			restricted
			LocalAlphaYear = EventDate year
			LocalAlphaDay  = EventDate year day
			JulianDate = LocalAlphaYear
			if (LocalAlphaDay size = 1)
				JulianDate += "00"
			else
			if (LocalAlphaDay size = 2)
				JulianDate += "0"
			JulianDate += LocalAlphaDay
		
			
	Conditions
		ErrorTransaction
			restricted
			when (ErrorDescription entered)
				
	Field Rules
		TrueCostConfiguration
			required
		TrueCostDriver
			required
		EventDate
			required
		AccountingEntity
			required
		Department
			required
				"<DepartmentIsRequired>"
        Amount
        
        
							
	Relations
		
		AccountingEntityRel
			one-to-one relation to AccountingEntity
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup	=	TrueCostConfiguration	
				related.AccountingEntity		=	AccountingEntity
				
		TrueCostDriverRel
			one-to-many relation to TrueCostDriver
			Field Mapping uses symbolic key
				related.TrueCostConfiguration	=	TrueCostConfiguration	
				related.TrueCostDriver			=	TrueCostDriver
		
		TrueCostDriverEventRel
			one-to-one relation to TrueCostDriverEvent
			Field Mapping uses symbolic key
				related.TrueCostConfiguration					=	TrueCostConfiguration	
				related.TrueCostDriver	                        =   TrueCostDriver
				related.AccountingEntity						=	AccountingEntity	
				related.TrueCostDriverEvent.Department	        = 	Department				
		        related.TrueCostDriverEvent.CostObject		    = 	CostObject		
    			related.TrueCostDriverEvent.EventDateJulian	    = 	JulianDate
			
		DepartmentAccountingUnitRel
			one-to-one relation to AccountingUnit
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.AccountingEntity		= AccountingEntity
				related.AccountingUnit			= Department

		Department1Rel
			one-to-one relation to FinanceDimension1
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension1 		= Department

		Department2Rel
			one-to-one relation to FinanceDimension2
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension2 		= Department

		Department3Rel
			one-to-one relation to FinanceDimension3
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension3 		= Department

		Department4Rel
			one-to-one relation to FinanceDimension4
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension4 		= Department

		Department5Rel
			one-to-one relation to FinanceDimension5
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension5 		= Department

		Department6Rel
			one-to-one relation to FinanceDimension6
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension6 		= Department

		Department7Rel
			one-to-one relation to FinanceDimension7
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension7 		= Department

		Department8Rel
			one-to-one relation to FinanceDimension8
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension8 		= Department

		Department9Rel
			one-to-one relation to FinanceDimension9
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension9 		= Department

		Department10Rel
			one-to-one relation to FinanceDimension10
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension10 		= Department
				
		Department1SummaryRel
			one-to-many relation to FinanceDimension1
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension1 		= Department
			Instance Selection
				where (related.FinanceDimension1.DimensionType.Summary)

		Department2SummaryRel
			one-to-many relation to FinanceDimension2
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension2 		= Department
			Instance Selection
				where (related.FinanceDimension2.DimensionType.Summary)

		Department3SummaryRel
			one-to-many relation to FinanceDimension3
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension3 		= Department
			Instance Selection
				where (related.FinanceDimension3.DimensionType.Summary)

		Department4SummaryRel
			one-to-many relation to FinanceDimension4
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension4 		= Department
			Instance Selection
				where (related.FinanceDimension4.DimensionType.Summary)

		Department5SummaryRel
			one-to-many relation to FinanceDimension5
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension5 		= Department
			Instance Selection
				where (related.FinanceDimension5.DimensionType.Summary)

		Department6SummaryRel
			one-to-many relation to FinanceDimension6
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension6 		= Department
			Instance Selection
				where (related.FinanceDimension6.DimensionType.Summary)

		Department7SummaryRel
			one-to-many relation to FinanceDimension7
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension7 		= Department
			Instance Selection
				where (related.FinanceDimension7.DimensionType.Summary)

		Department8SummaryRel
			one-to-many relation to FinanceDimension8
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension8 		= Department
			Instance Selection
				where (related.FinanceDimension8.DimensionType.Summary)

		Department9SummaryRel
			one-to-many relation to FinanceDimension9
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension9 		= Department
			Instance Selection
				where (related.FinanceDimension9.DimensionType.Summary)

		Department10SummaryRel
			one-to-many relation to FinanceDimension10
			Field Mapping uses symbolic key	
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension10 		= Department
			Instance Selection
				where (related.FinanceDimension10.DimensionType.Summary)

		CostObject1Rel
			one-to-one relation to FinanceDimension1
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension1 		= CostObject

		CostObject2Rel
			one-to-one relation to FinanceDimension2
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension2 		= CostObject

		CostObject3Rel
			one-to-one relation to FinanceDimension3
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension3 		= CostObject

		CostObject4Rel
			one-to-one relation to FinanceDimension4
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension4 		= CostObject

		CostObject5Rel
			one-to-one relation to FinanceDimension5
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension5 		= CostObject

		CostObject6Rel
			one-to-one relation to FinanceDimension6
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension6 		= CostObject

		CostObject7Rel
			one-to-one relation to FinanceDimension7
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension7 		= CostObject

		CostObject8Rel
			one-to-one relation to FinanceDimension8
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension8 		= CostObject

		CostObject9Rel
			one-to-one relation to FinanceDimension9
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension9 		= CostObject

		CostObject10Rel
			one-to-one relation to FinanceDimension10
			Field Mapping uses symbolic key
				related.FinanceEnterpriseGroup 	= TrueCostConfiguration	
				related.FinanceDimension10 		= CostObject
				
		RunGroupOtherRel
			one-to-many relation to TrueCostDriverEventInterface
			Field Mapping uses symbolic key
			Instance Selection
				where(related.TrueCostDriverEventInterface.RunGroup = TrueCostDriverEventInterface.RunGroup)
				
		RunGroupParamRel
			one-to-many relation to TrueCostDriverEventInterface
			Field Mapping uses symbolic key
				related.TrueCostConfiguration								= LocalTrueCostConfiguration
			Instance Selection
				where(related.TrueCostDriverEventInterface.RunGroup = LocalRunGroup)
				
		RunGroupDeleteRel
			one-to-many relation to TrueCostDriverEventInterface
			Field Mapping uses symbolic key
			Instance Selection
				where(related.TrueCostDriverEventInterface.RunGroup = LocalDeleteRunGroup)
				
		CopyRunGroupRel
			one-to-many relation to TrueCostDriverEventInterface
			Field Mapping uses symbolic key
				related.TrueCostConfiguration								= LocalTrueCostConfiguration
			Instance Selection
				where(related.TrueCostDriverEventInterface.RunGroup = LocalCopyFromRunGroup)
		
	Rule Blocks		
	
	Actions
		Create is a Create Action
			Entrance Rules
				LocalLastSequence = last RunGroupOtherRel.TrueCostDriverEventInterface.Sequence			
				if(!TrueCostDriverEventInterface.Sequence entered)
					TrueCostDriverEventInterface.Sequence = (LocalLastSequence + 1)
			Action Rules
				TrueCostDriver = TransientTrueCostDriver
		
		Update is an Update Action
			Action Rules
		
		Delete is a Delete Action
		
		Purge is a Purge Action
			restricted
			
		InterfaceDriverEvents 	is a Set Action						
			Parameters				
				PrmTrueCostConfiguration 		is a TrueCostConfiguration
					default label is "True\CostConfiguration"
				PrmRunGroup						is a RunGroup
					default label is "RunGroup"
				PrmUpdate						is Boolean
					default label is "UpdateExistingRecords"
						
			Parameter Rules		
				PrmTrueCostConfiguration
					required					
				PrmRunGroup
					required
						"Run_GroupIsRequired"
					LocalTrueCostConfiguration	=	PrmTrueCostConfiguration
					LocalRunGroup				=	PrmRunGroup				
					constraint(RunGroupParamRel exists)
						"Run_GroupDoesNotExist"
					LocalFirstCount =	instance count of RunGroupParamRel
				
			Instance Selection				
				where(TrueCostConfiguration = PrmTrueCostConfiguration
				and	TrueCostDriverEventInterface.RunGroup = PrmRunGroup)		
									
			Local Fields
				
				LocalFirstCount						is Numeric 10
				LocalFinalCount						is Numeric 10
				LocalActor							is an Actor
			Action Rules
				
				Set Rules
					Entrance Rules
						LocalActor = actor					
					Exit Rules
						LocalFinalCount =	LocalFirstCount - instance count of RunGroupParamRel					
						send notification
							to LocalActor
							description is "ImportTo_True\Cost_Driver\EventHasCompleted"
							priority is high
							detail is "NumberOfSuccessfulRecords<LocalFinalCount>.___NumberOfFailedRecords<instance count of RunGroupParamRel>.___TotalRecordsProcessed<LocalFirstCount>"
							
				Instance Rules
					initialize ErrorDescription
					
					if((TrueCostConfiguration.DepartmentIsAccountingUnit
					and DepartmentAccountingUnitRel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension1
					and Department1Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension2
					and Department2Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension3
					and Department3Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension4
					and Department4Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension5
					and Department5Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension6
					and Department6Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension7
					and Department7Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension8
					and Department8Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension9
					and Department9Rel not exists)
					or (TrueCostConfiguration.DepartmentIsDimension10
					and Department10Rel not exists))
						ErrorDescription = DepartmentNotDefined
						
					if((TrueCostConfiguration.DepartmentIsDimension1
					and Department1SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension2
					and Department2SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension3
					and Department3SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension4
					and Department4SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension5
					and Department5SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension6
					and Department6SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension7
					and Department7SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension8
					and Department8SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension9
					and Department9SummaryRel exists)
					or (TrueCostConfiguration.DepartmentIsDimension10
					and Department10SummaryRel exists))
						ErrorDescription = DepartmentMustBePosting

					if (CostObject entered)
						if((TrueCostConfiguration.CostObjectIsDimension1
						and CostObject1Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension2
						and CostObject2Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension3
						and CostObject3Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension4
						and CostObject4Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension5
						and CostObject5Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension6
						and CostObject6Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension7
						and CostObject7Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension8
						and CostObject8Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension9
						and CostObject9Rel not exists)
						or (TrueCostConfiguration.CostObjectIsDimension10
						and CostObject10Rel not exists))
							ErrorDescription = CostObjectNotDefined
					
					if(Department not entered)
						ErrorDescription = DepartmentIsRequired
					
					if(TrueCostDriverRel not exists)
						ErrorDescription = DriverIsNotDefined
											
					if(AccountingEntityRel not exists)
						ErrorDescription = AccountingEntityNotDefined
											
					if(TrueCostDriver not entered)
						ErrorDescription = DriverIsRequired
					
					if(Amount < 0)
						ErrorDescription = AmountCannotBeNegative
						
					if (!ErrorDescription entered)
						if(!PrmUpdate and TrueCostDriverEventRel exists)
							ErrorDescription = DriverEventAlreadyExist
																																																													
					if (!ErrorDescription entered)
						if(PrmUpdate and TrueCostDriverEventRel exists)
							invoke Update TrueCostDriverEventRel
								invoked.Amount 										=  Amount
						else
							invoke Create TrueCostDriverEvent
								resume on error
									ErrorDescription = error message							
					        	invoked.TrueCostConfiguration						=  TrueCostConfiguration
					        	invoked.TrueCostDriver 								=  TrueCostDriver
					        	invoked.TrueCostDriverEvent.Department 				=  Department
					        	invoked.AccountingEntity 							=  AccountingEntity
					        	invoked.TrueCostDriverEvent.CostObject 				=  CostObject		
					        	invoked.TrueCostDriverEvent.EventDate 				=  EventDate
					        	invoked.Amount 										=  Amount				
					        				        
					if (!ErrorDescription entered)
						invoke Delete
									
		DeleteAllTransactionsForRunGroup is a Set Action
			default label is "DeleteAllTransactionsForRunGroup"
			Parameters
				PrmRunGroup						is a RunGroup
					default label is "RunGroup"
			Parameter Rules
				PrmRunGroup
					required
						"Run_GroupIsRequired"
					LocalDeleteRunGroup		=	PrmRunGroup				
					constraint(RunGroupDeleteRel exists)
						"Run_GroupDoesNotExist"
			Instance Selection				
				where(TrueCostDriverEventInterface.RunGroup = PrmRunGroup)
			
			Action Rules
				Instance Rules
					invoke Delete
					
		CopyRunGroup					is a Set Action
			default label is "CopyRunGroup"
			
			Parameters
				PrmTCConfig				is a TrueCostConfiguration
					default label is "True\CostConfiguration"
				PrmRunGroupFrom			is a RunGroup
					default label is "Copy_from_RunGroup"
				PrmRunGroupTo			is a RunGroup
					default label is "Copy_to_RunGroup"
					
			Parameter Rules
				PrmTCConfig
					required
				PrmRunGroupFrom
					required
					LocalTrueCostConfiguration = PrmTCConfig
					LocalCopyFromRunGroup = PrmRunGroupFrom
					constraint (CopyRunGroupRel exists)
						"Source_Run_Group_does_not_exist"
					constraint (PrmRunGroupFrom != PrmRunGroupTo)
						"CopyFrom_Run_GroupCannotBeTheSameAsCopyTo_Run_Group"
				PrmRunGroupTo
					required
					
			Instance Selection
				where (TrueCostConfiguration = PrmTCConfig
				and TrueCostDriverEventInterface.RunGroup = PrmRunGroupFrom)
				
			Action Rules
				
				Instance Rules
					invoke Create TrueCostDriverEventInterface
						fill in fields from this instance
							except invoked.RunGroup
						invoked.RunGroup				= PrmRunGroupTo
