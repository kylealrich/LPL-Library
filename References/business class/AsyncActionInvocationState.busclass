AsyncActionInvocationState is a BusinessClass
    owned by async
    prefix is AAIS
    stored in environment
    default label is "AsyncActionInvocationState"
	
    Ontology
    	symbolic key is AsyncActionInvocationState

	Patterns
        disable AsOfDateProcessing
        disable EffectiveDated
        disable Auditing
	
	Persistent Fields
	
		Actor
		DataArea
		AsyncActionInvocationStatus
		BeginModOffsetDays	is Numeric 3
			default label is "SelectJobsModifiedWithinPastDays"
		BeginModTimeStamp	is TimeStamp
			default label is "SelectJobsModifiedSince"

	Local Fields
		LocalDataArea is a DataArea
		LocalActor		is an Actor
				
	Derived Fields
	
		AsyncActionInvocationsInStateCount is a ConditionalField
            type is Decimal 10
            default label is "JobsInState"
            
            if (Actor entered) 
            	(instance count of ActorTopLevelAsyncActionInvocationsInStateRel)
        	else 
            	(instance count of GlobalTopLevelAsyncActionInvocationsInStateRel)

        ThruBeginModTimeStamp is a DerivedField
        	type is TimeStamp
        	
        	ThruBeginModTimeStamp = blank
        	
        	if (BeginModOffsetDays != blank)
        		ThruBeginModTimeStamp = (system current timestamp - BeginModOffsetDays as days)
    		else
    		if (BeginModTimeStamp != blank)
         		ThruBeginModTimeStamp = BeginModTimeStamp
         		
     		return ThruBeginModTimeStamp
        
        StateStatusMessage is a MessageField
            restricted
            "<AsyncActionInvocationStatus>"    
     		
		ModifiedSinceMessage is a MessageField
			restricted
			"Status_'<AsyncActionInvocationStatus>'_modifiedSince<ThruBeginModTimeStamp>"   		
    		
		ThruBeginModTimeStampText is a DerivedField
			type is Alpha 50
			
			if (ThruBeginModTimeStamp = blank)
				return StateStatusMessage
			else
				return ModifiedSinceMessage

		IsActorStateRecord is a DerivedField
			type is Boolean
			default label is untranslatable
    		if (Actor not = blank)
    			return true
    		else
    			return false

		IsGlobalStateRecord is a DerivedField
    		type is Boolean
    		default label is untranslatable
    		if (Actor = blank)
    			return true
    		else
    			return false
        	
    Field Rules

		Actor
			cannot be changed
            
    	DataArea
    		required
    		cannot be changed
    		initial value is parentcontext.dataarea
			default to parentcontext.dataarea
			
		AsyncActionInvocationStatus
			required
			cannot be changed

		BeginModOffsetDays
			default to 0
			
            constraint (BeginModTimeStamp = blank or BeginModOffsetDays = blank)
 				"CannotEnterBothModifiedWithinPastDaysAndModifiedSince"

			constraint (BeginModOffsetDays >= 0)
				"WithinPastDaysCannotBeNegative"
		
 
	Relations
	
		ActorTopLevelAsyncActionInvocationsInStateRel
            one-to-many relation to AsyncActionInvocation
            Field Mapping uses ByActorDataAreaStatusLastModTime
            	related.Actor = Actor
            	related.DataArea = DataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus
        	Instance Selection
        		where (related.LastModTime  >= ThruBeginModTimeStamp)

		GlobalTopLevelAsyncActionInvocationsInStateRel
            one-to-many relation to AsyncActionInvocation
            Field Mapping uses ByDataAreaStatusLastModTime
            	related.DataArea = DataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus
        	Instance Selection
        		where (related.LastModTime  >= ThruBeginModTimeStamp)
		
        AsyncActionInvocationPendingSchedulingStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.PendingScheduling

        AsyncActionInvocationQueuedStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.Queued

        AsyncActionInvocationPendingStartStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.PendingStart
			
        AsyncActionInvocationLostWhilePendingStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.LostWhilePending
			
        AsyncActionInvocationFailedToStartStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.FailedToStart
			
        AsyncActionInvocationInProgressStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.InProgress
			
        AsyncActionInvocationLostWhileInProgressStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.LostWhileInProgress
			
        AsyncActionInvocationTerminatedAbnormallyStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.TerminatedAbnormally
			
        AsyncActionInvocationFinishedStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.Finished
			
        AsyncActionInvocationInRetryStateRel                
            one-to-one relation to AsyncActionInvocationState
            Field Mapping uses ByActorDataAreaInvocationStatus
            	related.Actor = LocalActor
            	related.DataArea = LocalDataArea
                related.AsyncActionInvocationStatus = AsyncActionInvocationStatus.InRetry

		ActorAllDataareaAsyncActionInvocationsRel
            one-to-many relation to AsyncActionInvocation
            Field Mapping uses ByActorDataAreaStatusLastModTime
            	related.Actor = Actor
            	related.DataArea = DataArea

		GlobalAllDataareaAsyncActionInvocationsRel
            one-to-many relation to AsyncActionInvocation
            Field Mapping uses ByDataAreaStatusLastModTime
            	related.DataArea = DataArea
		
	Sets

		ByActorDataAreaInvocationStatus
			indexed
			Sort Order
				Actor
				DataArea
				AsyncActionInvocationStatus

	Rule Blocks
	
        AddMissingStates
            if (not AsyncActionInvocationPendingSchedulingStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.PendingScheduling
    
            if (not AsyncActionInvocationQueuedStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.Queued

            if (not AsyncActionInvocationPendingStartStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.PendingStart
                 
            if (not AsyncActionInvocationLostWhilePendingStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.LostWhilePending
 
            if (not AsyncActionInvocationFailedToStartStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.FailedToStart
	
            if (not AsyncActionInvocationInProgressStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.InProgress
	
            if (not AsyncActionInvocationLostWhileInProgressStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.LostWhileInProgress
			
            if (not AsyncActionInvocationTerminatedAbnormallyStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.TerminatedAbnormally
                 
            if (not AsyncActionInvocationFinishedStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.Finished
                 
            if (not AsyncActionInvocationInRetryStateRel exists)
                invoke Create AsyncActionInvocationState
                    invoked.Actor = LocalActor
                    invoked.DataArea = LocalDataArea
                    invoked.AsyncActionInvocationStatus = AsyncActionInvocationStatus.InRetry
	

	Actions
		Create is a Create Action
            restricted

		Update is an Update Action
             
		Delete is a Delete Action
            restricted

        AddStateToActorChart is a Create Action
        	default label is "AddStateToActor'sStateChart"
        	
        	Action Rules
        		Actor = actor
        
        AddAllStatesToActorChart is a Set Action
        	default label is "AddAllStatesToActors'sStateChart"
            run in foreground
            
            Rule Blocks
                AddActorMissingStates
                

	           		LocalDataArea = parentcontext.dataarea
	           		LocalActor = actor
	           		
	           		include AddMissingStates
               
            Action Rules
                Empty Set Rules
                    include AddActorMissingStates

                Set Rules
                    Entrance Rules
                        include AddActorMissingStates

        AddStateToGlobalChart is a Create Action
        	default label is "AddStateToGlobalStateChart"
        	
        	Action Rules
        		Actor = blank
        
        AddAllStatesToGlobalChart is a Set Action
        	default label is "AddAllStatesToGlobalStateChart"
            run in foreground
        
            Rule Blocks
                AddGlobalMissingStates
                

	           		LocalDataArea = parentcontext.dataarea
	           		LocalActor = blank
	           		
	           		include AddMissingStates
               
            Action Rules
                Empty Set Rules
                    include AddGlobalMissingStates

                Set Rules
                    Entrance Rules
                        include AddGlobalMissingStates

        RemoveStateFromChart is a Delete Action
				
	Create Rules
		if ((AsyncActionInvocationStatus.Finished or AsyncActionInvocationStatus.PendingScheduling) and (BeginModOffsetDays not entered and BeginModTimeStamp not entered))
			BeginModOffsetDays = 5
