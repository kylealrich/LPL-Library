RecallNoticeTaskProduct is a BusinessClass
    owned by recall
    prefix is RMTP

    Ontology
    	symbolic key is RecallNoticeTaskProduct
    
    Patterns
        disable Auditing		
        disable EffectiveDated	
        implements DynamicCreation
        		 	
    Persistent Fields
		QuantityIdentified is Decimal size 13.4
			precision is RecallProduct.DerivedNumberOfDecimals
			
	Local Fields
		LocalItem	is a RecallProductItem
		LocalFromReassignTask is Boolean
		
	Derived Fields
		ViewQuestionsMessage is a LabelField
			restricted
			"ViewQuestions"
			
		AnswerQuestionsMessage is a LabelField
			restricted
			"AnswerQuestions"
			
		EditQuestionsMessage is a LabelField
			restricted
			"EditAnswers"
			
		EnterQuantitiesMessage is a LabelField
			restricted
			"EnterQuantities"
		
		EditQuantitiesMessage is a LabelField
			restricted
			"EditQuantities"
			
		ViewItemsMessage is a LabelField
			restricted
			"ViewItems"

		QuestionsComplete is a LabelField
			restricted
			"AllQuestionsDone"	

		QuestionsIncomplete is a LabelField
			restricted
			"UnansweredQuestions"		
		
		DerivedQuestionLabel is a DerivedField
			type is Alpha 20
			restricted
			if (!RecallNotice.Status.Active
			or   RecallNoticeTask.Status.Completed
			or   RecallNoticeTask.Status.New)
				return ViewQuestionsMessage
			else
			if (TaskProductAnsweredQuestionCount = 0)
				return AnswerQuestionsMessage
			else
				return EditQuestionsMessage

		DerivedItemsLabel is a DerivedField
			type is Alpha 20
			restricted
			if (RecallNoticeTask.AllowQuantityUpdates)
				if (QuantityIdentified = 0)
					return EnterQuantitiesMessage
				else
					return EditQuantitiesMessage
			else
				return ViewItemsMessage

		DerivedQuestionsLabel is a DerivedField
			type is Alpha 20
			if (HasRemainingRequiredQuestions)
				return QuestionsIncomplete
			else
				return QuestionsComplete

		RequiredQuestionAlertMessage is a MessageField
			restricted
			"<RemainingRequiredQuestions>OutOf<TaskProductRequiredQuestionCount>RequiredQuestionsHaveNotYetBeenAnswered"
			
		Questions1Message is a MessageField
			restricted
			"NumberOfQuestions"
			
		Questions2Message is a MessageField
			restricted
			"NumberOfRequiredQuestions"
			
		Questions3Message is a MessageField
			restricted
			"NumberOfQuestionsAnswered"
			
		TaskProductQuestionCount is a DerivedField
			type is Numeric 3
			restricted
			default label is "<Questions1Message>"
			return (instance count of RecallProduct.RecallProductQuestion set)
		
		TaskProductRequiredQuestionCount is a DerivedField
			type is Numeric 3
			restricted
			default label is "<Questions2Message>"
			return (instance count of RequiredRecallProductQuestionsRel)

		TaskProductAnsweredQuestionCount is a DerivedField
			type is Numeric 3
			restricted
			default label is "<Questions3Message>"
			return (instance count of ResponseToRecallProductQuestionRel)

		TaskProductRequiredAnswersQuestionCount is a DerivedField
			type is Numeric 3
			restricted
			default label is "<Questions3Message>"
			return (instance count of RequiredResponsesToRecallProductQuestionRel)

		RemainingRequiredQuestions is a DerivedField
			type is Numeric 3
			restricted
			return (TaskProductRequiredQuestionCount - TaskProductRequiredAnswersQuestionCount)
			
		DisplayQuantity is a DerivedField
			type is Alpha 20
			return QuantityIdentified
			
	Field Rules
     		
	Conditions
		HasTransactionRequisitionLines
			restricted
   			when (RequisitionLineTransactionActivityRel exists)
		
		ShowSummaryTransactionRequisitionLines
			restricted
   			when (HasTransactionRequisitionLines
			and   !RecallNoticeTask.ShowDetail)
		
		ShowDetailTransactionRequisitionLines
			restricted
   			when (HasTransactionRequisitionLines
			and   RecallNoticeTask.ShowDetail)
		
		HasTransactionProcurementTemplateLines
			restricted
			when (ProcurementTemplateLineTransactionActivityRel exists)
		
		HasTransactionPatientProcedureLines
			restricted
			when (PatientProcedureTransactionActivityRel exists)
		
		HasTransactionContractLines
			restricted
			when (ContractLineTransactionActivityRel exists)
			
		HasTransactionSourcingEventLines
			restricted
			when (SourcingEventLineTransactionActivityRel exists)
			
		HasTransactionPurchaseOrderLines
			restricted
			when (PurchaseOrderLineTransactionActivityRel exists)
		
		ShowSummaryTransactionPurchaseOrderLines
			restricted
			when (HasTransactionPurchaseOrderLines
			and   !RecallNoticeTask.ShowDetail)
		
		ShowDetailTransactionPurchaseOrderLines
			restricted
			when (HasTransactionPurchaseOrderLines
			and   RecallNoticeTask.ShowDetail)
		
		HasTransactionPolinesrc
			restricted
			when (PolinesrcTransactionActivityRel exists)
		
		ShowSummaryTransactionPolinesrc
			restricted
			when (HasTransactionPolinesrc
			and   !RecallNoticeTask.ShowDetail)
		
		ShowDetailTransactionPolinesrc
			restricted
			when (HasTransactionPolinesrc
			and   RecallNoticeTask.ShowDetail)
		
		HasTransactionInventory
			restricted
			when (InventoryTransactionActivityRel exists)
		
		HasTransactionParLocations
			restricted
			when (ParLocationTransactionActivityRel exists)
		
		HasTransactionIntransitTransfers
			restricted
			when (IntransitTransferTransactionActivityRel exists)
		
		HasTransactionIssues
			restricted
			when (RecentIssueTransactionActivityRel exists)
		
		ShowSummaryTransactionIssues
			restricted
			when (HasTransactionIssues
			and   !RecallNoticeTask.ShowDetail)
		
		ShowDetailTransactionIssues
			restricted
			when (HasTransactionIssues
			and   RecallNoticeTask.ShowDetail)
		
		HasTransactionEquipment
			restricted
			when (EquipmentTransactionActivityRel exists)
		
		HasTransactionSerialNumbers
			restricted
			when (SerialNumberTransactionActivityRel exists)
		
		HasTransactionLotNumbers
			restricted
			when (LotNumberTransactionActivityRel exists)
		
		HasTransactionIssueDetail
			restricted
			when (IssueDetailTransactionActivityRel exists)
		
		HasTransactionIntransitTransfersDetail
			restricted
			when (IntransitTransferDetailTransactionActivityRel exists)
		
		CanAnswerQuestions 
			restricted 
			when (RecallNoticeTask.IsOwner 
			or    RecallNotice.MyCoordinatorNotices)
		
		HasProductQuestions
			restricted
			when (RecallProduct.HasProductQuestions)
			
		ShowProductQuestions
			restricted
			when (HasProductQuestions
			and   LocationActivityRel exists)

		ShowProductQuestionsUpdate
			restricted
			when (HasProductQuestions
			and   LocationActivityRel exists
			and   CanAnswerQuestions
			and   RecallNoticeTask.Status.Accepted)
			
		ShowProductQuestionsNoUpdateNoAnswers
			restricted
			when (HasProductQuestions
			and   LocationActivityRel exists
			and  !HasProductQuestionAnswers
			and  (!CanAnswerQuestions
			or    RecallNoticeTask.Status.New
			or    RecallNoticeTask.Status.Completed))

		ShowProductQuestionsWithAnswers 
			restricted 
			when (HasProductQuestions
			and   LocationActivityRel exists
			and   HasProductQuestionAnswers
			and  (RecallNoticeTask.Status.Completed
			or    RecallNoticeTask.Status.New
			or   !CanAnswerQuestions))
		
		HasLocationActivity
			restricted
			when (LocationActivityRel exists)
			
		HasProductQuestionAnswers
			restricted
			when (ResponseToRecallProductQuestionRel exists)
			
		HasSerialNumbers
			restricted
			when (ProductSerialRel exists)
			
		HasLotNumbers
			restricted
			when (ProductLotRel exists)
			
		HasEquipmentSerialNumbers
			restricted
			when (ProductEquipmentSerialRel exists)
					
		HasRemainingRequiredQuestions
			restricted
			when (RemainingRequiredQuestions > 0
			and   ShowProductQuestions)
			
		HasTaskItems
			restricted
			when (RecallProductTaskItemRel exists)
			
		ShowEnterQuantityInstanceAction
			restricted
			when (RecallNoticeTask.AllowQuantityUpdates
			and   QuantityNotEnteredRel exists)
			
		UseProductInstructions
			restricted
			when (RecallNoticeTask.RecallTaskInstruction !entered)

		HasOrganizationsOnly
			restricted
			when (ManualOrganizationRel exists)
			
	Relations
		ManualOrganizationRel
			one-to-many relation to RecallNoticeOrganization
			Field Mapping uses symbolic key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
			Instance Selection
				where (related.FromManualTask
				and    related.AssignedUser = RecallNoticeTask.Owner)
		
		RequisitionLineTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 1 
	
		ProcurementTemplateLineTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 2 
		
		PatientProcedureTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 17 
		
		PurchaseOrderLineTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 4 
	
		InventoryTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 5 
				
		ParLocationTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 6 
		
		IntransitTransferTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 7 
		
		RecentIssueTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 8 
		
		EquipmentTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 9 
				
		SerialNumberTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 10 
		
		LotNumberTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 11 
	
		SourcingEventLineTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 12 
		
		ContractLineTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 13 
				
		PolinesrcTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 14 
	
		IssueDetailTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 15 
		
		IntransitTransferDetailTransactionActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
				related.ActivityType	 = 16 
		
		ProductSerialRel
			one-to-many relation to RecallProductSerial
			Field Mapping uses symbolic key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
				related.RecallProduct    = RecallProduct
				
		ProductEquipmentSerialRel
			one-to-many relation to RecallEquipmentSerial
			Field Mapping uses symbolic key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
				related.RecallProduct    = RecallProduct
		
		ProductLotRel
			one-to-many relation to RecallProductLot
			Field Mapping uses symbolic key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
				related.RecallProduct    = RecallProduct
		
		ResponseToRecallProductQuestionRel
			one-to-many relation to ResponseToRecallProductQuestion
			Field Mapping uses part of key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct    = RecallProduct   
		
		RequiredResponsesToRecallProductQuestionRel
			one-to-many relation to ResponseToRecallProductQuestion
			Field Mapping uses part of key
				related.RecallGroup      = RecallGroup
				related.RecallNotice     = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct    = RecallProduct
			Instance Selection
				where (related.RecallProductQuestion.ResponseRequired)   
		
		RequiredRecallProductQuestionsRel is a RecallProductQuestion set
  			Instance Selection
  				where (related.ResponseRequired)
						
		LocationActivityRel
			one-to-many relation to RecallProductTransactionTask
			Field Mapping uses ByTaskProduct
				related.RecallGroup		 = RecallGroup
				related.RecallNotice	 = RecallNotice
				related.RecallNoticeTask = RecallNoticeTask
				related.RecallProduct	 = RecallProduct
			Instance Selection
	   			where (related.ActivityType.RequisitionLines
   				or	   related.ActivityType.Issues
   				or     related.ActivityType.PurchaseOrderLines
   				or     related.ActivityType.Polinesrc
   				or     related.ActivityType.Inventory
	   			or	   related.ActivityType.ParLocations
   				or	   related.ActivityType.IntransitTransfers
   				or	   related.ActivityType.Itserial
   				or	   related.ActivityType.StockOnHandDetail)	
		
		RecallProductItemRel
    		one-to-many relation to RecallProductItem
    		Field Mapping uses symbolic key
				related.RecallGroup			= RecallGroup
				related.RecallNotice		= RecallNotice
				related.RecallProduct	 	= RecallProduct
		
		RecallProductTaskItemRel
    		one-to-many relation to RecallProductTaskItem
    		Field Mapping uses symbolic key
				related.RecallGroup			= RecallGroup
				related.RecallNotice		= RecallNotice
				related.RecallNoticeTask	= RecallNoticeTask
				related.RecallProduct	 	= RecallProduct
		
		QuantityNotEnteredRel
    		one-to-many relation to RecallProductTaskItem
    		Field Mapping uses symbolic key
				related.RecallGroup			= RecallGroup
				related.RecallNotice		= RecallNotice
				related.RecallNoticeTask	= RecallNoticeTask
				related.RecallProduct	 	= RecallProduct
			Instance Selection
				where (related.QuantityIdentified not entered
				and    related.ZeroQuantityFound = false)
		
		LocalRecallProductTaskItemRel
			one-to-many relation to RecallProductTaskItem
    		Field Mapping uses symbolic key
				related.RecallGroup				= RecallGroup
				related.RecallNotice			= RecallNotice
				related.RecallNoticeTask		= RecallNoticeTask
				related.RecallProduct	 		= RecallProduct
				related.RecallProductItem		= LocalItem
		
	Sets
		ByRecallProduct
			Sort Order
				RecallGroup
				RecallNotice
				RecallProduct
				RecallNoticeTask
						
	Actions
    	Create is a Create Action
    		restricted
    		
		Update is an Update Action
			valid when (RecallNoticeTask.Status.Accepted)
			Action Rules
				if (parentcontext.name != "RecallNoticeTaskProduct"
				and !LocalFromReassignTask)
					constraint (QuantityIdentified not changed)
						"QuantityCannotBeChangedFromHere"
     			
		InitializeQuantity is an Instance Action
			restricted
			Action Rules
	     		initialize QuantityIdentified
     			
		RequiredQuestionVerification is an Instance Action
			restricted
			Action Rules
				if (ShowProductQuestions)
					for each RequiredRecallProductQuestionsRel
						constraint (each.RecallProductQuestion = any ResponseToRecallProductQuestion set.RecallProductQuestion)
							"CannotCompleteTask;RequiredQuestion_#<each.RecallProductQuestion>'<each.Description>_'_isUnansweredForProduct<RecallProduct>"
				
		SetRemainingItemsToZeroQuantityFound is an Instance Action
			valid when (ShowEnterQuantityInstanceAction)
			Action Rules
				for each QuantityNotEnteredRel
					invoke UpdateFast each
						invoked.ZeroQuantityFound = true
		
		Delete is a Delete Action
			restricted
		
		Purge is a Purge Action
			restricted
			Action Rules
				invoke Purge RecallProductTaskItemRel


					
